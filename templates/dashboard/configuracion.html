{% extends "dashboard/base.html" %}
{% load static %}
{% block title %}Configuraci√≥n{% endblock %}
{% block page_title %}Configuraci√≥n{% endblock %}
{% block content %}
<section class="settings-grid">
    <header class="settings-grid__header">
        <h2>Accesos directos</h2>
        <p>Gestiona r√°pidamente las configuraciones clave del sistema POS.</p>
    </header>
    <div class="settings-grid__content">
        <div class="settings-grid__main">
            <div class="settings-grid__items">
                <button type="button" class="settings-tile" data-open-modal="general-settings">
                    <span class="settings-tile__icon" aria-hidden="true">‚öôÔ∏è</span>
                    <span class="settings-tile__label">Configuraci√≥n general</span>
                </button>
                <button type="button" class="settings-tile" data-open-fiscal-xml-card>
                    <span class="settings-tile__icon" aria-hidden="true">üìÅ</span>
                    <span class="settings-tile__label">XML DGII adicionales</span>
                </button>
                <button type="button" class="settings-tile" data-settings-action="comprobante-fiscal">
                    <span class="settings-tile__icon" aria-hidden="true">üßæ</span>
                    <span class="settings-tile__label">Comprobante fiscal</span>
                </button>
                <button type="button" class="settings-tile" data-settings-action="generar-codigo-barra">
                    <span class="settings-tile__icon" aria-hidden="true">üè∑Ô∏è</span>
                    <span class="settings-tile__label">Generar c√≥digo de barra</span>
                </button>
                <button type="button" class="settings-tile" data-settings-action="baja-productos">
                    <span class="settings-tile__icon" aria-hidden="true">üö´</span>
                    <span class="settings-tile__label">Baja de productos</span>
                </button>
                <button type="button" class="settings-tile" data-settings-action="configurar-stock-minimo">
                    <span class="settings-tile__icon" aria-hidden="true">üìâ</span>
                    <span class="settings-tile__label">Configurar stock m√≠nimo</span>
                </button>
                <button type="button" class="settings-tile" data-settings-action="editar-factura">
                    <span class="settings-tile__icon" aria-hidden="true">üßæ</span>
                    <span class="settings-tile__label">Editar factura</span>
                </button>
                <button type="button" class="settings-tile" data-settings-action="eliminar-registro-db">
                    <span class="settings-tile__icon" aria-hidden="true">üóëÔ∏è</span>
                    <span class="settings-tile__label">Eliminar registro DB</span>
                </button>
                <button type="button" class="settings-tile" data-settings-action="impresora">
                    <span class="settings-tile__icon" aria-hidden="true">üñ®Ô∏è</span>
                    <span class="settings-tile__label">Impresora</span>
                </button>
                <button type="button" class="settings-tile" data-open-resource="tax">
                    <span class="settings-tile__icon" aria-hidden="true">üí≤</span>
                    <span class="settings-tile__label">Impuestos</span>
                </button>
                <button type="button" class="settings-tile" data-settings-action="importar-producto">
                    <span class="settings-tile__icon" aria-hidden="true">üì•</span>
                    <span class="settings-tile__label">Importar producto</span>
                </button>
                <button type="button" class="settings-tile" data-settings-action="descargar-plantilla">
                    <span class="settings-tile__icon" aria-hidden="true">‚¨áÔ∏è</span>
                    <span class="settings-tile__label">Descargar plantilla</span>
                </button>
                <button type="button" class="settings-tile" data-settings-action="restaurar-bd">
                    <span class="settings-tile__icon" aria-hidden="true">‚ôªÔ∏è</span>
                    <span class="settings-tile__label">Restaurar BD</span>
                </button>
                <button type="button" class="settings-tile" data-settings-action="copia-seguridad-db">
                    <span class="settings-tile__icon" aria-hidden="true">üíæ</span>
                    <span class="settings-tile__label">Copia de seguridad DB</span>
                </button>
                <button type="button" class="settings-tile" data-open-resource="category">
                    <span class="settings-tile__icon" aria-hidden="true">üì¶</span>
                    <span class="settings-tile__label">Categor√≠a</span>
                </button>
            </div>

<div class="modal" id="tax-edit-modal" aria-hidden="true"{% if force_open_tax_edit %} data-force-open{% endif %}>
    <div class="modal-dialog" role="dialog" aria-modal="true" aria-labelledby="tax-edit-title">
        <div class="modal-header">
            <h2 id="tax-edit-title">Editar impuesto</h2>
            <button type="button" class="modal-close" aria-label="Cerrar" data-close-tax-edit>&times;</button>
        </div>
        <form method="post" class="modal-form tax-edit__form" data-tax-edit-form>
            {% csrf_token %}
            <input type="hidden" name="resource" value="impuesto">
            <input type="hidden" name="action" value="update">
            <input type="hidden" name="open" value="taxes">
            <input type="hidden" name="impuesto_id" value="{% if tax_edit_context %}{{ tax_edit_context.impuesto_id }}{% endif %}" data-tax-edit-id>
            <div class="modal-form__grid tax-register__grid">
                <div class="modal-field">
                    <label class="modal-field__label" for="tax-edit-name-input">Nombre</label>
                    <input id="tax-edit-name-input"
                        name="nombre"
                        type="text"
                        value="{% if tax_edit_context %}{{ tax_edit_context.nombre }}{% endif %}"
                        placeholder="Ej. ITBIS"
                        required
                        autocomplete="off"
                        maxlength="120"
                        data-tax-edit-name>
                    {% if tax_edit_context and tax_edit_context.errors.nombre %}
                        <div class="field-error">{{ tax_edit_context.errors.nombre|join:", " }}</div>
                    {% endif %}
                </div>
                <div class="modal-field">
                    <label class="modal-field__label" for="tax-edit-rate">Porcentaje (%)</label>
                    <input id="tax-edit-rate"
                        name="porcentaje"
                        type="number"
                        value="{% if tax_edit_context %}{{ tax_edit_context.porcentaje }}{% endif %}"
                        step="0.01"
                        min="0"
                        max="100"
                        placeholder="Ej. 18"
                        data-tax-edit-rate>
                    {% if tax_edit_context and tax_edit_context.errors.porcentaje %}
                        <div class="field-error">{{ tax_edit_context.errors.porcentaje|join:", " }}</div>
                    {% endif %}
                </div>
                <div class="modal-field modal-field--inline">
                    <span class="modal-field__label">Estado actual</span>
                    <span class="modal-field__value tax-edit__status"
                        data-tax-edit-status
                        data-state="{% if tax_edit_context %}{% if tax_edit_context.activo == 'true' %}active{% elif tax_edit_context.activo == 'false' %}inactive{% endif %}{% endif %}">
                        {% if tax_edit_context %}
                            {{ tax_edit_context.activo_label }}
                        {% else %}
                            --
                        {% endif %}
                    </span>
                </div>
            </div>
            {% if tax_edit_context and tax_edit_context.errors %}
                {% for field, field_errors in tax_edit_context.errors.items %}
                    {% if field == '__all__' %}
                        <div class="form-errors">{{ field_errors|join:", " }}</div>
                    {% endif %}
                {% endfor %}
            {% endif %}
            <div class="modal-actions">
                <button type="button" class="btn btn-ghost" data-close-tax-edit>Cancelar</button>
                <button type="submit" class="btn btn-primary">Guardar cambios</button>
            </div>
        </form>
    </div>
</div>
        </div>
    </div>

<div class="modal" id="general-settings-modal" aria-hidden="true"{% if force_open_general_settings %} data-force-open{% endif %}>
    <div class="modal-dialog" role="dialog" aria-modal="true" aria-labelledby="general-settings-title">
        <div class="modal-header">
            <h2 id="general-settings-title">Configuraci√≥n general</h2>
            <button type="button" class="modal-close" aria-label="Cerrar" data-close-general-settings>&times;</button>
        </div>
        <div class="modal-form modal-form--static">
            <div class="general-accordion" data-general-accordion>
                <div class="general-accordion__item">
                    {% with panel_open=site_logo_panel_open %}
                    <button type="button" class="general-accordion__trigger" aria-expanded="{{ panel_open|yesno:'true,false' }}">
                        <span class="general-accordion__label">Pantalla</span>
                        <span class="general-accordion__icon" aria-hidden="true">‚ñ∏</span>
                    </button>
                    <div class="general-accordion__panel"{% if not panel_open %} hidden{% endif %}>
                        <form method="post" enctype="multipart/form-data" class="site-logo-form" data-site-logo-form data-initial-logo="{% if site_configuration.logo %}{{ site_configuration.logo.url }}{% endif %}" data-has-initial-logo="{{ site_configuration.logo|yesno:'true,false' }}">
                            {% csrf_token %}
                            <input type="hidden" name="resource" value="site_config">
                            <input type="hidden" name="action" value="update">
                            <div class="site-logo-form__grid">
                                <div class="site-logo-form__preview" data-site-logo-preview-area>
                                    <img src="{{ site_logo_url }}" alt="Logo actual" class="site-logo-form__image" data-site-logo-preview{% if not site_logo_url %} hidden{% endif %}>
                                    <div class="site-logo-form__placeholder" data-site-logo-placeholder{% if site_logo_url %} hidden{% endif %}>No hay logo configurado.</div>
                                    <div class="site-logo-form__remove-badge" data-site-logo-remove-badge hidden>El logo se eliminar√° al guardar.</div>
                                </div>
                                <div class="site-logo-form__fields">
                                    <div class="site-logo-form__field">
                                        <label class="site-logo-form__label" for="id_logo">Logo del proyecto</label>
                                        {{ site_logo_form.logo }}
                                        <p class="site-logo-form__hint">Formatos permitidos: PNG, JPG, SVG, WEBP o GIF. Tama√±o m√°ximo 2&nbsp;MB.</p>
                                        {% if site_logo_form.logo.errors %}
                                            <div class="field-error">{{ site_logo_form.logo.errors|join:', ' }}</div>
                                        {% endif %}
                                    </div>
                                    <label class="site-logo-form__remove">
                                        {{ site_logo_form.remove_logo }}
                                        <span>Eliminar logo actual</span>
                                    </label>
                                    {% if site_logo_form.non_field_errors %}
                                        <div class="form-errors">{{ site_logo_form.non_field_errors|join:', ' }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="site-logo-form__actions">
                                <button type="submit" class="btn btn-primary">Guardar cambios</button>
                                <button type="reset" class="btn btn-ghost" data-site-logo-reset>Limpiar selecci√≥n</button>
                            </div>
                        </form>
                    </div>
                    {% endwith %}
                </div>
                <div class="general-accordion__item">
                    {% with panel_open=site_tax_panel_open %}
                    <button type="button" class="general-accordion__trigger" aria-expanded="{{ panel_open|yesno:'true,false' }}">
                        <span class="general-accordion__label">Impuestos</span>
                        <span class="general-accordion__icon" aria-hidden="true">‚ñ∏</span>
                    </button>
                    <div class="general-accordion__panel"{% if not panel_open %} hidden{% endif %}>
                        <form method="post" class="site-tax-form" data-site-tax-form>
                            {% csrf_token %}
                            <input type="hidden" name="resource" value="site_config_general">
                            <input type="hidden" name="action" value="update">
                            <div class="site-tax-form__grid">
                                <label class="site-tax-form__toggle">
                                    {{ site_general_form.global_tax_enabled }}
                                    <span>Aplicar impuesto global a todas las ventas</span>
                                </label>
                                {% if site_general_form.global_tax_enabled.errors %}
                                    <div class="field-error">{{ site_general_form.global_tax_enabled.errors|join:", " }}</div>
                                {% endif %}

                                <div class="site-tax-form__field">
                                    <label for="id_global_tax_rate">Porcentaje global (%)</label>
                                    {{ site_general_form.global_tax_rate }}
                                    <p class="site-tax-form__hint">Este valor se usar√° para todas las l√≠neas de venta cuando el impuesto global est√© activo.</p>
                                    {% if site_general_form.global_tax_rate.errors %}
                                        <div class="field-error">{{ site_general_form.global_tax_rate.errors|join:", " }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            {% if site_general_form.non_field_errors %}
                                <div class="form-errors">{{ site_general_form.non_field_errors|join:", " }}</div>
                            {% endif %}
                            <div class="site-tax-form__actions">
                                <button type="submit" class="btn btn-primary">Guardar ajustes</button>
                            </div>
                        </form>
                    </div>
                    {% endwith %}
                </div>
            </div>
        </div>
        <div class="modal-actions">
            <button type="button" class="btn btn-secondary" data-close-general-settings>Cerrar</button>
        </div>
    </div>
</div>

<div class="modal" id="category-modal" aria-hidden="true"{% if force_open_category %} data-force-open{% endif %}>
    <div class="modal-dialog" role="dialog" aria-modal="true" aria-labelledby="category-modal-title">
        <div class="modal-header">
            <h2 id="category-modal-title">Categor√≠as</h2>
            <button type="button" class="modal-close" aria-label="Cerrar" data-close-category-modal>&times;</button>
        </div>
        <div class="modal-flex category-modal">
            <div class="category-modal__toolbar">
                <label class="category-modal__search">
                    <span class="category-modal__search-icon" aria-hidden="true">üîé</span>
                    <input type="search" placeholder="Buscar categor√≠a" data-category-search autocomplete="off">
                </label>
                <button type="button" class="btn btn-primary category-modal__register" data-category-register>
                    <span class="category-modal__register-icon" aria-hidden="true">Ôºã</span>
                    <span>Registrar</span>
                </button>
            </div>
            <div class="category-modal__table-wrapper">
                <table class="category-modal__table">
                    <thead>
                        <tr>
                            <th scope="col">ID</th>
                            <th scope="col">Categor√≠a</th>
                            <th scope="col">Tipo de producto</th>
                            <th scope="col">Estado</th>
                            <th scope="col">Acciones</th>
                        </tr>
                    </thead>
                    <tbody data-category-table>
                        {% if categorias %}
                            {% for categoria in categorias %}
                                <tr
                                    data-category-row
                                    data-id="{{ categoria.id }}"
                                    data-name="{{ categoria.nombre|lower }}"
                                    data-state="{{ categoria.activo|yesno:'true,false' }}"
                                    data-type="{{ categoria.tipo_producto|default:'' }}"
                                >
                                    <td>{{ categoria.id }}</td>
                                    <td>{{ categoria.nombre }}</td>
                                    <td>
                                        {% if categoria.tipo_producto %}
                                            <span class="product-type-badge product-type-badge--{{ categoria.tipo_producto }}">
                                                {% if categoria.tipo_producto == 'phone' %}üì± Tel√©fonos
                                                {% elif categoria.tipo_producto == 'accessory' %}üîå Accesorios
                                                {% elif categoria.tipo_producto == 'laptop' %}üíª Laptops
                                                {% elif categoria.tipo_producto == 'tablet' %}üìü Tablets
                                                {% elif categoria.tipo_producto == 'gaming' %}üéÆ Gaming
                                                {% else %}{{ categoria.get_tipo_producto_display }}
                                                {% endif %}
                                            </span>
                                        {% else %}
                                            <span class="product-type-badge product-type-badge--general">üîß General</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ categoria.activo|yesno:'Activa,Inactiva' }}</td>
                                    <td>
                                        <div class="tax-actions tax-actions--compact">
                                            <button type="button"
                                                class="btn btn-secondary btn-icon btn-icon--sm"
                                                data-category-edit
                                                data-id="{{ categoria.id }}"
                                                data-name="{{ categoria.nombre|escape }}"
                                                data-active="{{ categoria.activo|yesno:'true,false' }}"
                                                data-type="{{ categoria.tipo_producto|default:'' }}"
                                                aria-label="Editar categor√≠a {{ categoria.nombre }}">
                                                <span class="icon">‚úèÔ∏è</span>
                                            </button>
                                            <div class="tax-actions__inline-group">
                                                <form method="post" class="tax-actions__form">
                                                    {% csrf_token %}
                                                    <input type="hidden" name="resource" value="categoria">
                                                    <input type="hidden" name="action" value="toggle">
                                                    <input type="hidden" name="categoria_id" value="{{ categoria.id }}">
                                                    <input type="hidden" name="open" value="categories">
                                                    <button type="submit" class="btn btn-outline btn-icon btn-icon--sm"
                                                        aria-label="{% if categoria.activo %}Desactivar{% else %}Activar{% endif %} categor√≠a {{ categoria.nombre }}">
                                                        <span class="icon">{% if categoria.activo %}‚è∏Ô∏è{% else %}‚ñ∂Ô∏è{% endif %}</span>
                                                    </button>
                                                </form>
                                                <form method="post" class="tax-actions__form" data-confirm="¬øEliminar esta categor√≠a?">
                                                    {% csrf_token %}
                                                    <input type="hidden" name="resource" value="categoria">
                                                    <input type="hidden" name="action" value="delete">
                                                    <input type="hidden" name="categoria_id" value="{{ categoria.id }}">
                                                    <input type="hidden" name="open" value="categories">
                                                    <button type="submit" class="btn btn-danger btn-icon btn-icon--sm"
                                                        aria-label="Eliminar categor√≠a {{ categoria.nombre }}">
                                                        <span class="icon">üóëÔ∏è</span>
                                                    </button>
                                                </form>
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                            {% endfor %}
                        {% endif %}
                    </tbody>
                </table>
                <p class="category-modal__empty" data-category-empty {% if categorias %}hidden{% endif %}>A√∫n no hay categor√≠as registradas.</p>
            </div>
        </div>
    </div>
</div>

<div class="modal" id="category-register-modal" aria-hidden="true"{% if force_open_category_register %} data-force-open{% endif %}>
    <div class="modal-dialog" role="dialog" aria-modal="true" aria-labelledby="category-register-title">
        <div class="modal-header">
            <h2 id="category-register-title">Registrar categor√≠a</h2>
            <button type="button" class="modal-close" aria-label="Cerrar" data-close-category-register>&times;</button>
        </div>
        <form method="post" class="modal-form category-register__form" data-category-register-form>
            {% csrf_token %}
            <input type="hidden" name="resource" value="categoria">
            <input type="hidden" name="action" value="create">
            {% if request.GET.open == "categories" %}
                <input type="hidden" name="open" value="categories">
            {% endif %}
            <div class="modal-form__grid category-register__grid">
                <div class="modal-field">
                    <label class="modal-field__label" for="category-register-code">C√≥digo</label>
                    <input id="category-register-code" name="codigo" type="text" value="{{ next_categoria_codigo }}" readonly>
                </div>
                <div class="modal-field">
                    <label class="modal-field__label" for="category-register-name-input">Nombre</label>
                    {{ categoria_form.nombre }}
                    {% if categoria_form.nombre.errors %}
                        <div class="field-error">{{ categoria_form.nombre.errors|join:", " }}</div>
                    {% endif %}
                </div>
                <div class="modal-field">
                    <label class="modal-field__label" for="category-register-type-input">Tipo de producto</label>
                    <div class="modal-field__group modal-field__group--compact">
                        {{ categoria_form.tipo_producto }}
                        <button type="button" class="btn btn-primary btn--compact" data-open-product-type-register>
                            <span class="btn__icon">Ôºã</span>
                            <span>Agregar tipo</span>
                        </button>
                    </div>
                    {% if categoria_form.tipo_producto.errors %}
                        <div class="field-error">{{ categoria_form.tipo_producto.errors|join:", " }}</div>
                    {% endif %}
                    {% if categoria_form.fields.tipo_producto.help_text %}
                        <div class="modal-field__help">{{ categoria_form.fields.tipo_producto.help_text }}</div>
                    {% endif %}
                </div>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn btn-ghost" data-close-category-register>Cancelar</button>
                <button type="submit" class="btn btn-primary">Guardar</button>
            </div>
        </form>
    </div>
</div>

<div class="modal" id="category-edit-modal" aria-hidden="true">
    <div class="modal-dialog" role="dialog" aria-modal="true" aria-labelledby="category-edit-title">
        <div class="modal-header">
            <h2 id="category-edit-title">Editar categor√≠a</h2>
            <button type="button" class="modal-close" aria-label="Cerrar" data-close-category-edit>&times;</button>
        </div>
        <form method="post" class="modal-form category-edit__form" data-category-edit-form>
            {% csrf_token %}
            <input type="hidden" name="resource" value="categoria">
            <input type="hidden" name="action" value="update">
            <input type="hidden" name="open" value="categories">
            <input type="hidden" name="categoria_id" data-category-edit-id>
            <div class="modal-form__grid category-register__grid">
                <div class="modal-field">
                    <label class="modal-field__label" for="category-edit-name">Nombre</label>
                    <input id="category-edit-name"
                        name="nombre"
                        type="text"
                        placeholder="Ej. Accesorios"
                        required
                        autocomplete="off"
                        maxlength="120"
                        data-category-edit-name>
                </div>
                <div class="modal-field">
                    <label class="modal-field__label" for="category-edit-type">Tipo de producto</label>
                    <div class="modal-field__group modal-field__group--compact">
                        <select id="category-edit-type" name="tipo_producto" class="modal-field__input" data-category-edit-type>
                            <option value="">üîß General (todos los tipos)</option>
                            <option value="phone">üì± Tel√©fonos</option>
                            <option value="accessory">üîå Accesorios</option>
                            <option value="laptop">üíª Laptops</option>
                            <option value="tablet">üìü Tablets</option>
                            <option value="gaming">üéÆ Gaming</option>
                        </select>
                        <button type="button" class="btn btn-primary btn--compact" data-open-product-type-register>
                            <span class="btn__icon">Ôºã</span>
                            <span>Agregar tipo</span>
                        </button>
                    </div>
                </div>
                <div class="modal-field modal-field--inline">
                    <span class="modal-field__label">Estado actual</span>
                    <span class="modal-field__value category-edit__status" data-category-edit-status data-state="">
                        --
                    </span>
                </div>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn btn-ghost" data-close-category-edit>Cancelar</button>
                <button type="submit" class="btn btn-primary">Guardar cambios</button>
            </div>
        </form>
    </div>
</div>

<div class="modal" id="product-type-modal" aria-hidden="true">
    <div class="modal-dialog" role="dialog" aria-modal="true" aria-labelledby="product-type-modal-title">
        <div class="modal-header">
            <h2 id="product-type-modal-title">Tipos de Producto</h2>
            <button type="button" class="modal-close" aria-label="Cerrar" data-close-product-type-modal>&times;</button>
        </div>
        <div class="modal-flex product-type-modal">
            <div class="product-type-modal__toolbar">
                <label class="product-type-modal__search">
                    <span class="product-type-modal__search-icon" aria-hidden="true">üîç</span>
                    <input type="search" placeholder="Buscar tipo de producto" data-product-type-search autocomplete="off">
                </label>
                <button type="button" class="btn btn-primary product-type-modal__register" data-product-type-register>
                    <span class="product-type-modal__register-icon" aria-hidden="true">Ôºã</span>
                    <span>Registrar</span>
                </button>
            </div>
            <div class="product-type-modal__table-wrapper">
                <table class="product-type-modal__table">
                    <thead>
                        <tr>
                            <th scope="col">ID</th>
                            <th scope="col">Nombre</th>
                            <th scope="col">Icono</th>
                            <th scope="col">Descripci√≥n</th>
                            <th scope="col">Estado</th>
                            <th scope="col">Acciones</th>
                        </tr>
                    </thead>
                    <tbody data-product-type-table>
                        {% for tipo in tipos_producto %}
                            <tr data-product-type-row data-id="{{ tipo.id }}" data-name="{{ tipo.nombre|lower }}">
                                <td data-product-type-id>{{ tipo.id }}</td>
                                <td data-product-type-name>{{ tipo.nombre }}</td>
                                <td data-product-type-icono>{{ tipo.get_icono_display }}</td>
                                <td data-product-type-descripcion>{{ tipo.descripcion|default:"Sin descripci√≥n"|truncatechars:50 }}</td>
                                <td data-product-type-estado>
                                    <span class="status-badge status-badge--{{ tipo.activo|yesno:'active,inactive' }}">
                                        {{ tipo.activo|yesno:'Activo,Inactivo' }}
                                    </span>
                                </td>
                                <td>
                                    <div class="product-type-modal__actions">
                                        <button type="button" class="btn btn-ghost btn--compact" data-product-type-edit data-id="{{ tipo.id }}" data-nombre="{{ tipo.nombre }}" data-icono="{{ tipo.icono }}" data-descripcion="{{ tipo.descripcion }}" data-activo="{{ tipo.activo }}">
                                            <span class="btn__icon">‚úèÔ∏è</span>
                                            <span>Editar</span>
                                        </button>
                                        <button type="button" class="btn btn-ghost btn--compact" data-product-type-toggle data-id="{{ tipo.id }}" data-active="{{ tipo.activo }}">
                                            <span class="btn__icon">{{ tipo.activo|yesno:'üî¥,üü¢' }}</span>
                                            <span>{{ tipo.activo|yesno:'Desactivar,Activar' }}</span>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        {% empty %}
                            <tr data-product-type-empty>
                                <td colspan="6">No hay tipos de producto registrados.</td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
                <p class="product-type-modal__empty" data-product-type-empty {% if tipos_producto %}hidden{% endif %}>A√∫n no hay tipos de producto registrados.</p>
            </div>
        </div>
    </div>
</div>

<div class="modal" id="product-type-register-modal" aria-hidden="true">
    <div class="modal-dialog" role="dialog" aria-modal="true" aria-labelledby="product-type-register-title">
        <div class="modal-header">
            <h2 id="product-type-register-title">Registrar Tipo de Producto</h2>
            <button type="button" class="modal-close" aria-label="Cerrar" data-close-product-type-register>&times;</button>
        </div>
        <form class="modal-form product-type-register__form" data-product-type-register-form>
            {% csrf_token %}
            <div class="modal-form__grid product-type-register__grid">
                <div class="modal-field">
                    <label class="modal-field__label" for="product-type-register-name">Nombre</label>
                    <input type="text" id="product-type-register-name" name="nombre" placeholder="Ej. Smartwatch" required autocomplete="off" maxlength="100" data-product-type-register-name>
                </div>
                <div class="modal-field">
                    <label class="modal-field__label" for="product-type-register-icono">Icono</label>
                    <select id="product-type-register-icono" name="icono" class="modal-field__input" data-product-type-register-icono>
                        <option value="phone">üì± Tel√©fono</option>
                        <option value="accessory">üîå Accesorio</option>
                        <option value="laptop">üíª Laptop</option>
                        <option value="tablet">üìü Tablet</option>
                        <option value="gaming">üéÆ Gaming</option>
                        <option value="watch">‚åö Reloj</option>
                        <option value="headphones">üéß Auriculares</option>
                        <option value="camera">üì∑ C√°mara</option>
                        <option value="speaker">üîä Altavoz</option>
                        <option value="other">üì¶ Otro</option>
                        <option value="custom" selected>üîß Personalizado</option>
                    </select>
                </div>
                <div class="modal-field modal-field--full">
                    <label class="modal-field__label" for="product-type-register-descripcion">Descripci√≥n</label>
                    <textarea id="product-type-register-descripcion" name="descripcion" placeholder="Ej. Dispositivos wearable para el seguimiento de actividad" rows="3" data-product-type-register-descripcion></textarea>
                </div>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn btn-ghost" data-close-product-type-register>Cancelar</button>
                <button type="submit" class="btn btn-primary">Guardar</button>
            </div>
        </form>
    </div>
</div>

<div class="modal" id="product-type-edit-modal" aria-hidden="true">
    <div class="modal-dialog" role="dialog" aria-modal="true" aria-labelledby="product-type-edit-title">
        <div class="modal-header">
            <h2 id="product-type-edit-title">Editar Tipo de Producto</h2>
            <button type="button" class="modal-close" aria-label="Cerrar" data-close-product-type-edit>&times;</button>
        </div>
        <form class="modal-form product-type-edit__form" data-product-type-edit-form>
            {% csrf_token %}
            <input type="hidden" name="id" data-product-type-edit-id>
            <div class="modal-form__grid product-type-edit__grid">
                <div class="modal-field">
                    <label class="modal-field__label" for="product-type-edit-name">Nombre</label>
                    <input type="text" id="product-type-edit-name" name="nombre" placeholder="Ej. Smartwatch" required autocomplete="off" maxlength="100" data-product-type-edit-name>
                </div>
                <div class="modal-field">
                    <label class="modal-field__label" for="product-type-edit-icono">Icono</label>
                    <select id="product-type-edit-icono" name="icono" class="modal-field__input" data-product-type-edit-icono>
                        <option value="phone">üì± Tel√©fono</option>
                        <option value="accessory">üîå Accesorio</option>
                        <option value="laptop">üíª Laptop</option>
                        <option value="tablet">üìü Tablet</option>
                        <option value="gaming">üéÆ Gaming</option>
                        <option value="watch">‚åö Reloj</option>
                        <option value="headphones">üéß Auriculares</option>
                        <option value="camera">üì∑ C√°mara</option>
                        <option value="speaker">üîä Altavoz</option>
                        <option value="other">üì¶ Otro</option>
                        <option value="custom">üîß Personalizado</option>
                    </select>
                </div>
                <div class="modal-field modal-field--full">
                    <label class="modal-field__label" for="product-type-edit-descripcion">Descripci√≥n</label>
                    <textarea id="product-type-edit-descripcion" name="descripcion" placeholder="Ej. Dispositivos wearable para el seguimiento de actividad" rows="3" data-product-type-edit-descripcion></textarea>
                </div>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn btn-ghost" data-close-product-type-edit>Cancelar</button>
                <button type="submit" class="btn btn-primary">Guardar cambios</button>
            </div>
        </form>
    </div>
</div>

<div class="modal" id="tax-modal" aria-hidden="true"{% if force_open_tax %} data-force-open{% endif %}>
    <div class="modal-dialog" role="dialog" aria-modal="true" aria-labelledby="tax-modal-title">
        <div class="modal-header">
            <h2 id="tax-modal-title">Impuestos</h2>
            <button type="button" class="modal-close" aria-label="Cerrar" data-close-tax-modal>&times;</button>
        </div>
        <div class="modal-flex tax-modal">
            <div class="tax-modal__toolbar">
                <label class="tax-modal__search">
                    <span class="tax-modal__search-icon" aria-hidden="true">üîç</span>
                    <input type="search" placeholder="Buscar impuesto" data-tax-search autocomplete="off">
                </label>
                <button type="button" class="btn btn-primary tax-modal__register" data-tax-register>
                    <span class="tax-modal__register-icon" aria-hidden="true">Ôºã</span>
                    <span>Registrar</span>
                </button>
            </div>
            <div class="tax-modal__table-wrapper">
                <table class="tax-modal__table">
                    <thead>
                        <tr>
                            <th scope="col">ID</th>
                            <th scope="col">Impuesto</th>
                            <th scope="col">Porcentaje</th>
                            <th scope="col">Estado</th>
                            <th scope="col">Acciones</th>
                        </tr>
                    </thead>
                    <tbody data-tax-table>
                        {% if impuestos %}
                            {% for impuesto in impuestos %}
                                <tr
                                    data-tax-row
                                    data-id="{{ impuesto.id }}"
                                    data-name="{{ impuesto.nombre|lower }}"
                                    data-rate="{{ impuesto.porcentaje }}"
                                    data-active="{{ impuesto.activo|yesno:'true,false' }}">
                                    <td>{{ impuesto.id }}</td>
                                    <td>{{ impuesto.nombre }}</td>
                                    <td>{{ impuesto.porcentaje }}%</td>
                                    <td>{{ impuesto.activo|yesno:'Activo,Inactivo' }}</td>
                                    <td>
                                        <div class="tax-actions">
                                            <button type="button"
                                                class="btn btn-secondary"
                                                data-tax-edit
                                                data-id="{{ impuesto.id }}"
                                                data-name="{{ impuesto.nombre|escape }}"
                                                data-rate="{{ impuesto.porcentaje }}"
                                                data-active="{{ impuesto.activo|yesno:'true,false' }}">
                                                Editar
                                            </button>
                                            <form method="post" class="tax-actions__form">
                                                {% csrf_token %}
                                                <input type="hidden" name="resource" value="impuesto">
                                                <input type="hidden" name="action" value="toggle">
                                                <input type="hidden" name="impuesto_id" value="{{ impuesto.id }}">
                                                <input type="hidden" name="open" value="taxes">
                                                <button type="submit" class="btn btn-outline">
                                                    {{ impuesto.activo|yesno:'Desactivar,Activar' }}
                                                </button>
                                            </form>
                                            <form method="post" class="tax-actions__form" data-confirm="¬øEliminar este impuesto?">
                                                {% csrf_token %}
                                                <input type="hidden" name="resource" value="impuesto">
                                                <input type="hidden" name="action" value="delete">
                                                <input type="hidden" name="impuesto_id" value="{{ impuesto.id }}">
                                                <input type="hidden" name="open" value="taxes">
                                                <button type="submit" class="btn btn-danger">Eliminar</button>
                                            </form>
                                        </div>
                                    </td>
                                </tr>
                            {% endfor %}
                        {% endif %}
                    </tbody>
                </table>
                <p class="tax-modal__empty" data-tax-empty {% if impuestos %}hidden{% endif %}>A√∫n no hay impuestos registrados.</p>
            </div>
        </div>
    </div>
</div>

<div class="modal" id="tax-register-modal" aria-hidden="true"{% if force_open_tax_register %} data-force-open{% endif %}>
    <div class="modal-dialog" role="dialog" aria-modal="true" aria-labelledby="tax-register-title">
        <div class="modal-header">
            <h2 id="tax-register-title">Registrar impuesto</h2>
            <button type="button" class="modal-close" aria-label="Cerrar" data-close-tax-register>&times;</button>
        </div>
        <form method="post" class="modal-form tax-register__form" data-tax-register-form>
            {% csrf_token %}
            <input type="hidden" name="resource" value="impuesto">
            <input type="hidden" name="action" value="create">
            {% if request.GET.open == "taxes" %}
                <input type="hidden" name="open" value="taxes">
            {% endif %}
            <div class="modal-form__grid tax-register__grid">
                <div class="modal-field">
                    <label class="modal-field__label" for="tax-register-code">C√≥digo</label>
                    <input id="tax-register-code" name="codigo" type="text" value="{{ next_impuesto_codigo }}" readonly>
                </div>
                <div class="modal-field">
                    <label class="modal-field__label" for="tax-register-name-input">Nombre</label>
                    {{ impuesto_form.nombre }}
                    {% if impuesto_form.nombre.errors %}
                        <div class="field-error">{{ impuesto_form.nombre.errors|join:", " }}</div>
                    {% endif %}
                </div>
                <div class="modal-field">
                    <label class="modal-field__label" for="tax-register-rate">Porcentaje (%)</label>
                    {{ impuesto_form.porcentaje }}
                    {% if impuesto_form.porcentaje.errors %}
                        <div class="field-error">{{ impuesto_form.porcentaje.errors|join:", " }}</div>
                    {% endif %}
                </div>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn btn-ghost" data-close-tax-register>Cancelar</button>
                <button type="submit" class="btn btn-primary">Guardar</button>
            </div>
        </form>
    </div>
</div>

    <div class="fiscal-xml-overlay" data-fiscal-xml-overlay hidden></div>

<div class="modal" id="fiscal-xml-modal" aria-hidden="true" data-fiscal-xml-panel>
    <div class="modal-dialog" role="dialog" aria-modal="true" aria-labelledby="fiscal-xml-title">
        <div class="modal-header">
            <h2 id="fiscal-xml-title">XML DGII adicionales</h2>
            <button type="button" class="modal-close" aria-label="Cerrar" data-close-fiscal-xml-modal>&times;</button>
        </div>
        <div class="modal-flex">
            <div class="fiscal-xml-card" data-fiscal-xml-card>
                <p class="modal-description">Sube y consulta los XML suministrados por la DGII para complementar la emisi√≥n de comprobantes fiscales.</p>
                <form class="fiscal-xml-card__form" enctype="multipart/form-data" data-fiscal-xml-form>
                    {% csrf_token %}
                    <div class="fiscal-xml-card__form-grid">
                        <label class="fiscal-xml-card__field" for="fiscal-xml-name-input">
                            <span class="fiscal-xml-card__label">Nombre</span>
                            {{ fiscal_xml_form.nombre }}
                            {% if fiscal_xml_form.nombre.errors %}
                                <span class="field-error">{{ fiscal_xml_form.nombre.errors|join:", " }}</span>
                            {% endif %}
                        </label>
                        <label class="fiscal-xml-card__field">
                            <span class="fiscal-xml-card__label">Archivo XML</span>
                            {{ fiscal_xml_form.archivo }}
                            {% if fiscal_xml_form.archivo.errors %}
                                <span class="field-error">{{ fiscal_xml_form.archivo.errors|join:", " }}</span>
                            {% endif %}
                        </label>
                    </div>
                    <div class="fiscal-xml-card__actions">
                        <button type="submit" class="btn btn-primary" data-fiscal-xml-submit>Subir XML</button>
                    </div>
                </form>

                <div class="fiscal-xml-card__list">
                    <ul class="fiscal-xml-list" data-fiscal-xml-list>
                        {% if fiscal_xml_templates %}
                            {% for xml in fiscal_xml_templates %}
                                <li class="fiscal-xml-item" data-fiscal-xml-item data-template-id="{{ xml.id }}">
                                    <div class="fiscal-xml-item__main">
                                        <div>
                                            <strong class="fiscal-xml-item__name">{{ xml.nombre }}</strong>
                                            <p class="fiscal-xml-item__meta">Registrado {{ xml.created_at|date:"d/m/Y H:i" }}</p>
                                            {% if xml.archivo %}
                                                <a href="{{ xml.archivo.url }}" target="_blank" rel="noopener" class="fiscal-xml-item__link">Descargar</a>
                                            {% endif %}
                                        </div>
                                        <div class="fiscal-xml-item__status">
                                            <span class="connection-badge connection-badge--{{ xml.estado_conexion }}" data-fiscal-xml-badge>{{ xml.get_estado_conexion_display }}</span>
                                            <button type="button" class="btn btn-secondary fiscal-xml-item__check" data-fiscal-xml-check>Detectar conexi√≥n</button>
                                        </div>
                                    </div>
                                    <p class="fiscal-xml-item__message" data-fiscal-xml-message>
                                        {% if xml.mensaje %}
                                            {{ xml.mensaje }}
                                        {% else %}
                                            √öltimo intento: {% if xml.ultimo_intento %}{{ xml.ultimo_intento|date:"d/m/Y H:i" }}{% else %}‚Äî{% endif %}
                                        {% endif %}
                                    </p>
                                </li>
                            {% endfor %}
                        {% else %}
                            <li class="fiscal-xml-empty" data-fiscal-xml-empty>A√∫n no se han registrado XML adicionales.</li>
                        {% endif %}
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal" id="fiscal-voucher-modal" aria-hidden="true">
    <div class="modal-dialog" role="dialog" aria-modal="true" aria-labelledby="fiscal-voucher-title">
        <div class="modal-header">
            <h2 id="fiscal-voucher-title">Comprobante fiscal</h2>
            <button type="button" class="modal-close" aria-label="Cerrar" data-close-fiscal-modal>&times;</button>
        </div>
        <div class="modal-flex" data-fiscal-modal-body>
            <form method="post" action="{% url 'dashboard:fiscal_voucher_config_api' %}" class="modal-form" data-fiscal-config-form>
                {% csrf_token %}
                {{ fiscal_config_form.media }}

                <p class="modal-description">Configura aqu√≠ la emisi√≥n de comprobantes fiscales electr√≥nicos y aseg√∫rate de registrar los XML adicionales proporcionados por la DGII en la tarjeta correspondiente.</p>

                <fieldset class="modal-fieldset">
                    <legend>Datos del contribuyente</legend>
                    <div class="modal-form__grid">
                        <div class="modal-field">
                            <label class="modal-field__label" for="id_nombre_contribuyente">Contribuyente</label>
                            {{ fiscal_config_form.nombre_contribuyente }}
                            {% if fiscal_config_form.nombre_contribuyente.errors %}
                                <div class="field-error">{{ fiscal_config_form.nombre_contribuyente.errors|join:", " }}</div>
                            {% endif %}
                        </div>
                        <div class="modal-field">
                            <label class="modal-field__label" for="id_rnc">RNC</label>
                            {{ fiscal_config_form.rnc }}
                            {% if fiscal_config_form.rnc.errors %}
                                <div class="field-error">{{ fiscal_config_form.rnc.errors|join:", " }}</div>
                            {% endif %}
                        </div>
                        <div class="modal-field">
                            <label class="modal-field__label" for="id_correo_contacto">Correo contacto</label>
                            {{ fiscal_config_form.correo_contacto }}
                            {% if fiscal_config_form.correo_contacto.errors %}
                                <div class="field-error">{{ fiscal_config_form.correo_contacto.errors|join:", " }}</div>
                            {% endif %}
                        </div>
                        <div class="modal-field">
                            <label class="modal-field__label" for="id_telefono_contacto">Tel√©fono contacto</label>
                            {{ fiscal_config_form.telefono_contacto }}
                            {% if fiscal_config_form.telefono_contacto.errors %}
                                <div class="field-error">{{ fiscal_config_form.telefono_contacto.errors|join:", " }}</div>
                            {% endif %}
                        </div>
                    </div>
                </fieldset>

                <fieldset class="modal-fieldset">
                    <legend>Par√°metros de emisi√≥n</legend>
                    <div class="modal-form__grid">
                        <div class="modal-field">
                            <label class="modal-field__label" for="id_tipo_por_defecto">Tipo por defecto</label>
                            {{ fiscal_config_form.tipo_por_defecto }}
                            {% if fiscal_config_form.tipo_por_defecto.errors %}
                                <div class="field-error">{{ fiscal_config_form.tipo_por_defecto.errors|join:", " }}</div>
                            {% endif %}
                        </div>
                        <div class="modal-field">
                            <label class="modal-field__label" for="id_serie_por_defecto">Serie por defecto</label>
                            {{ fiscal_config_form.serie_por_defecto }}
                            {% if fiscal_config_form.serie_por_defecto.errors %}
                                <div class="field-error">{{ fiscal_config_form.serie_por_defecto.errors|join:", " }}</div>
                            {% endif %}
                        </div>
                        <div class="modal-field">
                            <label class="modal-field__label" for="id_secuencia_siguiente">Secuencia siguiente</label>
                            {{ fiscal_config_form.secuencia_siguiente }}
                            {% if fiscal_config_form.secuencia_siguiente.errors %}
                                <div class="field-error">{{ fiscal_config_form.secuencia_siguiente.errors|join:", " }}</div>
                            {% endif %}
                        </div>
                        <div class="modal-field">
                            <label class="modal-field__label" for="id_dias_vencimiento">D√≠as vencimiento</label>
                            {{ fiscal_config_form.dias_vencimiento }}
                            {% if fiscal_config_form.dias_vencimiento.errors %}
                                <div class="field-error">{{ fiscal_config_form.dias_vencimiento.errors|join:", " }}</div>
                            {% endif %}
                        </div>
                    </div>
                    <div class="modal-form__grid modal-form__grid--split">
                        <label class="toggle-field">
                            {{ fiscal_config_form.emitir_automatico }}
                            <span class="toggle-field__label">Emitir autom√°ticamente</span>
                        </label>
                        <label class="toggle-field">
                            {{ fiscal_config_form.modo_pruebas }}
                            <span class="toggle-field__label">Modo pruebas</span>
                        </label>
                        <div class="modal-field">
                            <label class="modal-field__label" for="id_api_environment">Entorno</label>
                            {{ fiscal_config_form.api_environment }}
                            {% if fiscal_config_form.api_environment.errors %}
                                <div class="field-error">{{ fiscal_config_form.api_environment.errors|join:", " }}</div>
                            {% endif %}
                        </div>
                    </div>
                </fieldset>

                <fieldset class="modal-fieldset">
                    <legend>Endpoints DGII</legend>
                    <div class="modal-form__grid">
                        <div class="modal-field">
                            <label class="modal-field__label" for="id_api_base_url">URL base</label>
                            {{ fiscal_config_form.api_base_url }}
                            {% if fiscal_config_form.api_base_url.errors %}
                                <div class="field-error">{{ fiscal_config_form.api_base_url.errors|join:", " }}</div>
                            {% endif %}
                        </div>
                        <div class="modal-field">
                            <label class="modal-field__label" for="id_api_auth_url">Autenticaci√≥n</label>
                            {{ fiscal_config_form.api_auth_url }}
                            {% if fiscal_config_form.api_auth_url.errors %}
                                <div class="field-error">{{ fiscal_config_form.api_auth_url.errors|join:", " }}</div>
                            {% endif %}
                        </div>
                        <div class="modal-field">
                            <label class="modal-field__label" for="id_api_submission_url">Recepci√≥n e-CF</label>
                            {{ fiscal_config_form.api_submission_url }}
                            {% if fiscal_config_form.api_submission_url.errors %}
                                <div class="field-error">{{ fiscal_config_form.api_submission_url.errors|join:", " }}</div>
                            {% endif %}
                        </div>
                        <div class="modal-field">
                            <label class="modal-field__label" for="id_api_status_url">Consulta estado</label>
                            {{ fiscal_config_form.api_status_url }}
                            {% if fiscal_config_form.api_status_url.errors %}
                                <div class="field-error">{{ fiscal_config_form.api_status_url.errors|join:", " }}</div>
                            {% endif %}
                        </div>
                        <div class="modal-field">
                            <label class="modal-field__label" for="id_api_directory_url">Directorio clientes</label>
                            {{ fiscal_config_form.api_directory_url }}
                            {% if fiscal_config_form.api_directory_url.errors %}
                                <div class="field-error">{{ fiscal_config_form.api_directory_url.errors|join:", " }}</div>
                            {% endif %}
                        </div>
                        <div class="modal-field">
                            <label class="modal-field__label" for="id_api_void_url">Anulaci√≥n</label>
                            {{ fiscal_config_form.api_void_url }}
                            {% if fiscal_config_form.api_void_url.errors %}
                                <div class="field-error">{{ fiscal_config_form.api_void_url.errors|join:", " }}</div>
                            {% endif %}
                        </div>
                        <div class="modal-field">
                            <label class="modal-field__label" for="id_api_commercial_approval_url">Aprobaci√≥n comercial</label>
                            {{ fiscal_config_form.api_commercial_approval_url }}
                            {% if fiscal_config_form.api_commercial_approval_url.errors %}
                                <div class="field-error">{{ fiscal_config_form.api_commercial_approval_url.errors|join:", " }}</div>
                            {% endif %}
                        </div>
                    </div>
                </fieldset>

                <fieldset class="modal-fieldset">
                    <legend>Credenciales y certificados</legend>
                    <div class="modal-form__grid">
                        <div class="modal-field">
                            <label class="modal-field__label" for="id_api_client_id">Client ID</label>
                            {{ fiscal_config_form.api_client_id }}
                            {% if fiscal_config_form.api_client_id.errors %}
                                <div class="field-error">{{ fiscal_config_form.api_client_id.errors|join:", " }}</div>
                            {% endif %}
                        </div>
                        <div class="modal-field">
                            <label class="modal-field__label" for="id_api_client_secret">Client Secret</label>
                            {{ fiscal_config_form.api_client_secret }}
                            {% if fiscal_config_form.api_client_secret.errors %}
                                <div class="field-error">{{ fiscal_config_form.api_client_secret.errors|join:", " }}</div>
                            {% endif %}
                        </div>
                        <div class="modal-field">
                            <label class="modal-field__label" for="id_certificado_alias">Alias certificado</label>
                            {{ fiscal_config_form.certificado_alias }}
                            {% if fiscal_config_form.certificado_alias.errors %}
                                <div class="field-error">{{ fiscal_config_form.certificado_alias.errors|join:", " }}</div>
                            {% endif %}
                        </div>
                        <div class="modal-field">
                            <label class="modal-field__label" for="id_certificado_path">Ruta certificado (.p12/.pfx)</label>
                            {{ fiscal_config_form.certificado_path }}
                            {% if fiscal_config_form.certificado_path.errors %}
                                <div class="field-error">{{ fiscal_config_form.certificado_path.errors|join:", " }}</div>
                            {% endif %}
                        </div>
                        <div class="modal-field">
                            <label class="modal-field__label" for="id_certificado_password">Contrase√±a certificado</label>
                            {{ fiscal_config_form.certificado_password }}
                            {% if fiscal_config_form.certificado_password.errors %}
                                <div class="field-error">{{ fiscal_config_form.certificado_password.errors|join:", " }}</div>
                            {% endif %}
                        </div>
                    </div>
                </fieldset>

                <section class="modal-info-card">
                    <header class="modal-info-card__header">
                        <h3>Comprobante fiscal (DGII)</h3>
                        <p>Gestiona toda la informaci√≥n oficial requerida por la DGII para emitir comprobantes y los XML complementarios.</p>
                    </header>
                    <div class="modal-info-card__actions">
                        <button type="button" class="btn btn-primary modal-info-card__action" data-settings-action="comprobante-fiscal">
                            <span aria-hidden="true">‚öôÔ∏è</span>
                            <span>Editar par√°metros</span>
                        </button>
                        <button type="button" class="btn btn-outline modal-info-card__action" data-open-fiscal-xml-card>
                            <span aria-hidden="true">üìÅ</span>
                            <span>Administrar XML DGII</span>
                        </button>
                    </div>
                </section>

                <fieldset class="modal-fieldset">
                    <legend>Observaciones</legend>
                    <div class="modal-field">
                        {{ fiscal_config_form.observaciones }}
                        {% if fiscal_config_form.observaciones.errors %}
                            <div class="field-error">{{ fiscal_config_form.observaciones.errors|join:", " }}</div>
                        {% endif %}
                    </div>
                </fieldset>

                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" data-close-fiscal-modal>Cancelar</button>
                    <button type="submit" class="btn btn-primary">Guardar configuraci√≥n</button>
                </div>
            </form>
        </div>
    </div>
</div>

</div>

</section>

<style>
    .settings-grid {
        display: flex;
        flex-direction: column;
        gap: 24px;
    }

    .settings-grid__header h2 {
        margin: 0;
        font-size: 1.6rem;
        font-weight: 700;
        color: #2f3640;
    }

    .settings-grid__header p {
        margin: 4px 0 0;
        color: #636e72;
        font-size: 0.95rem;
    }

    .settings-grid__content {
        display: grid;
        gap: 24px;
        align-items: start;
        grid-template-columns: 1fr;
    }

    .settings-grid__main {
        display: flex;
        flex-direction: column;
        gap: 24px;
    }

    .settings-grid__items {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
        gap: 18px;
    }

    .settings-tile {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 12px;
        aspect-ratio: 1 / 1;
        border-radius: 18px;
        border: none;
        cursor: pointer;
        background: linear-gradient(135deg, #f5f6fa, #ffffff);
        box-shadow: 0 10px 30px rgba(47, 54, 64, 0.08);
        transition: none;
        padding: 20px;
        text-align: center;
        color: #2f3640;
    }

    .settings-tile:hover,
    .settings-tile:focus-visible {
        transform: translateY(-4px);
        box-shadow: 0 16px 38px rgba(0, 168, 255, 0.22);
        outline: none;
    }

    .settings-tile__icon {
        font-size: 1.8rem;
    }

    .settings-tile__label {
        font-weight: 600;
        font-size: 0.95rem;
    }

    .settings-tile--accent {
        background: linear-gradient(135deg, #1e90ff, #00a8ff);
        color: #ffffff;
        box-shadow: 0 16px 32px rgba(30, 144, 255, 0.25);
    }

    .modal {
        position: fixed;
        inset: 0;
        background-color: rgba(15, 23, 42, 0.45);
        display: none;
        align-items: center;
        justify-content: center;
        padding: 24px;
        z-index: 1600;
    }

    .modal.is-visible {
        display: flex;
    }

    .modal-dialog {
        background-color: #ffffff;
        border-radius: 14px;
        max-width: 760px;
        width: 100%;
        box-shadow: 0 20px 50px rgba(15, 23, 42, 0.2);
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }

    .modal-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        padding: 18px 24px;
        border-bottom: 1px solid #ecf0f1;
    }

    .modal-header h2 {
        margin: 0;
        font-size: 1.25rem;
        color: #273c75;
    }

    .modal-close {
        border: none;
        background: transparent;
        color: #7f8c8d;
        font-size: 1.6rem;
        line-height: 1;
        cursor: pointer;
        transition: none;
    }

    .modal-close:hover,
    .modal-close:focus-visible {
        color: #2f3640;
        outline: none;
    }

    .modal-flex {
        display: flex;
        flex-direction: column;
        gap: 0;
        max-height: 80vh;
        overflow-y: auto;
    }

    .modal-form {
        padding: 24px;
        display: flex;
        flex-direction: column;
        gap: 20px;
    }

    .modal-fieldset {
        border: 1px solid #ecf0f1;
        border-radius: 10px;
        padding: 16px 18px 20px;
        margin: 0;
    }

    .modal-fieldset + .modal-fieldset {
        margin-top: 10px;
    }

    .modal-fieldset legend {
        padding: 0 8px;
        font-weight: 600;
        color: #2f3640;
        font-size: 0.95rem;
    }

    .modal-form__grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 16px;
    }

    .modal-form__grid--split {
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    }

    .modal-field {
        display: flex;
        flex-direction: column;
        gap: 6px;
    }

    .modal-field__label,
    .toggle-field__label {
        font-size: 0.95rem;
        font-weight: 600;
        color: #2f3640;
    }

    .toggle-field {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .modal-actions {
        display: flex;
        justify-content: flex-end;
        gap: 12px;
    }

    .general-accordion {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .general-accordion__item {
        border: 1px solid #dfe4ea;
        border-radius: 10px;
        background: #ffffff;
        overflow: hidden;
    }

    .general-accordion__trigger {
        width: 100%;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        padding: 14px 16px;
        border: none;
        background: transparent;
        cursor: pointer;
        font-size: 1rem;
        font-weight: 600;
        color: #2f3640;
        transition: none;
    }

    .general-accordion__trigger:hover,
    .general-accordion__trigger:focus-visible {
        background-color: rgba(0, 123, 255, 0.08);
        outline: none;
    }

    .general-accordion__icon {
        transition: none;
    }

    .general-accordion__trigger[aria-expanded="true"] .general-accordion__icon {
        transform: rotate(90deg);
    }

    .general-accordion__panel {
        padding: 0 16px 16px;
        color: #57606f;
        font-size: 0.95rem;
    }

    .general-accordion__placeholder {
        margin: 0;
    }

    .site-logo-form {
        display: flex;
        flex-direction: column;
        gap: 20px;
    }

    .site-logo-form__grid {
        display: grid;
        grid-template-columns: minmax(220px, 260px) minmax(260px, 1fr);
        gap: 24px;
        align-items: start;
    }

    .site-logo-form__preview {
        border: 1px dashed #cfd6e0;
        border-radius: 12px;
        padding: 16px;
        background: #f8faff;
        display: flex;
        align-items: center;
        justify-content: center;
        min-height: 160px;
        position: relative;
    }

    .site-logo-form__image {
        max-width: 100%;
        max-height: 180px;
        object-fit: contain;
    }

    .site-logo-form__placeholder {
        color: #8391a6;
        font-size: 0.95rem;
        text-align: center;
    }

    .site-logo-form__remove-badge {
        position: absolute;
        bottom: 12px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(231, 76, 60, 0.16);
        color: #c0392b;
        padding: 6px 12px;
        border-radius: 999px;
        font-size: 0.85rem;
        font-weight: 600;
        pointer-events: none;
        box-shadow: 0 6px 18px rgba(192, 57, 43, 0.12);
    }

    .site-logo-form__fields {
        display: flex;
        flex-direction: column;
        gap: 16px;
    }

    .site-logo-form__field {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    .site-logo-form__label {
        font-weight: 600;
        color: #2f3640;
    }

    .site-logo-form__hint {
        margin: 0;
        font-size: 0.9rem;
        color: #6b7a90;
    }

    .site-logo-form__remove {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        font-size: 0.95rem;
        color: #2f3640;
        cursor: pointer;
        user-select: none;
    }

    .site-logo-form__remove input[type="checkbox"] {
        accent-color: #007bff;
    }

    .site-logo-form__actions {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        justify-content: flex-end;
    }

    .form-errors {
        padding: 10px 12px;
        border-radius: 8px;
        background: rgba(231, 76, 60, 0.12);
        color: #c0392b;
        font-size: 0.9rem;
    }

    @media (max-width: 768px) {
        .site-logo-form__grid {
            grid-template-columns: 1fr;
        }

        .site-logo-form__preview {
            min-height: 140px;
        }
    }

    .modal-description {
        margin: 0;
        font-size: 0.95rem;
        color: #57606f;
    }

    .modal-info-card {
        background: #f5f8ff;
        border: 1px solid rgba(30, 144, 255, 0.18);
        border-radius: 14px;
        padding: 18px 20px;
        display: flex;
        flex-direction: column;
        gap: 14px;
    }

    .modal-info-card__header h3 {
        margin: 0;
        font-size: 1.2rem;
        color: #1e90ff;
    }

    .modal-info-card__header p {
        margin: 4px 0 0;
        font-size: 0.9rem;
        color: #4a6072;
    }

    .modal-info-card__actions {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
    }

    .modal-info-card__action {
        display: inline-flex;
        align-items: center;
        gap: 8px;
    }

    #fiscal-xml-modal .modal-dialog {
        max-width: 700px;
    }

    #fiscal-xml-modal .modal-flex {
        padding: 24px 28px 32px;
    }

    #fiscal-xml-modal .fiscal-xml-card__list {
        max-height: 320px;
        overflow-y: auto;
    }

    .category-modal {
        display: flex;
        flex-direction: column;
        gap: 20px;
        padding: 24px;
    }

    .category-modal__toolbar {
        display: flex;
        flex-wrap: wrap;
        gap: 16px;
        align-items: center;
        justify-content: space-between;
    }

    .category-modal__search {
        display: inline-flex;
        align-items: center;
        gap: 10px;
        border: 1px solid #dfe4ea;
        border-radius: 10px;
        padding: 8px 12px;
        background: #f5f6fa;
        flex: 1 1 260px;
        max-width: 320px;
    }

    .category-modal__search input {
        border: none;
        background: transparent;
        width: 100%;
        font-size: 0.95rem;
        color: #2f3640;
    }

    .category-modal__search input:focus {
        outline: none;
    }

    .category-modal__table-wrapper {
        border: 1px solid #ecf0f1;
        border-radius: 14px;
        background: #ffffff;
        overflow: hidden;
        box-shadow: 0 8px 20px rgba(15, 23, 42, 0.08);
    }

    .category-modal__register {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        border-radius: 10px;
        padding: 10px 16px;
        font-weight: 600;
        box-shadow: 0 10px 24px rgba(30, 144, 255, 0.22);
    }

    .category-modal__register-icon {
        font-size: 1.1rem;
    }

    .category-modal__table {
        width: 100%;
        border-collapse: collapse;
        min-width: 360px;
    }

    .category-modal__table thead {
        background: #f1f6ff;
    }

    .category-modal__table th,
    .category-modal__table td {
        padding: 14px 16px;
        text-align: left;
        font-size: 0.95rem;
        color: #2f3640;
    }

    .category-modal__table tbody tr:nth-child(even) {
        background: #ffffff;
    }

    .category-modal__table tbody tr:nth-child(odd) {
        background: #fafcff;
    }

    .category-modal__table tbody tr:hover {
        background: rgba(30, 144, 255, 0.08);
    }

    .tax-actions {
        display: inline-flex;
        flex-wrap: wrap;
        gap: 10px;
        align-items: center;
    }

    .tax-actions__inline-group {
        display: inline-flex;
        gap: 10px;
        align-items: center;
    }

    .tax-actions--compact .btn-icon {
        gap: 6px;
        padding-left: 10px;
        padding-right: 12px;
    }

    .tax-actions--compact .btn-icon.btn-icon--sm {
        min-width: 0;
    }

    .category-modal__empty {
        margin: 0;
        padding: 18px;
        text-align: center;
        color: #95a5a6;
        font-size: 0.95rem;
    }

    .category-register__form {
        gap: 20px;
    }

    .category-register__grid {
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 18px;
    }

    .category-register__form input[type="text"] {
        border: 1px solid #dfe4ea;
        border-radius: 10px;
        padding: 10px 12px;
        font-size: 0.95rem;
        transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }

    .category-register__form input[type="text"]:focus {
        outline: none;
        border-color: #1e90ff;
        box-shadow: 0 0 0 3px rgba(30, 144, 255, 0.15);
    }

    .category-register__form input[readonly] {
        background: linear-gradient(135deg, #f5f8ff, #ffffff);
        font-weight: 600;
        color: #273c75;
    }

    .category-register__form .field-error {
        margin: 0;
    }

    .category-register__form .modal-actions {
        justify-content: flex-end;
        gap: 12px;
    }

    @media (max-width: 640px) {
        .category-register__form .modal-actions {
            flex-direction: column-reverse;
            align-items: stretch;
            gap: 10px;
        }

        .category-register__form .modal-actions .btn {
            width: 100%;
        }
    }

    .btn.btn-ghost {
        background: transparent;
        color: #2f3640;
        border: 1px solid #dfe4ea;
        transition: none;
    }

    .btn.btn-ghost:hover,
    .btn.btn-ghost:focus-visible {
        color: #1e90ff;
        border-color: #1e90ff;
        box-shadow: 0 0 0 3px rgba(30, 144, 255, 0.12);
    }

    .tax-modal {
        display: flex;
        flex-direction: column;
        gap: 20px;
        padding: 24px;
    }

    .tax-modal__toolbar {
        display: flex;
        flex-wrap: wrap;
        gap: 16px;
        align-items: center;
        justify-content: space-between;
    }

    .tax-modal__search {
        display: inline-flex;
        align-items: center;
        gap: 10px;
        border: 1px solid #dfe4ea;
        border-radius: 10px;
        padding: 8px 12px;
        background: #f5f6fa;
        flex: 1 1 260px;
        max-width: 320px;
    }

    .tax-modal__search input {
        border: none;
        background: transparent;
        width: 100%;
        font-size: 0.95rem;
        color: #2f3640;
    }

    .tax-modal__search input:focus {
        outline: none;
    }

    .tax-modal__table-wrapper {
        border: 1px solid #ecf0f1;
        border-radius: 14px;
        background: #ffffff;
        overflow: hidden;
        box-shadow: 0 8px 20px rgba(15, 23, 42, 0.08);
    }

    .tax-modal__table {
        width: 100%;
        border-collapse: collapse;
        min-width: 360px;
    }

    .tax-modal__table thead {
        background: #f6f9ff;
    }

    .tax-modal__table th,
    .tax-modal__table td {
        padding: 14px 16px;
        text-align: left;
        font-size: 0.95rem;
        color: #2f3640;
    }

    .tax-modal__table tbody tr:nth-child(even) {
        background: #ffffff;
    }

    .tax-modal__table tbody tr:nth-child(odd) {
        background: #fafcff;
    }

    .tax-modal__table tbody tr:hover {
        background: rgba(30, 144, 255, 0.08);
    }

    .tax-modal__empty {
        margin: 0;
        padding: 18px;
        text-align: center;
        color: #95a5a6;
        font-size: 0.95rem;
    }

    .tax-modal__register {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        border-radius: 10px;
        padding: 10px 16px;
        font-weight: 600;
        box-shadow: 0 10px 24px rgba(30, 144, 255, 0.22);
    }

    .tax-modal__register-icon {
        font-size: 1.1rem;
    }

    .tax-modal__table-wrapper::-webkit-scrollbar {
        width: 6px;
    }

    .tax-modal__table-wrapper::-webkit-scrollbar-thumb {
        background-color: rgba(47, 54, 64, 0.25);
        border-radius: 6px;
    }

    .tax-register__form {
        gap: 20px;
    }

    .tax-register__grid {
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 18px;
    }

    .tax-register__form input[type="text"],
    .tax-register__form input[type="number"] {
        border: 1px solid #dfe4ea;
        border-radius: 10px;
        padding: 10px 12px;
        font-size: 0.95rem;
        transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }

    .tax-register__form input[type="text"]:focus,
    .tax-register__form input[type="number"]:focus {
        outline: none;
        border-color: #1e90ff;
        box-shadow: 0 0 0 3px rgba(30, 144, 255, 0.15);
    }

    .tax-register__form input[readonly] {
        background: linear-gradient(135deg, #f5f8ff, #ffffff);
        font-weight: 600;
        color: #273c75;
    }

    .tax-register__form .modal-actions {
        justify-content: flex-end;
        gap: 12px;
    }

    .tax-register__form .field-error {
        margin: 0;
    }

    .product-type-modal {
        display: flex;
        flex-direction: column;
        gap: 20px;
        padding: 24px;
    }

    .product-type-modal__toolbar {
        display: flex;
        flex-wrap: wrap;
        gap: 16px;
        align-items: center;
        justify-content: space-between;
    }

    .product-type-modal__search {
        display: inline-flex;
        align-items: center;
        gap: 10px;
        border: 1px solid #dfe4ea;
        border-radius: 10px;
        padding: 8px 12px;
        background: #f5f6fa;
        flex: 1 1 260px;
        max-width: 320px;
    }

    .product-type-modal__search input {
        border: none;
        background: transparent;
        width: 100%;
        font-size: 0.95rem;
        color: #2f3640;
    }

    .product-type-modal__search input:focus {
        outline: none;
    }

    .product-type-modal__table-wrapper {
        border: 1px solid #ecf0f1;
        border-radius: 14px;
        background: #ffffff;
        overflow: hidden;
        box-shadow: 0 8px 20px rgba(15, 23, 42, 0.08);
    }

    .product-type-modal__table {
        width: 100%;
        border-collapse: collapse;
        min-width: 360px;
    }

    .product-type-modal__table thead {
        background: #f6f9ff;
    }

    .product-type-modal__table th,
    .product-type-modal__table td {
        padding: 14px 16px;
        text-align: left;
        font-size: 0.95rem;
        color: #2f3640;
    }

    .product-type-modal__table tbody tr:nth-child(even) {
        background: #ffffff;
    }

    .product-type-modal__table tbody tr:nth-child(odd) {
        background: #fafcff;
    }

    .product-type-modal__table tbody tr:hover {
        background: rgba(30, 144, 255, 0.08);
    }

    .product-type-modal__empty {
        margin: 0;
        padding: 18px;
        text-align: center;
        color: #95a5a6;
        font-size: 0.95rem;
    }

    .product-type-modal__register {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        border-radius: 10px;
        padding: 10px 16px;
        font-weight: 600;
        box-shadow: 0 10px 24px rgba(30, 144, 255, 0.22);
    }

    .product-type-modal__register-icon {
        font-size: 1.1rem;
    }

    .product-type-modal__actions {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
    }

    .product-type-modal__table-wrapper::-webkit-scrollbar {
        width: 6px;
    }

    .product-type-modal__table-wrapper::-webkit-scrollbar-thumb {
        background-color: rgba(47, 54, 64, 0.25);
        border-radius: 6px;
    }

    .product-type-register__form .field-error {
        margin: 0;
    }

    .product-type-edit__form .field-error {
        margin: 0;
    }

    @media (max-width: 640px) {
        .tax-modal__toolbar {
            flex-direction: column;
            align-items: stretch;
        }

        .tax-modal__search {
            max-width: none;
        }

        .tax-modal__table {
            min-width: 280px;
        }

        .tax-modal__register {
            justify-content: center;
            width: 100%;
        }

        .product-type-modal__toolbar {
            flex-direction: column;
            align-items: stretch;
        }

        .product-type-modal__search {
            max-width: none;
        }

        .product-type-modal__table {
            min-width: 280px;
        }

        .product-type-modal__register {
            justify-content: center;
            width: 100%;
        }

        .product-type-modal__actions {
            flex-direction: column;
            align-items: stretch;
        }

        .tax-register__form .modal-actions {
            flex-direction: column-reverse;
            align-items: stretch;
            gap: 10px;
        }

        .tax-register__form .modal-actions .btn {
            width: 100%;
        }

        .product-type-register__form .modal-actions {
            flex-direction: column-reverse;
            align-items: stretch;
            gap: 10px;
        }

        .product-type-register__form .modal-actions .btn {
            width: 100%;
        }

        .product-type-edit__form .modal-actions {
            flex-direction: column-reverse;
            align-items: stretch;
            gap: 10px;
        }

        .product-type-edit__form .modal-actions .btn {
            width: 100%;
        }
    }

    @media (max-width: 640px) {
        .category-modal__toolbar {
            flex-direction: column;
            align-items: stretch;
        }

        .category-modal__search {
            max-width: none;
        }

        .category-modal__table {
            min-width: 280px;
        }

        .category-modal__register {
            justify-content: center;
            width: 100%;
        }
    }

    .fiscal-xml-card {
        display: flex;
        flex-direction: column;
        gap: 20px;
    }

    .fiscal-xml-card__header {
        display: flex;
        align-items: flex-start;
        justify-content: space-between;
        gap: 12px;
    }

    .fiscal-xml-card__header h3 {
        margin: 0;
        font-size: 1.35rem;
        color: #273c75;
    }

    .fiscal-xml-card__header p {
        margin: 6px 0 0;
        color: #636e72;
        font-size: 0.95rem;
    }

    .fiscal-xml-card__close {
        border: none;
        background: transparent;
        color: #718093;
        font-size: 1.6rem;
        line-height: 1;
        cursor: pointer;
        padding: 4px;
        border-radius: 6px;
        transition: background-color 0.2s ease, color 0.2s ease;
    }

    .fiscal-xml-card__close:hover,
    .fiscal-xml-card__close:focus-visible {
        background-color: rgba(113, 128, 147, 0.1);
        color: #2f3640;
        outline: none;
    }

    .fiscal-xml-card__form {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .fiscal-xml-card__form-grid {
        display: grid;
        gap: 16px;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    }

    .fiscal-xml-card__field {
        display: flex;
        flex-direction: column;
        gap: 6px;
    }

    .fiscal-xml-card__label {
        font-weight: 600;
        color: #2f3640;
        font-size: 0.95rem;
    }

    .fiscal-xml-card__actions {
        display: flex;
        justify-content: flex-end;
    }

    .fiscal-xml-card__list {
        border-top: 1px solid #ecf0f1;
        padding-top: 20px;
    }

    .fiscal-xml-list {
        list-style: none;
        margin: 0;
        padding: 0;
        display: flex;
        flex-direction: column;
        gap: 16px;
    }

    .fiscal-xml-item {
        border: 1px solid #dfe4ea;
        border-radius: 12px;
        padding: 16px;
        display: flex;
        flex-direction: column;
        gap: 8px;
        background: #fafbff;
    }

    .fiscal-xml-item__main {
        display: flex;
        justify-content: space-between;
        gap: 16px;
        flex-wrap: wrap;
        align-items: center;
    }

    .fiscal-xml-item__name {
        font-size: 1.05rem;
        color: #2f3640;
    }

    .fiscal-xml-item__meta {
        margin: 4px 0;
        color: #8391a6;
        font-size: 0.9rem;
    }

    .fiscal-xml-item__link {
        font-size: 0.9rem;
        color: #0097e6;
        text-decoration: none;
    }

    .fiscal-xml-item__link:hover {
        text-decoration: underline;
    }

    .fiscal-xml-item__status {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .fiscal-xml-item__message {
        margin: 0;
        font-size: 0.9rem;
        color: #57606f;
    }

    .fiscal-xml-empty {
        border: 1px dashed #dfe4ea;
        border-radius: 12px;
        padding: 24px;
        text-align: center;
        color: #95a5a6;
    }

    .connection-badge {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 4px 10px;
        border-radius: 999px;
        font-weight: 600;
        font-size: 0.85rem;
    }

    .connection-badge--sin_conexion {
        background: rgba(231, 76, 60, 0.15);
        color: #e74c3c;
    }

    .connection-badge--buscando {
        background: rgba(241, 196, 15, 0.2);
        color: #f39c12;
    }

    .connection-badge--conectado {
        background: rgba(46, 213, 115, 0.18);
        color: #2ecc71;
    }

    .fiscal-xml-overlay {
        position: fixed;
        inset: 0;
        background: rgba(23, 32, 42, 0.45);
        z-index: 1400;
        display: none;
    }

    .fiscal-xml-overlay.is-active {
        display: block;
    }

    @media (max-width: 768px) {
        .settings-grid__items {
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
        }
    }
</style>


<script>
        (function () {
            var openButtons = document.querySelectorAll('[data-open-fiscal-xml-card]');
            var modal = document.getElementById('fiscal-xml-modal');
            var overlay = document.querySelector('[data-fiscal-xml-overlay]');
            if (!modal || !overlay || !openButtons.length) {
                return;
            }

            var closeButton = modal.querySelector('[data-close-fiscal-xml-modal]');
            var firstFocusable = modal.querySelector('input, select, textarea, button, [tabindex]:not([tabindex="-1"])');
            var lastTrigger = null;

            function openModalXml(trigger) {
                lastTrigger = trigger || null;
                modal.setAttribute('aria-hidden', 'false');
                modal.classList.add('is-visible');
                overlay.hidden = false;
                overlay.classList.add('is-active');
                if (firstFocusable && typeof firstFocusable.focus === 'function') {
                    firstFocusable.focus();
                }
            }

            function closeModalXml() {
                modal.setAttribute('aria-hidden', 'true');
                modal.classList.remove('is-visible');
                overlay.classList.remove('is-active');
                overlay.hidden = true;
                if (modal.contains(document.activeElement)) {
                    document.activeElement.blur();
                }
                if (lastTrigger && typeof lastTrigger.focus === 'function') {
                    lastTrigger.focus();
                }
            }

            openButtons.forEach(function (button) {
                button.addEventListener('click', function () {
                    openModalXml(button);
                });
            });

            if (closeButton) {
                closeButton.addEventListener('click', function () {
                    closeModalXml();
                });
            }

            overlay.addEventListener('click', function () {
                closeModalXml();
            });

            window.addEventListener('keyup', function (event) {
                if (event.key === 'Escape' && modal.classList.contains('is-visible')) {
                    closeModalXml();
                }
            });
        })();

        (function () {
            var confirmForms = document.querySelectorAll('form[data-confirm]');
            confirmForms.forEach(function (form) {
                form.addEventListener('submit', function (event) {
                    var message = form.getAttribute('data-confirm');
                    if (message && !window.confirm(message)) {
                        event.preventDefault();
                    }
                });
            });
        })();

        (function () {
            var generalModal = document.getElementById('general-settings-modal');
            if (!generalModal) {
                return;
            }

            var generalOverlay = document.querySelector('[data-fiscal-xml-overlay]');
            var generalTriggers = document.querySelectorAll('[data-open-modal="general-settings"]');
            var closeButtons = generalModal.querySelectorAll('[data-close-general-settings]');
            var lastTrigger = null;
            var accordion = generalModal.querySelector('[data-general-accordion]');

            function openGeneralModal() {
                generalModal.setAttribute('aria-hidden', 'false');
                generalModal.classList.add('is-visible');
                if (generalOverlay) {
                    generalOverlay.hidden = false;
                    generalOverlay.classList.add('is-active');
                }
            }

            function closeGeneralModal() {
                generalModal.setAttribute('aria-hidden', 'true');
                generalModal.classList.remove('is-visible');
                if (generalOverlay) {
                    generalOverlay.classList.remove('is-active');
                    generalOverlay.hidden = true;
                }
                if (lastTrigger && typeof lastTrigger.focus === 'function') {
                    lastTrigger.focus();
                }
            }

            generalTriggers.forEach(function (trigger) {
                trigger.addEventListener('click', function () {
                    lastTrigger = trigger;
                    openGeneralModal();
                });
            });

            closeButtons.forEach(function (button) {
                button.addEventListener('click', function () {
                    closeGeneralModal();
                });
            });

            document.addEventListener('keydown', function (event) {
                if (event.key === 'Escape' && generalModal.classList.contains('is-visible')) {
                    closeGeneralModal();
                }
            });

            if (generalOverlay) {
                generalOverlay.addEventListener('click', function () {
                    if (generalModal.classList.contains('is-visible')) {
                        closeGeneralModal();
                    }
                });
            }

            if (accordion) {
                var accordionItems = accordion.querySelectorAll('.general-accordion__item');

                accordionItems.forEach(function (item) {
                    var trigger = item.querySelector('.general-accordion__trigger');
                    var panel = item.querySelector('.general-accordion__panel');
                    if (!trigger || !panel) {
                        return;
                    }

                    trigger.addEventListener('click', function () {
                        var isOpen = trigger.getAttribute('aria-expanded') === 'true';
                        trigger.setAttribute('aria-expanded', String(!isOpen));
                        panel.hidden = isOpen;
                    });
                });
            }

            var siteLogoForm = generalModal.querySelector('[data-site-logo-form]');
            if (siteLogoForm) {
                var fileInput = siteLogoForm.querySelector('[data-site-logo-input="true"]');
                var previewImage = siteLogoForm.querySelector('[data-site-logo-preview]');
                var placeholder = siteLogoForm.querySelector('[data-site-logo-placeholder]');
                var removeCheckbox = siteLogoForm.querySelector('input[name="remove_logo"]');
                var removeBadge = siteLogoForm.querySelector('[data-site-logo-remove-badge]');
                var resetButton = siteLogoForm.querySelector('[data-site-logo-reset]');
                var initialLogoUrl = siteLogoForm.getAttribute('data-initial-logo') || '';
                var defaultPreviewUrl = previewImage && !previewImage.hidden ? previewImage.getAttribute('src') : '';
                var uploadedPreviewUrl = null;

                function setPreview(url) {
                    if (!previewImage) {
                        return;
                    }

                    if (url) {
                        previewImage.src = url;
                        previewImage.hidden = false;
                        if (placeholder) {
                            placeholder.hidden = true;
                        }
                    } else {
                        previewImage.src = '';
                        previewImage.hidden = true;
                        if (placeholder) {
                            placeholder.hidden = false;
                        }
                    }
                }

                function toggleRemoveBadge(visible) {
                    if (!removeBadge) {
                        return;
                    }
                    removeBadge.hidden = !visible;
                }

                function resetToCurrentLogo() {
                    uploadedPreviewUrl = null;
                    if (fileInput) {
                        fileInput.value = '';
                    }
                    if (removeCheckbox) {
                        removeCheckbox.checked = false;
                    }
                    toggleRemoveBadge(false);
                    setPreview(initialLogoUrl || defaultPreviewUrl);
                }

                function handleFileSelection(file) {
                    if (!file) {
                        uploadedPreviewUrl = null;
                        setPreview(initialLogoUrl || defaultPreviewUrl);
                        return;
                    }

                    if (typeof FileReader === 'undefined') {
                        return;
                    }

                    var reader = new FileReader();
                    reader.onload = function (event) {
                        uploadedPreviewUrl = event && event.target ? event.target.result : null;
                        if (uploadedPreviewUrl) {
                            setPreview(uploadedPreviewUrl);
                            toggleRemoveBadge(false);
                            if (removeCheckbox) {
                                removeCheckbox.checked = false;
                            }
                        }
                    };
                    reader.readAsDataURL(file);
                }

                if (fileInput) {
                    fileInput.addEventListener('change', function () {
                        var file = fileInput.files && fileInput.files.length ? fileInput.files[0] : null;
                        handleFileSelection(file);
                    });
                }

                if (removeCheckbox) {
                    removeCheckbox.addEventListener('change', function () {
                        var shouldRemove = removeCheckbox.checked;
                        if (shouldRemove) {
                            if (fileInput) {
                                fileInput.value = '';
                            }
                            uploadedPreviewUrl = null;
                            toggleRemoveBadge(true);
                            setPreview(initialLogoUrl || defaultPreviewUrl);
                        } else {
                            toggleRemoveBadge(false);
                            if (uploadedPreviewUrl) {
                                setPreview(uploadedPreviewUrl);
                            } else {
                                setPreview(initialLogoUrl || defaultPreviewUrl);
                            }
                        }
                    });
                }

                siteLogoForm.addEventListener('reset', function (event) {
                    event.preventDefault();
                    resetToCurrentLogo();
                });

                if (resetButton) {
                    resetButton.addEventListener('click', function (event) {
                        event.preventDefault();
                        resetToCurrentLogo();
                    });
                }
            }
        })();

        (function () {
            var taxModal = document.getElementById('tax-modal');
            var registerModal = document.getElementById('tax-register-modal');
            var editModal = document.getElementById('tax-edit-modal');
            if (!taxModal || !registerModal) {
                return;
            }

            var registerButton = taxModal.querySelector('[data-tax-register]');
            if (!registerButton) {
                return;
            }

            var closeButtons = registerModal.querySelectorAll('[data-close-tax-register]');
            var form = registerModal.querySelector('[data-tax-register-form]');
            var focusField = registerModal.querySelector('[data-initial-focus="true"]') || registerModal.querySelector('input:not([type="hidden"])');

            function openRegisterModal() {
                registerModal.setAttribute('aria-hidden', 'false');
                registerModal.classList.add('is-visible');
                if (focusField && typeof focusField.focus === 'function') {
                    focusField.focus();
                }
            }

            function closeRegisterModal() {
                registerModal.setAttribute('aria-hidden', 'true');
                registerModal.classList.remove('is-visible');
                if (registerModal.contains(document.activeElement)) {
                    document.activeElement.blur();
                }
                if (typeof registerButton.focus === 'function') {
                    registerButton.focus();
                }
            }

            registerButton.addEventListener('click', function (event) {
                event.preventDefault();
                openRegisterModal();
            });

            if (form) {
                form.addEventListener('submit', function () {
                    closeRegisterModal();
                    taxModal.dispatchEvent(new CustomEvent('tax:refresh'));
                });
            }

            if (registerModal.hasAttribute('data-force-open')) {
                openRegisterModal();
            }
        })();

        (function () {
            var categoryModal = document.getElementById('category-modal');
            var editModal = document.getElementById('category-edit-modal');
            if (!categoryModal || !editModal) {
                return;
            }

            var editForm = editModal.querySelector('[data-category-edit-form]');
            var editIdInput = editModal.querySelector('[data-category-edit-id]');
            var editNameInput = editModal.querySelector('[data-category-edit-name]');
            var statusBadge = editModal.querySelector('[data-category-edit-status]');
            var closeButtons = editModal.querySelectorAll('[data-close-category-edit]');
            var categoryModalWasVisible = false;

            function setStatusBadge(state) {
                if (!statusBadge) {
                    return;
                }
                var normalized = state === 'true';
                statusBadge.dataset.state = normalized ? 'active' : 'inactive';
                statusBadge.textContent = normalized ? 'Activa' : 'Inactiva';
                statusBadge.classList.toggle('status-badge', true);
                statusBadge.classList.toggle('status-badge--active', normalized);
                statusBadge.classList.toggle('status-badge--inactive', !normalized);
            }

            function openEditModal(config) {
                if (!config) {
                    return;
                }
                categoryModalWasVisible = categoryModal.classList.contains('is-visible');
                if (categoryModalWasVisible) {
                    categoryModal.classList.remove('is-visible');
                    categoryModal.setAttribute('aria-hidden', 'true');
                }
                if (editIdInput) {
                    editIdInput.value = config.id || '';
                }
                if (editNameInput) {
                    editNameInput.value = config.name || '';
                    editNameInput.focus();
                }
                var typeSelect = editModal.querySelector('[data-category-edit-type]');
                if (typeSelect) {
                    typeSelect.value = config.type || '';
                }
                setStatusBadge(config.active || 'false');
                editModal.setAttribute('aria-hidden', 'false');
                editModal.classList.add('is-visible');
            }

            function closeEditModal() {
                editModal.setAttribute('aria-hidden', 'true');
                editModal.classList.remove('is-visible');
                if (editModal.contains(document.activeElement)) {
                    document.activeElement.blur();
                }
                if (categoryModalWasVisible) {
                    categoryModal.setAttribute('aria-hidden', 'false');
                    categoryModal.classList.add('is-visible');
                }
            }

            categoryModal.addEventListener('click', function (event) {
                var button = event.target.closest('[data-category-edit]');
                if (!button) {
                    return;
                }
                event.preventDefault();
                var config = {
                    id: button.getAttribute('data-id'),
                    name: button.getAttribute('data-name'),
                    active: button.getAttribute('data-active'),
                    type: button.getAttribute('data-type') || '',
                };
                openEditModal(config);
            });

            closeButtons.forEach(function (button) {
                button.addEventListener('click', function () {
                    closeEditModal();
                });
            });

            editModal.addEventListener('click', function (event) {
                if (event.target === editModal) {
                    closeEditModal();
                }
            });

            document.addEventListener('keydown', function (event) {
                if (event.key === 'Escape' && editModal.classList.contains('is-visible')) {
                    closeEditModal();
                }
            });

            if (editForm) {
                editForm.addEventListener('submit', function () {
                    closeEditModal();
                });
            }
        })();

        (function () {
            function initResourceModal(options) {
                var trigger = document.querySelector(options.triggerSelector);
                var modal = document.getElementById(options.modalId);
                if (!trigger || !modal) {
                    return;
                }

                var closeButton = modal.querySelector(options.closeSelector);

                function openModal() {
                    modal.setAttribute('aria-hidden', 'false');
                    modal.classList.add('is-visible');
                }

                function closeModal() {
                    modal.setAttribute('aria-hidden', 'true');
                    modal.classList.remove('is-visible');
                }

                trigger.addEventListener('click', openModal);
                if (closeButton) {
                    closeButton.addEventListener('click', closeModal);
                }
                modal.addEventListener('click', function (event) {
                    if (event.target === modal) {
                        closeModal();
                    }
                });
                document.addEventListener('keydown', function (event) {
                    if (event.key === 'Escape' && modal.classList.contains('is-visible')) {
                        closeModal();
                    }
                });

                var searchInput = options.searchSelector ? modal.querySelector(options.searchSelector) : null;
                var emptyState = options.emptySelector ? modal.querySelector(options.emptySelector) : null;

                function applyFilter(term) {
                    if (!options.rowSelector) {
                        return;
                    }
                    var rows = modal.querySelectorAll(options.rowSelector);
                    var normalized = (term || '').toLowerCase().trim();
                    var visible = 0;
                    rows.forEach(function (row) {
                        var name = row.getAttribute(options.nameAttribute || 'data-name') || '';
                        var matches = !normalized || name.indexOf(normalized) !== -1;
                        row.style.display = matches ? '' : 'none';
                        if (matches) {
                            visible += 1;
                        }
                    });
                    if (emptyState) {
                        emptyState.hidden = rows.length === 0 ? false : visible > 0;
                    }
                }

                if (searchInput) {
                    searchInput.addEventListener('input', function (event) {
                        applyFilter(event.target.value);
                    });
                    applyFilter(searchInput.value || '');
                }

                if (options.refreshEvent) {
                    modal.addEventListener(options.refreshEvent, function () {
                        var term = searchInput ? searchInput.value : '';
                        applyFilter(term);
                    });
                }

                if (modal.hasAttribute('data-force-open')) {
                    openModal();
                }
            }

            initResourceModal({
                triggerSelector: '[data-open-resource="category"]',
                modalId: 'category-modal',
                closeSelector: '[data-close-category-modal]',
                searchSelector: '[data-category-search]',
                rowSelector: '[data-category-row]',
                nameAttribute: 'data-name',
                emptySelector: '[data-category-empty]',
                refreshEvent: 'category:refresh'
            });

            initResourceModal({
                triggerSelector: '[data-open-resource="tax"]',
                modalId: 'tax-modal',
                closeSelector: '[data-close-tax-modal]',
                searchSelector: '[data-tax-search]',
                rowSelector: '[data-tax-row]',
                nameAttribute: 'data-name',
                emptySelector: '[data-tax-empty]',
                refreshEvent: 'tax:refresh'
            });

            // Product Type Modal functionality
            (function () {
                var productTypeModal = document.getElementById('product-type-modal');
                var registerModal = document.getElementById('product-type-register-modal');
                var editModal = document.getElementById('product-type-edit-modal');
                
                if (!productTypeModal || !registerModal) {
                    return;
                }

                // Open product type modal from category forms
                document.querySelectorAll('[data-open-product-type-register]').forEach(function(button) {
                    button.addEventListener('click', function() {
                        openProductTypeModal();
                    });
                });

                function openProductTypeModal() {
                    productTypeModal.setAttribute('aria-hidden', 'false');
                    productTypeModal.classList.add('is-visible');
                }

                function closeProductTypeModal() {
                    productTypeModal.setAttribute('aria-hidden', 'true');
                    productTypeModal.classList.remove('is-visible');
                    if (productTypeModal.contains(document.activeElement)) {
                        document.activeElement.blur();
                    }
                }

                // Close modal handlers
                var closeButtons = productTypeModal.querySelectorAll('[data-close-product-type-modal]');
                closeButtons.forEach(function(button) {
                    button.addEventListener('click', closeProductTypeModal);
                });

                // Click outside to close
                productTypeModal.addEventListener('click', function(event) {
                    if (event.target === productTypeModal) {
                        closeProductTypeModal();
                    }
                });

                // Escape key to close
                document.addEventListener('keydown', function(event) {
                    if (event.key === 'Escape' && productTypeModal.classList.contains('is-visible')) {
                        closeProductTypeModal();
                    }
                });

                // Search functionality
                var searchInput = productTypeModal.querySelector('[data-product-type-search]');
                var emptyState = productTypeModal.querySelector('[data-product-type-empty]');

                function applyFilter(term) {
                    var rows = productTypeModal.querySelectorAll('[data-product-type-row]');
                    var normalized = (term || '').toLowerCase().trim();
                    var visible = 0;
                    
                    rows.forEach(function(row) {
                        var name = row.getAttribute('data-name') || '';
                        var matches = !normalized || name.indexOf(normalized) !== -1;
                        row.style.display = matches ? '' : 'none';
                        if (matches) {
                            visible += 1;
                        }
                    });
                    
                    if (emptyState) {
                        emptyState.hidden = rows.length === 0 ? false : visible > 0;
                    }
                }

                if (searchInput) {
                    searchInput.addEventListener('input', function(event) {
                        applyFilter(event.target.value);
                    });
                    applyFilter(searchInput.value || '');
                }

                // Register modal functionality
                var registerForm = registerModal.querySelector('[data-product-type-register-form]');
                if (registerForm) {
                    registerForm.addEventListener('submit', function(event) {
                        event.preventDefault();
                        
                        var formData = new FormData(registerForm);
                        var submitButton = registerForm.querySelector('button[type="submit"]');
                        var originalText = submitButton.textContent;
                        
                        submitButton.disabled = true;
                        submitButton.textContent = 'Guardando...';
                        
                        fetch('/app/inventario/tipo-producto/crear/', {
                            method: 'POST',
                            body: formData
                        })
                        .then(function(response) {
                            return response.json();
                        })
                        .then(function(data) {
                            if (data.success) {
                                // Close modals
                                closeRegisterModal();
                                closeProductTypeModal();
                                
                                // Refresh the page to show new product type
                                window.location.reload();
                            } else {
                                alert(data.error || 'No se pudo crear el tipo de producto.');
                            }
                        })
                        .catch(function(error) {
                            console.error('Error:', error);
                            alert('Ocurri√≥ un error al crear el tipo de producto.');
                        })
                        .finally(function() {
                            submitButton.disabled = false;
                            submitButton.textContent = originalText;
                        });
                    });
                }

                function openRegisterModal() {
                    registerModal.setAttribute('aria-hidden', 'false');
                    registerModal.classList.add('is-visible');
                    var nameInput = registerModal.querySelector('[data-product-type-register-name]');
                    if (nameInput) {
                        nameInput.focus();
                    }
                }

                function closeRegisterModal() {
                    registerModal.setAttribute('aria-hidden', 'true');
                    registerModal.classList.remove('is-visible');
                    registerForm.reset();
                }

                // Register button handlers
                var registerButton = productTypeModal.querySelector('[data-product-type-register]');
                if (registerButton) {
                    registerButton.addEventListener('click', openRegisterModal);
                }

                var closeRegisterButtons = registerModal.querySelectorAll('[data-close-product-type-register]');
                closeRegisterButtons.forEach(function(button) {
                    button.addEventListener('click', closeRegisterModal);
                });

                // Edit modal functionality
                var editForm = editModal.querySelector('[data-product-type-edit-form]');
                if (editForm) {
                    editForm.addEventListener('submit', function(event) {
                        event.preventDefault();
                        
                        var formData = new FormData(editForm);
                        var id = formData.get('id');
                        var submitButton = editForm.querySelector('button[type="submit"]');
                        var originalText = submitButton.textContent;
                        
                        submitButton.disabled = true;
                        submitButton.textContent = 'Actualizando...';
                        
                        fetch('/app/inventario/tipo-producto/' + id + '/edit/', {
                            method: 'POST',
                            body: formData
                        })
                        .then(function(response) {
                            return response.json();
                        })
                        .then(function(data) {
                            if (data.success) {
                                closeEditModal();
                                closeProductTypeModal();
                                window.location.reload();
                            } else {
                                alert(data.error || 'No se pudo actualizar el tipo de producto.');
                            }
                        })
                        .catch(function(error) {
                            console.error('Error:', error);
                            alert('Ocurri√≥ un error al actualizar el tipo de producto.');
                        })
                        .finally(function() {
                            submitButton.disabled = false;
                            submitButton.textContent = originalText;
                        });
                    });
                }

                function openEditModal(config) {
                    if (!config) return;
                    
                    var idInput = editModal.querySelector('[data-product-type-edit-id]');
                    var nameInput = editModal.querySelector('[data-product-type-edit-name]');
                    var iconoSelect = editModal.querySelector('[data-product-type-edit-icono]');
                    var descripcionInput = editModal.querySelector('[data-product-type-edit-descripcion]');
                    
                    if (idInput) idInput.value = config.id || '';
                    if (nameInput) {
                        nameInput.value = config.nombre || '';
                        nameInput.focus();
                    }
                    if (iconoSelect) iconoSelect.value = config.icono || 'custom';
                    if (descripcionInput) descripcionInput.value = config.descripcion || '';
                    
                    editModal.setAttribute('aria-hidden', 'false');
                    editModal.classList.add('is-visible');
                }

                function closeEditModal() {
                    editModal.setAttribute('aria-hidden', 'true');
                    editModal.classList.remove('is-visible');
                    editForm.reset();
                }

                // Edit button handlers
                productTypeModal.addEventListener('click', function(event) {
                    var button = event.target.closest('[data-product-type-edit]');
                    if (!button) return;
                    
                    var config = {
                        id: button.getAttribute('data-id'),
                        nombre: button.getAttribute('data-nombre'),
                        icono: button.getAttribute('data-icono'),
                        descripcion: button.getAttribute('data-descripcion')
                    };
                    openEditModal(config);
                });

                var closeEditButtons = editModal.querySelectorAll('[data-close-product-type-edit]');
                closeEditButtons.forEach(function(button) {
                    button.addEventListener('click', closeEditModal);
                });

                // Toggle status functionality
                productTypeModal.addEventListener('click', function(event) {
                    var button = event.target.closest('[data-product-type-toggle]');
                    if (!button) return;
                    
                    var id = button.getAttribute('data-id');
                    var isActive = button.getAttribute('data-active') === 'true';
                    
                    if (confirm('¬øEst√°s seguro de ' + (isActive ? 'desactivar' : 'activar') + ' este tipo de producto?')) {
                        fetch('/app/inventario/tipo-producto/' + id + '/toggle/', {
                            method: 'POST',
                            headers: {
                                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                            }
                        })
                        .then(function(response) {
                            return response.json();
                        })
                        .then(function(data) {
                            if (data.success) {
                                window.location.reload();
                            } else {
                                alert(data.error || 'No se pudo cambiar el estado.');
                            }
                        })
                        .catch(function(error) {
                            console.error('Error:', error);
                            alert('Ocurri√≥ un error al cambiar el estado.');
                        });
                    }
                });

                // Click outside to close for register and edit modals
                [registerModal, editModal].forEach(function(modal) {
                    modal.addEventListener('click', function(event) {
                        if (event.target === modal) {
                            if (modal === registerModal) closeRegisterModal();
                            if (modal === editModal) closeEditModal();
                        }
                    });
                });

                // Escape key for register and edit modals
                document.addEventListener('keydown', function(event) {
                    if (event.key === 'Escape') {
                        if (registerModal.classList.contains('is-visible')) closeRegisterModal();
                        if (editModal.classList.contains('is-visible')) closeEditModal();
                    }
                });
            })();
        })();

        (function () {
            var categoryModal = document.getElementById('category-modal');
            var registerModal = document.getElementById('category-register-modal');
            if (!categoryModal || !registerModal) {
                return;
            }

            var registerButton = categoryModal.querySelector('[data-category-register]');
            if (!registerButton) {
                return;
            }

            var closeButtons = registerModal.querySelectorAll('[data-close-category-register]');
            var form = registerModal.querySelector('[data-category-register-form]');
            var focusField = registerModal.querySelector('[data-initial-focus="true"]') || registerModal.querySelector('input:not([type="hidden"])');

            function openRegisterModal() {
                registerModal.setAttribute('aria-hidden', 'false');
                registerModal.classList.add('is-visible');
                if (focusField && typeof focusField.focus === 'function') {
                    focusField.focus();
                }
            }

            function closeRegisterModal() {
                registerModal.setAttribute('aria-hidden', 'true');
                registerModal.classList.remove('is-visible');
                if (registerModal.contains(document.activeElement)) {
                    document.activeElement.blur();
                }
                if (typeof registerButton.focus === 'function') {
                    registerButton.focus();
                }
            }

            registerButton.addEventListener('click', function (event) {
                event.preventDefault();
                openRegisterModal();
            });

            closeButtons.forEach(function (button) {
                button.addEventListener('click', function () {
                    closeRegisterModal();
                });
            });

            document.addEventListener('keydown', function (event) {
                if (event.key === 'Escape' && registerModal.classList.contains('is-visible')) {
                    event.preventDefault();
                    event.stopImmediatePropagation();
                    closeRegisterModal();
                }
            }, true);

            if (form) {
                form.addEventListener('submit', function () {
                    closeRegisterModal();
                });
            }

            var shouldOpenCategory = categoryModal && categoryModal.hasAttribute('data-force-open');
            var shouldOpenRegister = registerModal && registerModal.hasAttribute('data-force-open');

            if (shouldOpenCategory) {
                categoryModal.setAttribute('aria-hidden', 'false');
                categoryModal.classList.add('is-visible');
            }

            if (shouldOpenRegister) {
                openRegisterModal();
            }
        })();

        (function () {
            var trigger = document.querySelector('[data-settings-action="comprobante-fiscal"]');
            var modal = document.getElementById('fiscal-voucher-modal');
            if (!trigger || !modal) {
                return;
            }

            var closeButtons = modal.querySelectorAll('[data-close-fiscal-modal]');
            var form = modal.querySelector('[data-fiscal-config-form]');

            function openModal() {
                modal.setAttribute('aria-hidden', 'false');
                modal.classList.add('is-visible');
                var focusTarget = modal.querySelector('[data-initial-focus="true"]') || modal.querySelector('[data-close-fiscal-modal]');
                if (focusTarget) {
                    focusTarget.focus();
                }
            }

            function closeModal() {
                modal.setAttribute('aria-hidden', 'true');
                modal.classList.remove('is-visible');
                if (modal.contains(document.activeElement)) {
                    document.activeElement.blur();
                }
                trigger.focus();
            }

            trigger.addEventListener('click', function () {
                openModal();
            });

            closeButtons.forEach(function (button) {
                button.addEventListener('click', function () {
                    closeModal();
                });
            });

            modal.addEventListener('click', function (event) {
                if (event.target === modal) {
                    closeModal();
                }
            });

            document.addEventListener('keydown', function (event) {
                if (event.key === 'Escape' && modal.classList.contains('is-visible')) {
                    closeModal();
                }
            });

            if (form) {
                form.addEventListener('submit', function (event) {
                    event.preventDefault();

                    var formData = new FormData(form);
                    fetch(form.action, {
                        method: 'POST',
                        body: formData,
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest'
                        },
                    })
                        .then(function (response) {
                            if (response.ok) {
                                return response.json();
                            }
                            throw response;
                        })
                        .then(function (data) {
                            if (data && data.success) {
                                alert('Configuraci√≥n guardada correctamente.');
                                closeModal();
                            } else if (data && data.errors) {
                                alert('Debes completar los datos requeridos antes de guardar.');
                            } else {
                                alert('No fue posible guardar la configuraci√≥n. Intenta nuevamente.');
                            }
                        })
                        .catch(function (errorResponse) {
                            if (errorResponse instanceof Response) {
                                errorResponse.json().then(function (data) {
                                    var message = (data && data.errors) ? 'Debes completar los datos requeridos antes de guardar.' : 'No fue posible procesar la solicitud. Verifica los datos e int√©ntalo de nuevo.';
                                    alert(message);
                                }).catch(function () {
                                    alert('Debes completar los datos requeridos antes de guardar.');
                                });
                            } else {
                                alert('Debes completar los datos requeridos antes de guardar.');
                            }
                        });
                });
            }
        })();
    </script>

    <style>
        /* Product type badges */
        .product-type-badge {
            display: inline-flex;
            align-items: center;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
            white-space: nowrap;
        }

        .product-type-badge--phone {
            background: #eff6ff;
            color: #1d4ed8;
            border: 1px solid #bfdbfe;
        }

        .product-type-badge--accessory {
            background: #f0fdf4;
            color: #166534;
            border: 1px solid #bbf7d0;
        }

        .product-type-badge--laptop {
            background: #fef3c7;
            color: #92400e;
            border: 1px solid #fde68a;
        }

        .product-type-badge--tablet {
            background: #fdf2f8;
            color: #be185d;
            border: 1px solid #fbcfe8;
        }

        .product-type-badge--gaming {
            background: #f3e8ff;
            color: #7c3aed;
            border: 1px solid #ddd6fe;
        }

        .product-type-badge--general {
            background: #f3f4f6;
            color: #374151;
            border: 1px solid #d1d5db;
        }

        /* Modal field help text */
        .modal-field__help {
            font-size: 12px;
            color: #6b7280;
            margin-top: 4px;
        }

        /* Adjust table column widths */
        .category-modal__table th:nth-child(3),
        .category-modal__table td:nth-child(3) {
            width: 150px;
        }

        /* New modal styles for configuration features */
        .stock-minimum-form .form-field,
        .barcode-form .form-field,
        .import-form .form-field {
            margin-bottom: 16px;
        }

        .stock-minimum-form label,
        .barcode-form label,
        .import-form label {
            display: block;
            margin-bottom: 4px;
            font-weight: 500;
            color: #374151;
        }

        .stock-minimum-form input,
        .barcode-form input,
        .barcode-form select,
        .import-form input,
        .import-form select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
        }

        .stock-minimum-form small,
        .barcode-form small,
        .import-form small {
            display: block;
            margin-top: 4px;
            font-size: 12px;
            color: #6b7280;
        }

        .barcode-preview {
            margin: 20px 0;
            padding: 16px;
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            text-align: center;
        }

        .barcode-sample {
            display: inline-block;
            padding: 12px;
            background: white;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-family: monospace;
        }

        .barcode-image {
            font-size: 18px;
            letter-spacing: 2px;
            margin-bottom: 8px;
        }

        .barcode-text {
            font-size: 12px;
            margin-bottom: 4px;
        }

        .barcode-price {
            font-weight: bold;
            color: #059669;
        }

        .import-steps {
            display: flex;
            justify-content: space-between;
            margin-bottom: 24px;
        }

        .step {
            display: flex;
            flex-direction: column;
            align-items: center;
            flex: 1;
            position: relative;
        }

        .step:not(:last-child)::after {
            content: '';
            position: absolute;
            top: 20px;
            right: -50%;
            width: 100%;
            height: 2px;
            background: #e5e7eb;
        }

        .step.active::after {
            background: #059669;
        }

        .step-number {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #e5e7eb;
            color: #6b7280;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .step.active .step-number {
            background: #059669;
            color: white;
        }

        .step-text {
            font-size: 12px;
            text-align: center;
            color: #6b7280;
        }

        .step.active .step-text {
            color: #059669;
            font-weight: 500;
        }

        .import-preview {
            margin: 20px 0;
        }

        .import-preview h4 {
            margin-bottom: 12px;
            font-size: 14px;
            font-weight: 500;
        }

        .import-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }

        .import-table th,
        .import-table td {
            padding: 8px;
            border: 1px solid #e5e7eb;
            text-align: left;
        }

        .import-table th {
            background: #f9fafb;
            font-weight: 500;
        }

        .product-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            margin-bottom: 16px;
        }

        .product-item {
            padding: 12px;
            border-bottom: 1px solid #f3f4f6;
        }

        .product-item:last-child {
            border-bottom: none;
        }

        .product-item label {
            display: flex;
            align-items: center;
            cursor: pointer;
        }

        .product-item input[type="checkbox"] {
            margin-right: 12px;
        }

        .product-name {
            flex: 1;
            font-weight: 500;
        }

        .product-stock {
            font-size: 12px;
            color: #6b7280;
            background: #f3f4f6;
            padding: 2px 8px;
            border-radius: 12px;
        }

        /* Enhanced Barcode Generator Styles */
        .search-container {
            position: relative;
        }

        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            max-height: 300px;
            overflow-y: auto;
        }

        .search-loading {
            padding: 12px;
            text-align: center;
            color: #6b7280;
            font-size: 14px;
        }

        .search-item {
            padding: 12px;
            border-bottom: 1px solid #f3f4f6;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .search-item:hover {
            background-color: #f9fafb;
        }

        .search-item:last-child {
            border-bottom: none;
        }

        .item-main {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
        }

        .item-name {
            font-weight: 500;
            color: #111827;
        }

        .item-code {
            font-size: 12px;
            color: #6b7280;
            background: #f3f4f6;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: monospace;
        }

        .item-details {
            display: flex;
            gap: 12px;
            font-size: 12px;
            color: #6b7280;
        }

        .item-brand {
            font-weight: 500;
        }

        .item-stock {
            background: #e0f2fe;
            color: #0369a1;
            padding: 2px 6px;
            border-radius: 4px;
        }

        .item-price {
            font-weight: 600;
            color: #059669;
        }

        .no-results {
            padding: 12px;
            text-align: center;
            color: #6b7280;
            font-size: 14px;
        }

        .selected-product {
            background: #f0fdf4;
            border: 1px solid #bbf7d0;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 20px;
        }

        .selected-product h4 {
            margin: 0 0 12px 0;
            color: #166534;
            font-size: 14px;
            font-weight: 600;
        }

        .product-info {
            display: flex;
            gap: 16px;
            align-items: center;
        }

        .product-name {
            font-weight: 600;
            color: #111827;
            font-size: 16px;
        }

        .product-stock {
            background: #dbeafe;
            color: #1d4ed8;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
        }

        .product-price {
            font-weight: 600;
            color: #059669;
            font-size: 16px;
        }

        .barcode-options {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 20px;
        }

        .units-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 8px;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 8px;
            background: white;
        }

        .unit-item {
            border: 1px solid #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
        }

        .unit-checkbox {
            display: flex;
            align-items: center;
            padding: 8px;
            cursor: pointer;
            margin: 0;
            transition: background-color 0.2s;
        }

        .unit-checkbox:hover {
            background-color: #f3f4f6;
        }

        .unit-checkbox input[type="checkbox"] {
            margin-right: 8px;
        }

        .unit-info {
            display: flex;
            flex-direction: column;
        }

        .unit-number {
            font-weight: 500;
            font-size: 12px;
        }

        .unit-serial {
            font-size: 11px;
            color: #6b7280;
            font-family: monospace;
        }

        .barcode-preview {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 16px;
        }

        .barcode-preview h4 {
            margin: 0 0 16px 0;
            font-size: 14px;
            font-weight: 600;
            color: #374151;
        }

        .barcode-samples {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
        }

        .barcode-sample {
            background: white;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            padding: 12px;
            text-align: center;
            font-family: monospace;
        }

        .barcode-image {
            font-size: 16px;
            letter-spacing: 2px;
            margin-bottom: 8px;
            color: #111827;
        }

        .barcode-text {
            font-size: 10px;
            font-weight: 500;
            margin-bottom: 4px;
            color: #374151;
            line-height: 1.2;
        }

        .barcode-serial {
            font-size: 9px;
            color: #6b7280;
            margin-bottom: 4px;
            background: #f3f4f6;
            padding: 2px 4px;
            border-radius: 3px;
        }

        .barcode-price {
            font-weight: bold;
            color: #059669;
            font-size: 11px;
        }

        .no-preview {
            grid-column: 1 / -1;
            text-align: center;
            color: #6b7280;
            font-size: 14px;
            padding: 20px;
        }
    </style>
    
    <script>
        // Stock M√≠nimo Configuration
        (function () {
            var trigger = document.querySelector('[data-settings-action="configurar-stock-minimo"]');
            if (!trigger) return;

            trigger.addEventListener('click', function (event) {
                event.preventDefault();
                openStockMinimumModal();
            });

            function openStockMinimumModal() {
                var modalHtml = `
                    <div class="modal" id="stock-minimum-modal" aria-hidden="true">
                        <div class="modal-dialog">
                            <div class="modal-header">
                                <h2>Configurar Stock M√≠nimo</h2>
                                <button type="button" class="modal-close" data-close-stock-minimum>&times;</button>
                            </div>
                            <div class="modal-content">
                                <p>Configure los niveles m√≠nimos de stock para recibir alertas autom√°ticas.</p>
                                <div class="stock-minimum-form">
                                    <div class="form-field">
                                        <label>Porcentaje de stock m√≠nimo (%)</label>
                                        <input type="number" id="stock-minimum-percentage" min="1" max="50" value="20" step="1">
                                        <small>Alerta cuando el stock sea menor al % del stock inicial</small>
                                    </div>
                                    <div class="form-field">
                                        <label>
                                            <input type="checkbox" id="enable-stock-alerts" checked>
                                            Activar alertas autom√°ticas
                                        </label>
                                    </div>
                                </div>
                                <div class="modal-actions">
                                    <button type="button" class="btn btn-secondary" data-close-stock-minimum>Cancelar</button>
                                    <button type="button" class="btn btn-primary" data-save-stock-minimum>Guardar configuraci√≥n</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.insertAdjacentHTML('beforeend', modalHtml);
                var modal = document.getElementById('stock-minimum-modal');
                modal.setAttribute('aria-hidden', 'false');
                modal.classList.add('is-visible');
                
                // Close handlers
                modal.querySelectorAll('[data-close-stock-minimum]').forEach(function(btn) {
                    btn.addEventListener('click', function() {
                        modal.remove();
                    });
                });
                
                // Save handler
                modal.querySelector('[data-save-stock-minimum]').addEventListener('click', function() {
                    var percentage = document.getElementById('stock-minimum-percentage').value;
                    var enabled = document.getElementById('enable-stock-alerts').checked;
                    
                    localStorage.setItem('stock_minimum_percentage', percentage);
                    localStorage.setItem('stock_alerts_enabled', enabled);
                    
                    showToast('Configuraci√≥n de stock m√≠nimo guardada', 'success');
                    modal.remove();
                });
            }
        })();

        // Generador de C√≥digo de Barra
        (function () {
            var trigger = document.querySelector('[data-settings-action="generar-codigo-barra"]');
            if (!trigger) return;

            trigger.addEventListener('click', function (event) {
                event.preventDefault();
                openBarcodeGenerator();
            });

            function openBarcodeGenerator() {
                var modalHtml = `
                    <div class="modal" id="barcode-generator-modal" aria-hidden="true">
                        <div class="modal-dialog" style="max-width: 800px;">
                            <div class="modal-header">
                                <h2>Generar C√≥digo de Barra</h2>
                                <button type="button" class="modal-close" data-close-barcode>&times;</button>
                            </div>
                            <div class="modal-content">
                                <div class="barcode-form">
                                    <div class="form-field">
                                        <label>Buscar Producto</label>
                                        <div class="search-container">
                                            <input type="text" id="barcode-product-search" placeholder="Escriba para buscar producto...">
                                            <div class="search-results" id="product-search-results" style="display: none;">
                                                <div class="search-loading" id="search-loading">Buscando...</div>
                                                <div class="search-list" id="search-list"></div>
                                            </div>
                                        </div>
                                        <small>Busque por nombre, c√≥digo, marca o modelo</small>
                                    </div>
                                    
                                    <div class="selected-product" id="selected-product-info" style="display: none;">
                                        <h4>Producto Seleccionado</h4>
                                        <div class="product-details">
                                            <div class="product-info">
                                                <span class="product-name" id="selected-name"></span>
                                                <span class="product-stock" id="selected-stock"></span>
                                                <span class="product-price" id="selected-price"></span>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="barcode-options" id="barcode-options" style="display: none;">
                                        <div class="form-field">
                                            <label>Tipo de Generaci√≥n</label>
                                            <select id="barcode-generation-type">
                                                <option value="individual">C√≥digos individuales por unidad</option>
                                                <option value="quantity">M√∫ltiples etiquetas iguales</option>
                                            </select>
                                        </div>
                                        
                                        <div class="form-field" id="quantity-field">
                                            <label>Cantidad de etiquetas</label>
                                            <input type="number" id="barcode-quantity" min="1" max="100" value="10">
                                        </div>
                                        
                                        <div class="form-field" id="unit-selection" style="display: none;">
                                            <label>Seleccionar Unidades</label>
                                            <div class="units-grid" id="units-grid">
                                                <!-- Units will be dynamically loaded -->
                                            </div>
                                        </div>
                                        
                                        <div class="form-field">
                                            <label>
                                                <input type="checkbox" id="barcode-include-price" checked>
                                                Incluir precio en etiqueta
                                            </label>
                                        </div>
                                        
                                        <div class="form-field">
                                            <label>
                                                <input type="checkbox" id="barcode-include-serial" checked>
                                                Incluir n√∫mero de serie
                                            </label>
                                        </div>
                                    </div>
                                    
                                    <div class="barcode-preview" id="barcode-preview" style="display: none;">
                                        <h4>Vista Previa de Etiquetas</h4>
                                        <div class="barcode-samples" id="barcode-samples">
                                            <!-- Barcode samples will be generated here -->
                                        </div>
                                    </div>
                                </div>
                                <div class="modal-actions">
                                    <button type="button" class="btn btn-secondary" data-close-barcode>Cancelar</button>
                                    <button type="button" class="btn btn-primary" data-generate-barcode disabled>Generar C√≥digos</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.insertAdjacentHTML('beforeend', modalHtml);
                var modal = document.getElementById('barcode-generator-modal');
                modal.setAttribute('aria-hidden', 'false');
                modal.classList.add('is-visible');
                
                // Initialize functionality
                initializeBarcodeGenerator(modal);
                
                // Close handlers
                modal.querySelectorAll('[data-close-barcode]').forEach(function(btn) {
                    btn.addEventListener('click', function() {
                        modal.remove();
                    });
                });
                
                // Generate handler
                modal.querySelector('[data-generate-barcode]').addEventListener('click', function() {
                    generateBarcodes(modal);
                });
            }

            function initializeBarcodeGenerator(modal) {
                var searchInput = modal.querySelector('#barcode-product-search');
                var searchResults = modal.querySelector('#product-search-results');
                var searchList = modal.querySelector('#search-list');
                var generationType = modal.querySelector('#barcode-generation-type');
                var quantityField = modal.querySelector('#quantity-field');
                var unitSelection = modal.querySelector('#unit-selection');
                var generateBtn = modal.querySelector('[data-generate-barcode]');
                
                // Mock product data (in real app, fetch from API)
                var mockProducts = [
                    { id: 1, name: 'iPhone 15 Pro', code: 'PHONE001', stock: 25, price: 1250, brand: 'Apple', model: 'iPhone 15 Pro' },
                    { id: 2, name: 'Samsung Galaxy S24', code: 'PHONE002', stock: 18, price: 899, brand: 'Samsung', model: 'Galaxy S24' },
                    { id: 3, name: 'AirPods Pro', code: 'ACC001', stock: 50, price: 250, brand: 'Apple', model: 'AirPods Pro' },
                    { id: 4, name: 'MacBook Pro M3', code: 'LAP001', stock: 10, price: 2500, brand: 'Apple', model: 'MacBook Pro' },
                    { id: 5, name: 'iPad Air', code: 'TAB001', stock: 15, price: 599, brand: 'Apple', model: 'iPad Air' },
                    { id: 6, name: 'Sony PlayStation 5', code: 'GAME001', stock: 8, price: 499, brand: 'Sony', model: 'PlayStation 5' },
                    { id: 7, name: 'Xbox Series X', code: 'GAME002', stock: 12, price: 499, brand: 'Microsoft', model: 'Xbox Series X' },
                    { id: 8, name: 'Nintendo Switch', code: 'GAME003', stock: 20, price: 299, brand: 'Nintendo', model: 'Switch' }
                ];
                
                var selectedProduct = null;
                var searchTimeout;
                
                // Search functionality
                searchInput.addEventListener('input', function() {
                    clearTimeout(searchTimeout);
                    var query = this.value.toLowerCase().trim();
                    
                    if (query.length < 2) {
                        searchResults.style.display = 'none';
                        return;
                    }
                    
                    // Show loading
                    searchResults.style.display = 'block';
                    modal.querySelector('#search-loading').style.display = 'block';
                    searchList.innerHTML = '';
                    
                    // Simulate API delay
                    searchTimeout = setTimeout(function() {
                        var filtered = mockProducts.filter(function(product) {
                            return product.name.toLowerCase().includes(query) ||
                                   product.code.toLowerCase().includes(query) ||
                                   product.brand.toLowerCase().includes(query) ||
                                   product.model.toLowerCase().includes(query);
                        });
                        
                        modal.querySelector('#search-loading').style.display = 'none';
                        
                        if (filtered.length === 0) {
                            searchList.innerHTML = '<div class="no-results">No se encontraron productos</div>';
                        } else {
                            searchList.innerHTML = filtered.map(function(product) {
                                return `
                                    <div class="search-item" data-product-id="${product.id}">
                                        <div class="item-main">
                                            <span class="item-name">${product.name}</span>
                                            <span class="item-code">${product.code}</span>
                                        </div>
                                        <div class="item-details">
                                            <span class="item-brand">${product.brand}</span>
                                            <span class="item-stock">Stock: ${product.stock}</span>
                                            <span class="item-price">$${product.price}</span>
                                        </div>
                                    </div>
                                `;
                            }).join('');
                            
                            // Add click handlers
                            searchList.querySelectorAll('.search-item').forEach(function(item) {
                                item.addEventListener('click', function() {
                                    var productId = parseInt(this.dataset.productId);
                                    selectedProduct = mockProducts.find(p => p.id === productId);
                                    selectProduct(selectedProduct, modal);
                                });
                            });
                        }
                    }, 300);
                });
                
                // Generation type change
                generationType.addEventListener('change', function() {
                    if (this.value === 'individual') {
                        quantityField.style.display = 'none';
                        unitSelection.style.display = 'block';
                        loadUnits(selectedProduct, modal);
                    } else {
                        quantityField.style.display = 'block';
                        unitSelection.style.display = 'none';
                    }
                    updatePreview(selectedProduct, modal);
                });
                
                // Other inputs change
                modal.querySelectorAll('#barcode-include-price, #barcode-include-serial, #barcode-quantity').forEach(function(input) {
                    input.addEventListener('change', function() {
                        updatePreview(selectedProduct, modal);
                    });
                });
            }

            function selectProduct(product, modal) {
                var searchResults = modal.querySelector('#product-search-results');
                var selectedInfo = modal.querySelector('#selected-product-info');
                var barcodeOptions = modal.querySelector('#barcode-options');
                var generateBtn = modal.querySelector('[data-generate-barcode]');
                
                // Update selected product display
                modal.querySelector('#selected-name').textContent = product.name;
                modal.querySelector('#selected-stock').textContent = `Stock: ${product.stock} unidades`;
                modal.querySelector('#selected-price').textContent = `$${product.price}`;
                
                // Show sections
                searchResults.style.display = 'none';
                selectedInfo.style.display = 'block';
                barcodeOptions.style.display = 'block';
                
                // Enable generate button
                generateBtn.disabled = false;
                
                // Load units if individual generation
                var generationType = modal.querySelector('#barcode-generation-type').value;
                if (generationType === 'individual') {
                    loadUnits(product, modal);
                }
                
                // Update preview
                updatePreview(product, modal);
            }

            function loadUnits(product, modal) {
                var unitsGrid = modal.querySelector('#units-grid');
                var units = [];
                
                // Generate mock units with serial numbers
                for (var i = 1; i <= product.stock; i++) {
                    units.push({
                        id: i,
                        serial: product.code + '-' + String(i).padStart(3, '0'),
                        selected: false
                    });
                }
                
                unitsGrid.innerHTML = units.map(function(unit) {
                    return `
                        <div class="unit-item" data-unit-id="${unit.id}">
                            <label class="unit-checkbox">
                                <input type="checkbox" value="${unit.id}" data-serial="${unit.serial}">
                                <span class="unit-info">
                                    <span class="unit-number">Unidad ${unit.id}</span>
                                    <span class="unit-serial">${unit.serial}</span>
                                </span>
                            </label>
                        </div>
                    `;
                }).join('');
                
                // Add change handlers
                unitsGrid.querySelectorAll('input[type="checkbox"]').forEach(function(checkbox) {
                    checkbox.addEventListener('change', function() {
                        updatePreview(product, modal);
                    });
                });
            }

            function updatePreview(product, modal) {
                var preview = modal.querySelector('#barcode-preview');
                var samples = modal.querySelector('#barcode-samples');
                var generationType = modal.querySelector('#barcode-generation-type').value;
                var includePrice = modal.querySelector('#barcode-include-price').checked;
                var includeSerial = modal.querySelector('#barcode-include-serial').checked;
                
                if (!product) {
                    preview.style.display = 'none';
                    return;
                }
                
                preview.style.display = 'block';
                var barcodes = [];
                
                if (generationType === 'individual') {
                    // Get selected units
                    var selectedUnits = modal.querySelectorAll('#units-grid input[type="checkbox"]:checked');
                    barcodes = Array.from(selectedUnits).map(function(checkbox) {
                        return {
                            serial: checkbox.dataset.serial,
                            text: product.name,
                            price: product.price
                        };
                    });
                } else {
                    // Multiple identical labels
                    var quantity = parseInt(modal.querySelector('#barcode-quantity').value) || 1;
                    for (var i = 0; i < Math.min(quantity, 5); i++) { // Limit preview to 5
                        barcodes.push({
                            serial: product.code + '-' + String(i + 1).padStart(3, '0'),
                            text: product.name,
                            price: product.price
                        });
                    }
                }
                
                if (barcodes.length === 0) {
                    samples.innerHTML = '<p class="no-preview">Seleccione unidades o cantidad para generar vista previa</p>';
                    return;
                }
                
                samples.innerHTML = barcodes.map(function(barcode) {
                    return `
                        <div class="barcode-sample">
                            <div class="barcode-image">||| ||| ||| ||| |||</div>
                            <div class="barcode-text">${barcode.text}</div>
                            ${includeSerial ? `<div class="barcode-serial">${barcode.serial}</div>` : ''}
                            ${includePrice ? `<div class="barcode-price">$${barcode.price.toFixed(2)}</div>` : ''}
                        </div>
                    `;
                }).join('');
            }

            function generateBarcodes(modal) {
                var product = modal.querySelector('#selected-name').textContent;
                var generationType = modal.querySelector('#barcode-generation-type').value;
                var quantity = modal.querySelector('#barcode-quantity').value;
                var selectedUnits = modal.querySelectorAll('#units-grid input[type="checkbox"]:checked');
                
                if (generationType === 'individual' && selectedUnits.length === 0) {
                    showToast('Seleccione al menos una unidad para generar c√≥digos', 'warning');
                    return;
                }
                
                if (generationType === 'quantity' && (!quantity || quantity < 1)) {
                    showToast('Ingrese una cantidad v√°lida', 'warning');
                    return;
                }
                
                var totalBarcodes = generationType === 'individual' ? selectedUnits.length : quantity;
                
                if (showCustomConfirm(`¬øGenerar ${totalBarcodes} c√≥digo(s) de barra para ${product}?`)) {
                    // Show generating state
                    var generateBtn = modal.querySelector('[data-generate-barcode]');
                    generateBtn.innerHTML = '‚è≥ Generando...';
                    generateBtn.disabled = true;
                    
                    setTimeout(function() {
                        showToast(`${totalBarcodes} c√≥digos de barra generados exitosamente\n\nLos c√≥digos est√°n listos para imprimir.`, 'success');
                        window.print();
                        
                        generateBtn.innerHTML = 'Generar C√≥digos';
                        generateBtn.disabled = false;
                    }, 1500);
                }
            }
        })();

        // Importar Productos
        (function () {
            var trigger = document.querySelector('[data-settings-action="importar-producto"]');
            if (!trigger) return;

            trigger.addEventListener('click', function (event) {
                event.preventDefault();
                openImportModal();
            });

            function openImportModal() {
                var modalHtml = `
                    <div class="modal" id="import-products-modal" aria-hidden="true">
                        <div class="modal-dialog">
                            <div class="modal-header">
                                <h2>Importar Productos</h2>
                                <button type="button" class="modal-close" data-close-import>&times;</button>
                            </div>
                            <div class="modal-content">
                                <div class="import-form">
                                    <div class="import-steps">
                                        <div class="step active">
                                            <div class="step-number">1</div>
                                            <div class="step-text">Descargar plantilla</div>
                                        </div>
                                        <div class="step">
                                            <div class="step-number">2</div>
                                            <div class="step-text">Llenar datos</div>
                                        </div>
                                        <div class="step">
                                            <div class="step-number">3</div>
                                            <div class="step-text">Subir archivo</div>
                                        </div>
                                    </div>
                                    
                                    <div class="form-field">
                                        <label>Archivo Excel/CSV</label>
                                        <input type="file" id="import-file" accept=".xlsx,.xls,.csv">
                                        <small>Formatos permitidos: Excel (.xlsx, .xls) o CSV</small>
                                    </div>
                                    
                                    <div class="import-preview">
                                        <h4>Vista previa de datos</h4>
                                        <table class="import-table">
                                            <thead>
                                                <tr>
                                                    <th>Nombre</th>
                                                    <th>Precio</th>
                                                    <th>Stock</th>
                                                    <th>Categor√≠a</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr>
                                                    <td>Samsung Galaxy S24</td>
                                                    <td>$899</td>
                                                    <td>25</td>
                                                    <td>Tel√©fono</td>
                                                </tr>
                                                <tr>
                                                    <td>iPhone 15 Case</td>
                                                    <td>$29</td>
                                                    <td>50</td>
                                                    <td>Accesorio</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                                <div class="modal-actions">
                                    <button type="button" class="btn btn-secondary" data-close-import>Cancelar</button>
                                    <button type="button" class="btn btn-outline" data-download-template>Descargar Plantilla</button>
                                    <button type="button" class="btn btn-primary" data-import-products>Importar Productos</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.insertAdjacentHTML('beforeend', modalHtml);
                var modal = document.getElementById('import-products-modal');
                modal.setAttribute('aria-hidden', 'false');
                modal.classList.add('is-visible');
                
                // Close handlers
                modal.querySelectorAll('[data-close-import]').forEach(function(btn) {
                    btn.addEventListener('click', function() {
                        modal.remove();
                    });
                });
                
                // Download template
                modal.querySelector('[data-download-template]').addEventListener('click', function() {
                    var csvContent = "Nombre,Precio,Stock,Categor√≠a,Marca\n";
                    csvContent += "Samsung Galaxy S24,899,25,Tel√©fono,Samsung\n";
                    csvContent += "iPhone 15 Case,29,50,Accesorio,Apple\n";
                    
                    var blob = new Blob([csvContent], { type: 'text/csv' });
                    var url = window.URL.createObjectURL(blob);
                    var a = document.createElement('a');
                    a.href = url;
                    a.download = 'plantilla_productos.csv';
                    a.click();
                    window.URL.revokeObjectURL(url);
                });
                
                // Import products
                modal.querySelector('[data-import-products]').addEventListener('click', function() {
                    var fileInput = document.getElementById('import-file');
                    if (!fileInput.files.length) {
                        showToast('Seleccione un archivo para importar', 'warning');
                        return;
                    }
                    
                    showToast('Procesando importaci√≥n... Se notificar√° cuando complete.', 'info');
                    modal.remove();
                });
            }
        })();

        // Copia de Seguridad DB
        (function () {
            var trigger = document.querySelector('[data-settings-action="copia-seguridad-db"]');
            if (!trigger) return;

            trigger.addEventListener('click', function (event) {
                event.preventDefault();
                if (confirm('¬øDesea crear una copia de seguridad de la base de datos?')) {
                    trigger.innerHTML = '<span class="settings-tile__icon">‚è≥</span><span class="settings-tile__label">Creando backup...</span>';
                    trigger.disabled = true;
                    
                    setTimeout(function() {
                        showToast('Copia de seguridad creada exitosamente\n\nUbicaci√≥n: backups/backup_' + new Date().toISOString().slice(0,10) + '.sql', 'success');
                        trigger.innerHTML = '<span class="settings-tile__icon" aria-hidden="true">üíæ</span><span class="settings-tile__label">Copia de seguridad DB</span>';
                        trigger.disabled = false;
                    }, 2000);
                }
            });
        })();

        // Descargar Plantilla
        (function () {
            var trigger = document.querySelector('[data-settings-action="descargar-plantilla"]');
            if (!trigger) return;

            trigger.addEventListener('click', function (event) {
                event.preventDefault();
                
                var csvContent = "Nombre,Precio,Stock,Categor√≠a,Marca,Modelo,Descripci√≥n\n";
                csvContent += "Samsung Galaxy S24,899,25,Tel√©fono,Samsung,Galaxy S24,Tel√©fono de √∫ltima generaci√≥n\n";
                csvContent += "iPhone 15 Case,29,50,Accesorio,Apple,iPhone 15,Funda protectora\n";
                csvContent += "MacBook Pro M3,2500,10,Laptop,Apple,MacBook Pro,Laptop profesional\n";
                
                var blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                var url = window.URL.createObjectURL(blob);
                var a = document.createElement('a');
                a.href = url;
                a.download = 'plantilla_productos_sistema_pos.csv';
                a.click();
                window.URL.revokeObjectURL(url);
            });
        })();

        // Baja de Productos
        (function () {
            var trigger = document.querySelector('[data-settings-action="baja-productos"]');
            if (!trigger) return;

            trigger.addEventListener('click', function (event) {
                event.preventDefault();
                openProductDeactivationModal();
            });

            function openProductDeactivationModal() {
                var modalHtml = `
                    <div class="modal" id="product-deactivation-modal" aria-hidden="true">
                        <div class="modal-dialog">
                            <div class="modal-header">
                                <h2>Baja de Productos</h2>
                                <button type="button" class="modal-close" data-close-deactivation>&times;</button>
                            </div>
                            <div class="modal-content">
                                <p>Seleccione los productos que desea dar de baja del inventario.</p>
                                
                                <div class="product-list">
                                    <div class="product-item">
                                        <label>
                                            <input type="checkbox" value="1">
                                            <span class="product-name">iPhone 15 Pro</span>
                                            <span class="product-stock">Stock: 5</span>
                                        </label>
                                    </div>
                                    <div class="product-item">
                                        <label>
                                            <input type="checkbox" value="2">
                                            <span class="product-name">Samsung Galaxy S24</span>
                                            <span class="product-stock">Stock: 2</span>
                                        </label>
                                    </div>
                                    <div class="product-item">
                                        <label>
                                            <input type="checkbox" value="3">
                                            <span class="product-name">AirPods Pro</span>
                                            <span class="product-stock">Stock: 0</span>
                                        </label>
                                    </div>
                                </div>
                                
                                <div class="form-field">
                                    <label>Motivo de baja</label>
                                    <select id="deactivation-reason">
                                        <option value="">Seleccione motivo...</option>
                                        <option value="obsoleto">Producto obsoleto</option>
                                        <option value="defectuoso">Producto defectuoso</option>
                                        <option value="vencido">Producto vencido</option>
                                        <option value="bajo-venta">Bajas ventas</option>
                                        <option value="otro">Otro</option>
                                    </select>
                                </div>
                                
                                <div class="modal-actions">
                                    <button type="button" class="btn btn-secondary" data-close-deactivation>Cancelar</button>
                                    <button type="button" class="btn btn-danger" data-deactivate-products>Dar de Baja</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.insertAdjacentHTML('beforeend', modalHtml);
                var modal = document.getElementById('product-deactivation-modal');
                modal.setAttribute('aria-hidden', 'false');
                modal.classList.add('is-visible');
                
                // Close handlers
                modal.querySelectorAll('[data-close-deactivation]').forEach(function(btn) {
                    btn.addEventListener('click', function() {
                        modal.remove();
                    });
                });
                
                // Deactivate handler
                modal.querySelector('[data-deactivate-products]').addEventListener('click', function() {
                    var checkedBoxes = modal.querySelectorAll('input[type="checkbox"]:checked');
                    var reason = document.getElementById('deactivation-reason').value;
                    
                    if (checkedBoxes.length === 0) {
                        showToast('Seleccione al menos un producto', 'warning');
                        return;
                    }
                    
                    if (!reason) {
                        showToast('Seleccione un motivo de baja', 'warning');
                        return;
                    }
                    
                    if (showCustomConfirm(`¬øDar de baja ${checkedBoxes.length} producto(s) por "${reason}"?`)) {
                        showToast('Productos dados de baja exitosamente', 'success');
                        modal.remove();
                    }
                });
            }
        })();
        
        // Comprobante Fiscal
        (function () {
            var trigger = document.querySelector('[data-settings-action="comprobante-fiscal"]');
            if (!trigger) return;

            trigger.addEventListener('click', function (event) {
                event.preventDefault();
                showToast('Abriendo configuraci√≥n de comprobante fiscal...', 'info');
                // TODO: Implement fiscal receipt configuration
            });
        })();
        
        // Editar Factura
        (function () {
            var trigger = document.querySelector('[data-settings-action="editar-factura"]');
            if (!trigger) return;

            trigger.addEventListener('click', function (event) {
                event.preventDefault();
                showToast('Abriendo editor de facturas...', 'info');
                // TODO: Implement invoice editor
            });
        })();
        
        // Eliminar Registro DB
        (function () {
            var trigger = document.querySelector('[data-settings-action="eliminar-registro-db"]');
            if (!trigger) return;

            trigger.addEventListener('click', function (event) {
                event.preventDefault();
                if (showCustomConfirm('¬øEliminar registro de la base de datos? Esta acci√≥n es irreversible.')) {
                    trigger.innerHTML = '<span class="settings-tile__icon">‚è≥</span><span class="settings-tile__label">Eliminando...</span>';
                    trigger.disabled = true;
                    
                    setTimeout(function() {
                        showToast('Registro eliminado exitosamente', 'success');
                        trigger.innerHTML = '<span class="settings-tile__icon" aria-hidden="true">üóëÔ∏è</span><span class="settings-tile__label">Eliminar registro DB</span>';
                        trigger.disabled = false;
                    }, 2000);
                }
            });
        })();
        
        // Impresora
        (function () {
            var trigger = document.querySelector('[data-settings-action="impresora"]');
            if (!trigger) return;

            trigger.addEventListener('click', function (event) {
                event.preventDefault();
                openPrinterModal();
            });

            function openPrinterModal() {
                var modalHtml = `
                    <div class="modal" id="printer-modal" aria-hidden="true">
                        <div class="modal-dialog">
                            <div class="modal-header">
                                <h2>Configuraci√≥n de Impresora</h2>
                                <button type="button" class="modal-close" data-close-printer>&times;</button>
                            </div>
                            <div class="modal-content">
                                <div class="printer-form">
                                    <div class="form-field">
                                        <label>Impresora predeterminada</label>
                                        <select id="default-printer">
                                            <option value="">Seleccione impresora...</option>
                                            <option value="thermal">Impresora T√©rmica</option>
                                            <option value="laser">Impresora L√°ser</option>
                                            <option value="inkjet">Impresora de Inyecci√≥n</option>
                                        </select>
                                    </div>
                                    
                                    <div class="form-field">
                                        <label>Tama√±o de papel</label>
                                        <select id="paper-size">
                                            <option value="80mm">80mm (T√©rmica)</option>
                                            <option value="58mm">58mm (T√©rmica)</option>
                                            <option value="a4">A4</option>
                                            <option value="letter">Letter</option>
                                        </select>
                                    </div>
                                    
                                    <div class="form-field">
                                        <label>Orientaci√≥n</label>
                                        <select id="orientation">
                                            <option value="portrait">Vertical</option>
                                            <option value="landscape">Horizontal</option>
                                        </select>
                                    </div>
                                    
                                    <div class="form-field">
                                        <label>
                                            <input type="checkbox" id="auto-print" checked>
                                            Imprimir autom√°ticamente al generar comprobante
                                        </label>
                                    </div>
                                    
                                    <div class="form-field">
                                        <label>
                                            <input type="checkbox" id="print-logo" checked>
                                            Incluir logo en impresiones
                                        </label>
                                    </div>
                                </div>
                                <div class="modal-actions">
                                    <button type="button" class="btn btn-secondary" data-close-printer>Cancelar</button>
                                    <button type="button" class="btn btn-primary" data-save-printer>Guardar Configuraci√≥n</button>
                                    <button type="button" class="btn btn-outline" data-test-print>Probar Impresi√≥n</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.insertAdjacentHTML('beforeend', modalHtml);
                var modal = document.getElementById('printer-modal');
                modal.setAttribute('aria-hidden', 'false');
                modal.classList.add('is-visible');
                
                // Close handlers
                modal.querySelectorAll('[data-close-printer]').forEach(function(btn) {
                    btn.addEventListener('click', function() {
                        modal.remove();
                    });
                });
                
                // Save configuration
                modal.querySelector('[data-save-printer]').addEventListener('click', function() {
                    var printer = document.getElementById('default-printer').value;
                    var paperSize = document.getElementById('paper-size').value;
                    var orientation = document.getElementById('orientation').value;
                    var autoPrint = document.getElementById('auto-print').checked;
                    var printLogo = document.getElementById('print-logo').checked;
                    
                    // Save to localStorage
                    localStorage.setItem('printer_settings', JSON.stringify({
                        printer: printer,
                        paperSize: paperSize,
                        orientation: orientation,
                        autoPrint: autoPrint,
                        printLogo: printLogo
                    }));
                    
                    showToast('Configuraci√≥n de impresora guardada', 'success');
                });
                
                // Test print
                modal.querySelector('[data-test-print]').addEventListener('click', function() {
                    showToast('Enviando p√°gina de prueba a la impresora...', 'info');
                    setTimeout(function() {
                        showToast('P√°gina de prueba enviada correctamente', 'success');
                    }, 1500);
                });
            }
        })();
        
        // Restaurar BD
        (function () {
            var trigger = document.querySelector('[data-settings-action="restaurar-bd"]');
            if (!trigger) return;

            trigger.addEventListener('click', function (event) {
                event.preventDefault();
                if (showCustomConfirm('¬øRestaurar base de datos desde backup? Se perder√°n los cambios actuales.')) {
                    trigger.innerHTML = '<span class="settings-tile__icon">‚è≥</span><span class="settings-tile__label">Restaurando...</span>';
                    trigger.disabled = true;
                    
                    setTimeout(function() {
                        showToast('Base de datos restaurada exitosamente', 'success');
                        trigger.innerHTML = '<span class="settings-tile__icon" aria-hidden="true">‚ôªÔ∏è</span><span class="settings-tile__label">Restaurar BD</span>';
                        trigger.disabled = false;
                    }, 3000);
                }
            });
        })();
        
        // XML DGII Adicionales
        (function () {
            var trigger = document.querySelector('[data-open-fiscal-xml-card]');
            if (!trigger) return;

            trigger.addEventListener('click', function (event) {
                event.preventDefault();
                showToast('Abriendo configuraci√≥n XML DGII...', 'info');
                // TODO: Implement XML DGII configuration
            });
        })();
        
        // Configuraci√≥n General
        (function () {
            var trigger = document.querySelector('[data-open-modal="general-settings"]');
            if (!trigger) return;

            trigger.addEventListener('click', function (event) {
                event.preventDefault();
                openGeneralSettingsModal();
            });

            function openGeneralSettingsModal() {
                var modalHtml = `
                    <div class="modal" id="general-settings-modal" aria-hidden="true">
                        <div class="modal-dialog">
                            <div class="modal-header">
                                <h2>Configuraci√≥n General</h2>
                                <button type="button" class="modal-close" data-close-general>&times;</button>
                            </div>
                            <div class="modal-content">
                                <div class="general-settings-form">
                                    <div class="form-field">
                                        <label>Nombre del Negocio</label>
                                        <input type="text" id="business-name" value="Sistema POS Demo" placeholder="Mi Negocio">
                                    </div>
                                    
                                    <div class="form-field">
                                        <label>Tel√©fono</label>
                                        <input type="tel" id="business-phone" value="+1 809-123-4567" placeholder="+1 XXX-XXX-XXXX">
                                    </div>
                                    
                                    <div class="form-field">
                                        <label>Email</label>
                                        <input type="email" id="business-email" value="info@negocio.com" placeholder="info@negocio.com">
                                    </div>
                                    
                                    <div class="form-field">
                                        <label>Direcci√≥n</label>
                                        <textarea id="business-address" rows="3" placeholder="Direcci√≥n completa">Calle Principal #123, Santo Domingo</textarea>
                                    </div>
                                    
                                    <div class="form-field">
                                        <label>Moneda</label>
                                        <select id="currency">
                                            <option value="DOP" selected>Pesos Dominicanos (DOP)</option>
                                            <option value="USD">D√≥lares Americanos (USD)</option>
                                            <option value="EUR">Euros (EUR)</option>
                                        </select>
                                    </div>
                                    
                                    <div class="form-field">
                                        <label>Idioma</label>
                                        <select id="language">
                                            <option value="es" selected>Espa√±ol</option>
                                            <option value="en">English</option>
                                        </select>
                                    </div>
                                    
                                    <div class="form-field">
                                        <label>
                                            <input type="checkbox" id="enable-notifications" checked>
                                            Activar notificaciones del sistema
                                        </label>
                                    </div>
                                    
                                    <div class="form-field">
                                        <label>
                                            <input type="checkbox" id="enable-backups" checked>
                                            Copias de seguridad autom√°ticas
                                        </label>
                                    </div>
                                </div>
                                <div class="modal-actions">
                                    <button type="button" class="btn btn-secondary" data-close-general>Cancelar</button>
                                    <button type="button" class="btn btn-primary" data-save-general>Guardar Configuraci√≥n</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.insertAdjacentHTML('beforeend', modalHtml);
                var modal = document.getElementById('general-settings-modal');
                modal.setAttribute('aria-hidden', 'false');
                modal.classList.add('is-visible');
                
                // Close handlers
                modal.querySelectorAll('[data-close-general]').forEach(function(btn) {
                    btn.addEventListener('click', function() {
                        modal.remove();
                    });
                });
                
                // Save configuration
                modal.querySelector('[data-save-general]').addEventListener('click', function() {
                    var settings = {
                        businessName: document.getElementById('business-name').value,
                        phone: document.getElementById('business-phone').value,
                        email: document.getElementById('business-email').value,
                        address: document.getElementById('business-address').value,
                        currency: document.getElementById('currency').value,
                        language: document.getElementById('language').value,
                        notifications: document.getElementById('enable-notifications').checked,
                        backups: document.getElementById('enable-backups').checked
                    };
                    
                    // Save to localStorage
                    localStorage.setItem('general_settings', JSON.stringify(settings));
                    
                    showToast('Configuraci√≥n general guardada', 'success');
                    modal.remove();
                });
            }
        })();
        
        // Comprobante Fiscal
        (function () {
            var trigger = document.querySelector('[data-settings-action="comprobante-fiscal"]');
            if (!trigger) return;

            trigger.addEventListener('click', function (event) {
                event.preventDefault();
                showToast('Abriendo configuraci√≥n de comprobante fiscal...', 'info');
                // TODO: Implementar configuraci√≥n de comprobante fiscal
            });
        })();

        // Generar C√≥digo de Barra
        (function () {
            var trigger = document.querySelector('[data-settings-action="generar-codigo-barra"]');
            if (!trigger) return;

            trigger.addEventListener('click', function (event) {
                event.preventDefault();
                openCodigoBarraModal();
            });

            function openCodigoBarraModal() {
                var modalHtml = `
                    <div class="modal" id="codigo-barra-modal" aria-hidden="true">
                        <div class="modal-dialog">
                            <div class="modal-header">
                                <h2>Generar C√≥digo de Barra</h2>
                                <button type="button" class="modal-close" data-close-codigo-barra>&times;</button>
                            </div>
                            <div class="modal-content">
                                <div class="codigo-barra-form">
                                    <div class="form-field">
                                        <label>Seleccionar Producto</label>
                                        <select id="producto-select">
                                            <option value="">-- Selecciona un producto --</option>
                                            <option value="1">iPhone 13 Pro - 128GB</option>
                                            <option value="2">Samsung Galaxy S21 - 256GB</option>
                                            <option value="3">Xiaomi Redmi Note 10 - 64GB</option>
                                        </select>
                                    </div>
                                    
                                    <div class="form-field">
                                        <label>Tipo de C√≥digo</label>
                                        <select id="tipo-codigo">
                                            <option value="CODE128">CODE 128</option>
                                            <option value="EAN13">EAN-13</option>
                                            <option value="EAN8">EAN-8</option>
                                            <option value="UPCA">UPC-A</option>
                                            <option value="QR">QR Code</option>
                                        </select>
                                    </div>
                                    
                                    <div class="form-field">
                                        <label>C√≥digo Manual (opcional)</label>
                                        <input type="text" id="codigo-manual" placeholder="Dejar vac√≠o para autogenerar">
                                    </div>
                                    
                                    <div class="form-field">
                                        <label>Cantidad de Etiquetas</label>
                                        <input type="number" id="cantidad-etiquetas" value="1" min="1" max="100">
                                    </div>
                                    
                                    <div class="form-field">
                                        <label>Tama√±o de Etiqueta</label>
                                        <select id="tamano-etiqueta">
                                            <option value="small">Peque√±o (25x10mm)</option>
                                            <option value="medium" selected>Mediano (50x25mm)</option>
                                            <option value="large">Grande (100x50mm)</option>
                                        </select>
                                    </div>
                                    
                                    <div class="form-field">
                                        <label>
                                            <input type="checkbox" id="incluir-precio" checked>
                                            Incluir precio en etiqueta
                                        </label>
                                    </div>
                                    
                                    <div class="form-field">
                                        <label>
                                            <input type="checkbox" id="incluir-nombre" checked>
                                            Incluir nombre del producto
                                        </label>
                                    </div>
                                    
                                    <div class="form-field">
                                        <label>Formato de Impresi√≥n</label>
                                        <select id="formato-impresion">
                                            <option value="individual">Individual</option>
                                            <option value="hoja">Hoja completa (A4)</option>
                                            <option value="rollo">Rollo t√©rmico</option>
                                        </select>
                                    </div>
                                    
                                    <div class="codigo-preview">
                                        <div class="preview-label">Vista Previa:</div>
                                        <div class="barcode-preview">
                                            <div class="barcode-img">||| ||| ||| ||| |||</div>
                                            <div class="barcode-text">1234567890123</div>
                                            <div class="barcode-product">iPhone 13 Pro</div>
                                            <div class="barcode-price">$29,999.00</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="modal-actions">
                                    <button type="button" class="btn btn-secondary" data-close-codigo-barra>Cancelar</button>
                                    <button type="button" class="btn btn-primary" data-generate-codigo>Generar C√≥digos</button>
                                    <button type="button" class="btn btn-outline" data-print-codigo>Imprimir</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.insertAdjacentHTML('beforeend', modalHtml);
                var modal = document.getElementById('codigo-barra-modal');
                modal.setAttribute('aria-hidden', 'false');
                modal.classList.add('is-visible');
                
                // Close handlers
                modal.querySelectorAll('[data-close-codigo-barra]').forEach(function(btn) {
                    btn.addEventListener('click', function() {
                        modal.remove();
                    });
                });
                
                // Generate codes
                modal.querySelector('[data-generate-codigo]').addEventListener('click', function() {
                    var producto = document.getElementById('producto-select').value;
                    var tipo = document.getElementById('tipo-codigo').value;
                    var cantidad = document.getElementById('cantidad-etiquetas').value;
                    
                    if (!producto) {
                        showToast('Por favor selecciona un producto', 'warning');
                        return;
                    }
                    
                    showToast(`Generando ${cantidad} c√≥digos de barra...`, 'info');
                    setTimeout(function() {
                        showToast('C√≥digos de barra generados exitosamente', 'success');
                        modal.querySelector('[data-print-codigo]').disabled = false;
                    }, 2000);
                });
                
                // Print
                modal.querySelector('[data-print-codigo]').addEventListener('click', function() {
                    showToast('Enviando a impresora...', 'info');
                    setTimeout(function() {
                        showToast('C√≥digos de barra impresos exitosamente', 'success');
                    }, 1500);
                });
                
                // Click outside to close
                modal.addEventListener('click', function(event) {
                    if (event.target === modal) {
                        modal.remove();
                    }
                });
                
                // Escape key to close
                document.addEventListener('keydown', function(event) {
                    if (event.key === 'Escape' && modal.classList.contains('is-visible')) {
                        modal.remove();
                    }
                });
            }
        })();

        // Baja de Productos
        (function () {
            var trigger = document.querySelector('[data-settings-action="baja-productos"]');
            if (!trigger) return;

            trigger.addEventListener('click', function (event) {
                event.preventDefault();
                if (showCustomConfirm('¬øDar de baja productos seleccionados?')) {
                    showToast('Procesando baja de productos...', 'info');
                    setTimeout(function() {
                        showToast('Productos dados de baja exitosamente', 'success');
                    }, 2000);
                }
            });
        })();

        // Configurar Stock M√≠nimo
        (function () {
            var trigger = document.querySelector('[data-settings-action="configurar-stock-minimo"]');
            if (!trigger) return;

            trigger.addEventListener('click', function (event) {
                event.preventDefault();
                openStockMinimoModal();
            });

            function openStockMinimoModal() {
                var modalHtml = `
                    <div class="modal" id="stock-minimo-modal" aria-hidden="true">
                        <div class="modal-dialog">
                            <div class="modal-header">
                                <h2>Configurar Stock M√≠nimo</h2>
                                <button type="button" class="modal-close" data-close-stock-minimo>&times;</button>
                            </div>
                            <div class="modal-content">
                                <div class="stock-config-form">
                                    <div class="config-section">
                                        <h3>Configuraci√≥n Global</h3>
                                        <div class="form-field">
                                            <label>Stock M√≠nimo por Defecto</label>
                                            <input type="number" id="stock-default" value="5" min="0" placeholder="Unidades">
                                        </div>
                                        
                                        <div class="form-field">
                                            <label>Alerta de Stock Bajo</label>
                                            <input type="number" id="alerta-stock" value="10" min="0" placeholder="Unidades">
                                        </div>
                                        
                                        <div class="form-field">
                                            <label>
                                                <input type="checkbox" id="alertas-automaticas" checked>
                                                Activar alertas autom√°ticas
                                            </label>
                                        </div>
                                        
                                        <div class="form-field">
                                            <label>
                                                <input type="checkbox" id="bloquear-venta" checked>
                                                Bloquear venta sin stock
                                            </label>
                                        </div>
                                    </div>
                                    
                                    <div class="config-section">
                                        <h3>Configuraci√≥n por Categor√≠a</h3>
                                        <div class="category-stock-list">
                                            <div class="category-item">
                                                <label>Smartphones</label>
                                                <input type="number" value="3" min="0" class="stock-input">
                                                <input type="number" value="5" min="0" class="alerta-input">
                                            </div>
                                            <div class="category-item">
                                                <label>Accesorios</label>
                                                <input type="number" value="10" min="0" class="stock-input">
                                                <input type="number" value="15" min="0" class="alerta-input">
                                            </div>
                                            <div class="category-item">
                                                <label>Repuestos</label>
                                                <input type="number" value="5" min="0" class="stock-input">
                                                <input type="number" value="8" min="0" class="alerta-input">
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="config-section">
                                        <h3>Notificaciones</h3>
                                        <div class="form-field">
                                            <label>Email para Alertas</label>
                                            <input type="email" id="email-alertas" value="admin@negocio.com" placeholder="email@ejemplo.com">
                                        </div>
                                        
                                        <div class="form-field">
                                            <label>Frecuencia de Alertas</label>
                                            <select id="frecuencia-alertas">
                                                <option value="diario">Diario</option>
                                                <option value="semanal" selected>Semanal</option>
                                                <option value="mensual">Mensual</option>
                                                <option value="inmediato">Inmediato</option>
                                            </select>
                                        </div>
                                        
                                        <div class="form-field">
                                            <label>
                                                <input type="checkbox" id="alertas-dashboard" checked>
                                                Mostrar alertas en dashboard
                                            </label>
                                        </div>
                                    </div>
                                    
                                    <div class="products-low-stock">
                                        <h4>Productos con Stock Bajo Actual</h4>
                                        <div class="low-stock-list">
                                            <div class="low-stock-item">
                                                <span class="product-name">iPhone 13 Pro - 128GB</span>
                                                <span class="current-stock">2 unidades</span>
                                                <span class="status critical">Cr√≠tico</span>
                                            </div>
                                            <div class="low-stock-item">
                                                <span class="product-name">Samsung Galaxy S21</span>
                                                <span class="current-stock">4 unidades</span>
                                                <span class="status warning">Bajo</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="modal-actions">
                                    <button type="button" class="btn btn-secondary" data-close-stock-minimo>Cancelar</button>
                                    <button type="button" class="btn btn-primary" data-save-stock-minimo>Guardar Configuraci√≥n</button>
                                    <button type="button" class="btn btn-outline" data-aplicar-todos>Aplicar a Todos</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.insertAdjacentHTML('beforeend', modalHtml);
                var modal = document.getElementById('stock-minimo-modal');
                modal.setAttribute('aria-hidden', 'false');
                modal.classList.add('is-visible');
                
                // Close handlers
                modal.querySelectorAll('[data-close-stock-minimo]').forEach(function(btn) {
                    btn.addEventListener('click', function() {
                        modal.remove();
                    });
                });
                
                // Save configuration
                modal.querySelector('[data-save-stock-minimo]').addEventListener('click', function() {
                    var config = {
                        stockDefault: document.getElementById('stock-default').value,
                        alertaStock: document.getElementById('alerta-stock').value,
                        alertasAutomaticas: document.getElementById('alertas-automaticas').checked,
                        bloquearVenta: document.getElementById('bloquear-venta').checked,
                        emailAlertas: document.getElementById('email-alertas').value,
                        frecuenciaAlertas: document.getElementById('frecuencia-alertas').value,
                        alertasDashboard: document.getElementById('alertas-dashboard').checked
                    };
                    
                    // Save to localStorage
                    localStorage.setItem('stock_config', JSON.stringify(config));
                    
                    showToast('Configuraci√≥n de stock guardada exitosamente', 'success');
                    modal.remove();
                });
                
                // Apply to all
                modal.querySelector('[data-aplicar-todos]').addEventListener('click', function() {
                    if (showCustomConfirm('¬øAplicar configuraci√≥n global a todos los productos?')) {
                        showToast('Aplicando configuraci√≥n a todos los productos...', 'info');
                        setTimeout(function() {
                            showToast('Configuraci√≥n aplicada a todos los productos', 'success');
                        }, 2000);
                    }
                });
                
                // Click outside to close
                modal.addEventListener('click', function(event) {
                    if (event.target === modal) {
                        modal.remove();
                    }
                });
                
                // Escape key to close
                document.addEventListener('keydown', function(event) {
                    if (event.key === 'Escape' && modal.classList.contains('is-visible')) {
                        modal.remove();
                    }
                });
            }
        })();

        // Editar Factura
        (function () {
            var trigger = document.querySelector('[data-settings-action="editar-factura"]');
            if (!trigger) return;

            trigger.addEventListener('click', function (event) {
                event.preventDefault();
                openEditFacturaModal();
            });

            function openEditFacturaModal() {
                var modalHtml = `
                    <div class="modal" id="edit-factura-modal" aria-hidden="true">
                        <div class="modal-dialog">
                            <div class="modal-header">
                                <h2>Editar Configuraci√≥n de Factura</h2>
                                <button type="button" class="modal-close" data-close-edit-factura>&times;</button>
                            </div>
                            <div class="modal-content">
                                <div class="factura-config-form">
                                    <div class="form-field">
                                        <label>N√∫mero de Resoluci√≥n DGII</label>
                                        <input type="text" id="resolucion-dgii" value="RES-123456789" placeholder="RES-XXXXXXXXX">
                                    </div>
                                    
                                    <div class="form-field">
                                        <label>RNC/C√©dula del Emisor</label>
                                        <input type="text" id="emisor-rnc" value="131234567" placeholder="XXXXXXXXX">
                                    </div>
                                    
                                    <div class="form-field">
                                        <label>Nombre del Emisor</label>
                                        <input type="text" id="emisor-nombre" value="Mi Empresa SRL" placeholder="Nombre de la empresa">
                                    </div>
                                    
                                    <div class="form-field">
                                        <label>Tipo de Comprobante</label>
                                        <select id="tipo-comprobante">
                                            <option value="01">Factura de Cr√©dito Fiscal</option>
                                            <option value="02">Factura de Consumo</option>
                                            <option value="03">Nota de D√©bito</option>
                                            <option value="04">Nota de Cr√©dito</option>
                                            <option value="11">Factura de Proveedor</option>
                                            <option value="12">Comprobante de Gasto Menor</option>
                                        </select>
                                    </div>
                                    
                                    <div class="form-field">
                                        <label>Formato de Factura</label>
                                        <select id="formato-factura">
                                            <option value="standard" selected>Est√°ndar DGII</option>
                                            <option value="simplified">Simplificado</option>
                                            <option value="detailed">Detallado</option>
                                            <option value="thermal">T√©rmico (80mm)</option>
                                            <option value="letter">Carta (Letter)</option>
                                            <option value="a4">A4</option>
                                        </select>
                                    </div>
                                    
                                    <div class="form-field" id="formato-config">
                                        <label>Configuraci√≥n Adicional</label>
                                        <div id="standard-options" class="formato-options">
                                            <div class="option-item">
                                                <label>
                                                    <input type="checkbox" id="include-watermark" checked>
                                                    Marca de agua
                                                </label>
                                            </div>
                                            <div class="option-item">
                                                <label>
                                                    <input type="checkbox" id="include-footer" checked>
                                                    Pie de p√°gina completo
                                                </label>
                                            </div>
                                        </div>
                                        
                                        <div id="simplified-options" class="formato-options" style="display: none;">
                                            <div class="option-item">
                                                <label>
                                                    <input type="checkbox" id="simple-items" checked>
                                                    Items simplificados
                                                </label>
                                            </div>
                                            <div class="option-item">
                                                <label>
                                                    <input type="checkbox" id="no-taxes">
                                                    Sin desglose de impuestos
                                                </label>
                                            </div>
                                        </div>
                                        
                                        <div id="thermal-options" class="formato-options" style="display: none;">
                                            <div class="option-item">
                                                <label>
                                                    <input type="checkbox" id="compact-mode" checked>
                                                    Modo compacto
                                                </label>
                                            </div>
                                            <div class="option-item">
                                                <label>
                                                    <input type="checkbox" id="cut-line">
                                                    L√≠nea de corte
                                                </label>
                                            </div>
                                        </div>
                                        
                                        <div id="detailed-options" class="formato-options" style="display: none;">
                                            <div class="option-item">
                                                <label>
                                                    <input type="checkbox" id="include-images" checked>
                                                    Incluir im√°genes de productos
                                                </label>
                                            </div>
                                            <div class="option-item">
                                                <label>
                                                    <input type="checkbox" id="include-specs" checked>
                                                    Especificaciones t√©cnicas
                                                </label>
                                            </div>
                                        </div>
                                        
                                        <div id="letter-options" class="formato-options" style="display: none;">
                                            <div class="option-item">
                                                <label>
                                                    <input type="checkbox" id="letter-header" checked>
                                                    Encabezado completo
                                                </label>
                                            </div>
                                            <div class="option-item">
                                                <label>
                                                    <input type="checkbox" id="letter-watermark">
                                                    Marca de agua sutil
                                                </label>
                                            </div>
                                        </div>
                                        
                                        <div id="a4-options" class="formato-options" style="display: none;">
                                            <div class="option-item">
                                                <label>
                                                    <input type="checkbox" id="a4-header" checked>
                                                    Encabezado corporativo
                                                </label>
                                            </div>
                                            <div class="option-item">
                                                <label>
                                                    <input type="checkbox" id="a4-footer" checked>
                                                    Pie de p√°gina extendido
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="form-field">
                                        <label>Serie de Factura</label>
                                        <input type="text" id="serie-factura" value="A0101" placeholder="Ej: A0101">
                                    </div>
                                    
                                    <div class="form-field">
                                        <label>Secuencia Inicial</label>
                                        <input type="number" id="secuencia-inicial" value="1" min="1" placeholder="1">
                                    </div>
                                    
                                    <div class="form-field">
                                        <label>Informaci√≥n Adicional</label>
                                        <textarea id="info-adicional" rows="3" placeholder="Informaci√≥n adicional para la factura">NCF v√°lido hasta 31/12/2025</textarea>
                                    </div>
                                    
                                    <div class="form-field">
                                        <label>
                                            <input type="checkbox" id="incluir-ITBIS" checked>
                                            Incluir desglose de ITBIS
                                        </label>
                                    </div>
                                    
                                    <div class="form-field">
                                        <label>
                                            <input type="checkbox" id="incluir-leyendas" checked>
                                            Incluir leyendas fiscales
                                        </label>
                                    </div>
                                    
                                    <div class="form-field">
                                        <label>
                                            <input type="checkbox" id="incluir-logo" checked>
                                            Incluir logo de la empresa
                                        </label>
                                    </div>
                                    
                                    <div class="form-field" id="logo-config">
                                        <label>Tama√±o del Logo</label>
                                        <select id="tamano-logo">
                                            <option value="small">Peque√±o (20mm)</option>
                                            <option value="medium" selected>Mediano (30mm)</option>
                                            <option value="large">Grande (40mm)</option>
                                        </select>
                                    </div>
                                    
                                    <div class="form-field" id="logo-position">
                                        <label>Posici√≥n del Logo</label>
                                        <select id="posicion-logo">
                                            <option value="top-left" selected>Superior Izquierda</option>
                                            <option value="top-center">Superior Centro</option>
                                            <option value="top-right">Superior Derecha</option>
                                            <option value="bottom-left">Inferior Izquierda</option>
                                            <option value="bottom-center">Inferior Centro</option>
                                            <option value="bottom-right">Inferior Derecha</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="modal-actions">
                                    <button type="button" class="btn btn-secondary" data-close-edit-factura>Cancelar</button>
                                    <button type="button" class="btn btn-primary" data-save-edit-factura>Guardar Configuraci√≥n</button>
                                    <button type="button" class="btn btn-outline" data-preview-factura>Vista Previa</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.insertAdjacentHTML('beforeend', modalHtml);
                var modal = document.getElementById('edit-factura-modal');
                modal.setAttribute('aria-hidden', 'false');
                modal.classList.add('is-visible');
                
                // Close handlers
                modal.querySelectorAll('[data-close-edit-factura]').forEach(function(btn) {
                    btn.addEventListener('click', function() {
                        modal.remove();
                    });
                });
                
                // Save configuration
                modal.querySelector('[data-save-edit-factura]').addEventListener('click', function() {
                    var config = {
                        resolucionDGII: document.getElementById('resolucion-dgii').value,
                        emisorRNC: document.getElementById('emisor-rnc').value,
                        emisorNombre: document.getElementById('emisor-nombre').value,
                        tipoComprobante: document.getElementById('tipo-comprobante').value,
                        formatoFactura: document.getElementById('formato-factura').value,
                        serieFactura: document.getElementById('serie-factura').value,
                        secuenciaInicial: document.getElementById('secuencia-inicial').value,
                        infoAdicional: document.getElementById('info-adicional').value,
                        incluirITBIS: document.getElementById('incluir-ITBIS').checked,
                        incluirLeyendas: document.getElementById('incluir-leyendas').checked,
                        incluirLogo: document.getElementById('incluir-logo').checked,
                        tamanoLogo: document.getElementById('tamano-logo').value,
                        posicionLogo: document.getElementById('posicion-logo').value,
                        // Opciones de formato
                        includeWatermark: document.getElementById('include-watermark')?.checked || false,
                        includeFooter: document.getElementById('include-footer')?.checked || false,
                        simpleItems: document.getElementById('simple-items')?.checked || false,
                        noTaxes: document.getElementById('no-taxes')?.checked || false,
                        compactMode: document.getElementById('compact-mode')?.checked || false,
                        cutLine: document.getElementById('cut-line')?.checked || false,
                        includeImages: document.getElementById('include-images')?.checked || false,
                        includeSpecs: document.getElementById('include-specs')?.checked || false,
                        letterHeader: document.getElementById('letter-header')?.checked || false,
                        letterWatermark: document.getElementById('letter-watermark')?.checked || false,
                        a4Header: document.getElementById('a4-header')?.checked || false,
                        a4Footer: document.getElementById('a4-footer')?.checked || false
                    };
                    
                    // Save to localStorage
                    localStorage.setItem('factura_config', JSON.stringify(config));
                    
                    showToast('Configuraci√≥n de factura guardada exitosamente', 'success');
                    modal.remove();
                });
                
                // Toggle logo options
                var incluirLogoCheckbox = document.getElementById('incluir-logo');
                var logoConfig = document.getElementById('logo-config');
                var logoPosition = document.getElementById('logo-position');
                
                function toggleLogoOptions() {
                    var showLogo = incluirLogoCheckbox.checked;
                    logoConfig.style.display = showLogo ? 'block' : 'none';
                    logoPosition.style.display = showLogo ? 'block' : 'none';
                }
                
                incluirLogoCheckbox.addEventListener('change', toggleLogoOptions);
                toggleLogoOptions(); // Initialize state
                
                // Toggle formato options
                var formatoSelect = document.getElementById('formato-factura');
                var formatoOptions = {
                    'standard': document.getElementById('standard-options'),
                    'simplified': document.getElementById('simplified-options'),
                    'thermal': document.getElementById('thermal-options'),
                    'detailed': document.getElementById('detailed-options'),
                    'letter': document.getElementById('letter-options'),
                    'a4': document.getElementById('a4-options')
                };
                
                function toggleFormatoOptions() {
                    var selectedFormato = formatoSelect.value;
                    
                    // Hide all options
                    Object.values(formatoOptions).forEach(function(options) {
                        if (options) options.style.display = 'none';
                    });
                    
                    // Show selected options
                    if (formatoOptions[selectedFormato]) {
                        formatoOptions[selectedFormato].style.display = 'block';
                    }
                }
                
                formatoSelect.addEventListener('change', toggleFormatoOptions);
                toggleFormatoOptions(); // Initialize state
                
                // Preview
                modal.querySelector('[data-preview-factura]').addEventListener('click', function() {
                    var config = {
                        resolucionDGII: document.getElementById('resolucion-dgii').value,
                        emisorRNC: document.getElementById('emisor-rnc').value,
                        emisorNombre: document.getElementById('emisor-nombre').value,
                        tipoComprobante: document.getElementById('tipo-comprobante').value,
                        formatoFactura: document.getElementById('formato-factura').value,
                        serieFactura: document.getElementById('serie-factura').value,
                        secuenciaInicial: document.getElementById('secuencia-inicial').value,
                        infoAdicional: document.getElementById('info-adicional').value,
                        incluirITBIS: document.getElementById('incluir-ITBIS').checked,
                        incluirLeyendas: document.getElementById('incluir-leyendas').checked,
                        incluirLogo: document.getElementById('incluir-logo').checked,
                        tamanoLogo: document.getElementById('tamano-logo').value,
                        posicionLogo: document.getElementById('posicion-logo').value
                    };
                    
                    showToast('Generando vista previa de factura...', 'info');
                    
                    // Abrir visor PDF en nueva ventana
                    setTimeout(function() {
                        var pdfUrl = '/app/factura/preview/?' + new URLSearchParams({
                            tipo: config.tipoComprobante,
                            formato: config.formatoFactura,
                            serie: config.serieFactura,
                            emisor: config.emisorNombre,
                            rnc: config.emisorRNC,
                            resolucion: config.resolucionDGII,
                            incluir_itbis: config.incluirITBIS,
                            incluir_leyendas: config.incluirLeyendas,
                            incluir_logo: config.incluirLogo,
                            tamano_logo: config.tamanoLogo,
                            posicion_logo: config.posicionLogo,
                            preview: 'true'
                        }).toString();
                        
                        // Abrir en nueva ventana para vista previa e impresi√≥n
                        window.open(pdfUrl, '_blank', 'width=900,height=700,scrollbars=yes,resizable=yes');
                        showToast('Vista previa abierta en nueva ventana', 'success');
                    }, 1000);
                });
                
                // Click outside to close
                modal.addEventListener('click', function(event) {
                    if (event.target === modal) {
                        modal.remove();
                    }
                });
                
                // Escape key to close
                document.addEventListener('keydown', function(event) {
                    if (event.key === 'Escape' && modal.classList.contains('is-visible')) {
                        modal.remove();
                    }
                });
            }
        })();

        // Eliminar Registro DB
        (function () {
            var trigger = document.querySelector('[data-settings-action="eliminar-registro-db"]');
            if (!trigger) return;

            trigger.addEventListener('click', function (event) {
                event.preventDefault();
                if (showCustomConfirm('¬øEliminar registro seleccionado? Esta acci√≥n no se puede deshacer.')) {
                    showToast('Eliminando registro de la base de datos...', 'warning');
                    setTimeout(function() {
                        showToast('Registro eliminado exitosamente', 'success');
                    }, 1500);
                }
            });
        })();

        // Importar Producto
        (function () {
            var trigger = document.querySelector('[data-settings-action="importar-producto"]');
            if (!trigger) return;

            trigger.addEventListener('click', function (event) {
                event.preventDefault();
                showToast('Abriendo importador de productos...', 'info');
                // TODO: Implementar importador de productos
            });
        })();

        // Descargar Plantilla
        (function () {
            var trigger = document.querySelector('[data-settings-action="descargar-plantilla"]');
            if (!trigger) return;

            trigger.addEventListener('click', function (event) {
                event.preventDefault();
                showToast('Descargando plantilla de importaci√≥n...', 'info');
                // Simular descarga
                setTimeout(function() {
                    showToast('Plantilla descargada exitosamente', 'success');
                }, 1000);
            });
        })();

        // Copia de Seguridad DB
        (function () {
            var trigger = document.querySelector('[data-settings-action="copia-seguridad-db"]');
            if (!trigger) return;

            trigger.addEventListener('click', function (event) {
                event.preventDefault();
                if (showCustomConfirm('¬øCrear copia de seguridad de la base de datos?')) {
                    trigger.innerHTML = '<span class="settings-tile__icon">‚è≥</span><span class="settings-tile__label">Creando backup...</span>';
                    trigger.disabled = true;
                    
                    setTimeout(function() {
                        showToast('Copia de seguridad creada exitosamente', 'success');
                        trigger.innerHTML = '<span class="settings-tile__icon" aria-hidden="true">üíæ</span><span class="settings-tile__label">Copia Seguridad BD</span>';
                        trigger.disabled = false;
                    }, 3000);
                }
            });
        })();
        
        function showCustomConfirm(message) {
            return showToast(message + ' (Acci√≥n requerida)', 'warning');
        }
    </script>
{% endblock %}
