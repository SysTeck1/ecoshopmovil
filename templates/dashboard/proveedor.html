{% extends "dashboard/base.html" %}
{% block title %}Proveedor{% endblock %}
{% block page_title %}Proveedores{% endblock %}
{% block content %}
<section class="providers-section">
    <div class="providers-header">
        <p class="providers-description">
            Gestiona tus proveedores: registra nuevos, mantén su información al día y consulta su historial de compras.
        </p>
        <button type="button" class="btn btn-primary" id="open-create-provider-modal">Registrar proveedor</button>
    </div>
    
    <div class="filter-toolbar" data-filter-toolbar>
        <div class="filter-toolbar__fields">
            <div class="filter-toolbar__field">
                <span class="filter-toolbar__label">Buscar</span>
                <div class="filter-toolbar__control filter-toolbar__control--icon">
                    <i class="ri-search-line filter-toolbar__icon"></i>
                    <input type="text" id="providers-search" placeholder="Buscar por nombre, documento, teléfono...">
                </div>
            </div>
            <div class="filter-toolbar__field">
                <span class="filter-toolbar__label">Tipo documento</span>
                <div class="filter-toolbar__control filter-toolbar__control--icon">
                    <i class="ri-id-card-line filter-toolbar__icon"></i>
                    <select id="provider-document-type-filter">
                        <option value="">Todos los tipos</option>
                        <option value="cedula">Cédula</option>
                        <option value="rnc">RNC</option>
                        <option value="pasaporte">Pasaporte</option>
                        <option value="otro">Otro</option>
                    </select>
                    <i class="ri-arrow-down-s-line filter-toolbar__chevron"></i>
                </div>
            </div>
        </div>
        <div class="filter-toolbar__actions">
            <button type="button" class="btn btn-outline" id="clear-providers-filters">
                <i class="ri-refresh-line"></i>
                Limpiar
            </button>
            <button type="button" class="btn btn-secondary" id="apply-providers-filters">
                <i class="ri-filter-3-line"></i>
                Filtrar
            </button>
        </div>
    </div>
    <div class="table-wrapper">
        <table class="providers-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Nombre</th>
                    <th>Tipo de documento</th>
                    <th>Documento</th>
                    <th>Teléfono</th>
                    <th>Correo</th>
                    <th>Dirección</th>
                    <th class="actions-column">Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% for proveedor in proveedores_page %}
                    <tr>
                        <td>{{ proveedor.codigo }}</td>
                        <td>{{ proveedor.nombre|default:"-" }}</td>
                        <td>{{ proveedor.get_tipo_documento_display|default:"-" }}</td>
                        <td>{{ proveedor.documento|default:"-" }}</td>
                        <td>{{ proveedor.telefono|default:"-" }}</td>
                        <td>{{ proveedor.correo|default:"-" }}</td>
                        <td>{{ proveedor.direccion|default:"-" }}</td>
                        <td class="actions-column">
                            <a href="#" class="btn btn-secondary btn-link" aria-disabled="true">Ver historial</a>
                            <form method="post" class="inline-form" data-action="edit" data-proveedor="{{ proveedor.nombre }}">
                                {% csrf_token %}
                                <input type="hidden" name="action" value="edit_modal">
                                <input type="hidden" name="proveedor_id" value="{{ proveedor.id }}">
                                <button type="submit" class="btn btn-secondary">Editar</button>
                            </form>
                            <form method="post" class="inline-form delete-form" data-proveedor="{{ proveedor.nombre }}">
                                {% csrf_token %}
                                <input type="hidden" name="action" value="delete">
                                <input type="hidden" name="proveedor_id" value="{{ proveedor.id }}">
                                <button type="submit" class="btn btn-danger">Eliminar</button>
                            </form>
                        </td>
                    </tr>
                {% empty %}
                    <tr>
                        <td colspan="8" class="empty-state">No se han registrado proveedores todavía.</td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% if proveedores_page.has_other_pages %}
        <nav class="pagination" aria-label="Paginación de proveedores">
            <ul class="pagination__list">
                {% if proveedores_page.has_previous %}
                    <li class="pagination__item">
                        <a class="pagination__link" href="?page={{ proveedores_page.previous_page_number }}{% if pagination_querystring %}&{{ pagination_querystring }}{% endif %}" aria-label="Página anterior">&laquo;</a>
                    </li>
                {% else %}
                    <li class="pagination__item pagination__item--disabled"><span class="pagination__link" aria-hidden="true">&laquo;</span></li>
                {% endif %}

                {% for num in proveedores_page.paginator.page_range %}
                    {% if num == proveedores_page.number %}
                        <li class="pagination__item pagination__item--active"><span class="pagination__link">{{ num }}</span></li>
                    {% else %}
                        <li class="pagination__item">
                            <a class="pagination__link" href="?page={{ num }}{% if pagination_querystring %}&{{ pagination_querystring }}{% endif %}">{{ num }}</a>
                        </li>
                    {% endif %}
                {% endfor %}

                {% if proveedores_page.has_next %}
                    <li class="pagination__item">
                        <a class="pagination__link" href="?page={{ proveedores_page.next_page_number }}{% if pagination_querystring %}&{{ pagination_querystring }}{% endif %}" aria-label="Página siguiente">&raquo;</a>
                    </li>
                {% else %}
                    <li class="pagination__item pagination__item--disabled"><span class="pagination__link" aria-hidden="true">&raquo;</span></li>
                {% endif %}
            </ul>
        </nav>
    {% endif %}
</section>

<div
    class="modal"
    id="create-provider-modal"
    aria-hidden="true"
    data-force-open="{{ force_modal_open|yesno:'true,false' }}"
    data-mode="{{ modal_mode }}"
    data-next-codigo="{{ next_codigo }}"
>
    <div class="modal-dialog" role="dialog" aria-modal="true" aria-labelledby="create-provider-title">
        <div class="modal-header">
            <h2 id="create-provider-title">{% if modal_mode == 'edit' %}Editar proveedor{% else %}Registrar proveedor{% endif %}</h2>
            <button type="button" class="modal-close" aria-label="Cerrar" data-close-modal>&times;</button>
        </div>
        <form method="post" class="modal-form">
            {% csrf_token %}
            <input type="hidden" name="action" id="provider-modal-action" value="{% if modal_mode == 'edit' %}update{% else %}create{% endif %}">
            <input type="hidden" name="proveedor_id" id="provider-modal-id" value="{{ editing_proveedor_id|default:'' }}">
            {% if form.non_field_errors %}
                <div class="form-errors">
                    {% for error in form.non_field_errors %}
                        <p>{{ error }}</p>
                    {% endfor %}
                </div>
            {% endif %}
            <div class="form-grid">
                <label class="form-field">
                    <span class="form-label">ID</span>
                    <input type="text" id="provider-modal-codigo" value="{{ modal_codigo }}" readonly>
                </label>
                <label class="form-field">
                    <span class="form-label">Nombre</span>
                    {{ form.nombre }}
                    {% if form.nombre.errors %}
                        <span class="field-error">{{ form.nombre.errors|join:", " }}</span>
                    {% endif %}
                </label>
                <label class="form-field">
                    <span class="form-label">Tipo de documento</span>
                    {{ form.tipo_documento }}
                    {% if form.tipo_documento.errors %}
                        <span class="field-error">{{ form.tipo_documento.errors|join:", " }}</span>
                    {% endif %}
                </label>
                <label class="form-field">
                    <span class="form-label">Documento</span>
                    {{ form.documento }}
                    {% if form.documento.errors %}
                        <span class="field-error">{{ form.documento.errors|join:", " }}</span>
                    {% endif %}
                </label>
                <label class="form-field">
                    <span class="form-label">Teléfono</span>
                    {{ form.telefono }}
                    {% if form.telefono.errors %}
                        <span class="field-error">{{ form.telefono.errors|join:", " }}</span>
                    {% endif %}
                </label>
                <label class="form-field">
                    <span class="form-label">Correo electrónico</span>
                    {{ form.correo }}
                    {% if form.correo.errors %}
                        <span class="field-error">{{ form.correo.errors|join:", " }}</span>
                    {% endif %}
                </label>
                <label class="form-field form-field--full">
                    <span class="form-label">Dirección</span>
                    {{ form.direccion }}
                    {% if form.direccion.errors %}
                        <span class="field-error">{{ form.direccion.errors|join:", " }}</span>
                    {% endif %}
                </label>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" data-close-modal>Cancelar</button>
                <button type="submit" class="btn btn-primary" id="provider-modal-submit">
                    {% if modal_mode == 'edit' %}Actualizar proveedor{% else %}Guardar proveedor{% endif %}
                </button>
            </div>
        </form>
    </div>
</div>

<div class="confirm-dialog" id="provider-confirm-delete" aria-hidden="true" role="alertdialog" aria-modal="true" aria-labelledby="provider-confirm-title">
    <div class="confirm-dialog__panel">
        <h3 id="provider-confirm-title">Eliminar proveedor</h3>
        <p id="provider-confirm-message">¿Seguro que deseas eliminar a este proveedor?</p>
        <div class="confirm-dialog__actions">
            <button type="button" class="btn btn-secondary" data-provider-cancel>Cancelar</button>
            <button type="button" class="btn btn-danger" data-provider-accept>Eliminar</button>
        </div>
    </div>
</div>

<style>
    .btn-link {
        display: inline-block;
        text-decoration: none;
        margin-right: 6px;
        cursor: not-allowed;
    }

    .inline-form {
        display: inline;
        margin: 0 6px 0 0;
    }

    .inline-form:last-child {
        margin-right: 0;
    }

    .inline-form button {
        margin: 0;
    }

    .inline-form.delete-form button {
        margin-left: 0;
    }

    .providers-section {
        display: flex;
        flex-direction: column;
        gap: 20px;
    }

    .providers-header {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        justify-content: space-between;
        gap: 16px;
    }

    .providers-description {
        margin: 0;
        max-width: 520px;
        color: #636e72;
    }

    .btn {
        border: none;
        border-radius: 6px;
        padding: 8px 14px;
        font-size: 0.9rem;
        font-weight: 600;
        cursor: pointer;
        transition: none;
    }

    .btn-primary {
        background-color: #0097e6;
        color: #ffffff;
    }

    .btn-primary:hover {
        background-color: #00a8ff;
    }

    .btn-secondary {
        background-color: #dcdde1;
        color: #2f3640;
        margin-right: 6px;
    }

    .btn-secondary:hover {
        background-color: #ced6e0;
    }

    .btn-danger {
        background-color: #e84118;
        color: #ffffff;
    }

    .btn-danger:hover {
        background-color: #ff4757;
    }

    .table-wrapper {
        overflow-x: auto;
        border-radius: 8px;
        background-color: #ffffff;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
    }

    .providers-table {
        width: 100%;
        border-collapse: collapse;
    }

    .providers-table thead {
        background-color: #273c75;
        color: #f5f6fa;
    }

    .providers-table th,
    .providers-table td {
        padding: 12px 16px;
        text-align: left;
        border-bottom: 1px solid #ecf0f1;
        white-space: nowrap;
    }

    .providers-table tbody tr:hover {
        background-color: #f1f2f6;
    }

    .actions-column {
        white-space: nowrap;
        text-align: right;
    }

    .empty-state {
        text-align: center;
        color: #95a5a6;
        padding: 24px;
    }

    .form-errors {
        background-color: #f8d7da;
        color: #721c24;
        padding: 12px;
        border-radius: 6px;
        margin-bottom: 16px;
    }

    .field-error {
        color: #e84118;
        font-size: 0.85rem;
    }

    .modal {
        position: fixed;
        inset: 0;
        background-color: rgba(0, 0, 0, 0.4);
        display: none;
        align-items: center;
        justify-content: center;
        padding: 24px;
        z-index: 1000;
    }

    .modal.is-visible {
        display: flex;
    }

    .modal-dialog {
        background-color: #ffffff;
        border-radius: 10px;
        max-width: 720px;
        width: 100%;
        box-shadow: 0 12px 30px rgba(0, 0, 0, 0.12);
        overflow: hidden;
        display: flex;
        flex-direction: column;
    }

    .modal-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 18px 24px;
        border-bottom: 1px solid #ecf0f1;
    }

    .modal-header h2 {
        margin: 0;
        font-size: 1.2rem;
    }

    .modal-close {
        border: none;
        background: none;
        font-size: 1.5rem;
        cursor: pointer;
        color: #636e72;
    }

    .modal-form {
        padding: 24px;
        display: flex;
        flex-direction: column;
        gap: 24px;
    }

    .form-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 16px;
    }

    .form-field {
        display: flex;
        flex-direction: column;
        gap: 6px;
    }

    .form-field--full {
        grid-column: 1 / -1;
    }

    .form-label {
        font-weight: 600;
        color: #2f3640;
    }

    .form-field input,
    .form-field select,
    .form-field textarea {
        border: 1px solid #dcdde1;
        border-radius: 6px;
        padding: 10px;
        font-size: 0.95rem;
        background-color: #ffffff;
        width: 100%;
        box-sizing: border-box;
    }

    .form-field input:focus,
    .form-field select:focus,
    .form-field textarea:focus {
        outline: none;
        border-color: #0097e6;
        box-shadow: 0 0 0 2px rgba(0, 151, 230, 0.1);
    }

    .modal-actions {
        display: flex;
        justify-content: flex-end;
        gap: 12px;
    }

    .confirm-dialog {
        position: fixed;
        inset: 0;
        background-color: rgba(0, 0, 0, 0.45);
        display: none;
        align-items: center;
        justify-content: center;
        padding: 24px;
        z-index: 1050;
    }

    .confirm-dialog.is-visible {
        display: flex;
    }

    .confirm-dialog__panel {
        background-color: #ffffff;
        border-radius: 10px;
        max-width: 420px;
        width: 100%;
        padding: 24px;
        box-shadow: 0 12px 30px rgba(0, 0, 0, 0.18);
    }

    .confirm-dialog__panel h3 {
        margin-top: 0;
        margin-bottom: 12px;
        font-size: 1.25rem;
        color: #e84118;
    }

    .confirm-dialog__panel p {
        margin: 0 0 18px 0;
        color: #2f3640;
    }

    .confirm-dialog__actions {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
    }

    @media (max-width: 768px) {
        .providers-table th,
        .providers-table td {
            padding: 10px 12px;
        }

        .actions-column {
            text-align: left;
        }
    }

    @media (max-width: 540px) {
        .modal {
            padding: 12px;
        }

        .modal-dialog {
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-actions {
            flex-direction: column-reverse;
            align-items: stretch;
        }
    }
</style>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        var openButton = document.getElementById("open-create-provider-modal");
        var modal = document.getElementById("create-provider-modal");
        if (!openButton || !modal) {
            return;
        }

        var closeElements = modal.querySelectorAll("[data-close-modal]");
        var form = modal.querySelector(".modal-form");
        var actionInput = document.getElementById("provider-modal-action");
        var proveedorIdInput = document.getElementById("provider-modal-id");
        var modalTitle = document.getElementById("create-provider-title");
        var submitButton = document.getElementById("provider-modal-submit");
        var codigoInput = document.getElementById("provider-modal-codigo");

        function openModal() {
            modal.classList.add("is-visible");
            modal.setAttribute("aria-hidden", "false");
            var firstInput = modal.querySelector("[data-initial-focus='true']") || modal.querySelector("input[name='nombre']");
            if (firstInput) {
                firstInput.focus();
            }
            updateDocumentField();
        }

        function closeModal() {
            modal.classList.remove("is-visible");
            modal.setAttribute("aria-hidden", "true");
            openButton.focus();
        }

        openButton.addEventListener("click", function () {
            if (form) {
                form.reset();
            }
            if (actionInput) {
                actionInput.value = "create";
            }
            if (proveedorIdInput) {
                proveedorIdInput.value = "";
            }
            if (modalTitle) {
                modalTitle.textContent = "Registrar proveedor";
            }
            if (submitButton) {
                submitButton.textContent = "Guardar proveedor";
            }
            if (codigoInput) {
                codigoInput.value = modal.dataset.nextCodigo || codigoInput.value;
            }
            openModal();
        });

        closeElements.forEach(function (element) {
            element.addEventListener("click", closeModal);
        });

        // Evitar que el modal se cierre al hacer clic fuera
        modal.addEventListener("click", function (event) {
            var dialog = modal.querySelector(".modal-dialog");
            if (!dialog.contains(event.target) && !event.target.closest("[data-close-modal]")) {
                event.stopPropagation();
            }
        });

        document.addEventListener("keydown", function (event) {
            if (event.key === "Escape" && modal.classList.contains("is-visible")) {
                closeModal();
            }
        });

        var documentTypeSelect = modal.querySelector("select[name='tipo_documento']");
        var documentInput = modal.querySelector("input[name='documento']");

        function updateDocumentField() {
            if (!documentTypeSelect || !documentInput) {
                return;
            }

            var placeholders = {
                "rnc": "1-01-12345-6",
                "cedula": "000-0000000-0",
                "pasaporte": "A0000000",
                "otro": "Ingrese el documento"
            };

            var selected = documentTypeSelect.value;
            documentInput.placeholder = placeholders[selected] || "Ingrese el documento";
            documentInput.disabled = selected === "";
            if (selected === "") {
                documentInput.value = "";
            }
        }

        if (documentTypeSelect) {
            documentTypeSelect.addEventListener("change", updateDocumentField);
            updateDocumentField();
        }

        if (modal.dataset.forceOpen === "true") {
            openModal();
        }

        var confirmDialog = document.getElementById("provider-confirm-delete");
        var confirmMessage = document.getElementById("provider-confirm-message");
        var confirmAccept = confirmDialog ? confirmDialog.querySelector("[data-provider-accept]") : null;
        var confirmCancel = confirmDialog ? confirmDialog.querySelector("[data-provider-cancel]") : null;
        var formToSubmit = null;

        function openConfirmDialog(message, form) {
            formToSubmit = form;
            if (confirmMessage) {
                confirmMessage.textContent = message;
            }
            if (confirmDialog) {
                confirmDialog.classList.add("is-visible");
                confirmDialog.setAttribute("aria-hidden", "false");
            }
            if (confirmAccept) {
                confirmAccept.focus();
            }
        }

        function closeConfirmDialog() {
            if (confirmDialog) {
                confirmDialog.classList.remove("is-visible");
                confirmDialog.setAttribute("aria-hidden", "true");
            }
            formToSubmit = null;
        }

        document.querySelectorAll(".delete-form").forEach(function (formElement) {
            formElement.addEventListener("submit", function (event) {
                event.preventDefault();
                var nombre = formElement.dataset.proveedor || "este proveedor";
                var mensaje = "¿Seguro que deseas eliminar a " + nombre + "? Esta acción no se puede deshacer.";
                openConfirmDialog(mensaje, formElement);
            });
        });

        if (confirmCancel) {
            confirmCancel.addEventListener("click", function () {
                closeConfirmDialog();
            });
        }

        if (confirmAccept) {
            confirmAccept.addEventListener("click", function () {
                if (formToSubmit) {
                    formToSubmit.submit();
                }
                closeConfirmDialog();
            });
        }

        if (confirmDialog) {
            confirmDialog.addEventListener("click", function (event) {
                if (event.target === confirmDialog) {
                    closeConfirmDialog();
                }
            });
        }

        document.querySelectorAll("form[data-action='edit']").forEach(function (formElement) {
            formElement.addEventListener("submit", function (event) {
                var nombre = formElement.dataset.proveedor || "este proveedor";
                var mensaje = "Editarás los datos de " + nombre + ". Se abrirá el formulario con la información actual.";
                if (!window.confirm(mensaje)) {
                    event.preventDefault();
                }
            });
        });

        // Funcionalidad de filtros para proveedores
        var searchInput = document.getElementById('providers-search');
        var documentTypeFilter = document.getElementById('provider-document-type-filter');
        var applyFiltersBtn = document.getElementById('apply-providers-filters');
        var clearFiltersBtn = document.getElementById('clear-providers-filters');

        function applyFilters() {
            var params = new URLSearchParams();
            
            if (searchInput && searchInput.value.trim()) {
                params.set('search', searchInput.value.trim());
            }
            if (documentTypeFilter && documentTypeFilter.value) {
                params.set('tipo_documento', documentTypeFilter.value);
            }
            
            window.location.href = '?' + params.toString();
        }

        function clearFilters() {
            if (searchInput) searchInput.value = '';
            if (documentTypeFilter) documentTypeFilter.value = '';
            window.location.href = window.location.pathname;
        }

        if (applyFiltersBtn) {
            applyFiltersBtn.addEventListener('click', applyFilters);
        }

        if (clearFiltersBtn) {
            clearFiltersBtn.addEventListener('click', clearFilters);
        }

        // Aplicar filtros al presionar Enter en el campo de búsqueda
        if (searchInput) {
            searchInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    applyFilters();
                }
            });
        }

        // Cargar valores de filtros desde URL
        var urlParams = new URLSearchParams(window.location.search);
        if (searchInput && urlParams.get('search')) {
            searchInput.value = urlParams.get('search');
        }
        if (documentTypeFilter && urlParams.get('tipo_documento')) {
            documentTypeFilter.value = urlParams.get('tipo_documento');
        }
    });
</script>

<style>
    /* Estilos para filtros modernos */
    .filters-section {
        margin: 24px 0;
        background: var(--color-surface-card);
        border-radius: 16px;
        border: 1px solid var(--color-border-subtle);
        overflow: hidden;
    }

    .filters-container {
        padding: 20px 24px;
    }

    .filters-row {
        display: grid;
        grid-template-columns: 2fr 1fr auto;
        gap: 16px;
        align-items: end;
    }

    .filter-group {
        display: flex;
        flex-direction: column;
        gap: 6px;
    }

    .filter-label {
        font-size: 0.875rem;
        font-weight: 600;
        color: var(--color-text-main);
        margin: 0;
    }

    .search-input-wrapper {
        position: relative;
    }

    .filter-input, .filter-select {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid var(--color-border-subtle);
        border-radius: 8px;
        background: var(--color-surface-main);
        color: var(--color-text-main);
        font-size: 0.9rem;
        transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }

    .search-input {
        padding-right: 40px;
    }

    .search-icon {
        position: absolute;
        right: 12px;
        top: 50%;
        transform: translateY(-50%);
        color: var(--color-text-muted);
        font-size: 1.1rem;
        pointer-events: none;
    }

    .filter-input:focus, .filter-select:focus {
        outline: none;
        border-color: var(--color-primary);
        box-shadow: 0 0 0 3px rgba(var(--color-primary-rgb), 0.1);
    }

    .filter-actions {
        display: flex;
        gap: 8px;
        align-items: center;
    }

    .btn-sm {
        padding: 8px 16px;
        font-size: 0.875rem;
        min-height: auto;
    }

    /* Responsive design */
    @media (max-width: 768px) {
        .filters-row {
            grid-template-columns: 1fr;
            gap: 12px;
        }
        
        .filter-actions {
            justify-content: stretch;
        }
        
        .filter-actions .btn {
            flex: 1;
        }
    }

    @media (max-width: 480px) {
        .filters-container {
            padding: 16px;
        }
        
        .filter-actions {
            flex-direction: column;
            gap: 8px;
        }
    }
</style>
{% endblock %}
