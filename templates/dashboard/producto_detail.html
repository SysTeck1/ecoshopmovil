{% extends "dashboard/base.html" %}
{% block title %}Detalle de producto{% endblock %}
{% block page_title %}Detalle de producto{% endblock %}
{% block content %}
<section class="product-detail"
    data-product-id="{{ producto.id }}"
    data-detail-path="{% url 'dashboard:producto_detail' producto.id %}"
    data-product-name="{{ producto.nombre|default:"Producto"|escape }}"
    data-product-marca="{{ producto.marca|default:"Sin marca"|escape }}"
    data-product-modelo="{{ producto.modelo|default:"Sin modelo"|escape }}"
    data-product-categoria="{{ producto.categoria|default:"Sin categor√≠a"|escape }}"
    data-product-almacenamiento="{{ producto.almacenamiento|default:'' }}"
    data-product-almacenamiento-label="{{ producto.get_almacenamiento_display|default:"No especificado" }}"
    data-product-ram="{{ producto.memoria_ram|default:'' }}"
    data-product-ram-label="{{ producto.get_memoria_ram_display|default:"No especificada" }}"
    data-product-proveedor="{{ producto.proveedor|default:"Sin proveedor"|escape }}"
    data-product-costo="{{ producto.precio_compra|default_if_none:"" }}"
    data-product-precio="{{ producto.precio_venta|default_if_none:"" }}"
    data-product-descripcion="{{ producto.descripcion|default:""|escape }}"
    data-product-imagen="{{ producto_imagenes.0|default:"" }}"
    data-condition-api="{% url 'dashboard:product_condition_api' %}"
>
    <header class="product-detail__header">
        <div class="product-detail__title-group">
            <h2 class="product-detail__title">{{ producto.nombre }}</h2>
            <div class="product-detail__meta">
                {% if producto.marca %}<span class="product-detail__meta-item">Marca: {{ producto.marca }}</span>{% endif %}
                {% if producto.modelo %}<span class="product-detail__meta-item">Modelo: {{ producto.modelo }}</span>{% endif %}
                {% if producto.categoria %}<span class="product-detail__meta-item">Categor√≠a: {{ producto.categoria }}</span>{% endif %}
            </div>
        </div>
        <a class="btn btn-secondary" href="{% url 'dashboard:inventario' %}">Volver al inventario</a>
    </header>

    <section class="stock-gallery" aria-label="Inventario disponible">
        <header class="stock-gallery__header">
            <h3 class="stock-gallery__title">Unidades en stock</h3>
            <span class="stock-gallery__count">{{ producto.stock|default_if_none:0 }} unidades</span>
        </header>
        {% if unidades_stock %}
            <div class="stock-gallery__grid">
                {% for unidad in unidades_stock %}
                    <article class="stock-card {% if unidad.vendido %}stock-card--sold{% endif %}" data-unit-card="{{ unidad.index }}"
                        data-unit-imei="{{ unidad.imei|escape }}"
                        data-unit-color="{{ unidad.color|escape }}"
                        data-unit-storage="{{ unidad.almacenamiento|default:'' }}"
                        data-unit-storage-label="{{ unidad.almacenamiento_label|default:'No especificado' }}"
                        data-unit-ram="{{ unidad.memoria_ram|default:'' }}"
                        data-unit-ram-label="{{ unidad.memoria_ram_label|default:'No especificada' }}"
                        data-unit-battery="{{ unidad.vida_bateria|default:'' }}"
                        data-unit-condition="{{ unidad.producto_condicion|default:'' }}"
                        data-unit-condition-label="{{ unidad.producto_condicion_label|default:'Sin especificar' }}"
                        data-unit-has-custom="{{ unidad.has_custom|yesno:'true,false' }}"
                        data-unit-use-global="{{ unidad.usar_impuesto_global|yesno:'true,false' }}"
                        data-unit-tax-id="{{ unidad.impuesto_id }}"
                        data-unit-tax-label="{{ unidad.impuesto_label|default:'Impuesto global' }}"
                        data-unit-tax-rate="{{ unidad.impuesto_porcentaje|default:'' }}"
                        data-unit-tax-active="{{ unidad.impuesto_activo|yesno:'true,false' }}"
                    >
                        <div class="stock-card__status" aria-hidden="true">
                            {% if unidad.vendido %}
                                <span class="stock-card__badge stock-card__badge--sold">VENDIDO</span>
                                {% if unidad.fecha_venta %}
                                    <span class="stock-card__sold-date">{{ unidad.fecha_venta }}</span>
                                {% endif %}
                            {% else %}
                                <span class="stock-card__badge" data-unit-condition-chip>
                                    {{ unidad.producto_condicion_label|default:"Sin especificar" }}
                                </span>
                            {% endif %}
                        </div>
                        <div class="stock-card__thumb" aria-hidden="true">
                            {% if producto_imagenes %}
                                <img src="{{ producto_imagenes.0 }}" alt="Imagen de {{ producto.nombre }}" loading="lazy">
                            {% else %}
                                {% if producto.tipo_producto == 'phone' %}
                                    <span class="stock-card__placeholder stock-card__placeholder--phone" aria-hidden="true">üì±</span>
                                {% elif producto.tipo_producto == 'tablet' %}
                                    <span class="stock-card__placeholder stock-card__placeholder--tablet" aria-hidden="true">üì±</span>
                                {% elif producto.tipo_producto == 'laptop' %}
                                    <span class="stock-card__placeholder stock-card__placeholder--laptop" aria-hidden="true">üíª</span>
                                {% elif producto.tipo_producto == 'accessory' %}
                                    <span class="stock-card__placeholder stock-card__placeholder--accessory" aria-hidden="true">üéß</span>
                                {% elif producto.tipo_producto == 'gaming' %}
                                    <span class="stock-card__placeholder stock-card__placeholder--gaming" aria-hidden="true">üéÆ</span>
                                {% else %}
                                    <span class="stock-card__placeholder" aria-hidden="true">üì¶</span>
                                {% endif %}
                            {% endif %}
                        </div>
                        <div class="stock-card__body">
                            <h4 class="stock-card__title">Unidad {{ unidad.index }}</h4>
                            <ul class="stock-card__specs">
                                {% if producto.tipo_producto == 'phone' or producto.tipo_producto == 'tablet' %}
                                <li><span class="spec-icon">üì±</span> <span data-unit-imei>{{ unidad.imei|default:"Sin IMEI" }}</span></li>
                                {% endif %}
                                <li><span class="spec-icon">üé®</span> <span data-unit-color>{{ unidad.color|default:"Sin color" }}</span></li>
                                {% if producto.tipo_producto == 'phone' or producto.tipo_producto == 'tablet' or producto.tipo_producto == 'laptop' %}
                                <li><span class="spec-icon">üíæ</span> <span data-unit-storage>{{ unidad.almacenamiento_label|default:"No especificado" }}</span></li>
                                <li><span class="spec-icon">‚ö°</span> <span data-unit-ram>{{ unidad.memoria_ram_label|default:"No especificada" }}</span></li>
                                {% endif %}
                                {% if specific_fields %}
                                    {% if producto.tipo_producto == 'phone' or producto.tipo_producto == 'tablet' or producto.tipo_producto == 'laptop' %}
                                        {% if specific_fields.procesador %}
                                        <li><span class="spec-icon">‚öôÔ∏è</span> <span>{{ specific_fields.procesador|truncatechars:15 }}</span></li>
                                        {% endif %}
                                        {% if specific_fields.pantalla %}
                                        <li><span class="spec-icon">üñ•Ô∏è</span> <span>{{ specific_fields.pantalla|truncatechars:15 }}</span></li>
                                        {% endif %}
                                    {% elif producto.tipo_producto == 'laptop' %}
                                        {% if specific_fields.procesador %}
                                        <li><span class="spec-icon">‚öôÔ∏è</span> <span>{{ specific_fields.procesador|truncatechars:15 }}</span></li>
                                        {% endif %}
                                        {% if specific_fields.tarjeta_grafica %}
                                        <li><span class="spec-icon">üéÆ</span> <span>{{ specific_fields.tarjeta_grafica|truncatechars:15 }}</span></li>
                                        {% endif %}
                                    {% elif producto.tipo_producto == 'accessory' %}
                                        {% if specific_fields.tipo_accesorio %}
                                        <li><span class="spec-icon">üéß</span> <span>{{ specific_fields.tipo_accesorio|truncatechars:15 }}</span></li>
                                        {% endif %}
                                        {% if specific_fields.material %}
                                        <li><span class="spec-icon">üîß</span> <span>{{ specific_fields.material|truncatechars:15 }}</span></li>
                                        {% endif %}
                                    {% elif producto.tipo_producto == 'gaming' %}
                                        {% if specific_fields.tipo_gaming %}
                                        <li><span class="spec-icon">üéÆ</span> <span>{{ specific_fields.tipo_gaming|truncatechars:15 }}</span></li>
                                        {% endif %}
                                        {% if specific_fields.plataforma %}
                                        <li><span class="spec-icon">üïπÔ∏è</span> <span>{{ specific_fields.plataforma|truncatechars:15 }}</span></li>
                                        {% endif %}
                                    {% endif %}
                                {% endif %}
                                {% if producto.tipo_producto == 'phone' or producto.tipo_producto == 'tablet' or producto.tipo_producto == 'laptop' %}
                                <li><span class="spec-icon">üîã</span> <span data-unit-battery>{% if unidad.vida_bateria %}{{ unidad.vida_bateria }}%{% else %}Sin dato{% endif %}</span></li>
                                {% endif %}
                                <li><span class="spec-icon">üè∑Ô∏è</span> <span data-unit-barcode>{{ unidad.codigo_barras|default:'Generando...' }}</span></li>
                                <li><span class="spec-icon">üßæ</span> <span data-unit-tax>{{ unidad.impuesto_label|default:'Impuesto global' }}</span></li>
                            </ul>
                            <div class="stock-card__actions" aria-label="Acciones de la unidad">
                                {% if not unidad.vendido %}
                                    <button type="button"
                                        class="stock-card__action stock-card__action--view"
                                        data-open-unit-modal
                                        data-unit-index="{{ unidad.index }}"
                                    >
                                        Ver
                                    </button>
                                    <button type="button"
                                        class="stock-card__action stock-card__action--edit"
                                        data-open-edit-modal
                                        data-unit-index="{{ unidad.index }}"
                                    >
                                        Editar
                                    </button>
                                    {% if unidad.codigo_barras %}
                                    <button type="button"
                                        class="stock-card__action stock-card__action--print"
                                        data-print-label
                                        data-unit-id="{{ unidad.id }}"
                                        title="Imprimir etiqueta"
                                    >
                                        üè∑Ô∏è
                                    </button>
                                    {% endif %}
                                {% else %}
                                    <span class="stock-card__sold-notice">Unidad vendida - No disponible</span>
                                {% endif %}
                            </div>
                        </div>
                    </article>
                {% endfor %}
            </div>
        {% else %}
            <div class="stock-gallery__empty">
                <span class="stock-gallery__empty-icon" aria-hidden="true">üì¶</span>
                <p>No hay unidades registradas en inventario.</p>
            </div>
        {% endif %}
    </section>
</section>

<style>
    .product-detail {
        display: flex;
        flex-direction: column;
        gap: 32px;
        padding: 24px;
    }

    .product-modal--tax .product-modal__dialog {
        max-width: 380px;
        overflow-x: hidden;
    }

    .product-modal__dialog {
        overflow-x: hidden;
        max-width: 100%;
    }

    .product-modal--tax .product-modal__subtitle {
        font-size: 0.85rem;
        color: #636e72;
        margin-bottom: 4px;
    }

    .product-modal--tax .product-modal__form-field input {
        width: 100%;
    }

    .product-modal__form-field {
        max-width: 100%;
        overflow: hidden;
    }

    .product-modal__form-field input,
    .product-modal__form-field select,
    .product-modal__form-field textarea {
        max-width: 100%;
        box-sizing: border-box;
        overflow: hidden;
    }

    .product-modal--tax-manager,
    .product-modal--tax-create {
        z-index: 1400;
    }

    .product-modal--tax-manager .product-modal__dialog {
        max-width: 720px;
    }

    .product-detail__header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        flex-wrap: wrap;
        gap: 16px;
    }

    .product-detail__title {
        margin: 0;
        font-size: 1.8rem;
        color: #273c75;
    }

    .product-detail__meta {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        margin-top: 8px;
        color: #636e72;
        font-weight: 600;
    }

    .product-detail__meta-item {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        background: rgba(39, 60, 117, 0.08);
        border-radius: 999px;
        padding: 6px 12px;
    }

    .stock-gallery {
        background: #ffffff;
        border-radius: 20px;
        border: 1px solid #e6e8ef;
        padding: 24px;
        box-shadow: 0 18px 36px rgba(15, 23, 42, 0.08);
        display: flex;
        flex-direction: column;
        gap: 24px;
    }

    .stock-gallery__header {
        display: flex;
        justify-content: space-between;
        align-items: baseline;
        flex-wrap: wrap;
        gap: 12px;
    }

    .stock-gallery__title {
        margin: 0;
        font-size: 1.2rem;
        color: #2c3e50;
    }

    .stock-gallery__count {
        font-weight: 600;
        color: #273c75;
    }

    .stock-gallery__grid {
        display: grid;
        grid-template-columns: repeat(5, 1fr);
        gap: 16px;
    }

    .stock-card {
        border: 1px solid #e3e6f0;
        border-radius: 16px;
        overflow: hidden;
        background: linear-gradient(180deg, rgba(39, 60, 117, 0.07), rgba(39, 60, 117, 0.02));
        display: flex;
        flex-direction: column;
        min-height: 180px;
        position: relative;
    }

    .stock-card__status {
        position: absolute;
        top: 12px;
        right: 12px;
        pointer-events: none;
    }

    .stock-card__badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 6px 10px;
        border-radius: 999px;
        font-size: 0.75rem;
        font-weight: 700;
        letter-spacing: 0.02em;
        text-transform: uppercase;
        background: rgba(99, 110, 114, 0.14);
        color: #2d3436;
        box-shadow: 0 4px 10px rgba(47, 54, 64, 0.12);
    }

    .stock-card__badge--neutral {
        background: rgba(99, 110, 114, 0.18);
        color: #2d3436;
    }

    .stock-card__badge--success {
        background: rgba(46, 204, 113, 0.18);
        color: #207245;
    }

    .stock-card__badge--warning {
        background: rgba(243, 156, 18, 0.22);
        color: #a65a00;
    }

    .stock-card__badge--info {
        background: rgba(52, 152, 219, 0.2);
        color: #1a73b8;
    }

    .stock-card__badge--danger {
        background: rgba(231, 76, 60, 0.22);
        color: #b8322a;
    }

    .stock-card__thumb {
        height: 120px;
        background: rgba(39, 60, 117, 0.05);
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 12px;
    }

    .stock-card__thumb img {
        max-height: 100%;
        max-width: 100%;
        object-fit: contain;
    }

    .stock-card__placeholder {
        font-size: 2rem;
        color: #273c75;
    }

    .stock-card__placeholder--phone { font-size: 2.2rem; }
    .stock-card__placeholder--tablet { font-size: 2.1rem; }
    .stock-card__placeholder--laptop { font-size: 2.3rem; }
    .stock-card__placeholder--accessory { font-size: 2.1rem; }
    .stock-card__placeholder--gaming { font-size: 2.2rem; }

    .spec-icon {
        font-size: 0.9rem;
        margin-right: 6px;
        opacity: 0.8;
        display: inline-block;
        width: 20px;
        text-align: center;
    }

    .stock-card__specs li {
        display: flex;
        align-items: center;
        font-size: 0.85rem;
        gap: 4px;
    }

    .stock-card__body {
        padding: 14px 16px 18px;
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    .stock-card__title {
        margin: 0;
        font-size: 1rem;
        color: #273c75;
        font-weight: 700;
    }

    .stock-card__specs {
        list-style: none;
        margin: 0;
        padding: 0;
        display: flex;
        flex-direction: column;
        gap: 6px;
        color: #57606f;
        font-size: 0.85rem;
    }

    .stock-gallery__empty {
        display: flex;
        align-items: center;
        justify-content: center;
        flex-direction: column;
        gap: 12px;
        padding: 40px 16px;
        color: #95a5a6;
    }

    .stock-gallery__empty-icon {
        font-size: 2.5rem;
    }

    @media (max-width: 640px) {
        .product-detail {
            padding: 16px;
            gap: 24px;
        }

        .stock-gallery {
            padding: 18px;
        }

        .stock-gallery__grid {
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
        }
    }

    .stock-card__actions {
        display: flex;
        gap: 10px;
        justify-content: space-between;
        align-items: center;
        margin-top: auto;
        padding-top: 14px;
        border-top: 1px solid rgba(39, 60, 117, 0.12);
    }

    .stock-card__action {
        flex: 1 1 0;
        background: #ffffff;
        border: 1px solid #d7dbe8;
        color: #3f4d75;
        border-radius: 9px;
        padding: 8px 14px;
        font-size: 0.82rem;
        font-weight: 600;
        text-align: center;
        transition: transform 0.15s ease, box-shadow 0.15s ease, background 0.15s ease;
        box-shadow: inset 0 0 0 1px rgba(39, 60, 117, 0.04);
    }

    .stock-card__action:focus-visible {
        outline: 2px solid rgba(39, 60, 117, 0.45);
        outline-offset: 2px;
    }

    .stock-card__action--view {
        background: linear-gradient(135deg, #273c75, #4074d5);
        color: #ffffff;
        border-color: rgba(39, 60, 117, 0.75);
    }

    .stock-card__action--view:hover {
        box-shadow: 0 8px 18px rgba(39, 60, 117, 0.18);
        transform: translateY(-1px);
    }

    .stock-card__action--edit {
        background: #ffffff;
        border-color: rgba(39, 60, 117, 0.2);
        color: #273c75;
        cursor: pointer;
    }

    .stock-card__action--edit:hover {
        box-shadow: inset 0 0 0 1px rgba(39, 60, 117, 0.18);
        transform: translateY(-1px);
    }

    /* Sold unit styles */
    .stock-card--sold {
        opacity: 0.6;
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border: 2px dashed #6c757d;
    }

    .stock-card--sold .stock-card__thumb {
        filter: grayscale(100%);
    }

    .stock-card__badge--sold {
        background: #dc3545;
        color: white;
        font-weight: 600;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 11px;
        animation: pulse 2s infinite;
    }

    .stock-card__sold-date {
        display: block;
        font-size: 10px;
        color: #6c757d;
        margin-top: 2px;
    }

    .stock-card__sold-notice {
        display: block;
        text-align: center;
        color: #6c757d;
        font-size: 11px;
        font-weight: 500;
        padding: 8px;
        background: rgba(108, 117, 125, 0.1);
        border-radius: 4px;
    }

    @keyframes pulse {
        0% { opacity: 1; }
        50% { opacity: 0.7; }
        100% { opacity: 1; }
    }

    
    .product-modal {
        position: fixed;
        inset: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0;
        z-index: 1200;
    }

    .product-modal[hidden] {
        display: none;
    }

    .product-modal__backdrop {
        position: absolute;
        inset: 0;
        background: rgba(15, 23, 42, 0.55);
        backdrop-filter: blur(4px);
    }

    .product-modal__dialog {
        position: relative;
        background: #ffffff;
        border-radius: 20px;
        max-width: 640px;
        max-height: 90vh;
        width: 90%;
        padding: 32px 38px 32px 32px;
        box-shadow: 0 32px 60px rgba(15, 23, 42, 0.18);
        display: grid;
        gap: 20px;
        overflow-y: auto;
    }

    .product-modal__close {
        position: absolute;
        top: 18px;
        right: 18px;
        border: none;
        background: transparent;
        font-size: 1.4rem;
        color: #636e72;
        cursor: pointer;
    }

    .product-modal__heading {
        margin: 0;
        font-size: 1.5rem;
        color: #273c75;
    }

    .product-modal__layout {
        display: grid;
        gap: 20px;
        grid-template-columns: 180px 1fr;
    }

    .product-modal__media {
        background: #f4f6fb;
        border-radius: 16px;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
        padding: 12px;
    }

    .product-modal__media img {
        max-width: 100%;
        max-height: 100%;
        object-fit: contain;
    }

    .product-modal__media-placeholder {
        font-size: 3rem;
        color: #273c75;
    }

    .product-modal__body {
        display: flex;
        flex-direction: column;
        gap: 18px;
    }

    .unit-detail {
        display: flex;
        flex-direction: column;
        gap: 20px;
    }

    .unit-detail__content {
        display: grid;
        gap: 18px;
        grid-template-columns: repeat(2, 1fr);
        align-items: start;
    }

    .unit-detail__header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        flex-wrap: wrap;
        gap: 16px;
    }

    .unit-detail__title {
        display: flex;
        flex-direction: column;
        gap: 8px;
        max-width: 100%;
    }

    .unit-detail__subtitle {
        font-size: 0.78rem;
        font-weight: 700;
        letter-spacing: 0.4px;
        text-transform: uppercase;
        color: #95a5a6;
    }

    .unit-detail__name {
        margin: 0;
        font-size: 1.35rem;
        color: #273c75;
        word-break: break-word;
    }

    .unit-detail__chips {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
    }

    .unit-detail__chip {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 6px 12px;
        border-radius: 999px;
        background: rgba(39, 60, 117, 0.1);
        color: #273c75;

.unit-detail__header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    flex-wrap: wrap;
    gap: 16px;
}

.unit-detail__title {
    display: flex;
    flex-direction: column;
    gap: 8px;
    max-width: 100%;
}
        gap: 18px;
        grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
        align-items: start;
    }

    .unit-detail__column {
        display: flex;
        flex-direction: column;
        gap: 18px;
    }

    .unit-detail__media {
        background: #f4f6fb;
        border: 1px solid rgba(39, 60, 117, 0.12);
        border-radius: 16px;
        min-height: 220px;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 16px;
        overflow: hidden;
    }

    .unit-detail__media img {
        width: 100%;
        height: 100%;
        object-fit: contain;
    }

    .unit-detail__group {
        background: #ffffff;
        border: 1px solid rgba(39, 60, 117, 0.12);
        border-radius: 16px;
        padding: 18px;
        display: flex;
        flex-direction: column;
        gap: 12px;
        box-shadow: 0 12px 28px rgba(15, 23, 42, 0.08);
    }

    .unit-detail__group-label {
        font-size: 0.85rem;
        font-weight: 700;
        color: #273c75;
        text-transform: uppercase;
        letter-spacing: 0.35px;
    }

    .unit-detail__description .product-modal__description {
        color: #4b5563;
    }

    .unit-detail__grid {
        display: grid;
        gap: 12px;
        grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
    }

    .unit-detail__grid--compact {
        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
    }

    .unit-detail__grid > div {
        display: flex;
        flex-direction: column;
        gap: 4px;
    }

    .product-modal__subtitle {
        margin: 0;
        color: #57606f;
        font-weight: 600;
        letter-spacing: 0.4px;
        text-transform: uppercase;
    }

    .product-modal__meta {
        display: grid;
        gap: 12px;
        grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
    }

    .product-modal__meta dt {
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.4px;
        color: #95a5a6;
        margin-bottom: 4px;
    }

    .product-modal__meta dd {
        margin: 0;
        font-weight: 600;
        color: #2d3436;
    }

    .product-modal__description {
        margin: 0;
        color: #636e72;
        line-height: 1.6;
        font-size: 0.95rem;
    }

    .product-modal__footer {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
    }

    .product-modal__dialog--compact {
        max-width: 420px;
    }

    .product-modal__subtitle {
        margin: 0;
        color: #57606f;
        font-weight: 600;
        letter-spacing: 0.4px;
        text-transform: uppercase;
    }

    .product-modal__unit-tag {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 4px 12px;
        border-radius: 999px;
        background: rgba(39, 60, 117, 0.08);
        color: #273c75;
        font-weight: 600;
        font-size: 0.85rem;
    }

    .product-modal__form {
        display: flex;
        flex-direction: column;
        gap: 18px;
        margin-top: 12px;
    }

    .product-modal__error {
        background: rgba(235, 87, 87, 0.12);
        color: #c0392b;
        border-radius: 10px;
        padding: 10px 14px;
        font-size: 0.85rem;
        font-weight: 600;
    }

    .product-modal__form-row {
        display: grid;
        gap: 14px;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    }

    .product-modal__form-field {
        display: flex;
        flex-direction: column;
        gap: 6px;
    }

    .product-modal__form-label {
        font-size: 0.78rem;
        letter-spacing: 0.2px;
        font-weight: 600;
        color: #4b5d94;
    }

    .product-modal__form-field input,
    .product-modal__form-field select {
        border: 1px solid #dcdde1;
        border-radius: 10px;
        padding: 10px 12px;
        font-size: 0.95rem;
        transition: border-color 0.15s ease, box-shadow 0.15s ease;
        background-color: #fff;
    }

    .product-modal__form-field input:focus,
    .product-modal__form-field select:focus {
        outline: none;
        border-color: rgba(39, 60, 117, 0.6);
        box-shadow: 0 0 0 2px rgba(39, 60, 117, 0.12);
    }

    .product-modal__specs {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    .product-modal__specs-caption {
        font-size: 0.78rem;
        font-weight: 700;
        color: #364152;
        letter-spacing: 0.35px;
    }

    .product-modal__specs-grid {
        display: grid;
        gap: 16px;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        align-items: stretch;
        max-width: 100%;
        overflow: hidden;
    }

    @media (max-width: 768px) {
        .stock-gallery__grid {
            grid-template-columns: repeat(2, 1fr);
        }
        
        .product-modal__specs-grid {
            grid-template-columns: 1fr;
        }
    }

    @media (min-width: 769px) and (max-width: 1024px) {
        .stock-gallery__grid {
            grid-template-columns: repeat(3, 1fr);
        }
        
        .product-modal__specs-grid {
            grid-template-columns: repeat(2, 1fr);
        }
    }

    @media (min-width: 1025px) {
        .stock-gallery__grid {
            grid-template-columns: repeat(5, 1fr);
        }
        
        .product-modal__specs-grid {
            grid-template-columns: repeat(2, 1fr);
        }
    }

    .product-modal__spec-card {
        border: 1px solid rgba(39, 60, 117, 0.12);
        background: #ffffff;
        box-shadow: none;
        transition: border-color 0.15s ease, box-shadow 0.15s ease;
        width: 100%;
        max-width: 100%;
        box-sizing: border-box;
        overflow: hidden;
        min-width: 0;
    }

    .product-modal__spec-card:hover,
    .product-modal__spec-card:focus-within {
        border-color: rgba(39, 60, 117, 0.24);
        box-shadow: 0 6px 12px rgba(39, 60, 117, 0.12);
    }

    .product-modal__spec-card--static {
        background: linear-gradient(180deg, rgba(236, 240, 255, 0.45), rgba(236, 240, 255, 0.15));
        border-color: rgba(39, 60, 117, 0.18);
    }

    .product-modal__spec-header {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .product-modal__spec-header--with-action {
        justify-content: space-between;
    }

    .product-modal__spec-label {
        display: inline-flex;
        align-items: center;
        gap: 8px;
    }

    .product-modal__spec-action {
        border: none;
        background: rgba(39, 60, 117, 0.1);
        color: #273c75;
        border-radius: 8px;
        width: 28px;
        height: 28px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: background-color 0.15s ease, transform 0.15s ease;
    }

    .product-modal__spec-action:hover,
    .product-modal__spec-action:focus-visible {
        background: rgba(39, 60, 117, 0.2);
        transform: translateY(-1px);
    }

    .product-modal__spec-value {
        display: block;
        font-weight: 700;
        color: #273c75;
        font-size: 1.05rem;
    }

    .product-modal__accordion {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .product-modal__accordion-item {
        border: 1px solid rgba(39, 60, 117, 0.12);
        border-radius: 12px;
        overflow: hidden;
        background: #f8f9ff;
        box-shadow: none;
    }

    .product-modal__accordion-item[open] {
        background: linear-gradient(145deg, rgba(236, 240, 255, 0.45), #ffffff);
    }

    .product-modal__accordion-summary {
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
        padding: 12px 16px;
        font-weight: 700;
        color: #273c75;
        letter-spacing: 0.5px;
        text-transform: uppercase;
        position: relative;
    }

    .product-modal__accordion-summary::-webkit-details-marker {
        display: none;
    }

    .product-modal__accordion-icon {
        width: 22px;
        height: 22px;
        border-radius: 999px;
        border: 1px solid rgba(39, 60, 117, 0.3);
        color: #273c75;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: 0.85rem;
        transition: transform 0.2s ease;
    }

    .product-modal__accordion-item[open] .product-modal__accordion-icon {
        transform: rotate(180deg);
    }

    .product-modal__accordion-body {
        padding: 0 16px 16px;
        display: grid;
        gap: 14px;
    }

    .product-modal__form-actions {
        display: flex;
        justify-content: flex-end;
        gap: 12px;
    }

    .unit-detail__grid dt {
        margin: 0;
        font-size: 0.7rem;
        text-transform: uppercase;
        letter-spacing: 0.4px;
        color: #95a5a6;
    }

    .unit-detail__grid dd {
        margin: 0;
        font-weight: 600;
        color: #2d3436;
    }

    .condition-manager__form {
        display: grid;
        gap: 12px;
    }

    .condition-manager__fields {
        display: grid;
        gap: 12px;
    }

    .condition-manager__row {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
    }

    .condition-manager__list {
        border: 1px solid rgba(39, 60, 117, 0.16);
        border-radius: 10px;
        max-height: 220px;
        overflow-y: auto;
        padding: 8px;
        display: flex;
        flex-direction: column;
        gap: 8px;
        background: rgba(246, 248, 252, 0.8);
    }

    .condition-manager__empty {
        padding: 16px;
        text-align: center;
        color: #636e72;
        font-size: 0.95rem;
    }

    .condition-item {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 12px;
        padding: 10px 12px;
        border-radius: 8px;
        background: #ffffff;
        border: 1px solid rgba(39, 60, 117, 0.12);
    }

    .condition-item__meta {
        display: flex;
        flex-direction: column;
        gap: 4px;
    }

    .condition-item__title {
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .condition-item__badge {
        font-size: 0.72rem;
        padding: 2px 6px;
        border-radius: 12px;
        text-transform: uppercase;
        background: rgba(39, 60, 117, 0.12);
        color: #273c75;
        font-weight: 600;
    }

    .condition-item__badge--inactive {
        background: rgba(192, 57, 43, 0.15);
        color: #c0392b;
    }

    .condition-item__actions {
        display: flex;
        gap: 6px;
    }

    .condition-manager__error {
        color: #c0392b;
        background: rgba(231, 76, 60, 0.1);
        border: 1px solid rgba(231, 76, 60, 0.2);
        padding: 8px 12px;
        border-radius: 8px;
        font-size: 0.9rem;
    }

    .condition-manager__footer {
        display: flex;
        justify-content: flex-end;
        gap: 12px;
    }

    .product-modal__spec-icon {
        width: 28px;
        height: 28px;
        border-radius: 8px;
        background: rgba(39, 60, 117, 0.08);
        color: #273c75;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: 1rem;
    }

    .product-modal__spec-title {
        font-size: 0.85rem;
        font-weight: 700;
        color: #273c75;
    }

    .product-modal__form-field select {
        appearance: none;
        background-image: linear-gradient(45deg, transparent 50%, rgba(39, 60, 117, 0.6) 50%), linear-gradient(135deg, rgba(39, 60, 117, 0.6) 50%, transparent 50%);
        background-position: calc(100% - 18px) calc(50% - 4px), calc(100% - 12px) calc(50% - 4px);
        background-size: 6px 6px, 6px 6px;
        background-repeat: no-repeat;
        padding-right: 42px;
    }

    .product-modal__accordion {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .product-modal__accordion-item {
        border: 1px solid rgba(39, 60, 117, 0.12);
        border-radius: 12px;
        overflow: hidden;
        background: #f8f9ff;
        box-shadow: none;
    }

    .product-modal__accordion-item[open] {
        background: linear-gradient(145deg, rgba(236, 240, 255, 0.45), #ffffff);
    }

    .product-modal__accordion-summary {
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
        padding: 12px 16px;
        font-weight: 700;
        color: #273c75;
        letter-spacing: 0.5px;
        text-transform: uppercase;
        position: relative;
    }

    .product-modal__accordion-summary::-webkit-details-marker {
        display: none;
    }

    .product-modal__accordion-icon {
        width: 22px;
        height: 22px;
        border-radius: 999px;
        border: 1px solid rgba(39, 60, 117, 0.3);
        color: #273c75;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: 0.85rem;
        transition: transform 0.2s ease;
    }

    .product-modal__accordion-item[open] .product-modal__accordion-icon {
        transform: rotate(180deg);
    }

    .product-modal__accordion-body {
        padding: 0 16px 16px;
        display: grid;
        gap: 14px;
    }

    .product-modal__form-actions {
        display: flex;
        justify-content: flex-end;
        gap: 12px;
    }

    .unit-detail__chip {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 6px 10px;
        border-radius: 999px;
        background: rgba(39, 60, 117, 0.08);
        color: #273c75;
        font-size: 0.72rem;
        font-weight: 600;
        letter-spacing: 0.35px;
    }

    .unit-detail__chips {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
    }

    @media (max-width: 768px) {
        .product-modal__dialog {
            padding: 24px;
        }

        .product-modal__layout {
            grid-template-columns: 1fr;
        }

        .unit-detail__content {
            grid-template-columns: repeat(2, 1fr);
        }

        .unit-detail__media {
            height: 160px;
        }
    }

    @media (max-width: 640px) {
        .product-detail {
            padding: 16px;
            gap: 24px;
        }

        .stock-gallery {
            padding: 18px;
        }

        .stock-gallery__grid {
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
        }

        .product-modal {
            padding: 16px;
        }

        .product-modal__dialog {
            padding: 20px;
        }

        .unit-detail__title {
            min-width: 0;
        }

        .unit-detail__content {
            grid-template-columns: 1fr;
        }
    }

    body.modal-open {
        overflow: hidden;
    }

    .product-modal__dialog {
        padding: 20px;
    }

    .unit-detail__title {
        min-width: 0;
    }

    .product-modal__tax-group {
        overflow: hidden;
    }

    .product-modal__form-actions {
        gap: 14px;
        justify-content: flex-end;
        align-items: center;
        margin-top: 4px;
    }

    .product-modal__form-actions .btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        border-radius: 999px;
        padding: 12px 22px;
        font-weight: 600;
        letter-spacing: 0.4px;
        font-size: 0.95rem;
        transition: transform 0.2s ease, box-shadow 0.2s ease, background 0.2s ease, border-color 0.2s ease;
        position: relative;
        overflow: hidden;
    }

    .product-modal__form-actions .btn:focus-visible {
        outline: 3px solid rgba(39, 60, 117, 0.25);
        outline-offset: 2px;
    }

    .btn--ghost {
        background: linear-gradient(135deg, rgba(39, 60, 117, 0.08), rgba(64, 116, 213, 0.1));
        border: 1px solid rgba(39, 60, 117, 0.35);
        color: #273c75;
        box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.6);
    }

    .btn--ghost:hover {
        background: linear-gradient(135deg, rgba(39, 60, 117, 0.16), rgba(64, 116, 213, 0.22));
        border-color: rgba(39, 60, 117, 0.5);
        transform: translateY(-1px);
    }

    .btn--elevated {
        border: none;
        color: #ffffff;
        background: linear-gradient(135deg, #273c75, #6c5ce7);
        box-shadow: 0 14px 32px rgba(108, 92, 231, 0.35);
    }

    .btn--elevated::after {
        content: "";
        position: absolute;
        inset: 0;
        background: radial-gradient(circle at top left, rgba(255, 255, 255, 0.35), transparent 55%);
        opacity: 0.4;
        pointer-events: none;
        transition: opacity 0.2s ease;
    }

    .btn--elevated:hover {
        box-shadow: 0 18px 40px rgba(108, 92, 231, 0.45);
        transform: translateY(-2px);
    }

    .btn--elevated:hover::after {
        opacity: 0.55;
    }

    .btn__icon {
        font-size: 1rem;
        line-height: 1;
        display: inline-flex;
        align-items: center;
        justify-content: center;
    }
</style>

<div class="product-modal" data-product-modal hidden>
    <div class="product-modal__backdrop" data-close-modal></div>
    <div class="product-modal__dialog" role="dialog" aria-modal="true" aria-labelledby="unitModalTitle">
        <button type="button" class="product-modal__close" data-close-modal aria-label="Cerrar modal">√ó</button>
        <div class="product-modal__body">
            <div class="unit-detail">
                <div class="unit-detail__header">
                    <div class="unit-detail__title">
                        <span class="unit-detail__subtitle">Producto</span>
                        <h3 class="unit-detail__name" id="unitModalTitle" data-modal-product-name>{{ producto.nombre }}</h3>
                        <div class="unit-detail__chips">
                            {% if producto.marca %}<span class="unit-detail__chip">Marca: {{ producto.marca }}</span>{% endif %}
                            {% if producto.modelo %}<span class="unit-detail__chip">Modelo: {{ producto.modelo }}</span>{% endif %}
                            {% if producto.categoria %}<span class="unit-detail__chip">Categor√≠a: {{ producto.categoria }}</span>{% endif %}
                        </div>
                    </div>
                    <span class="stock-card__badge stock-card__badge--neutral unit-detail__status" data-modal-unit-status>Sin especificar</span>
                </div>
                <div class="unit-detail__content">
                    <div class="unit-detail__column">
                        <div class="unit-detail__media">
                            {% if producto_imagenes %}
                                <img src="{{ producto_imagenes.0 }}" alt="Imagen de {{ producto.nombre }}" data-modal-image>
                            {% else %}
                                <span class="product-modal__media-placeholder" aria-hidden="true">üì±</span>
                            {% endif %}
                        </div>
                        <div class="unit-detail__group unit-detail__description">
                            <span class="unit-detail__group-label">Descripci√≥n del producto</span>
                            <p class="product-modal__description">{{ producto.descripcion|default:"Sin descripci√≥n disponible." }}</p>
                        </div>
                    </div>
                    <div class="unit-detail__column">
                        <div class="unit-detail__group">
                            <span class="unit-detail__group-label">Informaci√≥n general</span>
                            <dl class="unit-detail__grid">
                                <div>
                                    <dt>Almacenamiento</dt>
                                    <dd data-modal-product-storage>{{ producto.get_almacenamiento_display|default:"No especificado" }}</dd>
                                </div>
                                <div>
                                    <dt>RAM</dt>
                                    <dd data-modal-product-ram>{{ producto.get_memoria_ram_display|default:"No especificada" }}</dd>
                                </div>
                                <div>
                                    <dt>Proveedor</dt>
                                    <dd>{{ producto.proveedor|default:"Sin proveedor" }}</dd>
                                </div>
                                <div>
                                    <dt>Precio costo</dt>
                                    <dd data-modal-product-cost>‚Äî</dd>
                                </div>
                                <div>
                                    <dt>Precio venta</dt>
                                    <dd data-modal-product-price>‚Äî</dd>
                                </div>
                            </dl>
                        </div>
                        {% if specific_fields %}
                        <div class="unit-detail__group">
                            <span class="unit-detail__group-label">Especificaciones t√©cnicas</span>
                            <dl class="unit-detail__grid">
                                {% if producto.tipo_producto == 'phone' or producto.tipo_producto == 'tablet' or producto.tipo_producto == 'laptop' %}
                                    {% if specific_fields.procesador %}
                                    <div>
                                        <dt>Procesador</dt>
                                        <dd>{{ specific_fields.procesador|default:"No especificado" }}</dd>
                                    </div>
                                    {% endif %}
                                    {% if specific_fields.pantalla %}
                                    <div>
                                        <dt>Pantalla</dt>
                                        <dd>{{ specific_fields.pantalla|default:"No especificado" }}</dd>
                                    </div>
                                    {% endif %}
                                    {% if specific_fields.sistema_operativo %}
                                    <div>
                                        <dt>Sistema operativo</dt>
                                        <dd>{{ specific_fields.sistema_operativo|default:"No especificado" }}</dd>
                                    </div>
                                    {% endif %}
                                    {% if producto.tipo_producto == 'tablet' and specific_fields.conectividad %}
                                    <div>
                                        <dt>Conectividad</dt>
                                        <dd>{{ specific_fields.conectividad|default:"No especificado" }}</dd>
                                    </div>
                                    {% endif %}
                                {% elif producto.tipo_producto == 'laptop' %}
                                    {% if specific_fields.procesador %}
                                    <div>
                                        <dt>Procesador</dt>
                                        <dd>{{ specific_fields.procesador|default:"No especificado" }}</dd>
                                    </div>
                                    {% endif %}
                                    {% if specific_fields.pantalla %}
                                    <div>
                                        <dt>Pantalla</dt>
                                        <dd>{{ specific_fields.pantalla|default:"No especificado" }}</dd>
                                    </div>
                                    {% endif %}
                                    {% if specific_fields.tarjeta_grafica %}
                                    <div>
                                        <dt>Tarjeta gr√°fica</dt>
                                        <dd>{{ specific_fields.tarjeta_grafica|default:"No especificado" }}</dd>
                                    </div>
                                    {% endif %}
                                    {% if specific_fields.numero_serie %}
                                    <div>
                                        <dt>N√∫mero de serie</dt>
                                        <dd>{{ specific_fields.numero_serie|default:"No especificado" }}</dd>
                                    </div>
                                    {% endif %}
                                {% elif producto.tipo_producto == 'accessory' %}
                                    {% if specific_fields.tipo_accesorio %}
                                    <div>
                                        <dt>Tipo de accesorio</dt>
                                        <dd>{{ specific_fields.tipo_accesorio|default:"No especificado" }}</dd>
                                    </div>
                                    {% endif %}
                                    {% if specific_fields.compatibilidad %}
                                    <div>
                                        <dt>Compatibilidad</dt>
                                        <dd>{{ specific_fields.compatibilidad|default:"No especificado" }}</dd>
                                    </div>
                                    {% endif %}
                                    {% if specific_fields.material %}
                                    <div>
                                        <dt>Material</dt>
                                        <dd>{{ specific_fields.material|default:"No especificado" }}</dd>
                                    </div>
                                    {% endif %}
                                    {% if specific_fields.potencia %}
                                    <div>
                                        <dt>Potencia/Capacidad</dt>
                                        <dd>{{ specific_fields.potencia|default:"No especificado" }}</dd>
                                    </div>
                                    {% endif %}
                                {% elif producto.tipo_producto == 'gaming' %}
                                    {% if specific_fields.tipo_gaming %}
                                    <div>
                                        <dt>Tipo gaming</dt>
                                        <dd>{{ specific_fields.tipo_gaming|default:"No especificado" }}</dd>
                                    </div>
                                    {% endif %}
                                    {% if specific_fields.plataforma %}
                                    <div>
                                        <dt>Plataforma</dt>
                                        <dd>{{ specific_fields.plataforma|default:"No especificado" }}</dd>
                                    </div>
                                    {% endif %}
                                    {% if specific_fields.potencia %}
                                    <div>
                                        <dt>Potencia</dt>
                                        <dd>{{ specific_fields.potencia|default:"No especificado" }}</dd>
                                    </div>
                                    {% endif %}
                                {% endif %}
                            </dl>
                        </div>
                        {% endif %}
                        <div class="unit-detail__group">
                            <span class="unit-detail__group-label">Unidad seleccionada</span>
                            <dl class="unit-detail__grid unit-detail__grid--compact">
                                <div>
                                    <dt>N√∫mero de unidad</dt>
                                    <dd data-modal-unit-index>‚Äî</dd>
                                </div>
                                {% if producto.tipo_producto == 'phone' or producto.tipo_producto == 'tablet' %}
                                <div>
                                    <dt>IMEI / Serie</dt>
                                    <dd data-modal-unit-imei>‚Äî</dd>
                                </div>
                                {% endif %}
                                <div>
                                    <dt>Color</dt>
                                    <dd data-modal-unit-color>‚Äî</dd>
                                </div>
                                <div>
                                    <dt>Vida √∫til bater√≠a</dt>
                                    <dd data-modal-unit-battery>‚Äî</dd>
                                </div>
                                <div>
                                    <dt>C√≥digo de barras</dt>
                                    <dd data-modal-unit-barcode>‚Äî</dd>
                                </div>
                            </dl>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="product-modal__footer">
            <button type="button" class="btn btn-secondary" data-close-modal>Cerrar</button>
        </div>
    </div>
</div>

<div class="product-modal product-modal--tax-manager" data-tax-management-modal hidden>
    <div class="product-modal__backdrop" data-close-tax-management></div>
    <div class="product-modal__dialog product-modal__dialog--wide" role="dialog" aria-modal="true" aria-labelledby="taxManagementTitle">
        <button type="button" class="product-modal__close" data-close-tax-management aria-label="Cerrar modal">√ó</button>
        <div class="product-modal__body">
            <div class="product-modal__header">
                <h3 class="product-modal__heading" id="taxManagementTitle">Gestionar impuestos</h3>
                <button type="button" class="btn btn-primary" data-open-tax-create>Agregar impuesto</button>
            </div>
            <div class="product-modal__table-wrapper">
                <table class="lookup-table lookup-table--taxes">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Impuesto</th>
                            <th>Porcentaje</th>
                            <th>Estado</th>
                            <th colspan="2">Acci√≥n</th>
                        </tr>
                    </thead>
                    <tbody data-tax-table-body>
                        {% if impuestos_catalogo %}
                            {% for impuesto in impuestos_catalogo %}
                                <tr data-tax-row data-tax-id="{{ impuesto.id }}" data-tax-name="{{ impuesto.nombre }}" data-tax-rate="{{ impuesto.porcentaje }}" data-tax-active="{{ impuesto.activo|yesno:'true,false' }}">
                                    <td data-row-index>{{ forloop.counter }}</td>
                                    <td><span class="lookup-name">{{ impuesto.nombre }}</span></td>
                                    <td>{{ impuesto.porcentaje }}%</td>
                                    <td>
                                        <span class="lookup-status {% if impuesto.activo %}lookup-status--active{% else %}lookup-status--inactive{% endif %}">
                                            {% if impuesto.activo %}Activo{% else %}Inactivo{% endif %}
                                        </span>
                                    </td>
                                    <td>
                                        <button type="button" class="btn btn-outline btn--compact" data-tax-select-button>
                                            Seleccionar
                                        </button>
                                    </td>
                                    <td>
                                        <button type="button" class="btn btn-outline btn--compact" data-tax-toggle-button data-toggle-url="{% url 'dashboard:toggle_tax_status_api' impuesto.id %}">
                                            {% if impuesto.activo %}Inactivar{% else %}Activar{% endif %}
                                        </button>
                                    </td>
                                </tr>
                            {% endfor %}
                        {% else %}
                            <tr data-tax-empty>
                                <td colspan="6">No hay impuestos registrados.</td>
                            </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
        <div class="product-modal__footer">
            <button type="button" class="btn btn-secondary" data-close-tax-management>Cerrar</button>
        </div>
    </div>
</div>

<div class="product-modal product-modal--tax-create" data-tax-create-modal hidden>
    <div class="product-modal__backdrop" data-close-tax-create></div>
    <div class="product-modal__dialog product-modal__dialog--compact" role="dialog" aria-modal="true" aria-labelledby="taxCreateTitle">
        <button type="button" class="product-modal__close" data-close-tax-create aria-label="Cerrar modal">√ó</button>
        <div class="product-modal__body">
            <h3 class="product-modal__heading" id="taxCreateTitle">Registrar impuesto</h3>
            <form class="product-modal__form" data-tax-create-form>
                {% csrf_token %}
                <div class="product-modal__form-field">
                    <span class="product-modal__form-label">Nombre</span>
                    <input type="text" name="nombre" placeholder="Ej. ITBIS reducido" maxlength="120" data-tax-create-name required>
                </div>
                <div class="product-modal__form-field">
                    <span class="product-modal__form-label">Porcentaje (%)</span>
                    <input type="number" name="porcentaje" min="0" max="100" step="0.01" placeholder="0.00" data-tax-create-rate required>
                </div>
                <div class="product-modal__form-field">
                    <label class="checkbox-toggle">
                        <input type="checkbox" name="activo" data-tax-create-active checked>
                        <span class="checkbox-toggle__track">
                            <span class="checkbox-toggle__thumb"></span>
                        </span>
                        <span class="checkbox-toggle__label">Activo</span>
                    </label>
                </div>
                <div class="product-modal__form-field" data-tax-create-error hidden>
                    <div class="product-modal__error" data-tax-create-error-message></div>
                </div>
                <div class="product-modal__form-actions">
                    <button type="button" class="btn btn-outline" data-close-tax-create>Cancelar</button>
                    <button type="submit" class="btn btn-primary" data-tax-create-submit>Guardar</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="product-modal product-modal--edit" data-edit-modal hidden>
    <div class="product-modal__backdrop" data-close-edit-modal></div>
    <div class="product-modal__dialog product-modal__dialog--compact" role="dialog" aria-modal="true" aria-labelledby="editModalTitle">
        <button type="button" class="product-modal__close" data-close-edit-modal aria-label="Cerrar modal">√ó</button>
        <div class="product-modal__body">
            <h3 class="product-modal__heading" id="editModalTitle">Editar unidad</h3>
            <form class="product-modal__form" method="post" data-edit-modal-form>
                {% csrf_token %}
                <input type="hidden" name="unidad_index" value="" data-edit-input-index>
                <div class="product-modal__accordion">
                    <details class="product-modal__accordion-item" open>
                        <summary class="product-modal__accordion-summary">
                            Informaci√≥n editable
                            <span class="product-modal__accordion-icon" aria-hidden="true">‚åÑ</span>
                        </summary>
                        <div class="product-modal__accordion-body">
                            <div class="product-modal__form-row">
                                {% if producto.tipo_producto == 'phone' or producto.tipo_producto == 'tablet' %}
                                <label class="product-modal__form-field">
                                    <span class="product-modal__form-label">IMEI / Serie</span>
                                    <input type="text" name="imei" data-edit-input-imei placeholder="Ingresa IMEI o n√∫mero de serie">
                                </label>
                                {% endif %}
                                <label class="product-modal__form-field">
                                    <span class="product-modal__form-label">Color</span>
                                    <input type="text" name="color" data-edit-input-color placeholder="Ingresa color de la unidad">
                                </label>
                                {% if producto.tipo_producto == 'phone' or producto.tipo_producto == 'tablet' or producto.tipo_producto == 'laptop' %}
                                <label class="product-modal__form-field">
                                    <span class="product-modal__form-label">Vida √∫til bater√≠a (%)</span>
                                    <input type="number" name="vida_bateria" data-edit-input-battery min="0" max="100" step="1" placeholder="0-100">
                                </label>
                                {% endif %}
                            </div>
                        </div>
                    </details>
                    <details class="product-modal__accordion-item">
                        <summary class="product-modal__accordion-summary">
                            Configuraci√≥n t√©cnica
                            <span class="product-modal__accordion-icon" aria-hidden="true">‚åÑ</span>
                        </summary>
                        <div class="product-modal__accordion-body">
                            <div class="product-modal__specs">
                                <div class="product-modal__specs-grid">
                                    {% if producto.tipo_producto == 'phone' or producto.tipo_producto == 'tablet' or producto.tipo_producto == 'laptop' %}
                                    <label class="product-modal__spec-card product-modal__form-field">
                                        <span class="product-modal__spec-header">
                                            <span class="product-modal__spec-icon" aria-hidden="true">üíæ</span>
                                            <span class="product-modal__spec-title">Almacenamiento</span>
                                        </span>
                                        <select name="almacenamiento" data-edit-input-storage>
                                            <option value="">No especificado</option>
                                            {% for value, label in almacenamiento_choices %}
                                                <option value="{{ value }}">{{ label }}</option>
                                            {% endfor %}
                                        </select>
                                    </label>
                                    {% endif %}
                                    {% if producto.tipo_producto == 'phone' or producto.tipo_producto == 'tablet' or producto.tipo_producto == 'laptop' %}
                                    <label class="product-modal__spec-card product-modal__form-field">
                                        <span class="product-modal__spec-header">
                                            <span class="product-modal__spec-icon" aria-hidden="true">‚ö°</span>
                                            <span class="product-modal__spec-title">Memoria RAM</span>
                                        </span>
                                        <select name="memoria_ram" data-edit-input-ram>
                                            <option value="">No especificada</option>
                                            {% for value, label in ram_choices %}
                                                <option value="{{ value }}">{{ label }}</option>
                                            {% endfor %}
                                        </select>
                                    </label>
                                    {% endif %}
                                    <label class="product-modal__spec-card product-modal__form-field">
                                        <span class="product-modal__spec-header product-modal__spec-header--with-action">
                                            <span class="product-modal__spec-label">
                                                <span class="product-modal__spec-icon" aria-hidden="true">üéØ</span>
                                                <span class="product-modal__spec-title">Estado del producto</span>
                                            </span>
                                            <button type="button" class="product-modal__spec-action" data-open-condition-modal aria-label="Gestionar estados">
                                                <span aria-hidden="true">‚öôÔ∏è</span>
                                            </button>
                                        </span>
                                        <select name="producto_condicion" data-edit-input-condition>
                                            <option value="">Sin especificar</option>
                                            {% for condicion in product_conditions %}
                                                <option value="{{ condicion.id }}">{{ condicion.nombre }}</option>
                                            {% endfor %}
                                        </select>
                                    </label>
                                    <label class="product-modal__spec-card product-modal__form-field">
                                        <span class="product-modal__spec-header">
                                            <span class="product-modal__spec-icon" aria-hidden="true">üí∞</span>
                                            <span class="product-modal__spec-title">Precio costo</span>
                                        </span>
                                        <input type="number" name="precio_costo" inputmode="decimal" step="0.01" min="0" placeholder="0.00" data-edit-input-cost>
                                    </label>
                                    <label class="product-modal__spec-card product-modal__form-field">
                                        <span class="product-modal__spec-header">
                                            <span class="product-modal__spec-icon" aria-hidden="true">üíµ</span>
                                            <span class="product-modal__spec-title">Precio venta</span>
                                        </span>
                                        <input type="number" name="precio_venta" inputmode="decimal" step="0.01" min="0" placeholder="0.00" data-edit-input-price>
                                    </label>
                                    {% if producto.tipo_producto == 'phone' or producto.tipo_producto == 'tablet' or producto.tipo_producto == 'laptop' %}
                                        {% if specific_fields.procesador %}
                                        <label class="product-modal__spec-card product-modal__form-field">
                                            <span class="product-modal__spec-header">
                                                <span class="product-modal__spec-icon" aria-hidden="true">‚öôÔ∏è</span>
                                                <span class="product-modal__spec-title">Procesador</span>
                                            </span>
                                            <input type="text" name="procesador" value="{{ specific_fields.procesador }}" placeholder="Ej: Snapdragon 8 Gen 2">
                                        </label>
                                        {% endif %}
                                        {% if specific_fields.pantalla %}
                                        <label class="product-modal__spec-card product-modal__form-field">
                                            <span class="product-modal__spec-header">
                                                <span class="product-modal__spec-icon" aria-hidden="true">üì±</span>
                                                <span class="product-modal__spec-title">Pantalla</span>
                                            </span>
                                            <input type="text" name="pantalla" value="{{ specific_fields.pantalla }}" placeholder="Ej: 6.7 pulgadas OLED">
                                        </label>
                                        {% endif %}
                                        {% if specific_fields.sistema_operativo %}
                                        <label class="product-modal__spec-card product-modal__form-field">
                                            <span class="product-modal__spec-header">
                                                <span class="product-modal__spec-icon" aria-hidden="true">üîÑ</span>
                                                <span class="product-modal__spec-title">Sistema operativo</span>
                                            </span>
                                            <input type="text" name="sistema_operativo" value="{{ specific_fields.sistema_operativo }}" placeholder="Ej: iOS 16, Android 13">
                                        </label>
                                        {% endif %}
                                        {% if producto.tipo_producto == 'tablet' and specific_fields.conectividad %}
                                        <label class="product-modal__spec-card product-modal__form-field">
                                            <span class="product-modal__spec-header">
                                                <span class="product-modal__spec-icon" aria-hidden="true">üì°</span>
                                                <span class="product-modal__spec-title">Conectividad</span>
                                            </span>
                                            <input type="text" name="conectividad" value="{{ specific_fields.conectividad }}" placeholder="Ej: Wi-Fi, 4G LTE">
                                        </label>
                                        {% endif %}
                                    {% elif producto.tipo_producto == 'laptop' %}
                                        {% if specific_fields.procesador %}
                                        <label class="product-modal__spec-card product-modal__form-field">
                                            <span class="product-modal__spec-header">
                                                <span class="product-modal__spec-icon" aria-hidden="true">‚öôÔ∏è</span>
                                                <span class="product-modal__spec-title">Procesador</span>
                                            </span>
                                            <input type="text" name="procesador" value="{{ specific_fields.procesador }}" placeholder="Ej: Intel Core i7-12700H">
                                        </label>
                                        {% endif %}
                                        {% if specific_fields.pantalla %}
                                        <label class="product-modal__spec-card product-modal__form-field">
                                            <span class="product-modal__spec-header">
                                                <span class="product-modal__spec-icon" aria-hidden="true">üíª</span>
                                                <span class="product-modal__spec-title">Pantalla</span>
                                            </span>
                                            <input type="text" name="pantalla" value="{{ specific_fields.pantalla }}" placeholder="Ej: 15.6 pulgadas Full HD">
                                        </label>
                                        {% endif %}
                                        {% if specific_fields.tarjeta_grafica %}
                                        <label class="product-modal__spec-card product-modal__form-field">
                                            <span class="product-modal__spec-header">
                                                <span class="product-modal__spec-icon" aria-hidden="true">üéÆ</span>
                                                <span class="product-modal__spec-title">Tarjeta gr√°fica</span>
                                            </span>
                                            <input type="text" name="tarjeta_grafica" value="{{ specific_fields.tarjeta_grafica }}" placeholder="Ej: NVIDIA RTX 3060">
                                        </label>
                                        {% endif %}
                                        {% if specific_fields.numero_serie %}
                                        <label class="product-modal__spec-card product-modal__form-field">
                                            <span class="product-modal__spec-header">
                                                <span class="product-modal__spec-icon" aria-hidden="true">üî¢</span>
                                                <span class="product-modal__spec-title">N√∫mero de serie</span>
                                            </span>
                                            <input type="text" name="numero_serie" value="{{ specific_fields.numero_serie }}" placeholder="Ej: SN123456789">
                                        </label>
                                        {% endif %}
                                    {% elif producto.tipo_producto == 'accessory' %}
                                        {% if specific_fields.tipo_accesorio %}
                                        <label class="product-modal__spec-card product-modal__form-field">
                                            <span class="product-modal__spec-header">
                                                <span class="product-modal__spec-icon" aria-hidden="true">üéß</span>
                                                <span class="product-modal__spec-title">Tipo de accesorio</span>
                                            </span>
                                            <input type="text" name="tipo_accesorio" value="{{ specific_fields.tipo_accesorio }}" placeholder="Ej: Auriculares, Funda, Cargador">
                                        </label>
                                        {% endif %}
                                        {% if specific_fields.compatibilidad %}
                                        <label class="product-modal__spec-card product-modal__form-field">
                                            <span class="product-modal__spec-header">
                                                <span class="product-modal__spec-icon" aria-hidden="true">üîó</span>
                                                <span class="product-modal__spec-title">Compatibilidad</span>
                                            </span>
                                            <input type="text" name="compatibilidad" value="{{ specific_fields.compatibilidad }}" placeholder="Ej: iPhone 12-14, Samsung Galaxy S">
                                        </label>
                                        {% endif %}
                                        {% if specific_fields.material %}
                                        <label class="product-modal__spec-card product-modal__form-field">
                                            <span class="product-modal__spec-header">
                                                <span class="product-modal__spec-icon" aria-hidden="true">üõ°Ô∏è</span>
                                                <span class="product-modal__spec-title">Material</span>
                                            </span>
                                            <input type="text" name="material" value="{{ specific_fields.material }}" placeholder="Ej: Silicon, Cuero, Pl√°stico">
                                        </label>
                                        {% endif %}
                                        {% if specific_fields.potencia %}
                                        <label class="product-modal__spec-card product-modal__form-field">
                                            <span class="product-modal__spec-header">
                                                <span class="product-modal__spec-icon" aria-hidden="true">‚ö°</span>
                                                <span class="product-modal__spec-title">Potencia/Capacidad</span>
                                            </span>
                                            <input type="text" name="potencia" value="{{ specific_fields.potencia }}" placeholder="Ej: 20W, 10000mAh">
                                        </label>
                                        {% endif %}
                                    {% elif producto.tipo_producto == 'gaming' %}
                                        {% if specific_fields.tipo_gaming %}
                                        <label class="product-modal__spec-card product-modal__form-field">
                                            <span class="product-modal__spec-header">
                                                <span class="product-modal__spec-icon" aria-hidden="true">üéÆ</span>
                                                <span class="product-modal__spec-title">Tipo gaming</span>
                                            </span>
                                            <input type="text" name="tipo_gaming" value="{{ specific_fields.tipo_gaming }}" placeholder="Ej: Consola, Accesorio, Juego">
                                        </label>
                                        {% endif %}
                                        {% if specific_fields.plataforma %}
                                        <label class="product-modal__spec-card product-modal__form-field">
                                            <span class="product-modal__spec-header">
                                                <span class="product-modal__spec-icon" aria-hidden="true">üïπÔ∏è</span>
                                                <span class="product-modal__spec-title">Plataforma</span>
                                            </span>
                                            <input type="text" name="plataforma" value="{{ specific_fields.plataforma }}" placeholder="Ej: PlayStation, Xbox, PC">
                                        </label>
                                        {% endif %}
                                        {% if specific_fields.potencia %}
                                        <label class="product-modal__spec-card product-modal__form-field">
                                            <span class="product-modal__spec-header">
                                                <span class="product-modal__spec-icon" aria-hidden="true">‚ö°</span>
                                                <span class="product-modal__spec-title">Potencia</span>
                                            </span>
                                            <input type="text" name="potencia" value="{{ specific_fields.potencia }}" placeholder="Ej: 500W, 1000W">
                                        </label>
                                        {% endif %}
                                    {% endif %}
                                    <label class="product-modal__spec-card product-modal__form-field">
                                        <span class="product-modal__spec-header">
                                            <span class="product-modal__spec-icon" aria-hidden="true">üßæ</span>
                                            <span class="product-modal__spec-title">Impuesto aplicado</span>
                                        </span>
                                        <div class="product-modal__tax-group" data-edit-tax-wrapper>
                                            <label class="checkbox-toggle">
                                                <input type="checkbox" name="usar_impuesto_global" value="true" data-edit-input-tax-mode>
                                                <span class="checkbox-toggle__track">
                                                    <span class="checkbox-toggle__thumb"></span>
                                                </span>
                                                <span class="checkbox-toggle__label">Usar impuesto global</span>
                                            </label>
                                            <div class="product-modal__tax-actions">
                                                <select name="impuesto" data-edit-input-tax hidden disabled>
                                                    <option value="">Sin impuesto</option>
                                                    {% for impuesto in impuestos %}
                                                        <option value="{{ impuesto.id }}">{{ impuesto.nombre }} ({{ impuesto.porcentaje }}%)</option>
                                                    {% endfor %}
                                                </select>
                                                <button type="button" class="btn btn-outline btn-sm product-modal__tax-create" data-edit-open-tax-modal>
                                                    <span aria-hidden="true">Ôºã</span>
                                                    <span class="product-modal__tax-create-label">Nuevo impuesto</span>
                                                </button>
                                            </div>
                                        </div>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </details>
                </div>
                <div class="product-modal__form-actions">
                    <button type="button" class="btn btn-outline btn--ghost" data-close-edit-modal>
                        <span class="btn__icon" aria-hidden="true">‚úï</span>
                        <span>Cancelar</span>
                    </button>
                    <button type="submit" class="btn btn-primary btn--elevated">
                        <span class="btn__icon" aria-hidden="true">üíæ</span>
                        <span>Guardar cambios</span>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="product-modal" data-condition-modal hidden>
    <div class="product-modal__backdrop" data-close-condition-modal></div>
    <div class="product-modal__dialog product-modal__dialog--compact" role="dialog" aria-modal="true" aria-labelledby="conditionModalTitle">
        <button type="button" class="product-modal__close" data-close-condition-modal aria-label="Cerrar modal">√ó</button>
        <div class="product-modal__body">
            <h3 class="product-modal__heading" id="conditionModalTitle">Gestionar condici√≥n</h3>
            <div class="condition-manager" data-condition-manager>
                <form class="condition-manager__form" data-condition-form>
                    {% csrf_token %}
                    <input type="hidden" name="condicion_id" value="" data-condition-id>
                    <div class="condition-manager__fields">
                        <div class="condition-manager__row">
                            <label class="product-modal__form-field" style="flex:1;min-width:220px;">
                                <span class="product-modal__form-label">Nombre</span>
                                <input type="text" name="nombre" maxlength="120" placeholder="Ej. Nuevo" data-condition-name required>
                            </label>
                            <label class="product-modal__form-field" style="width:160px;">
                                <span class="product-modal__form-label">Estado</span>
                                <select name="activo" data-condition-active>
                                    <option value="true">Activo</option>
                                    <option value="false">Inactivo</option>
                                </select>
                            </label>
                        </div>
                        <label class="product-modal__form-field">
                            <span class="product-modal__form-label">Descripci√≥n</span>
                            <textarea name="descripcion" rows="2" placeholder="Notas opcionales" data-condition-description></textarea>
                        </label>
                    </div>
                    <div class="condition-manager__row" style="justify-content:flex-end;">
                        <button type="button" class="btn btn-outline" data-condition-reset>Nuevo</button>
                        <button type="submit" class="btn btn-primary" data-condition-submit>Guardar</button>
                    </div>
                    <div class="condition-manager__error" data-condition-error hidden></div>
                </form>
                <div class="condition-manager__list" data-condition-list>
                    <div class="condition-manager__empty" data-condition-empty>Sin condiciones registradas.</div>
                </div>
            </div>
        </div>
        <div class="product-modal__footer condition-manager__footer">
            <button type="button" class="btn btn-secondary" data-close-condition-modal>Cerrar</button>
        </div>
    </div>
</div>

<script>
    // Funci√≥n de notificaci√≥n simple
    function showToast(message, type = 'info') {
        console.log(`[${type.toUpperCase()}] ${message}`);
        // Crear una notificaci√≥n simple si no existe un sistema de notificaciones
        const notification = document.createElement('div');
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 20px;
            background: ${type === 'error' ? '#dc3545' : type === 'success' ? '#28a745' : type === 'warning' ? '#ffc107' : '#17a2b8'};
            color: white;
            border-radius: 4px;
            z-index: 9999;
            font-size: 14px;
            max-width: 300px;
            text-align: center;
        `;
        notification.textContent = message;
        document.body.appendChild(notification);
        
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 3000);
    }

    document.addEventListener("DOMContentLoaded", function () {
        var detailSection = document.querySelector(".product-detail");
        var viewModal = document.querySelector("[data-product-modal]");
        var editModal = document.querySelector("[data-edit-modal]");
        var conditionModal = document.querySelector("[data-condition-modal]");
        var taxModal = null;  // legacy reference no longer used

        if (!detailSection || (!viewModal && !editModal && !conditionModal)) {
            return;
        }

        var body = document.body;
        var productData = detailSection.dataset || {};
        function formatCurrency(value) {
            if (value === null || value === undefined || value === "") {
                return "‚Äî";
            }
            var number = Number(value);
            if (Number.isNaN(number)) {
                return value;
            }
            return new Intl.NumberFormat("es-DO", {
                style: "currency",
                currency: "DOP",
                minimumFractionDigits: 2,
            }).format(number);
        }
        var productId = parseInt(productData.productId || "0", 10);
        var detailPath = productData.detailPath || "";
        var conditionApiUrl = productData.conditionApi || "";

        var modalUnitIndex = viewModal ? viewModal.querySelector("[data-modal-unit-index]") : null;
        var modalUnitImei = viewModal ? viewModal.querySelector("[data-modal-unit-imei]") : null;
        var modalUnitColor = viewModal ? viewModal.querySelector("[data-modal-unit-color]") : null;
        var modalProductName = viewModal ? viewModal.querySelector("[data-modal-product-name]") : null;
        var modalProductStorage = viewModal ? viewModal.querySelector("[data-modal-product-storage]") : null;
        var modalProductRam = viewModal ? viewModal.querySelector("[data-modal-product-ram]") : null;
        var modalProductCost = viewModal ? viewModal.querySelector("[data-modal-product-cost]") : null;
        var modalProductPrice = viewModal ? viewModal.querySelector("[data-modal-product-price]") : null;
        var modalUnitTax = viewModal ? viewModal.querySelector("[data-modal-unit-tax]") : null;
        var modalUnitBattery = viewModal ? viewModal.querySelector("[data-modal-unit-battery]") : null;
        var modalUnitBarcode = viewModal ? viewModal.querySelector("[data-modal-unit-barcode]") : null;
        var modalImage = viewModal ? viewModal.querySelector("[data-modal-image]") : null;
        var editModalUnitTag = editModal ? editModal.querySelector("[data-edit-modal-unit]") : null;
        var editModalUnitIndex = editModal ? editModal.querySelector("[data-edit-modal-unit-index]") : null;
        var editModalUnitImei = editModal ? editModal.querySelector("[data-edit-modal-unit-imei]") : null;
        var editModalUnitColor = editModal ? editModal.querySelector("[data-edit-modal-unit-color]") : null;
        var editModalUnitStorage = editModal ? editModal.querySelector("[data-edit-modal-unit-storage]") : null;
        var editModalUnitRam = editModal ? editModal.querySelector("[data-edit-modal-unit-ram]") : null;
        var editModalUnitTax = editModal ? editModal.querySelector("[data-edit-modal-unit-tax]") : null;
        var editModalForm = editModal ? editModal.querySelector("[data-edit-modal-form]") : null;
        var editInputIndex = editModal ? editModal.querySelector("[data-edit-input-index]") : null;
        var editInputImei = editModal ? editModal.querySelector("[data-edit-input-imei]") : null;
        var editInputColor = editModal ? editModal.querySelector("[data-edit-input-color]") : null;
        var editInputStorage = editModal ? editModal.querySelector("[data-edit-input-storage]") : null;
        var editInputRam = editModal ? editModal.querySelector("[data-edit-input-ram]") : null;
        var editInputBattery = editModal ? editModal.querySelector("[data-edit-input-battery]") : null;
        var editInputCondition = editModal ? editModal.querySelector("[data-edit-input-condition]") : null;
        var editInputCost = editModal ? editModal.querySelector("[data-edit-input-cost]") : null;
        var editInputPrice = editModal ? editModal.querySelector("[data-edit-input-price]") : null;
        var editInputTaxMode = editModal ? editModal.querySelector("[data-edit-input-tax-mode]") : null;
        var editInputTax = editModal ? editModal.querySelector("[data-edit-input-tax]") : null;
        var editCsrfInput = editModalForm ? editModalForm.querySelector('input[name="csrfmiddlewaretoken"]') : null;
        var editOpenTaxModalButton = editModal ? editModal.querySelector("[data-edit-open-tax-modal]") : null;

        var conditionManager = conditionModal ? conditionModal.querySelector("[data-condition-manager]") : null;
        var conditionForm = conditionManager ? conditionManager.querySelector("[data-condition-form]") : null;
        var conditionIdInput = conditionManager ? conditionManager.querySelector("[data-condition-id]") : null;
        var conditionNameInput = conditionManager ? conditionManager.querySelector("[data-condition-name]") : null;
        var conditionDescriptionInput = conditionManager ? conditionManager.querySelector("[data-condition-description]") : null;
        var conditionActiveInput = conditionManager ? conditionManager.querySelector("[data-condition-active]") : null;
        var conditionSubmitButton = conditionManager ? conditionManager.querySelector("[data-condition-submit]") : null;
        var conditionResetButton = conditionManager ? conditionManager.querySelector("[data-condition-reset]") : null;
        var conditionErrorBox = conditionManager ? conditionManager.querySelector("[data-condition-error]") : null;
        var conditionList = conditionManager ? conditionManager.querySelector("[data-condition-list]") : null;
        var conditionEmptyState = conditionManager ? conditionManager.querySelector("[data-condition-empty]") : null;

        var conditionState = {
            loaded: false,
            loading: false,
            items: [],
        };

        function showInlineError(message) {
            if (!editModalForm) {
                return;
            }
            var alertBox = editModalForm.querySelector(".product-modal__error");
            if (!alertBox) {
                alertBox = document.createElement("div");
                alertBox.className = "product-modal__error";
                editModalForm.prepend(alertBox);
            }
            alertBox.textContent = message;
        }

        function clearInlineError() {
            if (!editModalForm) {
                return;
            }
            var alertBox = editModalForm.querySelector(".product-modal__error");
            if (alertBox) {
                alertBox.remove();
            }
        }

        function lockBody() {
            body.classList.add("modal-open");
        }

        function unlockBodyIfNoModal() {
            var viewOpen = viewModal && !viewModal.hasAttribute("hidden");
            var editOpen = editModal && !editModal.hasAttribute("hidden");
            var conditionOpen = conditionModal && !conditionModal.hasAttribute("hidden");
            if (!viewOpen && !editOpen && !conditionOpen) {
                body.classList.remove("modal-open");
            }
        }

        function resolveUnitCard(unitIndex) {
            return detailSection.querySelector('[data-unit-card="' + unitIndex + '"]');
        }

        function parseCardData(unitIndex) {
            var card = resolveUnitCard(unitIndex);
            if (!card) {
                return {
                    imei: "",
                    color: "",
                    almacenamiento: "",
                    almacenamiento_label: "No especificado",
                    memoria_ram: "",
                    memoria_ram_label: "No especificada",
                    producto_condicion: "",
                    producto_condicion_label: "Sin especificar",
                    has_custom: false,
                };
            }
            return {
                imei: card.dataset.unitImei || "",
                color: card.dataset.unitColor || "",
                almacenamiento: card.dataset.unitStorage || "",
                almacenamiento_label: card.dataset.unitStorageLabel || "No especificado",
                memoria_ram: card.dataset.unitRam || "",
                memoria_ram_label: card.dataset.unitRamLabel || "No especificada",
                vida_bateria: card.dataset.unitBattery || "",
                producto_condicion: card.dataset.unitCondition || "",
                producto_condicion_label: card.dataset.unitConditionLabel || "Sin especificar",
                usar_impuesto_global: card.dataset.unitUseGlobal === "true",
                impuesto_id: card.dataset.unitTaxId || "",
                impuesto_label: card.dataset.unitTaxLabel || "Impuesto global",
                impuesto_porcentaje: card.dataset.unitTaxRate || "",
                impuesto_activo: card.dataset.unitTaxActive === "true",
                has_custom: card.dataset.unitHasCustom === "true",
            };
        }

        function syncProductData(productInfo) {
            if (!productInfo || !detailSection) {
                return;
            }

            var hasUpdates = false;

            if (Object.prototype.hasOwnProperty.call(productInfo, "precio_compra")) {
                var compraValue = productInfo.precio_compra;
                if (compraValue === null || compraValue === undefined) {
                    compraValue = "";
                }
                detailSection.dataset.productCosto = String(compraValue);
                hasUpdates = true;
                if (editInputCost && document.activeElement !== editInputCost) {
                    editInputCost.value = String(compraValue);
                }
            }

            if (Object.prototype.hasOwnProperty.call(productInfo, "precio_venta")) {
                var ventaValue = productInfo.precio_venta;
                if (ventaValue === null || ventaValue === undefined) {
                    ventaValue = "";
                }
                detailSection.dataset.productPrecio = String(ventaValue);
                hasUpdates = true;
                if (editInputPrice && document.activeElement !== editInputPrice) {
                    editInputPrice.value = String(ventaValue);
                }
            }

            if (!hasUpdates) {
                return;
            }

            if (modalProductCost) {
                // Usar precio del producto actualizado que viene en productInfo
                var resolvedCost = productInfo.precio_compra || productData.productCosto || "";
                modalProductCost.textContent = formatCurrency(resolvedCost || "");
            }
            if (modalProductPrice) {
                // Usar precio del producto actualizado que viene en productInfo
                var resolvedPrice = productInfo.precio_venta || productData.productPrecio || "";
                modalProductPrice.textContent = formatCurrency(resolvedPrice || "");
            }
        }

        function buildUnitUrl(unitIndex) {
            if (!productId || !unitIndex) {
                return null;
            }
            var base = detailPath || window.location.pathname;
            if (!base.endsWith("/")) {
                base += "/";
            }
            return base + "unidad/" + unitIndex + "/";
        }

        function updateCardDisplay(unitIndex, unitData) {
            var card = resolveUnitCard(unitIndex);
            if (!card) {
                return;
            }
            card.dataset.unitImei = unitData.imei || "";
            card.dataset.unitColor = unitData.color || "";
            card.dataset.unitStorage = unitData.almacenamiento || "";
            card.dataset.unitStorageLabel = unitData.almacenamiento_label || "No especificado";
            card.dataset.unitRam = unitData.memoria_ram || "";
            card.dataset.unitRamLabel = unitData.memoria_ram_label || "No especificada";
            card.dataset.unitBattery = unitData.vida_bateria || "";
            card.dataset.unitCondition = unitData.producto_condicion || "";
            card.dataset.unitConditionLabel = unitData.producto_condicion_label || "Sin especificar";
            card.dataset.unitHasCustom = unitData.has_custom ? "true" : "false";
            card.dataset.unitUseGlobal = unitData.usar_impuesto_global ? "true" : "false";
            card.dataset.unitTaxId = unitData.impuesto_id || "";
            card.dataset.unitTaxLabel = unitData.impuesto_label || "Impuesto global";
            card.dataset.unitTaxRate = unitData.impuesto_porcentaje || "";
            card.dataset.unitTaxActive = unitData.impuesto_activo ? "true" : "false";

            var imeiTarget = card.querySelector("[data-unit-imei]");
            var colorTarget = card.querySelector("[data-unit-color]");
            var storageTarget = card.querySelector("[data-unit-storage]");
            var ramTarget = card.querySelector("[data-unit-ram]");
            var taxTarget = card.querySelector("[data-unit-tax]");

            if (imeiTarget) {
                imeiTarget.textContent = unitData.imei || "Sin IMEI";
            }
            if (colorTarget) {
                colorTarget.textContent = unitData.color || "Sin color";
            }
            if (storageTarget) {
                storageTarget.textContent = unitData.almacenamiento_label || "No especificado";
            }
            if (ramTarget) {
                ramTarget.textContent = unitData.memoria_ram_label || "No especificada";
            }
            var batteryTarget = card.querySelector("[data-unit-battery]");
            if (batteryTarget) {
                batteryTarget.textContent = unitData.vida_bateria ? unitData.vida_bateria + "%" : "Sin dato";
            }
            if (taxTarget) {
                taxTarget.textContent = unitData.impuesto_label || "Impuesto global";
            }
            var conditionTarget = card.querySelector("[data-unit-condition]");
            if (conditionTarget) {
                conditionTarget.textContent = unitData.producto_condicion_label || "Sin especificar";
            }
            var badge = card.querySelector("[data-unit-condition-chip]");
            if (badge) {
                var badgeClass = resolveConditionClass(unitData.producto_condicion_label || "");
                badge.className = "stock-card__badge" + (badgeClass ? " " + badgeClass : "");
                badge.textContent = unitData.producto_condicion_label || "Sin especificar";
            }

            card.querySelectorAll("[data-open-unit-modal]").forEach(function (btn) {
                btn.dataset.unitIndex = unitIndex;
            });
            card.querySelectorAll("[data-open-edit-modal]").forEach(function (btn) {
                btn.dataset.unitIndex = unitIndex;
            });
        }

        function hydrateViewModal(unitIndex, unitData) {
            if (!viewModal) {
                return;
            }

            if (modalProductName && productData.productName) {
                modalProductName.textContent = productData.productName;
            }

            var statusChip = detailSection.querySelector('[data-unit-card="' + unitIndex + '"] [data-unit-condition-chip]');
            var modalStatusChip = viewModal.querySelector('[data-modal-unit-status]');

            if (modalUnitIndex) {
                modalUnitIndex.textContent = unitIndex || "‚Äî";
            }
            if (modalUnitImei) {
                modalUnitImei.textContent = (unitData && unitData.imei) ? unitData.imei : "Sin IMEI";
            }
            if (modalUnitColor) {
                modalUnitColor.textContent = (unitData && unitData.color) ? unitData.color : "Sin color";
            }
            if (modalUnitBattery) {
                var batteryLabel = unitData && unitData.vida_bateria ? unitData.vida_bateria + "%" : "Sin dato";
                modalUnitBattery.textContent = batteryLabel;
            }
            if (modalUnitBarcode) {
                var barcodeLabel = unitData && unitData.codigo_barras ? unitData.codigo_barras : "Generando...";
                modalUnitBarcode.textContent = barcodeLabel;
            }
            if (modalProductStorage) {
                var fallbackStorage = productData.productAlmacenamientoLabel || "No especificado";
                modalProductStorage.textContent = (unitData && unitData.almacenamiento_label) ? unitData.almacenamiento_label : fallbackStorage;
            }
            if (modalProductRam) {
                var fallbackRam = productData.productRamLabel || "No especificada";
                modalProductRam.textContent = (unitData && unitData.memoria_ram_label) ? unitData.memoria_ram_label : fallbackRam;
            }
            if (modalUnitTax) {
                var taxLabel = unitData && unitData.impuesto_label ? unitData.impuesto_label : (unitData && unitData.usar_impuesto_global ? "Impuesto global" : "Sin impuesto");
                modalUnitTax.textContent = taxLabel || "Impuesto global";
            }
            if (modalProductCost) {
                // Usar precio espec√≠fico de la unidad si existe, sino el del producto general
                var resolvedCost = (unitData && unitData.precio_compra) ? unitData.precio_compra : (productData.productCosto || "");
                modalProductCost.textContent = formatCurrency(resolvedCost || "");
            }
            if (modalProductPrice) {
                // Usar precio espec√≠fico de la unidad si existe, sino el del producto general
                var resolvedPrice = (unitData && unitData.precio_venta) ? unitData.precio_venta : (productData.productPrecio || "");
                modalProductPrice.textContent = formatCurrency(resolvedPrice || "");
            }

            if (modalStatusChip) {
                var label = (unitData && unitData.producto_condicion_label) ? unitData.producto_condicion_label : (statusChip ? statusChip.textContent : "Sin especificar");
                var badgeClass = resolveConditionClass(label || "");
                modalStatusChip.className = "stock-card__badge unit-detail__status" + (badgeClass ? " " + badgeClass : "");
                modalStatusChip.textContent = label || "Sin especificar";
            }

            if (modalImage && productData.productImagen) {
                modalImage.setAttribute("src", productData.productImagen);
                modalImage.setAttribute("alt", "Imagen de " + (productData.productName || "producto"));
            }
        }

        function resolveConditionClass(label) {
            if (!label) {
                return "stock-card__badge--neutral";
            }
            var normalized = label.trim().toLowerCase();
            if (
                normalized === "sin especificar" ||
                normalized.includes("sin especific") ||
                normalized.includes("sin estado")
            ) {
                return "stock-card__badge--neutral";
            }
            if (
                normalized.includes("nuevo") ||
                normalized.includes("excelente") ||
                normalized.includes("a+") ||
                normalized.includes("a+")
            ) {
                return "stock-card__badge--success";
            }
            if (
                normalized.includes("clase a") ||
                normalized.includes("CLASE A")
            ) {
                return "stock-card__badge--info";
            }
            if (
                normalized.includes("usado") ||
                normalized.includes("semi") ||
                normalized.includes("clase b") ||
                normalized.includes("CLASE B") ||
                normalized.includes("b+")
            ) {
                return "stock-card__badge--warning";
            }
            if (
                normalized.includes("clase c") ||
                normalized.includes("CLASE C") ||
                normalized.includes("repar") ||
                normalized.includes("da√±") ||
                normalized.includes("averiado")
            ) {
                return "stock-card__badge--danger";
            }
            return "stock-card__badge--info";
        }

        detailSection.querySelectorAll("[data-unit-card]").forEach(function (card) {
            var indexValue = card.getAttribute("data-unit-card");
            if (!indexValue) {
                return;
            }
            var data = parseCardData(indexValue);
            updateCardDisplay(indexValue, data);
        });

        // Handle print label buttons
        var printLabelButtons = document.querySelectorAll('[data-print-label]');
        printLabelButtons.forEach(function(button) {
            button.addEventListener('click', function() {
                var unitId = button.getAttribute('data-unit-id');
                if (unitId) {
                    generateBarcodeLabel([unitId]);
                }
            });
        });

        function generateBarcodeLabel(unitIds) {
            if (!unitIds || unitIds.length === 0) {
                showToast('No se especificaron unidades para imprimir', 'warning');
                return;
            }
            
            var params = unitIds.map(id => 'units[]=' + encodeURIComponent(id)).join('&');
            var url = '{% url "dashboard:generate_barcode_labels_api" %}?' + params;
            
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.labels) {
                        openPrintWindow(data.labels);
                    } else {
                        showToast(data.error || 'Error generando etiquetas', 'error');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showToast('Error de conexi√≥n al generar etiquetas', 'error');
                });
        }

        function openPrintWindow(labels) {
            var printWindow = window.open('', '_blank', 'width=800,height=600');
            var doc = printWindow.document;
            
            doc.open();
            doc.write('<!DOCTYPE html>');
            doc.write('<html><head><title>Etiquetas</title>');
            doc.write('<style>');
            doc.write('body{font-family:Arial,sans-serif;margin:20px}');
            doc.write('.label{border:1px solid #ccc;padding:10px;margin:10px 0;width:300px;display:inline-block}');
            doc.write('.label-code{font-size:18px;font-weight:bold;text-align:center;font-family:monospace}');
            doc.write('.label-product{font-size:14px;font-weight:bold}');
            doc.write('.label-details{font-size:12px;color:#666}');
            doc.write('.label-price{font-size:16px;font-weight:bold;color:#2c5aa0}');
            doc.write('</style></head><body>');
            doc.write('<h2>Etiquetas de C√≥digo de Barras</h2>');
            
            for (var i = 0; i < labels.length; i++) {
                var label = labels[i];
                doc.write('<div class="label">');
                doc.write('<div class="label-code">' + label.codigo + '</div>');
                doc.write('<div class="label-product">' + label.producto + '</div>');
                doc.write('<div class="label-details">' + label.unidad + '</div>');
                doc.write('<div class="label-details">IMEI: ' + label.imei + '</div>');
                doc.write('<div class="label-details">Color: ' + label.color + '</div>');
                doc.write('<div class="label-price">RD$ ' + label.precio + '</div>');
                doc.write('</div>');
            }
            
            doc.write('</body></html>');
            doc.close();
            setTimeout(function() {
                printWindow.print();
            }, 500);
        }

        function updateTaxModePresentation(toggle) {
            if (!toggle || !editInputTax) {
                return;
            }
            var useGlobal = toggle.checked;
            if (useGlobal) {
                editInputTax.setAttribute("hidden", "hidden");
                editInputTax.disabled = true;
            } else {
                editInputTax.removeAttribute("hidden");
                editInputTax.disabled = false;
            }
        }

        function getCsrfToken() {
            var csrfInput = document.querySelector('input[name="csrfmiddlewaretoken"]');
            if (csrfInput) {
                return csrfInput.value;
            }
            return "";
        }

        var taxManagementModal = document.querySelector("[data-tax-management-modal]");
        var taxCreateModal = document.querySelector("[data-tax-create-modal]");
        var taxTableBody = taxManagementModal ? taxManagementModal.querySelector("[data-tax-table-body]") : null;

        function refreshTaxRows() {
            if (!taxTableBody) {
                return;
            }
            var emptyRow = taxTableBody.querySelector("[data-tax-empty]");
            var rows = taxTableBody.querySelectorAll("[data-tax-row]");
            if (emptyRow) {
                emptyRow.hidden = rows.length > 0;
            }
            var counter = 0;
            rows.forEach(function (row) {
                var indexCell = row.querySelector("[data-row-index]");
                if (indexCell) {
                    counter += 1;
                    indexCell.textContent = counter;
                }
                attachTaxRowHandlers(row);
            });
        }

        function appendTaxOption(taxData) {
            if (!taxData || !editInputTax) {
                return;
            }
            var option = editInputTax.querySelector('option[value="' + taxData.id + '"]');
            if (!option) {
                option = document.createElement("option");
                option.value = taxData.id;
                editInputTax.appendChild(option);
            }
            option.textContent = taxData.nombre + " (" + taxData.porcentaje + "%)";
            option.dataset.taxOptionActive = taxData.activo ? "true" : "false";
            editInputTax.value = String(taxData.id);
        }

        function updateSelectedTaxLabel(name, rate) {
            if (editModalUnitTax) {
                var label = name ? name + (rate ? " (" + rate + "%)" : "") : "Sin impuesto";
                editModalUnitTax.textContent = label;
            }
        }

        function attachTaxRowHandlers(row) {
            if (!row) {
                return;
            }
            var selectButton = row.querySelector("[data-tax-select-button]");
            if (selectButton && selectButton.dataset.bound !== "true") {
                selectButton.dataset.bound = "true";
                selectButton.addEventListener("click", function () {
                    var taxId = row.dataset.taxId;
                    var taxName = row.dataset.taxName;
                    var taxRate = row.dataset.taxRate;
                    appendTaxOption({ id: taxId, nombre: taxName, porcentaje: taxRate, activo: row.dataset.taxActive === "true" });
                    if (editInputTaxMode) {
                        editInputTaxMode.checked = false;
                        updateTaxModePresentation(editInputTaxMode);
                    }
                    updateSelectedTaxLabel(taxName, taxRate);
                    if (taxManagementModal) {
                        taxManagementModal.setAttribute("hidden", "hidden");
                    }
                    unlockBodyIfNoModal();
                    showToast("Impuesto seleccionado: " + taxName, "success");
                });
            }

            var toggleButton = row.querySelector("[data-tax-toggle-button]");
            if (toggleButton && toggleButton.dataset.bound !== "true") {
                toggleButton.dataset.bound = "true";
                toggleButton.addEventListener("click", function () {
                    var toggleUrl = toggleButton.dataset.toggleUrl;
                    if (!toggleUrl) {
                        return;
                    }
                    toggleButton.disabled = true;
                    fetch(toggleUrl, {
                        method: "POST",
                        headers: {
                            "X-CSRFToken": getCsrfToken(),
                        },
                    })
                        .then(function (response) {
                            if (!response.ok) {
                                throw new Error("No se pudo actualizar el estado del impuesto.");
                            }
                            return response.json();
                        })
                        .then(function (data) {
                            row.dataset.taxActive = data.activo ? "true" : "false";
                            row.dataset.taxName = data.nombre || "";
                            row.dataset.taxRate = data.porcentaje || "0";
                            var statusSpan = row.querySelector(".lookup-status");
                            if (statusSpan) {
                                statusSpan.textContent = data.activo ? "Activo" : "Inactivo";
                                statusSpan.classList.toggle("lookup-status--active", !!data.activo);
                                statusSpan.classList.toggle("lookup-status--inactive", !data.activo);
                            }
                            toggleButton.textContent = data.activo ? "Inactivar" : "Activar";
                            toggleButton.disabled = false;
                            appendTaxOption(data);
                            showToast("Estado del impuesto actualizado.", "success");
                        })
                        .catch(function (error) {
                            toggleButton.disabled = false;
                            showToast(error.message || "No se pudo actualizar el impuesto.", "error");
                        });
                });
            }
        }

        function openTaxManagementModal() {
            if (!taxManagementModal) {
                return;
            }
            if (editModal && !editModal.hasAttribute("hidden")) {
                editModal.dataset.wasTemporarilyHidden = "true";
                editModal.setAttribute("hidden", "hidden");
            }
            taxManagementModal.removeAttribute("hidden");
            lockBody();
            refreshTaxRows();
        }

        function closeTaxManagementModal() {
            if (!taxManagementModal) {
                return;
            }
            taxManagementModal.setAttribute("hidden", "hidden");
            if (editModal && editModal.dataset.wasTemporarilyHidden === "true") {
                delete editModal.dataset.wasTemporarilyHidden;
                editModal.removeAttribute("hidden");
                lockBody();
            } else {
                unlockBodyIfNoModal();
            }
        }

        function openTaxCreateModal() {
            if (!taxCreateModal) {
                return;
            }
            if (taxManagementModal && !taxManagementModal.hasAttribute("hidden")) {
                taxManagementModal.dataset.wasTemporarilyHidden = "true";
                taxManagementModal.setAttribute("hidden", "hidden");
            }
            lockBody();
            var form = taxCreateModal.querySelector("[data-tax-create-form]");
            if (form) {
                form.reset();
                showTaxCreateError("");
                var nameInput = form.querySelector("[data-tax-create-name]");
                if (nameInput) {
                    nameInput.focus();
                }
            }
            taxCreateModal.removeAttribute("hidden");
        }

        function closeTaxCreateModal() {
            if (!taxCreateModal) {
                return;
            }
            taxCreateModal.setAttribute("hidden", "hidden");
            if (taxManagementModal && taxManagementModal.dataset.wasTemporarilyHidden === "true") {
                delete taxManagementModal.dataset.wasTemporarilyHidden;
                taxManagementModal.removeAttribute("hidden");
                refreshTaxRows();
                lockBody();
            } else {
                unlockBodyIfNoModal();
            }
        }

        function showTaxCreateError(message) {
            if (!taxCreateModal) {
                return;
            }
            var errorWrapper = taxCreateModal.querySelector("[data-tax-create-error]");
            var messageBox = taxCreateModal.querySelector("[data-tax-create-error-message]");
            if (!errorWrapper || !messageBox) {
                return;
            }
            if (message) {
                errorWrapper.hidden = false;
                messageBox.textContent = message;
            } else {
                errorWrapper.hidden = true;
                messageBox.textContent = "";
            }
        }

        function addTaxRow(data) {
            if (!taxTableBody) {
                return;
            }
            var emptyRow = taxTableBody.querySelector("[data-tax-empty]");
            if (emptyRow) {
                emptyRow.hidden = true;
            }
            var row = document.createElement("tr");
            row.dataset.taxRow = "";
            row.dataset.taxId = data.id;
            row.dataset.taxName = data.nombre || "";
            row.dataset.taxRate = data.porcentaje || "0";
            row.dataset.taxActive = data.activo ? "true" : "false";
            row.innerHTML = [
                '<td data-row-index></td>',
                '<td><span class="lookup-name">' + (data.nombre || "") + '</span></td>',
                '<td>' + (data.porcentaje || "0") + '%</td>',
                '<td><span class="lookup-status ' + (data.activo ? 'lookup-status--active' : 'lookup-status--inactive') + '">' + (data.activo ? 'Activo' : 'Inactivo') + '</span></td>',
                '<td><button type="button" class="btn btn-outline btn--compact" data-tax-select-button>Seleccionar</button></td>',
                '<td><button type="button" class="btn btn-outline btn--compact" data-tax-toggle-button data-toggle-url="' + ("{% url 'dashboard:toggle_tax_status_api' 0 %}".replace(/0$/, String(data.id || ""))) + '">' + (data.activo ? 'Inactivar' : 'Activar') + '</button></td>'
            ].join("");
            taxTableBody.appendChild(row);
            attachTaxRowHandlers(row);
            refreshTaxRows();
        }

        if (editInputTaxMode) {
            editInputTaxMode.addEventListener("change", function () {
                updateTaxModePresentation(editInputTaxMode);
            });
            updateTaxModePresentation(editInputTaxMode);
        }

        if (editOpenTaxModalButton) {
            editOpenTaxModalButton.addEventListener("click", function () {
                if (editInputTaxMode) {
                    editInputTaxMode.checked = false;
                    updateTaxModePresentation(editInputTaxMode);
                }
                openTaxManagementModal();
            });
        }

        if (taxManagementModal) {
            taxManagementModal.querySelectorAll('[data-close-tax-management]').forEach(function (button) {
                button.addEventListener("click", function () {
                    closeTaxManagementModal();
                });
            });
            var openCreateButton = taxManagementModal.querySelector('[data-open-tax-create]');
            if (openCreateButton) {
                openCreateButton.addEventListener("click", function () {
                    openTaxCreateModal();
                });
            }
        }

        if (taxCreateModal) {
            taxCreateModal.querySelectorAll('[data-close-tax-create]').forEach(function (button) {
                button.addEventListener("click", function () {
                    closeTaxCreateModal();
                });
            });
            var taxCreateForm = taxCreateModal.querySelector('[data-tax-create-form]');
            if (taxCreateForm) {
                taxCreateForm.addEventListener("submit", function (event) {
                    event.preventDefault();
                    showTaxCreateError("");

                    var nameInput = taxCreateForm.querySelector('[data-tax-create-name]');
                    var rateInput = taxCreateForm.querySelector('[data-tax-create-rate]');
                    var activeInput = taxCreateForm.querySelector('[data-tax-create-active]');

                    var nombre = nameInput ? nameInput.value.trim() : "";
                    var porcentaje = rateInput ? rateInput.value.trim() : "";
                    var activo = activeInput ? activeInput.checked : true;

                    if (!nombre) {
                        showTaxCreateError("Ingresa el nombre del impuesto.");
                        if (nameInput) {
                            nameInput.focus();
                        }
                        return;
                    }
                    if (!porcentaje) {
                        showTaxCreateError("Ingresa el porcentaje de impuesto.");
                        if (rateInput) {
                            rateInput.focus();
                        }
                        return;
                    }

                    var submitButton = taxCreateForm.querySelector('[data-tax-create-submit]');
                    if (submitButton) {
                        submitButton.disabled = true;
                    }

                    fetch("{% url 'dashboard:create_tax_api' %}", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            "X-CSRFToken": getCsrfToken(),
                        },
                        body: JSON.stringify({ nombre: nombre, porcentaje: porcentaje, activo: activo }),
                    })
                        .then(function (response) {
                            if (!response.ok) {
                                return response.json().then(function (payload) {
                                    throw new Error(payload && payload.error ? payload.error : "No se pudo registrar el impuesto.");
                                });
                            }
                            return response.json();
                        })
                        .then(function (data) {
                            appendTaxOption(data);
                            addTaxRow(data);
                            closeTaxCreateModal();
                            showToast("Impuesto registrado correctamente.", "success");
                        })
                        .catch(function (error) {
                            showTaxCreateError(error.message || "No se pudo registrar el impuesto.");
                        })
                        .finally(function () {
                            if (submitButton) {
                                submitButton.disabled = false;
                            }
                        });
                });
            }
        }

        function openViewModal(button) {
            if (!viewModal) {
                return;
            }
            var unitIndex = button.getAttribute("data-unit-index");
            if (!unitIndex) {
                return;
            }

            var initialData = parseCardData(unitIndex);
            hydrateViewModal(unitIndex, initialData);

            viewModal.removeAttribute("hidden");
            lockBody();
            var closeBtn = viewModal.querySelector("[data-close-modal]");
            if (closeBtn) {
                closeBtn.focus();
            }

            var unitUrl = buildUnitUrl(unitIndex);
            if (!unitUrl) {
                return;
            }

            fetch(unitUrl, {
                credentials: "same-origin",
                headers: {
                    "Accept": "application/json"
                }
            })
                .then(function (response) {
                    if (!response.ok) {
                        throw new Error("No se pudo cargar la unidad");
                    }
                    return response.json();
                })
                .then(function (data) {
                    if (!data.success) {
                        throw new Error(data.message || "No se pudo cargar la unidad");
                    }
                    var unitData = data.unit || {};
                    hydrateViewModal(unitIndex, unitData);
                    updateCardDisplay(unitIndex, unitData);
                })
                .catch(function (error) {
                    console.error(error);
                });
        }

        function closeViewModal() {
            if (!viewModal || viewModal.hasAttribute("hidden")) {
                return;
            }
            viewModal.setAttribute("hidden", "hidden");
            unlockBodyIfNoModal();
        }

        function hydrateEditModal(unitIndex, unitData) {
            if (!editModal) {
                return;
            }

            if (editModalUnitTag) {
                var label = unitIndex || "‚Äî";
                editModalUnitTag.textContent = "Unidad " + label;
            }
            if (editInputIndex) {
                editInputIndex.value = unitIndex || "";
            }
            if (editModalUnitIndex) {
                editModalUnitIndex.textContent = unitIndex || "‚Äî";
            }
            if (editInputCost) {
                var resolvedCost = productData.productCosto || "";
                if (unitData && Object.prototype.hasOwnProperty.call(unitData, "precio_compra")) {
                    resolvedCost = unitData.precio_compra || "";
                }
                editInputCost.value = resolvedCost;
            }
            if (editInputPrice) {
                var resolvedPrice = productData.productPrecio || "";
                if (unitData && Object.prototype.hasOwnProperty.call(unitData, "precio_venta")) {
                    resolvedPrice = unitData.precio_venta || "";
                }
                editInputPrice.value = resolvedPrice;
            }
            if (editInputImei) {
                editInputImei.value = unitData && unitData.imei ? unitData.imei : "";
            }
            if (editInputColor) {
                editInputColor.value = unitData && unitData.color ? unitData.color : "";
            }
            if (editInputStorage) {
                editInputStorage.value = unitData && unitData.almacenamiento ? unitData.almacenamiento : "";
            }
            if (editInputRam) {
                editInputRam.value = unitData && unitData.memoria_ram ? unitData.memoria_ram : "";
            }
            if (editInputBattery) {
                editInputBattery.value = unitData && unitData.vida_bateria ? unitData.vida_bateria : "";
            }
            if (editModalUnitImei) {
                editModalUnitImei.textContent = (unitData && unitData.imei) ? unitData.imei : "Sin IMEI";
            }
            if (editModalUnitColor) {
                editModalUnitColor.textContent = (unitData && unitData.color) ? unitData.color : "Sin color";
            }
            if (editModalUnitStorage) {
                editModalUnitStorage.textContent = (unitData && unitData.almacenamiento_label) ? unitData.almacenamiento_label : "No especificado";
            }
            if (editModalUnitRam) {
                editModalUnitRam.textContent = (unitData && unitData.memoria_ram_label) ? unitData.memoria_ram_label : "No especificada";
            }
            if (editModalUnitTax) {
                editModalUnitTax.textContent = (unitData && unitData.impuesto_label) ? unitData.impuesto_label : "Impuesto global";
            }
            if (editModalUnitTax) {
                editModalUnitTax.textContent = (unitData && unitData.impuesto_label) ? unitData.impuesto_label : "Impuesto global";
            }
            if (editInputCondition && unitData && Object.prototype.hasOwnProperty.call(unitData, "producto_condicion")) {
                editInputCondition.value = unitData.producto_condicion || "";
            }
            if (editInputTaxMode) {
                var useGlobal = !unitData || unitData.usar_impuesto_global !== false;
                editInputTaxMode.checked = useGlobal;
                updateTaxModePresentation(editInputTaxMode);
            }
            if (editInputTax && unitData) {
                editInputTax.value = unitData.impuesto_id || "";
            }
        }

        function openEditModal(button) {
            if (!editModal) {
                return;
            }
            var unitIndex = button.getAttribute("data-unit-index");
            if (!unitIndex) {
                return;
            }

            var initialData = parseCardData(unitIndex);
            hydrateEditModal(unitIndex, initialData);
            clearInlineError();

            editModal.removeAttribute("hidden");
            lockBody();
            var closeBtnInitial = editModal.querySelector("[data-close-edit-modal]");
            if (closeBtnInitial) {
                closeBtnInitial.focus();
            }

            var unitUrl = buildUnitUrl(unitIndex);
            if (!unitUrl) {
                return;
            }

            fetch(unitUrl, {
                credentials: "same-origin",
                headers: {
                    "Accept": "application/json"
                }
            })
                .then(function (response) {
                    if (!response.ok) {
                        throw new Error("No se pudo cargar la unidad");
                    }
                    return response.json();
                })
                .then(function (data) {
                    if (!data.success) {
                        throw new Error(data.message || "No se pudo cargar la unidad");
                    }
                    var unitData = data.unit || {};
                    if (data.product) {
                        syncProductData(data.product);
                    }
                    hydrateEditModal(unitIndex, unitData);
                    updateTaxModePresentation(editInputTaxMode);
                })
                .catch(function (error) {
                    console.error(error);
                });
        }

        function closeEditModal() {
            if (!editModal || editModal.hasAttribute("hidden")) {
                return;
            }
            editModal.setAttribute("hidden", "hidden");
            unlockBodyIfNoModal();
        }

        function handleEditFormSubmit(event) {
            if (!editModalForm) {
                return;
            }
            event.preventDefault();

            var unitIndexValue = editInputIndex ? (editInputIndex.value || "").trim() : "";
            if (!unitIndexValue) {
                showInlineError("No se pudo identificar la unidad.");
                return;
            }

            var unitUrl = buildUnitUrl(unitIndexValue);
            if (!unitUrl) {
                showInlineError("No se pudo determinar la ruta de actualizaci√≥n.");
                return;
            }

            clearInlineError();

            var formData = new FormData(editModalForm);
            if (editInputCondition) {
                formData.set("producto_condicion", editInputCondition.value || "");
            }
            if (editInputCost) {
                formData.set("precio_costo", (editInputCost.value || "").toString().trim());
            }
            if (editInputPrice) {
                formData.set("precio_venta", (editInputPrice.value || "").toString().trim());
            }
            if (editInputTaxMode) {
                formData.set("usar_impuesto_global", editInputTaxMode.checked ? "true" : "false");
            }
            if (editInputTax) {
                formData.set("impuesto", (editInputTax.value || "").toString().trim());
            }

            fetch(unitUrl, {
                method: "POST",
                credentials: "same-origin",
                headers: {
                    "X-Requested-With": "XMLHttpRequest",
                    "X-CSRFToken": editCsrfInput ? editCsrfInput.value : "",
                    "Accept": "application/json",
                },
                body: formData,
            })
                .then(function (response) {
                    return response.json().then(function (payload) {
                        if (!response.ok || !payload.success) {
                            var message = payload && payload.message ? payload.message : "No se pudo guardar la unidad.";
                            throw new Error(message);
                        }
                        return payload;
                    });
                })
                .then(function (payload) {
                    var unitData = payload.unit || {};
                    if (payload.product) {
                        syncProductData(payload.product);
                    }
                    hydrateEditModal(unitIndexValue, unitData);
                    updateTaxModePresentation(editInputTaxMode);
                    updateCardDisplay(unitIndexValue, unitData);
                    closeEditModal();
                    showToast("Unidad actualizada correctamente.", "success");
                })
                .catch(function (error) {
                    console.error(error);
                    showInlineError(error.message || "Ocurri√≥ un error al guardar la unidad.");
                });
        }

        function showConditionError(message) {
            if (!conditionErrorBox) {
                return;
            }
            if (message) {
                conditionErrorBox.textContent = message;
                conditionErrorBox.hidden = false;
            } else {
                conditionErrorBox.textContent = "";
                conditionErrorBox.hidden = true;
            }
        }

        function resetConditionForm() {
            if (!conditionForm) {
                return;
            }
            conditionForm.reset();
            if (conditionIdInput) {
                conditionIdInput.value = "";
            }
            if (conditionActiveInput) {
                conditionActiveInput.value = "true";
            }
            if (conditionSubmitButton) {
                conditionSubmitButton.textContent = "Guardar";
            }
            showConditionError("");
        }

        function renderConditionSelect(items) {
            if (!editInputCondition) {
                return;
            }
            var previous = editInputCondition.value;
            editInputCondition.innerHTML = "";
            var emptyOption = document.createElement("option");
            emptyOption.value = "";
            emptyOption.textContent = "Sin especificar";
            editInputCondition.appendChild(emptyOption);
            var found = false;
            items.filter(function (item) { return item.activo; }).forEach(function (item) {
                var option = document.createElement("option");
                option.value = String(item.id);
                option.textContent = item.nombre;
                if (!found && previous && String(item.id) === previous) {
                    option.selected = true;
                    found = true;
                }
                editInputCondition.appendChild(option);
            });
            if (previous && !found) {
                editInputCondition.value = "";
            }
        }

        function renderConditionList(items) {
            if (!conditionList) {
                return;
            }
            conditionList.querySelectorAll(".condition-item").forEach(function (node) {
                node.remove();
            });
            if (!items || !items.length) {
                if (conditionEmptyState) {
                    conditionEmptyState.hidden = false;
                }
                return;
            }
            if (conditionEmptyState) {
                conditionEmptyState.hidden = true;
            }

            items.forEach(function (item) {
                var wrapper = document.createElement("div");
                wrapper.className = "condition-item";
                wrapper.dataset.conditionId = item.id;

                var meta = document.createElement("div");
                meta.className = "condition-item__meta";
                var title = document.createElement("div");
                title.className = "condition-item__title";
                title.textContent = item.nombre;
                var badge = document.createElement("span");
                badge.className = "condition-item__badge" + (item.activo ? "" : " condition-item__badge--inactive");
                badge.textContent = item.activo ? "Activo" : "Inactivo";
                title.appendChild(badge);
                meta.appendChild(title);
                var descriptionText = (item.descripcion || "").trim();
                if (descriptionText) {
                    var desc = document.createElement("div");
                    desc.textContent = descriptionText;
                    meta.appendChild(desc);
                }
                wrapper.appendChild(meta);

                var actions = document.createElement("div");
                actions.className = "condition-item__actions";

                var editBtn = document.createElement("button");
                editBtn.type = "button";
                editBtn.className = "btn btn-outline";
                editBtn.textContent = "Editar";
                editBtn.addEventListener("click", function () {
                    if (!conditionForm) {
                        return;
                    }
                    if (conditionIdInput) {
                        conditionIdInput.value = item.id;
                    }
                    if (conditionNameInput) {
                        conditionNameInput.value = item.nombre;
                    }
                    if (conditionDescriptionInput) {
                        conditionDescriptionInput.value = item.descripcion || "";
                    }
                    if (conditionActiveInput) {
                        conditionActiveInput.value = item.activo ? "true" : "false";
                    }
                    if (conditionSubmitButton) {
                        conditionSubmitButton.textContent = "Actualizar";
                    }
                    showConditionError("");
                    if (conditionNameInput) {
                        conditionNameInput.focus();
                    }
                });
                actions.appendChild(editBtn);

                var toggleBtn = document.createElement("button");
                toggleBtn.type = "button";
                toggleBtn.className = "btn btn-outline";
                toggleBtn.textContent = item.activo ? "Inactivar" : "Activar";
                toggleBtn.addEventListener("click", function () {
                    submitConditionAction("toggle", { id: item.id, activo: !item.activo });
                });
                actions.appendChild(toggleBtn);

                var deleteBtn = document.createElement("button");
                deleteBtn.type = "button";
                deleteBtn.className = "btn btn-danger";
                deleteBtn.textContent = "Eliminar";
                deleteBtn.addEventListener("click", function () {
                    if (confirm("¬øEliminar este estado?")) {
                        submitConditionAction("delete", { id: item.id });
                    }
                });
                actions.appendChild(deleteBtn);

                wrapper.appendChild(actions);
                conditionList.appendChild(wrapper);
            });
        }

        function syncConditionUI(items, highlightId) {
            conditionState.items = items || [];
            renderConditionSelect(conditionState.items);
            renderConditionList(conditionState.items);
            showConditionError("");
            if (highlightId && editInputCondition) {
                editInputCondition.value = String(highlightId);
            }
        }

        function fetchConditions() {
            if (!conditionApiUrl || conditionState.loading) {
                return Promise.resolve();
            }
            conditionState.loading = true;
            return fetch(conditionApiUrl, {
                credentials: "same-origin",
                headers: {
                    "Accept": "application/json",
                },
            })
                .then(function (response) {
                    if (!response.ok) {
                        throw new Error("No se pudieron cargar los estados.");
                    }
                    return response.json();
                })
                .then(function (payload) {
                    conditionState.loaded = true;
                    syncConditionUI(payload.conditions || []);
                })
                .catch(function (error) {
                    console.error(error);
                    showConditionError(error.message || "Error al cargar los estados.");
                })
                .finally(function () {
                    conditionState.loading = false;
                });
        }

        function ensureConditionsLoaded() {
            if (!conditionState.loaded) {
                return fetchConditions();
            }
            return Promise.resolve();
        }

        function getConditionCsrf() {
            if (conditionForm) {
                var csrfField = conditionForm.querySelector('input[name="csrfmiddlewaretoken"]');
                if (csrfField) {
                    return csrfField.value;
                }
            }
            if (editCsrfInput) {
                return editCsrfInput.value;
            }
            return "";
        }

        function submitConditionAction(action, data, options) {
            if (!conditionApiUrl) {
                showConditionError("No se encontr√≥ la ruta para gestionar estados.");
                return;
            }
            var payload = new FormData();
            payload.append("action", action);
            if (data) {
                Object.keys(data).forEach(function (key) {
                    var value = data[key];
                    if (value !== undefined && value !== null) {
                        payload.append(key, value);
                    }
                });
            }

            return fetch(conditionApiUrl, {
                method: "POST",
                credentials: "same-origin",
                headers: {
                    "X-Requested-With": "XMLHttpRequest",
                    "X-CSRFToken": getConditionCsrf(),
                },
                body: payload,
            })
                .then(function (response) {
                    return response.json().then(function (body) {
                        if (!response.ok || !body.success) {
                            var message = body && body.message ? body.message : "No se pudo completar la acci√≥n.";
                            throw new Error(message);
                        }
                        return body;
                    });
                })
                .then(function (body) {
                    var createdOrUpdated = body.condition ? body.condition.id : null;
                    syncConditionUI(body.conditions || [], createdOrUpdated);
                    if (options && options.resetForm) {
                        resetConditionForm();
                    }
                    return body;
                })
                .catch(function (error) {
                    console.error(error);
                    showConditionError(error.message || "No se pudo completar la acci√≥n.");
                });
        }

        function handleConditionFormSubmit(event) {
            if (!conditionForm) {
                return;
            }
            event.preventDefault();
            var nombre = conditionNameInput ? conditionNameInput.value.trim() : "";
            if (!nombre) {
                showConditionError("Indica un nombre.");
                if (conditionNameInput) {
                    conditionNameInput.focus();
                }
                return;
            }
            var formData = {
                nombre: nombre,
                descripcion: conditionDescriptionInput ? conditionDescriptionInput.value.trim() : "",
                activo: conditionActiveInput ? conditionActiveInput.value : "true",
            };
            if (conditionIdInput && conditionIdInput.value) {
                formData.id = conditionIdInput.value;
                submitConditionAction("update", formData, { resetForm: true });
            } else {
                submitConditionAction("create", formData, { resetForm: true });
            }
        }

        function openConditionModal() {
            if (!conditionModal) {
                return;
            }
            ensureConditionsLoaded().finally(function () {
                conditionModal.removeAttribute("hidden");
                lockBody();
                if (conditionNameInput) {
                    conditionNameInput.focus();
                } else {
                    var closeBtn = conditionModal.querySelector("[data-close-condition-modal]");
                    if (closeBtn) {
                        closeBtn.focus();
                    }
                }
            });
        }

        function closeConditionModal() {
            if (!conditionModal || conditionModal.hasAttribute("hidden")) {
                return;
            }
            conditionModal.setAttribute("hidden", "hidden");
            unlockBodyIfNoModal();
        }

        if (viewModal) {
            detailSection.querySelectorAll("[data-open-unit-modal]").forEach(function (button) {
                button.addEventListener("click", function () {
                    openViewModal(button);
                });
            });

            viewModal.querySelectorAll("[data-close-modal]").forEach(function (element) {
                element.addEventListener("click", closeViewModal);
            });

            viewModal.addEventListener("click", function (event) {
                if (event.target === viewModal) {
                    closeViewModal();
                }
            });
        }

        if (editModal) {
            detailSection.querySelectorAll("[data-open-edit-modal]").forEach(function (button) {
                button.addEventListener("click", function () {
                    openEditModal(button);
                });
            });

            editModal.querySelectorAll("[data-close-edit-modal]").forEach(function (element) {
                element.addEventListener("click", closeEditModal);
            });

            editModal.addEventListener("click", function (event) {
                if (event.target === editModal) {
                    closeEditModal();
                }
            });

            editModal.querySelectorAll("[data-open-condition-modal]").forEach(function (button) {
                button.addEventListener("click", function () {
                    openConditionModal();
                });
            });

            if (editModalForm) {
                editModalForm.addEventListener("submit", handleEditFormSubmit);
            }
        }

        if (conditionModal) {
            conditionModal.querySelectorAll("[data-close-condition-modal]").forEach(function (element) {
                element.addEventListener("click", closeConditionModal);
            });

            conditionModal.addEventListener("click", function (event) {
                if (event.target === conditionModal) {
                    closeConditionModal();
                }
            });
            if (conditionForm) {
                conditionForm.addEventListener("submit", handleConditionFormSubmit);
            }
            if (conditionResetButton) {
                conditionResetButton.addEventListener("click", function () {
                    resetConditionForm();
                });
            }
        }

        document.addEventListener("keydown", function (event) {
            if (event.key === "Escape") {
                var handled = false;
                if (viewModal && !viewModal.hasAttribute("hidden")) {
                    closeViewModal();
                    handled = true;
                }
                if (editModal && !editModal.hasAttribute("hidden")) {
                    closeEditModal();
                    handled = true;
                }
                if (conditionModal && !conditionModal.hasAttribute("hidden")) {
                    closeConditionModal();
                    handled = true;
                }
                if (handled) {
                    event.preventDefault();
                }
            }
        });
    });
</script>
{% endblock %}
