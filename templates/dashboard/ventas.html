{% extends "dashboard/base.html" %}
{% block title %}Ventas{% endblock %}
{% block page_title %}Ventas{% endblock %}
{% block page_actions %}
<div class="sales-actions">
    <div class="sales-badge">
        Facturas registradas: <span>{{ invoices_count }}</span>
    </div>
    <button type="button" class="btn btn-outline btn-icon" data-open-cash-open>
        <span class="icon">üîì</span>
        Abrir caja
    </button>
    <button type="button" class="btn btn-secondary btn-icon" data-open-cash-close disabled>
        <span class="icon">üîí</span>
        Cerrar caja
    </button>
</div>
{% endblock %}
{% block content %}
<div class="cash-status cash-status--closed" data-cash-status>
    Caja cerrada. Abre la caja para iniciar operaciones.
</div>
<section class="sales-entry" data-cash-locked data-sale-submit="{% url 'dashboard:registrar_venta_api' %}">
    <form class="sales-entry__form" autocomplete="off">
        <div class="sales-entry__column sales-entry__column--left">
            <label class="field">
                <span class="field__label">Cliente</span>
                <div class="field__group field__group--full">
                    <select name="cliente" class="field__control" data-client-select>
                        <option value="">Selecciona cliente</option>
                        {% for cliente in clientes %}
                            <option value="{{ cliente.id }}"
                                data-documento="{{ cliente.documento|default:'' }}"
                                data-correo="{{ cliente.correo|default:'' }}"
                                data-telefono="{{ cliente.telefono|default:'' }}"
                            >{{ cliente.nombre }}</option>
                        {% endfor %}
                    </select>
                    <button type="button" class="btn btn-outline" data-open-client-modal>Buscar</button>
                </div>
            </label>
            <label class="field">
                <span class="field__label">C√≥digo</span>
                <input type="text" name="codigo" class="field__control" placeholder="Escanea c√≥digo de barras aqu√≠" data-sales-code data-barcode-input />
            </label>
            <label class="field">
                <span class="field__label">Producto</span>
                <div class="field__group field__group--full">
                    <select name="producto" class="field__control" data-product-selector data-sales-product>
                        <option value="">Selecciona unidad</option>
                        {% for unit in producto_unit_options %}
                            <option value="{{ unit.key }}"
                                data-product-id="{{ unit.producto_id }}"
                                data-unit-index="{{ unit.unidad_index }}"
                                data-stock="{{ unit.stock }}"
                                data-price="{{ unit.precio }}"
                                data-impuesto="{{ unit.impuesto_porcentaje }}"
                                data-impuesto-activo="{% if unit.impuesto_activo %}true{% else %}false{% endif %}"
                                data-usa-global="{{ unit.usar_impuesto_global|yesno:'true,false' }}"
                                data-impuesto-id="{{ unit.impuesto_id }}"
                                data-impuesto-label="{{ unit.impuesto_label|default:'Impuesto global' }}"
                                data-imei="{{ unit.imei }}"
                                data-color="{{ unit.color }}"
                                data-almacenamiento="{{ unit.almacenamiento }}"
                                data-ram="{{ unit.memoria_ram }}"
                                data-battery="{{ unit.vida_bateria }}"
                                data-barcode="{{ unit.codigo_barras }}"
                                data-units='{{ unit.units_json|safe }}'
                            >{{ unit.etiqueta }}</option>
                        {% endfor %}
                    </select>
                    <button type="button" class="btn btn-outline" data-open-product-modal>Buscar</button>
                </div>
            </label>
        </div>
        <div class="sales-entry__column sales-entry__column--right">
            <label class="field">
                <span class="field__label">Cantidad</span>
                <input type="number" name="cantidad" class="field__control" min="1" step="1" placeholder="0" data-sales-quantity />
            </label>
            <div class="field field--readonly">
                <span class="field__label">Stock disponible</span>
                <div class="field__value" data-stock-output>--</div>
            </div>
            <div class="sales-entry__actions">
                <button type="button" class="btn btn-secondary" data-sales-action="add">Agregar</button>
                <button type="button" class="btn btn-secondary" data-sales-action="edit">Editar</button>
                <button type="button" class="btn btn-outline" data-sales-action="clear">Limpiar</button>
                <button type="button" class="btn btn-outline" data-sales-action="price">Precio</button>
                <button type="button" class="btn btn-danger" data-sales-action="delete">Eliminar</button>
                <button type="button" class="btn btn-outline" data-open-sales-modal>Ver venta realizada</button>
                <button type="button" class="btn btn-primary" data-open-credit-collection> Cobrar cr√©dito</button>
            </div>
        </div>
    </form>
</section>

<section class="sales-cart" data-cash-locked>
    <div class="sales-cart__body">
        <div class="sales-cart__items">
            <div class="sales-cart__header">
                <h2>Productos a√±adidos</h2>
            </div>
            <div class="sales-cart__table-wrapper">
                <table class="sales-cart__table" data-sales-table>
                    <thead>
                        <tr>
                            <th>Cliente</th>
                            <th>Producto</th>
                            <th>Vida bater√≠a</th>
                            <th>Precio c/u</th>
                            <th>Cantidad</th>
                            <th>Impuesto</th>
                            <th>Total</th>
                        </tr>
                    </thead>
                    <tbody data-sales-items>
                        <tr>
                            <td colspan="7" class="sales-cart__empty">Agrega un producto para comenzar.</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        <div class="sales-cart__summary">
            <h3>Resumen de pago</h3>
            <dl class="sales-cart__totals">
                <div class="sales-cart__row">
                    <dt>Subtotal</dt>
                    <dd data-sales-subtotal>RD$ 0.00</dd>
                </div>
                <div class="sales-cart__row">
                    <dt>Impuestos</dt>
                    <dd data-sales-tax>RD$ 0.00</dd>
                </div>
                <div class="sales-cart__row sales-cart__row--highlight">
                    <dt>Total</dt>
                    <dd data-sales-total>RD$ 0.00</dd>
                </div>
            </dl>
            <div class="sales-cart__actions">
                <button type="button" class="btn btn-primary" data-open-payment-modal>Realizar pago</button>
            </div>
        </div>
    </div>
</section>
<div class="modal" id="client-modal" aria-hidden="true">
    <div class="modal-dialog" role="dialog" aria-modal="true" aria-labelledby="client-modal-title">
        <div class="modal-header">
            <h2 id="client-modal-title">Seleccionar cliente</h2>
            <button type="button" class="modal-close" aria-label="Cerrar" data-close-modal>&times;</button>
        </div>
        <div class="modal-form modal-form--static">
            <div class="client-search">
                <input type="text" class="client-search__input" placeholder="Buscar cliente" data-client-search>
            </div>
            <ul class="client-list" data-client-list>
                {% for cliente in clientes %}
                    <li class="client-list__item" data-client-item data-id="{{ cliente.id }}" data-name="{{ cliente.nombre }}">
                        <div class="client-list__info">
                            <span class="client-list__name">{{ cliente.nombre }}</span>
                            <div class="client-list__meta">
                                <span class="client-list__label">C√≥digo</span>
                                <span class="client-list__code">{{ cliente.codigo|default:"Sin c√≥digo" }}</span>
                            </div>
                        </div>
                        <button type="button" class="btn btn-secondary" data-select-client>Seleccionar</button>
                    </li>
                {% endfor %}
            </ul>
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" data-close-modal>Cerrar</button>
            </div>
        </div>
    </div>
</div>
<div class="modal" id="cash-close-confirm-modal" aria-hidden="true">
    <div class="modal-dialog modal-dialog--narrow" role="dialog" aria-modal="true" aria-labelledby="cash-close-confirm-title">
        <div class="modal-header">
            <h2 id="cash-close-confirm-title">Confirmar cierre de caja</h2>
            <button type="button" class="modal-close" aria-label="Cerrar" data-close-cash-close-confirm>&times;</button>
        </div>
        <div class="modal-form modal-form--static">
            <p>¬øSeguro que deseas cerrar la caja? Esta acci√≥n registrar√° los totales actuales.</p>
        </div>
        <div class="modal-actions">
            <button type="button" class="btn btn-secondary" data-close-cash-close-confirm>Cancelar</button>
            <button type="button" class="btn btn-primary" data-confirm-cash-close>Confirmar cierre</button>
        </div>
    </div>
</div>
<div class="modal" id="invoice-modal" aria-hidden="true">
    <div class="modal-dialog modal-dialog--narrow" role="dialog" aria-modal="true" aria-labelledby="invoice-modal-title">
        <div class="modal-header">
            <h2 id="invoice-modal-title">Seleccionar formato de factura</h2>
            <button type="button" class="modal-close" aria-label="Cerrar" data-close-invoice>&times;</button>
        </div>
        <div class="modal-form modal-form--static">
            <p id="invoice-modal-subtitle">Selecciona el tipo de comprobante que deseas generar para esta venta.</p>
            <div class="invoice-options" data-invoice-options>
                <button type="button" class="invoice-option" data-invoice-option="a4">
                    <span class="invoice-option__icon">üìÑ</span>
                    <span class="invoice-option__title">Factura A4</span>
                    <span class="invoice-option__caption">Documento detallado para impresi√≥n tama√±o carta.</span>
                </button>
                <button type="button" class="invoice-option" data-invoice-option="ticket80">
                    <span class="invoice-option__icon">üßæ</span>
                    <span class="invoice-option__title">Ticket 80 mm</span>
                    <span class="invoice-option__caption">Formato t√©rmico para impresoras de 3.1".</span>
                </button>
                <button type="button" class="invoice-option" data-invoice-option="ticket50">
                    <span class="invoice-option__icon">üßæ</span>
                    <span class="invoice-option__title">Ticket 50 mm</span>
                    <span class="invoice-option__caption">Formato t√©rmico compacto de 2".</span>
                </button>
                <button type="button" class="invoice-option" data-invoice-option="skip">
                    <span class="invoice-option__icon">üö´</span>
                    <span class="invoice-option__title">No generar</span>
                    <span class="invoice-option__caption">Cierra sin producir ning√∫n documento.</span>
                </button>
            </div>
        </div>
        <div class="modal-actions">
            <button type="button" class="btn btn-secondary" data-close-invoice>Cerrar</button>
        </div>
    </div>
</div>
<div class="modal" id="product-modal" aria-hidden="true" data-product-search-endpoint="{% url 'dashboard:sales_product_unit_search_api' %}">
    <div class="modal-dialog" role="dialog" aria-modal="true" aria-labelledby="product-modal-title">
        <div class="modal-header">
            <h2 id="product-modal-title">Seleccionar producto</h2>
            <button type="button" class="modal-close" aria-label="Cerrar" data-close-product>&times;</button>
        </div>
        <div class="modal-form modal-form--static product-search">
            <div class="product-search__input-group">
                <input type="text" class="product-search__input" placeholder="Buscar por nombre, c√≥digo, IMEI, almacenamiento, RAM..." data-product-search>
                <span class="product-search__hint">Escribe para buscar productos por cualquier atributo: nombre, c√≥digo, IMEI, almacenamiento, RAM, color, etc.</span>
            </div>
            <div class="product-search__filters" data-product-filters>
                <div class="product-search__filter">
                    <label class="product-search__filter-label" for="product-filter-brand">Marca</label>
                    <select id="product-filter-brand" class="product-search__filter-control" data-product-filter="brand">
                        <option value="">Todas las marcas</option>
                        {% for brand in producto_filter_options.brands %}
                            <option value="{{ brand.id }}">{{ brand.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="product-search__filter">
                    <label class="product-search__filter-label" for="product-filter-model">Modelo</label>
                    <select id="product-filter-model" class="product-search__filter-control" data-product-filter="model">
                        <option value="">Todos los modelos</option>
                        {% for model in producto_filter_options.models %}
                            <option value="{{ model.id }}" data-brand-id="{{ model.brand_id }}">{{ model.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="product-search__filter">
                    <label class="product-search__filter-label" for="product-filter-color">Color</label>
                    <select id="product-filter-color" class="product-search__filter-control" data-product-filter="color">
                        <option value="">Todos los colores</option>
                        {% for color in producto_filter_options.colors %}
                            <option value="{{ color }}">{{ color }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="product-search__filter">
                    <label class="product-search__filter-label" for="product-filter-storage">Almacenamiento</label>
                    <select id="product-filter-storage" class="product-search__filter-control" data-product-filter="storage">
                        <option value="">Todo almacenamiento</option>
                        {% for storage in producto_filter_options.storage %}
                            <option value="{{ storage.code }}">{{ storage.label }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="product-search__filter">
                    <label class="product-search__filter-label" for="product-filter-ram">RAM</label>
                    <select id="product-filter-ram" class="product-search__filter-control" data-product-filter="ram">
                        <option value="">Toda la RAM</option>
                        {% for ram in producto_filter_options.ram %}
                            <option value="{{ ram.code }}">{{ ram.label }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="product-search__filter product-search__filter--price">
                    <label class="product-search__filter-label" for="product-filter-price-min">Precio (RD$)</label>
                    <div class="product-search__filter-range">
                        <input type="number" min="0" step="0.01" id="product-filter-price-min" class="product-search__filter-control" placeholder="{{ producto_filter_options.price.min|default:'M√≠n' }}" data-product-filter="price-min">
                        <span class="product-search__filter-separator">‚Äì</span>
                        <input type="number" min="0" step="0.01" id="product-filter-price-max" class="product-search__filter-control" placeholder="{{ producto_filter_options.price.max|default:'M√°x' }}" data-product-filter="price-max">
                    </div>
                </div>
                <div class="product-search__filter product-search__filter--actions">
                    <button type="button" class="btn btn-outline btn-sm" data-product-filter-clear>Limpiar filtros</button>
                </div>
            </div>
            <div class="product-search__results" data-product-results>
                <div class="product-search__placeholder">Escribe el nombre del producto para ver las unidades en existencia.</div>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" data-close-product>Cerrar</button>
            </div>
        </div>
    </div>
</div>
<div class="modal" id="edit-quantity-modal" aria-hidden="true">
    <div class="modal-dialog modal-dialog--narrow" role="dialog" aria-modal="true" aria-labelledby="edit-quantity-title">
        <div class="modal-header">
            <h2 id="edit-quantity-title">Editar cantidad</h2>
            <button type="button" class="modal-close" aria-label="Cerrar" data-close-quantity>&times;</button>
        </div>
        <div class="modal-form modal-form--static">
            <p>Actualiza la cantidad del producto seleccionado.</p>
            
            <!-- Informaci√≥n del producto y stock -->
            <div class="stock-info" data-stock-info style="margin-bottom: 16px; padding: 12px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #007bff;">
                <div class="stock-info__product" data-stock-product style="font-weight: 600; margin-bottom: 8px;"></div>
                <div class="stock-info__specs" data-stock-specs style="font-size: 0.9rem; color: #6c757d; margin-bottom: 8px;"></div>
                <div class="stock-info__availability" data-stock-availability style="font-size: 0.85rem;"></div>
            </div>
            
            <label class="field">
                <span class="field__label">Cantidad</span>
                <input type="number" class="field__control" min="1" step="1" data-edit-quantity-input>
            </label>
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" data-close-quantity>Cancelar</button>
                <button type="button" class="btn btn-primary" data-save-quantity>Guardar cambios</button>
            </div>
        </div>
    </div>
</div>
<div class="modal" id="edit-price-modal" aria-hidden="true">
    <div class="modal-dialog modal-dialog--narrow" role="dialog" aria-modal="true" aria-labelledby="edit-price-title">
        <div class="modal-header">
            <h2 id="edit-price-title">Editar precio unitario</h2>
            <button type="button" class="modal-close" aria-label="Cerrar" data-close-price>&times;</button>
        </div>
        <div class="modal-form modal-form--static">
            <p>Ingresa el nuevo precio unitario para esta venta.</p>
            <label class="field">
                <span class="field__label">Precio</span>
                <input type="number" class="field__control" min="0" step="0.01" data-edit-price-input>
            </label>
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" data-close-price>Cancelar</button>
                <button type="button" class="btn btn-primary" data-save-price>Guardar cambios</button>
            </div>
        </div>
    </div>
</div>
<div class="modal" id="sales-modal" aria-hidden="true" data-sales-endpoint="{% url 'dashboard:ventas_historial_api' %}">
    <div class="modal-dialog" role="dialog" aria-modal="true" aria-labelledby="sales-modal-title">
        <div class="modal-header">
            <h2 id="sales-modal-title">Historial de ventas realizadas</h2>
            <button type="button" class="modal-close" aria-label="Cerrar" data-close-sales>&times;</button>
        </div>
        <div class="modal-form modal-form--static">
            <form class="sales-filter" data-sales-filter>
                <div class="sales-history__header">
                    <p>Consulta las ventas realizadas recientemente en el sistema.</p>
                    <div class="sales-filter__row">
                        <label class="sales-filter__field">
                            <span>Desde</span>
                            <input type="date" name="fecha_inicio" data-sales-date-start>
                        </label>
                        <label class="sales-filter__field">
                            <span>Hasta</span>
                            <input type="date" name="fecha_fin" data-sales-date-end>
                        </label>
                    </div>
                    <div class="sales-filter__row sales-filter__row--search">
                        <label class="sales-filter__field sales-filter__field--search">
                            <span>Buscar</span>
                            <input type="search" name="query" placeholder="Cliente, documento o factura" data-sales-search>
                        </label>
                        <button type="button" class="btn btn-secondary" data-sales-refresh>Filtrar</button>
                    </div>
                </div>
            </form>
            <div class="sales-history" data-sales-results>
                <div class="sales-history__table-wrapper">
                    <table class="sales-history__table">
                        <thead>
                            <tr>
                                <th>Factura</th>
                                <th>Cliente</th>
                                <th>Subtotal</th>
                                <th>ITBIS</th>
                                <th>Total</th>
                                <th>Abonado</th>
                                <th>Fecha</th>
                                <th>Hora</th>
                                <th>Cajero</th>
                                <th>Medio de pago</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody data-sales-table-body>
                            <tr>
                                <td colspan="11" class="sales-history__empty">Selecciona un rango o busca por nombre/documento.</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <div class="modal-actions">
            <button type="button" class="btn btn-secondary" data-close-sales>Cerrar</button>
        </div>
    </div>
</div>
<div class="modal" id="cash-open-modal" aria-hidden="true">
    <div class="modal-dialog" role="dialog" aria-modal="true" aria-labelledby="cash-open-title">
        <div class="modal-header">
            <h2 id="cash-open-title">Abrir caja</h2>
            <button type="button" class="modal-close" aria-label="Cerrar" data-close-cash-open>&times;</button>
        </div>
        <form class="modal-form" data-cash-open-form>
            <label class="form-field">
                <span class="form-label">Ingresa el monto inicial</span>
                <input type="number" min="0" step="0.01" placeholder="0.00" data-cash-open-amount>
            </label>
            <div class="cash-open-info-line">
                <span class="cash-open-info-line__label">√öltimo cierre registrado</span>
                <span class="cash-open-info-line__value" data-cash-open-last>RD$ 0.00</span>
                <span class="cash-open-info-line__timestamp" data-cash-open-timestamp></span>
            </div>
            <div class="cash-open-info-line">
                <span class="cash-open-info-line__label">√öltimo total de ventas</span>
                <span class="cash-open-info-line__value" data-cash-open-sales>RD$ 0.00</span>
            </div>
            <div class="cash-open-info-line">
                <span class="cash-open-info-line__label">√öltima ganancia neta</span>
                <span class="cash-open-info-line__value" data-cash-open-profit>RD$ 0.00</span>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" data-close-cash-open>Cancelar</button>
                <button type="button" class="btn btn-primary" data-confirm-cash-open>Abrir caja</button>
            </div>
        </form>
    </div>
</div>
<div class="modal" id="cash-close-modal" aria-hidden="true">
    <div class="modal-dialog" role="dialog" aria-modal="true" aria-labelledby="cash-close-title">
        <div class="modal-header">
            <h2 id="cash-close-title">Cierre de caja</h2>
            <button type="button" class="modal-close" aria-label="Cerrar" data-close-cash-close>&times;</button>
        </div>
        <div class="modal-form modal-form--static">
            <div class="cash-close-summary">
                <div class="cash-close-balance">
                    <div class="cash-close-balance__item">
                        <span>Apertura</span>
                        <strong data-cash-close-opening>RD$ 0.00</strong>
                    </div>
                    <div class="cash-close-balance__item">
                        <span>Cierre</span>
                        <strong data-cash-close-closing>RD$ 0.00</strong>
                    </div>
                </div>
                <div class="cash-close-report">
                    <h3>Informe del d√≠a</h3>
                    <dl>
                        <div>
                            <dt>Monto inicial</dt>
                            <dd data-cash-report-initial>RD$ 0.00</dd>
                        </div>
                        <div>
                            <dt>Total ventas</dt>
                            <dd data-cash-report-sales>RD$ 0.00</dd>
                        </div>
                        <div>
                            <dt>Total ventas a cr√©dito</dt>
                            <dd data-cash-report-credit-sales>RD$ 0.00</dd>
                        </div>
                        <div>
                            <dt>Total abonos a cr√©dito</dt>
                            <dd data-cash-report-credit-payments>RD$ 0.00</dd>
                        </div>
                        <div>
                            <dt>Total descuentos</dt>
                            <dd data-cash-report-discounts>RD$ 0.00</dd>
                        </div>
                        <div>
                            <dt>Total impuesto</dt>
                            <dd data-cash-report-taxes>RD$ 0.00</dd>
                        </div>
                        <div>
                            <dt>Total en caja</dt>
                            <dd data-cash-report-cash>RD$ 0.00</dd>
                        </div>
                        <div>
                            <dt>Total pagos electr√≥nicos</dt>
                            <dd data-cash-report-electronic>RD$ 0.00</dd>
                        </div>
                    </dl>
                </div>
                <div class="cash-close-payments">
                    <h3>Medios de pago</h3>
                    <ul>
                        <li>Efectivo: <span data-cash-report-cash-sales>RD$ 0.00</span></li>
                        <li>Efectivo (ventas a cr√©dito): <span data-cash-report-cash-credit>RD$ 0.00</span></li>
                        <li>Tarjeta de d√©bito: <span data-cash-report-card-debit>RD$ 0.00</span></li>
                        <li>Tarjeta de cr√©dito: <span data-cash-report-card-credit>RD$ 0.00</span></li>
                        <li>Transferencia: <span data-cash-report-transfer>RD$ 0.00</span></li>
                        <li>Cr√©dito: <span data-cash-report-credit>RD$ 0.00</span></li>
                        <li>Mixto: <span data-cash-report-mixed>RD$ 0.00</span></li>
                    </ul>
                </div>
            </div>
        </div>
        <div class="modal-actions">
            <button type="button" class="btn btn-outline" data-export-cash-close>Exportar</button>
            <button type="button" class="btn btn-primary" data-finalize-cash-close>Cerrar</button>
        </div>
    </div>
</div>

<div class="modal" id="credit-collections-modal" aria-hidden="true">
    <div class="modal-dialog modal-dialog--wide" role="dialog" aria-modal="true" aria-labelledby="credit-collections-title">
        <div class="modal-header">
            <h2 id="credit-collections-title">Cobros de cr√©dito del d√≠a</h2>
            <button type="button" class="modal-close" aria-label="Cerrar" data-close-credit-collections>&times;</button>
        </div>
        <div class="modal-form modal-form--scrollable">
            <div class="credit-collections">
                <header class="credit-collections__header">
                    <div>
                        <p class="credit-collections__subtitle">Monitorea las cuotas que debes gestionar durante la jornada.</p>
                    </div>
                    <div class="credit-collections__summary">
                        <div class="credit-collections__kpi">
                            <span class="credit-collections__kpi-label">Cuotas que vencen hoy</span>
                            <span class="credit-collections__kpi-value" data-credit-summary="due-count">{{ credit_collection_summary.due_today_count }}</span>
                            <span class="credit-collections__kpi-hint">Monto: <span data-credit-summary="due-amount">{{ credit_collection_summary.due_today_amount_display }}</span></span>
                        </div>
                        <div class="credit-collections__kpi">
                            <span class="credit-collections__kpi-label">Total pendiente</span>
                            <span class="credit-collections__kpi-value" data-credit-summary="pending">{{ credit_collection_summary.total_pending_display }}</span>
                        </div>
                        <div class="credit-collections__kpi">
                            <span class="credit-collections__kpi-label">Cuotas atrasadas</span>
                            <span class="credit-collections__kpi-value" data-credit-summary="overdue">{{ credit_collection_summary.overdue_count }}</span>
                        </div>
                        <div class="credit-collections__kpi">
                            <span class="credit-collections__kpi-label">Pr√≥ximos 7 d√≠as</span>
                            <span class="credit-collections__kpi-value" data-credit-summary="upcoming">{{ credit_collection_summary.upcoming_count }}</span>
                        </div>
                        <div class="credit-collections__kpi credit-collections__kpi--highlight">
                            <span class="credit-collections__kpi-label">Cobrado hoy</span>
                            <span class="credit-collections__kpi-value" data-credit-summary="collected">{{ credit_collection_summary.collected_today_display }}</span>
                        </div>
                    </div>
                </header>

                <div class="credit-collections__table-wrapper">
                    <table class="credit-collections__table">
                        <thead>
                            <tr>
                                <th>Cliente</th>
                                <th>Factura</th>
                                <th>Estado</th>
                                <th>Cuota</th>
                                <th>Saldo pendiente</th>
                                <th>Progreso</th>
                                <th>Vence</th>
                                <th>Prioridad</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% if credit_collection_rows %}
                                {% for row in credit_collection_rows %}
                                    <tr data-credit-collection-row
                                        data-credit-id="{{ row.cuenta_id }}"
                                        data-credit-cliente="{{ row.cliente }}"
                                        data-credit-factura="{{ row.factura }}"
                                        data-credit-estado="{{ row.estado }}"
                                        data-credit-estado-key="{{ row.estado_key }}"
                                        data-credit-estado-clase="{{ row.status_class }}"
                                        data-credit-monto="{{ row.monto_cuota_display }}"
                                        data-credit-monto-raw="{{ row.monto_cuota_raw }}"
                                        data-credit-progreso="{{ row.progreso|default:'' }}"
                                        data-credit-vencimiento="{{ row.due_date_display }}"
                                        data-credit-prioridad="{{ row.due_badge }}"
                                        data-credit-chip-class="{{ row.chip_class }}"
                                        data-credit-saldo="{{ row.saldo_pendiente_display }}"
                                        data-credit-saldo-raw="{{ row.saldo_pendiente_raw }}">
                                        <td>{{ row.cliente }}</td>
                                        <td>{{ row.factura }}</td>
                                        <td><span class="{{ row.status_class }}">{{ row.estado }}</span></td>
                                        <td>{{ row.monto_cuota_display }}</td>
                                        <td>{{ row.saldo_pendiente_display }}</td>
                                        <td>{{ row.progreso|default:"‚Äî" }}</td>
                                        <td>{{ row.due_date_display }}</td>
                                        <td><span class="{{ row.chip_class }}">{{ row.due_badge }}</span></td>
                                        <td>
                                            <button type="button" class="btn btn-outline btn-outline--primary" data-credit-action="open-collection-modal">Registrar cobro</button>
                                        </td>
                                    </tr>
                                {% endfor %}
                            {% else %}
                                <tr class="credit-collections__empty-row">
                                    <td colspan="9" class="credit-collections__empty">
                                        No hay cuotas pendientes para hoy. ¬°Buen trabajo!
                                    </td>
                                </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal" id="credit-collection-modal" aria-hidden="true">
    <div class="modal-dialog modal-dialog--narrow" role="dialog" aria-modal="true" aria-labelledby="credit-collection-title">
        <div class="modal-header">
            <h2 id="credit-collection-title">Registrar cobro de cuota</h2>
            <button type="button" class="modal-close" aria-label="Cerrar" data-close-credit-collection>&times;</button>
        </div>
        <form class="modal-form" data-credit-collection-form>
            <input type="hidden" name="cuenta_id" data-credit-collection-id>
            <div class="modal-field">
                <span class="modal-field__label">Cliente</span>
                <span class="modal-field__value" data-credit-collection-cliente>‚Äî</span>
            </div>
            <div class="modal-field">
                <span class="modal-field__label">Factura</span>
                <span class="modal-field__value" data-credit-collection-factura>‚Äî</span>
            </div>
            <div class="modal-field">
                <span class="modal-field__label">Estado actual</span>
                <span class="modal-field__value" data-credit-collection-estado>‚Äî</span>
            </div>
            <div class="modal-field">
                <span class="modal-field__label">Saldo pendiente</span>
                <span class="modal-field__value" data-credit-collection-saldo>‚Äî</span>
            </div>
            <div class="modal-field">
                <label class="modal-field__label" for="credit-collection-amount">Monto recibido</label>
                <input id="credit-collection-amount" type="number" name="monto" step="0.01" min="0.01" placeholder="Monto de la cuota" data-credit-collection-amount>
                <small class="modal-field__hint">Por defecto se sugiere el valor completo de la cuota.</small>
            </div>
            <div class="modal-field modal-field--full">
                <label class="modal-field__label" for="credit-collection-comment">Comentario</label>
                <textarea id="credit-collection-comment" name="comentario" rows="2" placeholder="Opcional" data-credit-collection-comment></textarea>
            </div>
            <div class="modal-field modal-field--full">
                <span class="modal-field__label">Prioridad</span>
                <span class="modal-field__value" data-credit-collection-prioridad>‚Äî</span>
            </div>
        </form>
        <div class="modal-actions">
            <button type="button" class="btn btn-secondary" data-close-credit-collection>Cancelar</button>
            <button type="button" class="btn btn-primary" data-credit-collection-submit disabled>Registrar cobro</button>
        </div>
    </div>
</div>

<div class="modal" id="payment-modal" aria-hidden="true" data-tradein-validate-url="{% url 'dashboard:tradein_validate_api' %}">
    <div class="modal-dialog" role="dialog" aria-modal="true" aria-labelledby="payment-modal-title">
        <div class="modal-header">
            <h2 id="payment-modal-title">Realizar pago</h2>
            <button type="button" class="modal-close" aria-label="Cerrar" data-close-payment>&times;</button>
        </div>
        <div class="modal-form modal-form--scrollable">
            <div class="payment-layout">
                <section class="payment-section">
                    <h3 class="payment-section__title">Detalle de pago</h3>
                    <dl class="payment-summary">
                        <div class="payment-summary__row">
                            <dt>Total a pagar</dt>
                            <dd data-payment-total>RD$ 0.00</dd>
                        </div>
                        <div class="payment-summary__row" data-payment-discount-row hidden>
                            <dt>Descuento aplicado</dt>
                            <dd data-payment-discount>RD$ 0.00</dd>
                        </div>
                        <div class="payment-summary__row payment-summary__row--total" data-payment-total-discounted-row hidden>
                            <dt>Total con descuento</dt>
                            <dd data-payment-total-discounted>RD$ 0.00</dd>
                        </div>
                        <div class="payment-summary__row" data-payment-tradein-row hidden>
                            <dt>Cr√©dito trade-in</dt>
                            <dd data-payment-tradein>RD$ 0.00</dd>
                        </div>
                        <div class="payment-summary__row payment-summary__row--change" hidden data-payment-change-row>
                            <dt>Vuelto a entregar</dt>
                            <dd data-payment-change>RD$ 0.00</dd>
                        </div>
                    </dl>
                    <button type="button" class="btn btn-outline btn-icon" data-open-discount>
                        <span class="icon">%</span>
                        <span>Aplicar descuento</span>
                    </button>
                    <div class="tradein-apply">
                        <label class="tradein-apply__label" for="tradein-code-input">C√≥digo trade-in</label>
                        <div class="tradein-apply__controls">
                            <div class="tradein-code-group">
                                <span class="tradein-code-icon"><i class="ri-ticket-2-line"></i></span>
                                <input id="tradein-code-input" type="text" placeholder="Ej. TRD-ABC123" autocomplete="off" data-tradein-code>
                            </div>
                            <button type="button" class="btn btn-outline btn-icon" data-tradein-search>
                                <i class="ri-search-line"></i>
                            </button>
                            <button type="button" class="btn btn-primary" data-apply-tradein>Aplicar</button>
                            <button type="button" class="btn btn-link" data-remove-tradein hidden>Quitar</button>
                        </div>
                        <p class="tradein-apply__feedback" data-tradein-feedback></p>
                    </div>
                    <div class="payment-table-wrapper">
                        <h4 class="payment-table__title">Ingrese el monto pagado:</h4>
                        <table class="payment-table">
                            <thead>
                                <tr>
                                    <th>Concepto</th>
                                    <th>Monto</th>
                                </tr>
                            </thead>
                            <tbody data-payment-entries>
                                <tr>
                                    <td>Total recibido</td>
                                    <td>
                                        <input type="number" step="0.01" min="0" placeholder="0.00" data-payment-input>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </section>
                <section class="payment-section">
                    <h3 class="payment-section__title">Medio de pago contado</h3>
                    <div class="payment-methods">
                        <label class="payment-option">
                            <input type="checkbox" value="efectivo" data-payment-cash data-payment-method="cash">
                            <span class="payment-option__icon">üíµ</span>
                            <span>Efectivo</span>
                        </label>
                        <label class="payment-option">
                            <input type="checkbox" value="debito" data-payment-debit data-payment-method="debit">
                            <span class="payment-option__icon">üí≥</span>
                            <span>Tarjeta de d√©bito</span>
                        </label>
                        <label class="payment-option">
                            <input type="checkbox" value="credito" data-payment-credit data-payment-method="credit">
                            <span class="payment-option__icon">üí≥</span>
                            <span>Tarjeta de cr√©dito</span>
                        </label>
                        <label class="payment-option">
                            <input type="checkbox" value="transferencia" data-payment-transfer data-payment-method="transfer">
                            <span class="payment-option__icon">‚áÑ</span>
                            <span>Transferencia</span>
                        </label>
                        <label class="payment-option">
                            <input type="checkbox" value="mixto" data-payment-mixed data-payment-method="mixed">
                            <span class="payment-option__icon">‚ûï</span>
                            <span>Pago mixto</span>
                        </label>
                    </div>
                    <h3 class="payment-section__title">Medio de pago a cr√©dito</h3>
                    <label class="payment-option payment-option--single">
                        <input type="checkbox" value="credito" data-payment-credit-sale>
                        <span class="payment-option__icon">üìù</span>
                        <span>Venta a cr√©dito</span>
                    </label>
                    <div class="payment-option payment-option--single payment-option--fiscal">
                        <div class="payment-option__header">
                            <label>
                                <input type="checkbox" value="fiscal" data-payment-emit-fiscal>
                                <span class="payment-option__icon">üìÑ</span>
                                <span>Emitir comprobante fiscal</span>
                            </label>
                            <button type="button" class="btn btn-outline btn-icon btn-icon--sm" data-open-fiscal-settings aria-label="Configurar comprobante fiscal">
                                <span class="icon">‚öôÔ∏è</span>
                            </button>
                        </div>
                    </div>
                    <div class="fiscal-preview" data-payment-fiscal-preview hidden>
                        <span class="fiscal-preview__title">Comprobante fiscal configurado</span>
                        <dl class="fiscal-preview__list">
                            <div>
                                <dt>Tipo</dt>
                                <dd data-fiscal-preview-type>‚Äî</dd>
                            </div>
                            <div>
                                <dt>Serie</dt>
                                <dd data-fiscal-preview-series>‚Äî</dd>
                            </div>
                        </dl>
                    </div>
                </section>
            </div>
        </div>
        <div class="modal-actions">
            <button type="button" class="btn btn-secondary" data-close-payment>Cancelar</button>
            <button type="button" class="btn btn-primary" data-confirm-payment>Confirmar pago</button>
        </div>
    </div>
</div>
<div class="modal" id="discount-modal" aria-hidden="true">
    <div class="modal-dialog modal-dialog--narrow" role="dialog" aria-modal="true" aria-labelledby="discount-modal-title">
        <div class="modal-header">
            <h2 id="discount-modal-title">Aplicar descuento</h2>
            <button type="button" class="modal-close" aria-label="Cerrar" data-close-discount>&times;</button>
        </div>
        <div class="modal-form modal-form--static">
            <fieldset class="discount-type-group">
                <legend>Tipo de descuento</legend>
                <label class="discount-option">
                    <input type="radio" name="discount_type" value="fixed" data-discount-type>
                    <span>Valor fijo</span>
                </label>
                <label class="discount-option">
                    <input type="radio" name="discount_type" value="percent" data-discount-type>
                    <span>Porcentaje (%)</span>
                </label>
            </fieldset>
            <div class="discount-table-wrapper">
                <h3 class="discount-table__title">Ingrese el descuento</h3>
                <table class="discount-table">
                    <tbody>
                        <tr>
                            <th>Descuento</th>
                            <td>
                                <input type="number" min="0" step="0.01" placeholder="0.00" data-discount-value>
                            </td>
                        </tr>
                        <tr>
                            <th>Total actual</th>
                            <td data-discount-current-total>RD$ 0.00</td>
                        </tr>
                        <tr>
                            <th>Total con descuento</th>
                            <td data-discount-final-total>RD$ 0.00</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        <div class="modal-actions">
            <button type="button" class="btn btn-secondary" data-close-discount>Cancelar</button>
            <button type="button" class="btn btn-primary" data-apply-discount>Aplicar</button>
        </div>
    </div>
</div>

<!-- Modal de configuraci√≥n de cuotas -->
<div class="modal" id="credit-installments-modal" aria-hidden="true">
    <div class="modal-dialog modal-dialog--narrow" role="dialog" aria-modal="true" aria-labelledby="credit-modal-title">
        <div class="modal-header">
            <h2 id="credit-modal-title">Configurar venta a cr√©dito</h2>
            <button type="button" class="modal-close" aria-label="Cerrar" data-close-credit-modal>&times;</button>
        </div>
        <div class="modal-form modal-form--static">
            <div class="credit-summary">
                <div class="credit-summary__row">
                    <dt>Total de la venta</dt>
                    <dd data-credit-total>RD$ 0.00</dd>
                </div>
            </div>
            
            <div class="form-group">
                <label for="credit-installments">N√∫mero de cuotas</label>
                <select id="credit-installments" data-credit-installments>
                    <option value="1">1 cuota (pago √∫nico)</option>
                    <option value="2">2 cuotas</option>
                    <option value="3" selected>3 cuotas</option>
                    <option value="6">6 cuotas</option>
                    <option value="10">10 cuotas</option>
                    <option value="12">12 cuotas</option>
                    <option value="18">18 cuotas</option>
                    <option value="24">24 cuotas</option>
                </select>
            </div>

            <div class="form-group">
                <label for="credit-frequency">Frecuencia de pago</label>
                <select id="credit-frequency" data-credit-frequency>
                    <option value="7">Semanal (7 d√≠as)</option>
                    <option value="15">Quincenal (15 d√≠as)</option>
                    <option value="30" selected>Mensual (30 d√≠as)</option>
                </select>
            </div>

            <div class="form-group">
                <label for="credit-initial-payment">Abono inicial (opcional)</label>
                <input type="number" id="credit-initial-payment" step="0.01" min="0" placeholder="0.00" data-credit-initial-payment>
                <small class="form-help">Monto que el cliente paga al momento de la venta</small>
            </div>

            <div class="credit-calculation">
                <h3>Resumen del financiamiento</h3>
                <dl class="credit-calculation__list">
                    <div>
                        <dt>Abono inicial:</dt>
                        <dd data-credit-calc-initial>RD$ 0.00</dd>
                    </div>
                    <div>
                        <dt>Saldo a financiar:</dt>
                        <dd data-credit-calc-balance>RD$ 0.00</dd>
                    </div>
                    <div>
                        <dt>Valor de cada cuota:</dt>
                        <dd data-credit-calc-installment>RD$ 0.00</dd>
                    </div>
                    <div>
                        <dt>Frecuencia:</dt>
                        <dd data-credit-calc-frequency>Mensual</dd>
                    </div>
                </dl>
            </div>
        </div>
        <div class="modal-actions">
            <button type="button" class="btn btn-secondary" data-close-credit-modal>Cancelar</button>
            <button type="button" class="btn btn-primary" data-confirm-credit-config>Confirmar configuraci√≥n</button>
        </div>
    </div>
</div>

<style>
    .sales-actions {
        display: inline-flex;
        align-items: center;
        gap: 6px;
    }

    .cash-status {
        margin-bottom: 20px;
        padding: 12px 16px;
        border-radius: 8px;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 12px;
        border: 1px solid transparent;
    }

    .cash-status--open {
        background: var(--color-success-bg);
        border-color: var(--color-success);
        color: var(--color-success-text);
    }

    .cash-status--closed {
        background: var(--color-danger-bg);
        border-color: var(--color-danger);
        color: var(--color-danger-text);
    }

    [data-cash-locked].is-disabled {
        position: relative;
        pointer-events: none;
        opacity: 0.45;
    }

    .cash-close-summary {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
        gap: 20px;
    }

    .cash-close-balance {
        display: flex;
        flex-direction: column;
        gap: 12px;
        background: var(--color-surface-soft);
        border-radius: 10px;
        padding: 16px;
        border: 1px solid var(--color-border-faint);
    }

    .cash-close-balance__item {
        display: flex;
        justify-content: space-between;
        font-weight: 600;
        color: var(--color-accent-deep);
    }

    .cash-close-report,
    .cash-close-payments {
        background: var(--color-surface-card);
        border-radius: 10px;
        border: 1px solid var(--color-border-faint);
        padding: 16px;
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .cash-close-report h3,
    .cash-close-payments h3 {
        margin: 0;
        font-size: 1.05rem;
        color: var(--color-text-main);
    }

    .cash-close-report dl {
        margin: 0;
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    .cash-close-report dl div,
    .cash-close-payments ul li {
        display: flex;
        justify-content: space-between;
        font-size: 0.95rem;
        color: var(--color-text-main);
    }

    .cash-close-payments ul {
        margin: 0;
        padding-left: 0;
        list-style: none;
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .sales-badge span {
        color: var(--color-accent-deep);
    }

    .payment-layout {
        display: grid;
        grid-template-columns: minmax(380px, 2fr) minmax(260px, 1fr);
        gap: 24px;
        align-items: start;
    }

    .payment-section {
        display: flex;
        flex-direction: column;
        gap: 16px;
        background: var(--color-surface-soft);
        border-radius: 10px;
        padding: 20px;
        border: 1px solid var(--color-border-faint);
        min-width: 0;
    }

    .payment-section__title {
        margin: 0;
        font-size: 1.05rem;
        color: var(--color-text-main);
    }

    .payment-summary {
        margin: 0;
        padding: 0;
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    .payment-summary__row {
        display: flex;
        justify-content: space-between;
        font-weight: 600;
        color: var(--color-accent-deep);
    }

    .payment-table-wrapper {
        background: var(--color-surface-card);
        border-radius: 8px;
        border: 1px solid var(--color-border-faint);
        overflow: hidden;
        display: inline-block;
        align-self: flex-start;
        max-width: 320px;
    }

    .payment-table__title {
        margin: 0;
        padding: 12px 16px;
        font-size: 0.95rem;
        font-weight: 600;
        color: var(--color-text-main);
        border-bottom: 1px solid var(--color-border-faint);
        background: var(--color-surface-contrast);
    }

    .payment-table {
        width: 100%;
        border-collapse: collapse;
    }

    .payment-table th,
    .payment-table td {
        padding: 10px 14px;
        border-bottom: 1px solid var(--color-border-divider);
        text-align: left;
    }

    .payment-table input[type="number"] {
        width: 100%;
        border: 1px solid var(--color-border-subtle);
        border-radius: 6px;
        padding: 8px 10px;
        font-size: 0.95rem;
    }

    .payment-table input[type="number"]:focus {
        border-color: var(--color-info);
        box-shadow: 0 0 0 2px rgba(var(--color-info-rgb), 0.15);
        outline: none;
    }

    .payment-methods {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 12px;
    }

    .payment-option {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px 12px;
        border: 1px solid var(--color-border-faint);
        border-radius: 8px;
        background-color: var(--color-surface-card);
        cursor: pointer;
        transition: none;
        user-select: none;
    }

    .payment-option input {
        accent-color: var(--color-accent-deep);
    }

    .payment-option__icon {
        font-size: 1.2rem;
    }

    .payment-option:hover {
        border-color: var(--color-accent-deep);
        background: var(--color-surface-contrast);
    }

    .payment-option--single {
        justify-content: flex-start;
        margin-top: 8px;
    }

    .payment-option--fiscal {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .payment-option__header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 12px;
    }

    .payment-option__header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 12px;
    }

    .btn-icon--sm {
        width: 32px;
        height: 32px;
        padding: 0;
        display: inline-flex;
        align-items: center;
        justify-content: center;
    }

    .fiscal-preview {
        margin-top: 12px;
        padding: 12px;
        border-radius: 8px;
        border: 1px dashed var(--color-border-faint);
        background: var(--color-surface-soft);
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .fiscal-preview__title {
        font-weight: 600;
        color: var(--color-accent-deep);
    }

    .fiscal-preview__list {
        margin: 0;
        display: flex;
        gap: 18px;
    }

    .fiscal-preview__list div {
        display: flex;
        flex-direction: column;
        gap: 2px;
        font-size: 0.9rem;
    }

    @media (max-width: 720px) {
        .payment-layout {
            grid-template-columns: 1fr;
        }

        .cash-open-table {
            max-width: 100%;
        }
    }

    .cash-open-table {
        margin-bottom: 16px;
        max-width: 320px;
        width: 100%;
        margin-left: 0;
        margin-right: auto;
    }

    .cash-open-table__table {
        width: 100%;
        border-collapse: collapse;
        min-width: 200px;
        background-color: var(--color-surface-card);
        border-radius: 10px;
        overflow: hidden;
        border: 1px solid var(--color-border-faint);
    }

    .cash-open-table__table thead {
        background-color: var(--color-surface-soft);
    }

    .cash-open-table__table th,
    .cash-open-table__table td {
        padding: 12px 16px;
        border-bottom: 1px solid var(--color-border-divider);
        text-align: left;
    }

    .cash-open-table__table tbody tr:last-child td {
        border-bottom: none;
    }

    .cash-open-table__table input[type="number"] {
        width: 100%;
        border: 1px solid var(--color-border-subtle);
        border-radius: 6px;
        padding: 8px 10px;
        font-size: 0.95rem;
    }

    .cash-open-table__table input[type="number"]:focus {
        border-color: var(--color-info);
        box-shadow: 0 0 0 2px rgba(var(--color-info-rgb), 0.15);
        outline: none;
    }

    .cash-open-info {
        display: flex;
        flex-direction: column;
        gap: 4px;
        padding: 12px 14px;
        background-color: var(--color-surface-soft);
        border: 1px solid var(--color-border-faint);
        border-radius: 8px;
    }

    .cash-open-info__label {
        font-size: 0.85rem;
        color: var(--color-text-muted);
        text-transform: uppercase;
        letter-spacing: 0.02em;
    }

    .cash-open-info__value {
        font-size: 1rem;
        font-weight: 600;
        color: var(--color-text-main);
    }

    .form-grid--dense {
        gap: 12px;
    }

    .cash-open-info-line {
        display: flex;
        gap: 8px;
        align-items: center;
        padding: 8px 12px;
        background-color: var(--color-surface-soft);
        border: 1px solid var(--color-border-faint);
        border-radius: 8px;
        font-size: 0.95rem;
        margin-bottom: 16px;
    }

    .cash-open-info-line__label {
        font-weight: 600;
        color: var(--color-text-main);
    }

    .cash-open-info-line__value {
        color: var(--color-accent-deep);
    }

    .cash-open-info-line__timestamp {
        margin-left: auto;
        font-size: 0.85rem;
        color: var(--color-text-muted);
    }

    [data-cash-open-amount] {
        width: 100%;
        max-width: 260px;
        border: 1px solid var(--color-border-subtle);
        border-radius: 6px;
        padding: 10px 14px;
        font-size: 1rem;
        transition: border-color 0.2s ease, box-shadow 0.2s ease;
        background-color: var(--color-surface-card);
        display: block;
    }

    [data-cash-open-amount]:focus {
        border-color: var(--color-info);
        box-shadow: 0 0 0 2px rgba(var(--color-info-rgb), 0.15);
        outline: none;
    }

    .cash-close-summary {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
        gap: 20px;
    }

    .cash-close-balance {
        display: flex;
        flex-direction: column;
        gap: 12px;
        background: #f6f8fb;
        border-radius: 10px;
        padding: 16px;
        border: 1px solid #e1e7f0;
    }

    .cash-close-balance__item {
        display: flex;
        justify-content: space-between;
        font-weight: 600;
        color: #273c75;
    }

    .cash-close-report,
    .cash-close-payments {
        background: #ffffff;
        border-radius: 10px;
        border: 1px solid #e1e7f0;
        padding: 16px;
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .cash-close-report h3,
    .cash-close-payments h3 {
        margin: 0;
        font-size: 1.05rem;
        color: #2f3640;
    }

    .cash-close-report dl {
        margin: 0;
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    .cash-close-report dl div,
    .cash-close-payments ul li {
        display: flex;
        justify-content: space-between;
        font-size: 0.95rem;
        color: #2f3640;
    }

    .cash-close-payments ul {
        margin: 0;
        padding-left: 0;
        list-style: none;
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .sales-badge span {
        color: #273c75;
    }

    .discount-type-group {
        border: 1px solid #dcdde1;
        border-radius: 8px;
        padding: 16px;
        display: flex;
        justify-content: space-between;
        gap: 12px;
        margin: 0;
    }

    .discount-type-group legend {
        font-weight: 600;
        color: #2f3640;
    }

    .discount-option {
        display: flex;
        align-items: center;
        gap: 8px;
        cursor: pointer;
    }

    .discount-table-wrapper {
        border: 1px solid #dfe6f3;
        border-radius: 8px;
        overflow: hidden;
    }

    .discount-table__title {
        margin: 0;
        padding: 12px 16px;
        background: #f1f5fb;
        font-size: 0.95rem;
        font-weight: 600;
        color: #2f3640;
        border-bottom: 1px solid #dfe6f3;
    }

    .discount-table {
        width: 100%;
        border-collapse: collapse;
    }

    .discount-table th,
    .discount-table td {
        padding: 12px 16px;
        border-bottom: 1px solid #edf2fb;
        text-align: left;
    }

    .discount-table input[type="number"] {
        width: 100%;
        padding: 8px 10px;
        border: 1px solid #dcdde1;
        border-radius: 6px;
    }

    .discount-table input[type="number"]:focus {
        border-color: #0097e6;
        box-shadow: 0 0 0 2px rgba(0, 151, 230, 0.15);
        outline: none;
    }

    .btn {
        border: none;
        border-radius: 6px;
        padding: 8px 14px;
        font-size: 0.9rem;
        font-weight: 600;
        cursor: pointer;
        transition: none;
    }

    .btn-secondary {
        background-color: #273c75;
        color: #ffffff;
    }

    .btn-secondary:hover {
        background-color: #1f2f5c;
    }

    .btn-primary {
        background-color: #0097e6;
        color: #ffffff;
    }

    .btn-primary:hover {
        background-color: #007bb8;
    }

    .btn-outline {
        border: 1px solid #273c75;
        background: transparent;
        color: #273c75;
    }

    .btn-outline:hover {
        background: rgba(39, 60, 117, 0.1);
    }

    .btn-icon {
        display: inline-flex;
        align-items: center;
        gap: 6px;
    }

    .btn-icon .icon {
        font-size: 1rem;
    }

    @media (max-width: 640px) {
        .sales-header {
            flex-direction: column;
            align-items: flex-start;
        }
    }

    .field {
        display: flex;
        flex-direction: column;
        gap: 6px;
    }

    .field__group {
        display: flex;
        gap: 10px;
        align-items: center;
    }

    .field__group--full .field__control {
        flex: 1;
    }

    .field__label {
        font-weight: 600;
        color: #2f3640;
    }

    .field__control {
        border: 1px solid #dcdde1;
        border-radius: 6px;
        padding: 8px 12px;
        font-size: 0.95rem;
        outline: none;
        transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }

    .field__control:focus {
        border-color: #0097e6;
        box-shadow: 0 0 0 2px rgba(0, 151, 230, 0.15);
    }

    .field--readonly {
        background-color: #f5f6fa;
        border-radius: 6px;
        padding: 8px 12px;
    }

    .field__value {
        font-size: 1.4rem;
        font-weight: 600;
        color: #273c75;
    }

    .sales-cart {
        margin-top: 32px;
        background-color: #ffffff;
        border-radius: 10px;
        padding: 24px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.06);
    }

    .sales-cart__body {
        display: flex;
        gap: 24px;
        flex-wrap: wrap;
    }

    .sales-cart__items {
        flex: 2 1 420px;
        display: flex;
        flex-direction: column;
        gap: 16px;
    }

    .sales-cart__header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 12px;
    }

    .sales-cart__header h2 {
        margin: 0;
        font-size: 1.35rem;
        color: #2f3640;
    }

    .sales-cart__table-wrapper {
        overflow-x: auto;
    }

    .sales-cart__table {
        width: 100%;
        border-collapse: collapse;
        min-width: 720px;
        font-size: 0.95rem;
    }

    .sales-cart__table th,
    .sales-cart__table td {
        padding: 10px 12px;
        border-bottom: 1px solid #ecf0f1;
        text-align: left;
        white-space: nowrap;
    }

    .credit-collections {
        margin-top: 28px;
        background: #ffffff;
        border-radius: 12px;
        padding: 24px;
        box-shadow: 0 10px 30px rgba(27, 31, 59, 0.08);
        display: flex;
        flex-direction: column;
        gap: 20px;
    }

    .credit-collections__header {
        display: flex;
        flex-direction: column;
        gap: 18px;
    }

    .credit-collections__header h2 {
        margin: 0;
        font-size: 1.4rem;
        color: #1e272e;
    }

    .credit-collections__subtitle {
        margin: 0;
        color: #57606f;
        font-size: 0.95rem;
    }

    .credit-collections__summary {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 16px;
    }

    .credit-collections__kpi {
        background: #f5f6fa;
        border-radius: 10px;
        padding: 16px;
        display: flex;
        flex-direction: column;
        gap: 4px;
        border: 1px solid rgba(9, 132, 227, 0.04);
    }

    .credit-collections__kpi--highlight {
        background: linear-gradient(135deg, #0fbcf9, #00a8ff);
        color: #ffffff;
        box-shadow: 0 8px 18px rgba(15, 188, 249, 0.25);
    }

    .credit-collections__kpi-label {
        font-size: 0.85rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.04em;
    }

    .credit-collections__kpi-value {
        font-size: 1.4rem;
        font-weight: 700;
    }

    .credit-collections__kpi-hint {
        font-size: 0.85rem;
        color: rgba(87, 96, 111, 0.85);
    }

    .credit-collections__table-wrapper {
        border-radius: 12px;
        border: 1px solid #ecf0f1;
        overflow: hidden;
    }

    .credit-collections__table {
        width: 100%;
        border-collapse: collapse;
        min-width: 780px;
    }

    .credit-collections__table thead {
        background: #fafafa;
    }

    .credit-collections__table th,
    .credit-collections__table td {
        padding: 12px 16px;
        text-align: left;
        border-bottom: 1px solid #ecf0f1;
        font-size: 0.95rem;
    }

    .credit-collections__table tbody tr:hover {
        background: rgba(15, 188, 249, 0.05);
    }

    .credit-collections__table tbody tr:last-child td {
        border-bottom: none;
    }

    .credit-collections__table td:nth-child(4),
    .credit-collections__table td:nth-child(5),
    .credit-collections__table td:nth-child(9) {
        white-space: nowrap;
    }

    .credit-collections__chip {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 4px 10px;
        border-radius: 999px;
        font-size: 0.8rem;
        font-weight: 600;
    }

    .credit-collections__chip--today {
        background: rgba(9, 132, 227, 0.15);
        color: #0a62c9;
    }

    .credit-collections__chip--overdue {
        background: rgba(214, 48, 49, 0.18);
        color: #b71c1c;
    }

    .credit-collections__chip--upcoming {
        background: rgba(0, 184, 148, 0.2);
        color: #00897b;
    }

    .credit-collections__empty {
        text-align: center;
        padding: 32px 16px;
        color: #8395a7;
        font-style: italic;
    }

    .sales-cart__table tbody tr.is-selected,
    .sales-cart__table tbody tr.is-selected:hover {
        background-color: #dfe8ff;
    }

    .sales-cart__table td:last-child,
    .sales-cart__table th:last-child {
        text-align: right;
    }

    .sales-cart__empty {
        text-align: center;
        color: #7f8fa6;
        font-style: italic;
    }

    .sales-cart__summary {
        flex: 1 1 260px;
        background-color: #f5f6fa;
        border-radius: 10px;
        padding: 20px;
        display: flex;
        flex-direction: column;
        gap: 16px;
    }

    .sales-cart__summary h3 {
        margin: 0;
        font-size: 1.2rem;
        color: #2f3640;
    }

    .sales-cart__totals {
        margin: 0;
        padding: 0;
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .sales-cart__row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-weight: 600;
        color: #2f3640;
    }

    .sales-cart__row--highlight {
        font-size: 1.1rem;
        color: #0097e6;
    }

    .sales-cart__row dt,
    .sales-cart__row dd {
        margin: 0;
    }

    .sales-cart__actions {
        display: flex;
        gap: 10px;
        justify-content: flex-end;
    }

    .modal {
        position: fixed;
        inset: 0;
        background-color: rgba(0, 0, 0, 0.4);
        display: none;
        align-items: center;
        justify-content: center;
        padding: 24px;
        z-index: 1000;
    }

    .modal.is-visible {
        display: flex;
    }

    .modal-dialog {
        background-color: #ffffff;
        border-radius: 10px;
        max-width: 720px;
        width: 100%;
        box-shadow: 0 12px 30px rgba(0, 0, 0, 0.12);
        overflow: hidden;
        display: flex;
        flex-direction: column;
        max-height: 90vh;
    }

    .modal-dialog--narrow {
        max-width: 420px;
    }

    .modal-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 18px 24px;
        border-bottom: 1px solid #ecf0f1;
    }

    .modal-close {
        border: none;
        background: transparent;
        font-size: 1.6rem;
        cursor: pointer;
        line-height: 1;
        color: #2f3640;
    }

    .modal-form {
        padding: 24px;
        display: flex;
        flex-direction: column;
        gap: 24px;
        overflow-y: auto;
    }

    .modal-actions {
        display: flex;
        gap: 10px;
        justify-content: flex-end;
        padding: 16px 24px;
        border-top: 1px solid #ecf0f1;
    }

    .client-search {
        display: flex;
        flex-direction: column;
        padding: 16px 24px 0;
    }

    .client-search__input,
    .product-search__input {
        width: 100%;
        border: 1px solid #dcdde1;
        border-radius: 6px;
        padding: 10px 14px;
        font-size: 0.95rem;
        outline: none;
        transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }

    .client-search__input:focus,
    .product-search__input:focus {
        border-color: #0097e6;
        box-shadow: 0 0 0 2px rgba(0, 151, 230, 0.15);
    }

    .product-search {
        padding: 16px 24px 24px;
        display: flex;
        flex-direction: column;
        gap: 18px;
    }

    .product-search__input-group {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .product-search__hint {
        font-size: 0.8rem;
        color: #7f8fa6;
    }

    .product-search__filters {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 16px;
    }

    .product-search__filter {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .product-search__filter--actions {
        align-self: end;
        display: flex;
        justify-content: flex-end;
    }

    .product-search__filter-label {
        font-size: 0.85rem;
        color: #636e72;
        font-weight: 600;
    }

    .product-search__filter-control {
        width: 100%;
        border: 1px solid #dcdde1;
        border-radius: 6px;
        padding: 8px 10px;
        font-size: 0.9rem;
        background: #fff;
        color: #2f3640;
    }

    .product-search__filter-range {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .product-search__filter-separator {
        color: #7f8fa6;
    }

    .product-search__results {
        border: 1px solid rgba(39, 60, 117, 0.12);
        border-radius: 12px;
        background: #ffffff;
        padding: 0;
        max-height: 420px;
        overflow-y: auto;
    }

    .product-search__placeholder,
    .product-search__status {
        padding: 24px;
        text-align: center;
        color: #7f8fa6;
        font-size: 0.95rem;
    }

    .product-results__list {
        list-style: none;
        margin: 0;
        padding: 0;
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .product-results__item {
        display: flex;
        flex-direction: column;
        gap: 14px;
        padding: 18px 20px;
        border-bottom: 1px solid rgba(39, 60, 117, 0.08);
    }

    .product-results__header {
        display: grid;
        grid-template-columns: auto 1fr auto;
        gap: 16px;
        align-items: center;
    }

    .product-results__thumb {
        width: 72px;
        height: 72px;
        border-radius: 12px;
        background: rgba(39, 60, 117, 0.08);
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
        font-size: 1.8rem;
        color: #273c75;
    }

    .product-results__thumb img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .product-results__title {
        margin: 0;
        font-size: 1rem;
        color: #273c75;
        font-weight: 700;
    }

    .product-results__meta {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        font-size: 0.85rem;
        color: #636e72;
    }

    .product-results__stock {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 6px 10px;
        border-radius: 999px;
        background: rgba(39, 60, 117, 0.08);
        color: #273c75;
        font-weight: 600;
        font-size: 0.75rem;
        letter-spacing: 0.02em;
    }

    .product-results__units {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    .product-results__unit {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 12px;
        padding: 12px 14px;
        border: 1px solid rgba(39, 60, 117, 0.08);
        border-radius: 10px;
        background: #f9fbff;
    }

    .product-results__unit-label {
        display: flex;
        flex-direction: column;
        gap: 4px;
        font-size: 0.78rem;
        text-transform: uppercase;
        letter-spacing: 0.04em;
        color: #7f8fa6;
    }

    .product-results__unit-value {
        font-size: 0.92rem;
        color: #273c75;
        font-weight: 600;
        word-break: break-word;
    }

    .product-results__empty-state {
        padding: 32px 20px;
        text-align: center;
        color: #95a5a6;
        font-size: 0.95rem;
    }

    .product-results__item:last-child {
        border-bottom: none;
    }

    .product-results__select {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
    }

    @media (max-width: 640px) {
        .product-results__header {
            grid-template-columns: 1fr;
            justify-items: flex-start;
        }

        .product-results__select {
            width: 100%;
        }
    }

    .client-list {
        list-style: none;
        margin: 16px 0 0;
        padding: 0 24px;
        max-height: 360px;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .client-list__item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        padding: 12px 14px;
        border: 1px solid #dcdde1;
        border-radius: 8px;
        transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }

    .client-list__item:hover {
        border-color: #0097e6;
        box-shadow: 0 4px 10px rgba(0, 151, 230, 0.15);
    }

    .client-list__info {
        display: flex;
        flex-direction: column;
        gap: 4px;
        flex: 1;
    }

    .client-list__meta {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 12px;
        font-size: 0.85rem;
        color: #636e72;
    }

    .client-list__label {
        font-weight: 600;
        color: #2f3640;
    }

    .client-list__code {
        font-weight: 600;
    }

    .discount-option span {
        font-weight: 600;
    }

    .tradein-apply {
        margin-top: 16px;
        display: flex;
        flex-direction: column;
        gap: 6px;
    }

    .tradein-apply__label {
        font-size: 0.85rem;
        font-weight: 600;
        color: #636e72;
    }

    .tradein-apply__controls {
        display: flex;
        gap: 8px;
        flex-wrap: nowrap;
        align-items: center;
        max-width: 420px;
    }

    .tradein-code-group {
        display: flex;
        align-items: center;
        flex: 1 1 auto;
        border: 1px solid #dcdde1;
        border-radius: 8px;
        background: #fff;
        overflow: hidden;
        transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }

    .tradein-code-group:focus-within {
        border-color: #2563eb;
        box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.18);
    }

    .tradein-code-icon {
        padding: 0 10px;
        color: #2563eb;
        font-size: 1.1rem;
        display: inline-flex;
        align-items: center;
    }

    .tradein-code-group input[type="text"] {
        flex: 1 1 auto;
        padding: 10px 10px 10px 4px;
        border: none;
        font-size: 0.95rem;
        outline: none;
    }

    .tradein-apply__feedback {
        margin: 4px 0 0;
        font-size: 0.85rem;
        color: #636e72;
    }

    .tradein-apply__feedback--success {
        color: var(--color-success-text);
    }

    .tradein-apply__feedback--error {
        color: var(--color-danger-text);
    }

    /* Estilos para modal de cuotas */
    .credit-summary {
        background: var(--color-surface-soft);
        border-radius: 8px;
        padding: 16px;
        margin-bottom: 20px;
    }

    .credit-summary__row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin: 0;
    }

    .credit-summary__row dt {
        font-weight: 600;
        color: #636e72;
        margin: 0;
    }

    .credit-summary__row dd {
        font-weight: 700;
        color: #2f3640;
        font-size: 1.1rem;
        margin: 0;
    }

    .credit-calculation {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 16px;
        margin-top: 20px;
    }

    .credit-calculation h3 {
        margin: 0 0 12px 0;
        font-size: 1rem;
        color: #2f3640;
    }

    .credit-calculation__list {
        display: flex;
        flex-direction: column;
        gap: 8px;
        margin: 0;
    }

    .credit-calculation__list > div {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .credit-calculation__list dt {
        font-weight: 500;
        color: #636e72;
        margin: 0;
    }

    .credit-calculation__list dd {
        font-weight: 600;
        color: #2f3640;
        margin: 0;
    }

    .form-help {
        display: block;
        margin-top: 4px;
        font-size: 0.85rem;
        color: #636e72;
        font-style: italic;
    }

    .discount-table-wrapper {
        padding: 24px;
        gap: 20px;
    }

    .modal-actions {
        display: flex;
        gap: 10px;
        justify-content: flex-end;
    }

    .invoice-options {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
        gap: 16px;
    }

    .invoice-option {
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
        padding: 16px;
        border: 1px solid #dcdde1;
        border-radius: 10px;
        background-color: #f5f8ff;
        cursor: pointer;
        transition: none;
        text-align: left;
    }

    .invoice-option:hover,
    .invoice-option:focus {
        border-color: #0097e6;
        box-shadow: 0 6px 18px rgba(0, 151, 230, 0.15);
        transform: translateY(-2px);
        outline: none;
    }

    .invoice-option__icon {
        font-size: 1.6rem;
    }

    .invoice-option__title {
        font-weight: 600;
        color: #273c75;
        margin: 0;
    }

    .invoice-option__caption {
        margin: 0;
        font-size: 0.9rem;
        color: #636e72;
    }

    #product-modal .client-list__code {
        color: #636e72;
    }

    .sales-filter {
        display: flex;
        flex-direction: column;
        gap: 12px;
        padding: 16px 24px 0;
    }

    .sales-filter__row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
        gap: 12px;
        align-items: end;
    }

    .sales-filter__row--search {
        grid-template-columns: minmax(0, 260px) auto;
        justify-content: flex-start;
    }

    .sales-filter__field {
        display: flex;
        flex-direction: column;
        gap: 6px;
        font-size: 0.9rem;
        color: #2f3640;
    }

    .sales-filter__field input[type="date"],
    .sales-filter__field input[type="search"] {
        border: 1px solid #dcdde1;
        border-radius: 6px;
        padding: 8px 12px;
        font-size: 0.95rem;
        outline: none;
        transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }

    .sales-filter__field input[type="date"]:focus,
    .sales-filter__field input[type="search"]:focus {
        border-color: #0097e6;
        box-shadow: 0 0 0 2px rgba(0, 151, 230, 0.15);
    }

    .sales-filter__field--search {
        max-width: 260px;
    }

    .sales-filter__field--full {
        grid-column: 1 / -1;
    }

    .sales-history {
        padding: 16px 24px 24px;
        display: flex;
        flex-direction: column;
        gap: 12px;
        max-height: 360px;
        overflow-y: auto;
    }

    .sales-history__empty {
        text-align: center;
        color: #7f8fa6;
        font-style: italic;
    }

    .sales-history__list {
        list-style: none;
        margin: 0;
        padding: 0;
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    .sales-history__item {
        background-color: #ffffff;
        border-radius: 12px;
        border: 1px solid rgba(39, 60, 117, 0.12);
        box-shadow: 0 10px 30px rgba(39, 60, 117, 0.08);
        overflow: hidden;
    }

    .sales-history__accordion-trigger {
        width: 100%;
        border: none;
        background: none;
        padding: 18px 20px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        cursor: pointer;
        text-align: left;
    }

    .sales-history__summary {
        display: flex;
        flex-direction: column;
        gap: 6px;
    }

    .sales-history__summary-row {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        gap: 10px;
    }

    .sales-history__summary-main {
        display: flex;
        align-items: center;
        gap: 8px;
        font-weight: 600;
        color: #273c75;
    }

    .sales-history__summary-extra {
        font-size: 0.85rem;
        color: #636e72;
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .sales-history__summary-date {
        font-size: 0.85rem;
        color: #8391a6;
    }

    .sales-history__badge {
        padding: 4px 10px;
        border-radius: 999px;
        font-size: 0.75rem;
        font-weight: 600;
        background-color: rgba(0, 151, 230, 0.12);
        color: #0097e6;
        text-transform: uppercase;
        letter-spacing: 0.04em;
    }

    .sales-history__badge--credit {
        background-color: rgba(255, 165, 0, 0.12);
        color: #ff8c00;
        text-transform: none;
    }

    .sales-history__trigger-icon {
        margin-left: auto;
        font-size: 1.5rem;
        line-height: 1;
        transition: none;
    }

    .sales-history__item.is-open .sales-history__trigger-icon {
        transform: rotate(180deg);
    }

    .sales-history__body {
        display: none;
        padding: 0 20px 18px;
        border-top: 1px solid rgba(39, 60, 117, 0.08);
        margin-top: -6px;
        animation: none;
    }

    .sales-history__item.is-open .sales-history__body {
        display: block;
    }

    .sales-history__meta-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 12px;
    }

    @media (max-width: 640px) {
        .sales-history__summary-row {
            flex-direction: column;
            align-items: flex-start;
        }

        .sales-history__meta-grid {
            grid-template-columns: 1fr;
        }
    }

    .sales-history__meta-item {
        display: flex;
        flex-direction: column;
        gap: 4px;
        padding: 10px 12px;
        border: 1px solid rgba(39, 60, 117, 0.08);
        border-radius: 8px;
        background-color: #f9fbff;
    }

    .sales-history__meta-label {
        font-size: 0.75rem;
        color: #8391a6;
        text-transform: uppercase;
        letter-spacing: 0.06em;
    }

    .sales-history__meta-value {
        font-weight: 600;
        color: #273c75;
        font-size: 0.95rem;
    }

    .sales-history__details-wrapper {
        grid-column: 1 / -1;
        border-top: 1px dashed rgba(39, 60, 117, 0.12);
        padding-top: 12px;
    }

    .sales-history__details {
        list-style: none;
        padding: 0;
        margin: 8px 0 0;
        display: grid;
        gap: 8px;
        font-size: 0.9rem;
        color: #2f3640;
    }

    .sales-history__totals {
        display: flex;
        flex-wrap: wrap;
        gap: 14px;
        margin-top: 12px;
    }

    .sales-history__totals-item {
        background-color: #f5f8ff;
        border: 1px solid #dcdde1;
        border-radius: 8px;
        padding: 12px 18px;
        min-width: 200px;
        flex: 1 1 calc(33.333% - 20px);
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
    }

    .sales-history__totals-label {
        margin: 0;
        color: #636e72;
        font-size: 0.9rem;
        font-weight: 600;
    }

    .sales-history__totals-value {
        margin: 0;
        font-weight: 700;
        color: #2f3640;
        font-size: 1rem;
        white-space: nowrap;
    }

    @media (max-width: 720px) {
        .sales-history__totals-item {
            flex: 1 1 100%;
        }
    }

    @media (max-width: 640px) {
        .sales-filter__row {
            grid-template-columns: 1fr;
        }

        .sales-filter__row--search {
            grid-template-columns: 1fr;
        }

        .sales-filter__field--full {
            grid-column: 1 / -1;
        }
    }

    @media (max-width: 768px) {
        .sales-entry__form {
            flex-direction: column;
        }

        .sales-entry__column--right {
            max-width: none;
        }

        .sales-entry__actions {
            justify-content: flex-start;
        }
    }
.product-quantity-badge {
            display: inline-block;
            background: rgba(39, 60, 117, 0.1);
            color: #273c75;
            padding: 2px 6px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-left: 4px;
        }

        .product-specs {
            display: inline-block;
            background: rgba(52, 211, 153, 0.1);
            color: #059669;
            padding: 2px 6px;
            border-radius: 8px;
            font-size: 0.8rem;
            font-weight: 500;
            margin-left: 4px;
        }
    </style>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        var productSelector = document.querySelector('[data-product-selector]');
        var stockOutput = document.querySelector('[data-stock-output]');
        var clientSelect = document.querySelector('[data-client-select]');
        var openClientModalButton = document.querySelector('[data-open-client-modal]');
        var clientModal = document.getElementById('client-modal');
        var clientSearchInput = clientModal ? clientModal.querySelector('[data-client-search]') : null;
        var clientList = clientModal ? clientModal.querySelector('[data-client-list]') : null;
        var openCashOpenButton = document.querySelector('[data-open-cash-open]');
        var openCashCloseButton = document.querySelector('[data-open-cash-close]');
        var cashStatusBanner = document.querySelector('[data-cash-status]');
        var cashLockedSections = document.querySelectorAll('[data-cash-locked]');
        var codeInput = document.querySelector('[data-sales-code]');
        var quantityInput = document.querySelector('[data-sales-quantity]');
        var salesItemsBody = document.querySelector('[data-sales-items]');
        var subtotalOutput = document.querySelector('[data-sales-subtotal]');
        var taxOutput = document.querySelector('[data-sales-tax]');
        var totalOutput = document.querySelector('[data-sales-total]');
        var paymentInput = document.querySelector('[data-sales-payment]');
        var salesActionButtons = document.querySelectorAll('[data-sales-action]');
        var openProductModalButton = document.querySelector('[data-open-product-modal]');
        var productModal = document.getElementById('product-modal');
        var editQuantityModal = document.getElementById('edit-quantity-modal');
        var editPriceModal = document.getElementById('edit-price-modal');
        var editQuantityInput = editQuantityModal ? editQuantityModal.querySelector('[data-edit-quantity-input]') : null;
        var editPriceInput = editPriceModal ? editPriceModal.querySelector('[data-edit-price-input]') : null;
        var productSearchInput = productModal ? productModal.querySelector('[data-product-search]') : null;
        var productResultsContainer = productModal ? productModal.querySelector('[data-product-results]') : null;
        var productSearchEndpoint = productModal ? productModal.getAttribute('data-product-search-endpoint') : '';
        var productSearchAbortController = null;
        var productSearchDebounceTimer = null;
        var productFilters = productModal ? productModal.querySelector('[data-product-filters]') : null;
        var productFilterControls = productFilters ? productFilters.querySelectorAll('[data-product-filter]') : [];
        var productFilterClearButton = productFilters ? productFilters.querySelector('[data-product-filter-clear]') : null;
        var productFilterOptions = window.PRODUCT_FILTER_OPTIONS || null;
        var productFilterOptionsRaw = productFilterOptions;
        if (!productFilterOptionsRaw && typeof window.PRODUCT_FILTER_OPTIONS_JSON === 'string') {
            try {
                productFilterOptionsRaw = JSON.parse(window.PRODUCT_FILTER_OPTIONS_JSON);
            } catch (error) {
                productFilterOptionsRaw = null;
            }
        }
        if (productFilterOptionsRaw) {
            window.PRODUCT_FILTER_OPTIONS = productFilterOptionsRaw;
        }
        productFilterOptions = window.PRODUCT_FILTER_OPTIONS || {};
        var activeProductFilters = {
            brand: '',
            model: '',
            color: '',
            storage: '',
            ram: '',
            priceMin: '',
            priceMax: '',
        };
        var openSalesModalButton = document.querySelector('[data-open-sales-modal]');
        var salesModal = document.getElementById('sales-modal');
        var paymentModal = document.getElementById('payment-modal');
        var salesEntrySection = document.querySelector('.sales-entry');
        var saleSubmitEndpoint = salesEntrySection ? salesEntrySection.getAttribute('data-sale-submit') : '';
        var cashOpenModal = document.getElementById('cash-open-modal');
        var cashCloseModal = document.getElementById('cash-close-modal');
        var cashCloseConfirmModal = document.getElementById('cash-close-confirm-modal');
        var openPaymentModalButton = document.querySelector('[data-open-payment-modal]');
        var closePaymentButtons = paymentModal ? paymentModal.querySelectorAll('[data-close-payment]') : [];
        var confirmPaymentButton = paymentModal ? paymentModal.querySelector('[data-confirm-payment]') : null;
        var confirmPaymentButtonLabel = confirmPaymentButton ? confirmPaymentButton.textContent : '';
        var creditSaleCheckbox = paymentModal ? paymentModal.querySelector('[data-payment-credit-sale]') : null;
        var fiscalEmitCheckbox = paymentModal ? paymentModal.querySelector('[data-payment-emit-fiscal]') : null;
        var fiscalPreview = paymentModal ? paymentModal.querySelector('[data-payment-fiscal-preview]') : null;
        var fiscalPreviewType = paymentModal ? paymentModal.querySelector('[data-fiscal-preview-type]') : null;
        var fiscalPreviewSeries = paymentModal ? paymentModal.querySelector('[data-fiscal-preview-series]') : null;
        var openFiscalSettingsButton = paymentModal ? paymentModal.querySelector('[data-open-fiscal-settings]') : null;
        var paymentTotalOutput = paymentModal ? paymentModal.querySelector('[data-payment-total]') : null;
        var paymentDiscountOutput = paymentModal ? paymentModal.querySelector('[data-payment-discount]') : null;
        var paymentDiscountRow = paymentModal ? paymentModal.querySelector('[data-payment-discount-row]') : null;
        var paymentTradeInRow = paymentModal ? paymentModal.querySelector('[data-payment-tradein-row]') : null;
        var paymentTradeInValue = paymentModal ? paymentModal.querySelector('[data-payment-tradein]') : null;
        var paymentReceivedOutput = paymentModal ? paymentModal.querySelector('[data-payment-received]') : null;
        var paymentTotalDiscountedOutput = paymentModal ? paymentModal.querySelector('[data-payment-total-discounted]') : null;
        var paymentTotalDiscountedRow = paymentModal ? paymentModal.querySelector('[data-payment-total-discounted-row]') : null;
        var paymentChangeRow = paymentModal ? paymentModal.querySelector('[data-payment-change-row]') : null;
        var paymentChangeOutput = paymentModal ? paymentModal.querySelector('[data-payment-change]') : null;
        var invoiceModal = document.getElementById('invoice-modal');
        var closeInvoiceButtons = invoiceModal ? invoiceModal.querySelectorAll('[data-close-invoice]') : [];
        var invoiceOptionsContainer = invoiceModal ? invoiceModal.querySelector('[data-invoice-options]') : null;
        var paymentInputs = paymentModal ? paymentModal.querySelectorAll('[data-payment-input]') : [];
        var paymentMethodRefs = paymentModal ? {
            cash: paymentModal.querySelector('[data-payment-method="cash"]'),
            debit: paymentModal.querySelector('[data-payment-method="debit"]'),
            credit: paymentModal.querySelector('[data-payment-method="credit"]'),
            transfer: paymentModal.querySelector('[data-payment-method="transfer"]'),
            mixed: paymentModal.querySelector('[data-payment-method="mixed"]'),
        } : {};
        var openDiscountButton = paymentModal ? paymentModal.querySelector('[data-open-discount]') : null;
        var discountModal = document.getElementById('discount-modal');
        var closeDiscountButtons = discountModal ? discountModal.querySelectorAll('[data-close-discount]') : [];
        var applyDiscountButton = discountModal ? discountModal.querySelector('[data-apply-discount]') : null;
        var discountTypeInputs = discountModal ? discountModal.querySelectorAll('[data-discount-type]') : [];
        var discountValueInput = discountModal ? discountModal.querySelector('[data-discount-value]') : null;
        var discountCurrentTotal = discountModal ? discountModal.querySelector('[data-discount-current-total]') : null;
        var discountFinalTotal = discountModal ? discountModal.querySelector('[data-discount-final-total]') : null;
        var tradeInCodeInput = paymentModal ? paymentModal.querySelector('[data-tradein-code]') : null;
        var tradeInApplyButton = paymentModal ? paymentModal.querySelector('[data-apply-tradein]') : null;
        var tradeInSearchButton = paymentModal ? paymentModal.querySelector('[data-tradein-search]') : null;
        var tradeInRemoveButton = paymentModal ? paymentModal.querySelector('[data-remove-tradein]') : null;
        var tradeInFeedback = paymentModal ? paymentModal.querySelector('[data-tradein-feedback]') : null;
        var tradeInValidateEndpoint = paymentModal ? paymentModal.getAttribute('data-tradein-validate-url') : '';
        var creditInstallmentsModal = document.getElementById('credit-installments-modal');
        var closeCreditModalButtons = creditInstallmentsModal ? creditInstallmentsModal.querySelectorAll('[data-close-credit-modal]') : [];
        var confirmCreditConfigButton = creditInstallmentsModal ? creditInstallmentsModal.querySelector('[data-confirm-credit-config]') : null;
        var creditTotalOutput = creditInstallmentsModal ? creditInstallmentsModal.querySelector('[data-credit-total]') : null;
        var creditInstallmentsSelect = creditInstallmentsModal ? creditInstallmentsModal.querySelector('[data-credit-installments]') : null;
        var creditFrequencySelect = creditInstallmentsModal ? creditInstallmentsModal.querySelector('[data-credit-frequency]') : null;
        var creditInitialPaymentInput = creditInstallmentsModal ? creditInstallmentsModal.querySelector('[data-credit-initial-payment]') : null;
        var creditCalcInitial = creditInstallmentsModal ? creditInstallmentsModal.querySelector('[data-credit-calc-initial]') : null;
        var creditCalcBalance = creditInstallmentsModal ? creditInstallmentsModal.querySelector('[data-credit-calc-balance]') : null;
        var creditCalcInstallment = creditInstallmentsModal ? creditInstallmentsModal.querySelector('[data-credit-calc-installment]') : null;
        var creditCalcFrequency = creditInstallmentsModal ? creditInstallmentsModal.querySelector('[data-credit-calc-frequency]') : null;

        var creditCollectionsModal = document.getElementById('credit-collections-modal');
        var creditCollectionModal = document.getElementById('credit-collection-modal');
        var creditCollectionForm = creditCollectionModal ? creditCollectionModal.querySelector('[data-credit-collection-form]') : null;
        var creditCollectionCloseButtons = creditCollectionModal ? creditCollectionModal.querySelectorAll('[data-close-credit-collection]') : [];
        var creditCollectionsCloseButtons = creditCollectionsModal ? creditCollectionsModal.querySelectorAll('[data-close-credit-collections]') : [];
        var creditCollectionSubmitButton = creditCollectionModal ? creditCollectionModal.querySelector('[data-credit-collection-submit]') : null;
        var creditCollectionCliente = creditCollectionModal ? creditCollectionModal.querySelector('[data-credit-collection-cliente]') : null;
        var creditCollectionFactura = creditCollectionModal ? creditCollectionModal.querySelector('[data-credit-collection-factura]') : null;
        var creditCollectionEstado = creditCollectionModal ? creditCollectionModal.querySelector('[data-credit-collection-estado]') : null;
        var creditCollectionSaldo = creditCollectionModal ? creditCollectionModal.querySelector('[data-credit-collection-saldo]') : null;
        var creditCollectionPrioridad = creditCollectionModal ? creditCollectionModal.querySelector('[data-credit-collection-prioridad]') : null;
        var creditCollectionCuentaInput = creditCollectionModal ? creditCollectionModal.querySelector('[data-credit-collection-id]') : null;
        var creditCollectionAmountInput = creditCollectionModal ? creditCollectionModal.querySelector('[data-credit-collection-amount]') : null;
        var creditCollectionCommentInput = creditCollectionModal ? creditCollectionModal.querySelector('[data-credit-collection-comment]') : null;
        var creditCollectionsTableBody = document.querySelector('.credit-collections__table tbody');

        var cashOpenAmountInput = cashOpenModal ? cashOpenModal.querySelector('[data-cash-open-amount]') : null;
        var cashOpenLastValue = cashOpenModal ? cashOpenModal.querySelector('[data-cash-open-last]') : null;
        var cashOpenTimestampLabel = cashOpenModal ? cashOpenModal.querySelector('[data-cash-open-timestamp]') : null;
        var cashOpenSalesValue = cashOpenModal ? cashOpenModal.querySelector('[data-cash-open-sales]') : null;
        var cashOpenProfitValue = cashOpenModal ? cashOpenModal.querySelector('[data-cash-open-profit]') : null;
        var closeCashOpenButtons = cashOpenModal ? cashOpenModal.querySelectorAll('[data-close-cash-open]') : [];
        var confirmCashOpenButton = cashOpenModal ? cashOpenModal.querySelector('[data-confirm-cash-open]') : null;
        var closeCashCloseButtons = cashCloseModal ? cashCloseModal.querySelectorAll('[data-close-cash-close]') : [];
        var finalizeCashCloseButton = cashCloseModal ? cashCloseModal.querySelector('[data-finalize-cash-close]') : null;
        var exportCashCloseButton = cashCloseModal ? cashCloseModal.querySelector('[data-export-cash-close]') : null;
        var closeCashCloseConfirmButtons = cashCloseConfirmModal ? cashCloseConfirmModal.querySelectorAll('[data-close-cash-close-confirm]') : [];
        var confirmCashCloseButton = cashCloseConfirmModal ? cashCloseConfirmModal.querySelector('[data-confirm-cash-close]') : null;
        var cashReportTableBody = document.querySelector('[data-report-cash-table-body]');
        var cashReportWrapper = document.querySelector('[data-report-cash-table-wrapper]');
        var cashReportPagination = document.querySelector('[data-report-cash-pagination]');
        var cashReportPageInfo = document.querySelector('[data-report-cash-page]');
        var cashCloseSummaryRefs = cashCloseModal ? {
            opening: cashCloseModal.querySelector('[data-cash-close-opening]'),
            closing: cashCloseModal.querySelector('[data-cash-close-closing]'),
            initial: cashCloseModal.querySelector('[data-cash-report-initial]'),
            sales: cashCloseModal.querySelector('[data-cash-report-sales]'),
            creditSales: cashCloseModal.querySelector('[data-cash-report-credit-sales]'),
            creditPayments: cashCloseModal.querySelector('[data-cash-report-credit-payments]'),
            discounts: cashCloseModal.querySelector('[data-cash-report-discounts]'),
            taxes: cashCloseModal.querySelector('[data-cash-report-taxes]'),
            cash: cashCloseModal.querySelector('[data-cash-report-cash]'),
            tradeIn: cashCloseModal.querySelector('[data-cash-report-tradein]'),
            electronic: cashCloseModal.querySelector('[data-cash-report-electronic]'),
            cashSales: cashCloseModal.querySelector('[data-cash-report-cash-sales]'),
            cashCredit: cashCloseModal.querySelector('[data-cash-report-cash-credit]'),
            cardDebit: cashCloseModal.querySelector('[data-cash-report-card-debit]'),
            cardCredit: cashCloseModal.querySelector('[data-cash-report-card-credit]'),
            transfer: cashCloseModal.querySelector('[data-cash-report-transfer]'),
            credit: cashCloseModal.querySelector('[data-cash-report-credit]'),
            mixed: cashCloseModal.querySelector('[data-cash-report-mixed]'),
        } : null;

        var cashEndpoints = {
            status: '{% url "dashboard:cash_session_status_api" %}',
            open: '{% url "dashboard:cash_session_open_api" %}',
            close: '{% url "dashboard:cash_session_close_api" %}',
        };

        function getCreditCollectionRows() {
            return document.querySelectorAll('[data-credit-collection-row]');
        }

        function closeCreditCollectionModal() {
            if (!creditCollectionModal) {
                return;
            }
            closeModalElement(creditCollectionModal);
            if (creditCollectionSubmitButton) {
                creditCollectionSubmitButton.classList.remove('is-loading');
                creditCollectionSubmitButton.disabled = false;
            }
            if (creditCollectionAmountInput) {
                creditCollectionAmountInput.value = '';
            }
            if (creditCollectionCommentInput) {
                creditCollectionCommentInput.value = '';
            }
        }

        function openCreditCollectionModalWithDataset(dataset) {
            if (!creditCollectionModal || !dataset) {
                return;
            }

            var cuentaId = dataset.creditId;
            if (!cuentaId) {
                showToast('No se pudo determinar la cuota seleccionada.', 'warning');
                return;
            }

            if (creditCollectionCliente) {
                creditCollectionCliente.textContent = dataset.creditCliente || '‚Äî';
            }
            if (creditCollectionFactura) {
                creditCollectionFactura.textContent = dataset.creditFactura || '‚Äî';
            }
            if (creditCollectionEstado) {
                creditCollectionEstado.textContent = dataset.creditEstado || '‚Äî';
                creditCollectionEstado.className = 'modal-field__value ' + (dataset.creditEstadoClase || '');
            }
            if (creditCollectionSaldo) {
                creditCollectionSaldo.textContent = dataset.creditSaldo || 'RD$ 0.00';
            }
            if (creditCollectionPrioridad) {
                creditCollectionPrioridad.textContent = dataset.creditPrioridad || '‚Äî';
                creditCollectionPrioridad.className = 'modal-field__value ' + (dataset.creditChipClass || '');
            }
            if (creditCollectionCuentaInput) {
                creditCollectionCuentaInput.value = cuentaId;
            }

            if (creditCollectionAmountInput) {
                var parsedAmount = Number(dataset.creditMontoRaw);
                if (!Number.isFinite(parsedAmount) || parsedAmount <= 0) {
                    parsedAmount = Number(dataset.creditSaldoRaw);
                }
                if (!Number.isFinite(parsedAmount) || parsedAmount <= 0) {
                    parsedAmount = 0;
                }
                creditCollectionAmountInput.value = parsedAmount ? parsedAmount.toFixed(2) : '';
                var saldoMax = Number(dataset.creditSaldoRaw);
                creditCollectionAmountInput.max = Number.isFinite(saldoMax) && saldoMax > 0 ? saldoMax.toFixed(2) : '';
            }

            if (creditCollectionSubmitButton) {
                creditCollectionSubmitButton.disabled = false;
                creditCollectionSubmitButton.dataset.creditId = cuentaId;
                creditCollectionSubmitButton.dataset.creditEstadoKey = dataset.creditEstadoKey || 'pendiente';
            }

            openModalElement(creditCollectionModal);
            if (creditCollectionAmountInput) {
                creditCollectionAmountInput.focus();
                creditCollectionAmountInput.select();
            }
        }

        if (creditCollectionsTableBody) {
            creditCollectionsTableBody.addEventListener('click', function (event) {
                var trigger = event.target.closest('[data-credit-action="open-collection-modal"]');
                if (!trigger) {
                    return;
                }
                var row = trigger.closest('[data-credit-collection-row]');
                if (!row) {
                    return;
                }
                openCreditCollectionModalWithDataset(row.dataset);
            });
        }

        var openCreditCollectionButton = document.querySelector('[data-open-credit-collection]');
        if (openCreditCollectionButton) {
            openCreditCollectionButton.addEventListener('click', function () {
                var rows = getCreditCollectionRows();
                var availableRow = Array.prototype.find.call(rows, function (row) {
                    return row;
                });

                if (!availableRow) {
                    showToast('No hay cuotas pendientes para cobrar en este momento.', 'info');
                    return;
                }

                if (creditCollectionsModal) {
                    openModalElement(creditCollectionsModal);
                }
                openCreditCollectionModalWithDataset(availableRow.dataset);
            });
        }

        creditCollectionsCloseButtons.forEach(function (button) {
            button.addEventListener('click', function () {
                closeModalElement(creditCollectionsModal);
            });
        });

        creditCollectionCloseButtons.forEach(function (button) {
            button.addEventListener('click', closeCreditCollectionModal);
        });

        if (creditCollectionSubmitButton) {
            creditCollectionSubmitButton.addEventListener('click', function () {
                if (creditCollectionSubmitButton.classList.contains('is-loading')) {
                    return;
                }

                var cuentaId = creditCollectionSubmitButton.dataset.creditId || '';
                var estadoKey = (creditCollectionSubmitButton.dataset.creditEstadoKey || 'pendiente').toLowerCase();
                var amountValue = creditCollectionAmountInput ? Number(creditCollectionAmountInput.value) : 0;
                var comentario = creditCollectionCommentInput ? creditCollectionCommentInput.value.trim() : '';

                if (!cuentaId) {
                    showToast('No se pudo determinar la cuenta a cobrar.', 'error');
                    return;
                }

                if (!Number.isFinite(amountValue) || amountValue <= 0) {
                    showToast('Ingresa un monto v√°lido para registrar el cobro.', 'warning');
                    if (creditCollectionAmountInput) {
                        creditCollectionAmountInput.focus();
                    }
                    return;
                }

                if (!ensureCashOpen('Debes abrir la caja antes de registrar un cobro de cuota.')) {
                    return;
                }

                creditCollectionSubmitButton.disabled = true;
                creditCollectionSubmitButton.classList.add('is-loading');

                var payload = {
                    cuenta_id: cuentaId,
                    monto: amountValue,
                    comentario: comentario,
                };

                var endpoint = estadoKey === 'atrasado'
                    ? '{% url "dashboard:registrar_pago_tardio_credito_api" %}'
                    : '{% url "dashboard:registrar_abono_credito_api" %}';

                fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCsrfToken(),
                    },
                    body: JSON.stringify(payload),
                })
                    .then(function (response) {
                        if (!response.ok) {
                            return response.json().catch(function () { return {}; }).then(function (data) {
                                throw new Error(data.error || 'No se pudo registrar el cobro.');
                            });
                        }
                        return response.json();
                    })
                    .then(function (data) {
                        showToast('Cobro registrado correctamente.', 'success');
                        addCreditPaymentSnapshot(amountValue);
                        window.location.reload();
                    })
                    .catch(function (error) {
                        showToast(error.message || 'No se pudo registrar el cobro.', 'error');
                        creditCollectionSubmitButton.disabled = false;
                        creditCollectionSubmitButton.classList.remove('is-loading');
                    });
            });
        }

        document.addEventListener('keydown', function (event) {
            if (event.key === 'Escape' && creditCollectionModal && creditCollectionModal.classList.contains('is-visible')) {
                closeCreditCollectionModal();
            }
        });

        function parseCashSession(session) {
            if (!session) {
                return null;
            }
            var totals = session.totals || {};
            return {
                id: session.id,
                apertura: session.apertura_display || '--',
                aperturaISO: session.apertura || null,
                montoInicial: session.monto_inicial_display || 'RD$ 0.00',
                montoInicialValor: typeof session.monto_inicial === 'number' ? Number(session.monto_inicial) : null,
                totalEnCaja: totals.total_en_caja_display || 'RD$ 0.00',
                totalEnCajaValor: typeof totals.total_en_caja === 'number'
                    ? Number(totals.total_en_caja)
                    : (typeof session.total_en_caja_registrado === 'number' ? Number(session.total_en_caja_registrado) : null),
                estado: session.estado || 'abierta',
                estadoDisplay: session.estado_display || 'Abierta',
                totalVentas: totals.total_display || 'RD$ 0.00',
                totalVentasValor: typeof totals.total === 'number'
                    ? Number(totals.total)
                    : null,
                totalCost: totals.total_costo_display || 'RD$ 0.00',
                totalCostValor: typeof totals.total_costo === 'number'
                    ? Number(totals.total_costo)
                    : null,
                totalGanancia: totals.total_ganancia_display || 'RD$ 0.00',
                totalGananciaValor: typeof totals.total_ganancia === 'number'
                    ? Number(totals.total_ganancia)
                    : null,
                cierre: session.cierre_display || '--',
                cierreISO: session.cierre || null,
                impuesto: totals.impuestos_display || 'RD$ 0.00',
                discounts: typeof totals.descuento === 'number' ? totals.descuento : 0,
                tradeIn: typeof totals.trade_in === 'number' ? totals.trade_in : 0,
                descuento: totals.descuento_display || 'RD$ 0.00',
                credito: totals.total_credito_display || 'RD$ 0.00',
                creditPayments: totals.total_credit_payments_display || 'RD$ 0.00',
                creditPaymentsValor: typeof totals.total_credit_payments === 'number'
                    ? Number(totals.total_credit_payments)
                    : null,
            };
        }

        function renderCashReportRow(sessionData) {
            if (!cashReportTableBody) {
                return;
            }
            cashReportTableBody.innerHTML = '';
            if (!sessionData) {
                cashReportTableBody.innerHTML = '<tr><td colspan="10">Sin registros disponibles.</td></tr>';
                return;
            }
            var row = document.createElement('tr');
            function cell(value) {
                var td = document.createElement('td');
                td.textContent = value;
                return td;
            }

            row.appendChild(cell(sessionData.id || '--'));
            row.appendChild(cell(sessionData.apertura));
            row.appendChild(cell(sessionData.montoInicial));
            row.appendChild(cell(sessionData.estado === 'cerrada' ? sessionData.totalEnCaja : '--'));
            row.appendChild(cell(sessionData.estado === 'cerrada' ? sessionData.estadoDisplay : '--'));
            row.appendChild(cell(sessionData.estado === 'cerrada' ? sessionData.totalVentas : '--'));
            row.appendChild(cell(sessionData.estado === 'cerrada' ? sessionData.cierre : '--'));
            row.appendChild(cell(sessionData.estado === 'cerrada' ? sessionData.impuesto : '--'));
            row.appendChild(cell(sessionData.estado === 'cerrada' ? sessionData.descuento : '--'));
            row.appendChild(cell(sessionData.estado === 'cerrada' ? sessionData.credito : '--'));
            cashReportTableBody.appendChild(row);
            if (cashReportWrapper) {
                cashReportWrapper.hidden = false;
            }
        }

        function openPaymentModal() {
            if (!paymentModal) {
                return;
            }
            handlePaymentTrigger();
        }

        function fetchCashStatus() {
            return fetch(cashEndpoints.status, {
                headers: {
                    'Accept': 'application/json',
                },
            })
                .then(function (response) {
                    if (!response.ok) {
                        return null;
                    }
                    return response.json();
                })
                .then(function (data) {
                    if (!data) {
                        return null;
                    }
                    return {
                        openSession: parseCashSession(data.open_session),
                        lastClosed: parseCashSession(data.last_closed),
                    };
                })
                .catch(function () {
                    return null;
                });
        }

        function updateCashStatusFromServer() {
            fetchCashStatus().then(function (status) {
                if (!status) {
                    return;
                }
                if (status.openSession) {
                    cashState.isOpen = true;
                    if (typeof status.openSession.montoInicialValor === 'number' && !Number.isNaN(status.openSession.montoInicialValor)) {
                        cashState.openingAmount = status.openSession.montoInicialValor;
                    } else {
                        var cleanedAmount = (status.openSession.montoInicial || '').replace(/[RD$\s]/g, '').replace(/,/g, '');
                        cashState.openingAmount = parseFloat(cleanedAmount) || 0;
                    }
                } else {
                    cashState.isOpen = false;
                    cashState.openingAmount = 0;
                }

                if (status.lastClosed) {
                    var lastClosed = status.lastClosed;
                    cashState.lastCloseAmount = typeof lastClosed.totalEnCajaValor === 'number'
                        ? lastClosed.totalEnCajaValor
                        : cashState.lastCloseAmount;
                    cashState.lastCloseSales = typeof lastClosed.totalVentasValor === 'number'
                        ? lastClosed.totalVentasValor
                        : cashState.lastCloseSales;
                    cashState.lastCloseProfit = typeof lastClosed.totalGananciaValor === 'number'
                        ? lastClosed.totalGananciaValor
                        : cashState.lastCloseProfit;
                    if (lastClosed.cierreISO) {
                        var parsedCloseDate = new Date(lastClosed.cierreISO);
                        cashState.lastCloseTimestamp = Number.isNaN(parsedCloseDate.getTime())
                            ? cashState.lastCloseTimestamp
                            : parsedCloseDate;
                    }
                } else if (!status.openSession) {
                    cashState.lastCloseAmount = null;
                    cashState.lastCloseTimestamp = null;
                    cashState.lastCloseSales = null;
                    cashState.lastCloseProfit = null;
                }

                renderCashReportRow(status.openSession || status.lastClosed);
                setCashUiState();
            });
        }
        var salesSearchInput = salesModal ? salesModal.querySelector('[data-sales-search]') : null;
        var salesDateStartInput = salesModal ? salesModal.querySelector('[data-sales-date-start]') : null;
        var salesDateEndInput = salesModal ? salesModal.querySelector('[data-sales-date-end]') : null;
        var salesRefreshButton = salesModal ? salesModal.querySelector('[data-sales-refresh]') : null;
        var salesResultsContainer = salesModal ? salesModal.querySelector('[data-sales-results]') : null;
        var salesTableBody = salesModal ? salesModal.querySelector('[data-sales-table-body]') : null;
        var salesPagination = salesModal ? salesModal.querySelector('[data-sales-pagination]') : null;
        var salesPrevButton = salesModal ? salesModal.querySelector('[data-sales-prev]') : null;
        var salesNextButton = salesModal ? salesModal.querySelector('[data-sales-next]') : null;
        var salesSummary = salesModal ? salesModal.querySelector('[data-sales-summary]') : null;
        var salesEndpoint = salesModal ? salesModal.getAttribute('data-sales-endpoint') : '';
        var salesState = {
            page: 1,
            pageSize: 10,
            query: '',
            fechaInicio: '',
            fechaFin: '',
            isLoading: false,
        };
        var GLOBAL_TAX_ENABLED = '{{ global_tax_enabled|yesno:"true,false" }}' === 'true';
        var GLOBAL_TAX_RATE = parseFloat('{{ global_tax_rate|default:0 }}') / 100;
        var CURRENCY = 'RD$';
        var VentaMetodoPago = {
            EFECTIVO: 'efectivo',
            TARJETA: 'tarjeta',
            TRANSFERENCIA: 'transferencia',
            MIXTO: 'mixto',
            CREDITO: 'credito',
        };
        var cartItems = [];
        var creditConfig = {
            enabled: false,
            installments: 3,
            frequency: 30,
            initialPayment: 0,
            installmentAmount: 0
        };
        var paymentState = {
            total: 0,
            discountAmount: 0,
            discountType: null,
            discountValue: 0,
            subtotal: 0,
            tax: 0,
            fiscalConfig: null,
            fiscalEnabled: false,
            tradeIn: null,
        };
        var cashState = {
            isOpen: false,
            openingAmount: 0,
            totals: {
                sales: 0,
                creditSales: 0,
                creditPayments: 0,
                discounts: 0,
                taxes: 0,
                tradeIn: 0,
                payment: {
                    cash: 0,
                    cashCredit: 0,
                    cardDebit: 0,
                    cardCredit: 0,
                    transfer: 0,
                    credit: 0,
                    mixed: 0,
                },
            },
            lastCloseAmount: null,
            lastCloseTimestamp: null,
            lastCloseSales: null,
            lastCloseProfit: null,
        };
        var CASH_STATE_STORAGE_KEY = 'ventas_cash_state';
        var invoiceCode = null;
        var selectedItemIndex = null;
        var isSubmittingSale = false;
        var lastRegisteredSale = null;

        function syncConfirmPaymentButton(isLoading) {
            if (!confirmPaymentButton) {
                return;
            }
            if (isLoading) {
                confirmPaymentButton.disabled = true;
                confirmPaymentButton.textContent = 'Guardando...';
            } else {
                confirmPaymentButton.disabled = false;
                confirmPaymentButton.textContent = confirmPaymentButtonLabel || 'Confirmar pago';
            }
        }

        function showToast(message, type) {
            if (typeof window.showToast === 'function' && window.showToast !== showToast) {
                window.showToast(message, type);
                return;
            }
            if (typeof window.createToast === 'function') {
                window.createToast(message, type);
                return;
            }
            console.warn('[toast]', type || 'info', message);
        }

        function refreshSalesHistory() {
            if (!salesModal || !salesEndpoint) {
                return;
            }
            salesState.page = 1;
            fetchSalesData();
        }

        function resetSaleForm() {
            cartItems = [];
            selectedItemIndex = null;
            renderCart();
            if (paymentInputs.length) {
                paymentInputs.forEach(function (input) {
                    input.value = '';
                });
            }
            Object.keys(paymentMethodRefs || {}).forEach(function (key) {
                if (paymentMethodRefs[key]) {
                    paymentMethodRefs[key].checked = false;
                }
            });
            if (creditSaleCheckbox) {
                creditSaleCheckbox.checked = false;
            }
            if (fiscalEmitCheckbox) {
                fiscalEmitCheckbox.checked = false;
            }
            paymentState.fiscalEnabled = false;
            paymentState.discountAmount = 0;
            paymentState.discountType = null;
            paymentState.discountValue = 0;
            paymentState.fiscalConfig = null;
            clearTradeInState({ silent: true, resetInput: true });
            hideFiscalPreview();
            updatePaymentSummary();
            invoiceCode = generateInvoiceCode();
            if (codeInput) {
                codeInput.value = invoiceCode;
            }
        }

        function renderSaleTableRows(data) {
            if (!salesTableBody) {
                return;
            }
            if (!Array.isArray(data) || !data.length) {
                salesTableBody.innerHTML = '<tr><td colspan="11" class="sales-history__empty">No se encontraron ventas para los filtros seleccionados.</td></tr>';
                return;
            }

            var rows = data.map(function (sale) {
                var subtotalDisplay = sale.subtotal || (typeof sale.subtotal_num === 'number' ? formatCurrency(sale.subtotal_num) : '-');
                var taxDisplay = sale.impuestos || (typeof sale.impuestos_num === 'number' ? formatCurrency(sale.impuestos_num) : '-');
                var totalDisplay = sale.total || (typeof sale.total_num === 'number' ? formatCurrency(sale.total_num) : '-');
                var abonadoDisplay = sale.total_abonado || (typeof sale.total_abonado_num === 'number' ? formatCurrency(sale.total_abonado_num) : '-');

                return [
                    '<tr>',
                    '<td>' + (sale.factura || '-') + '</td>',
                    '<td>' + (sale.cliente_nombre || '-') + '</td>',
                    '<td>' + subtotalDisplay + '</td>',
                    '<td>' + taxDisplay + '</td>',
                    '<td>' + totalDisplay + '</td>',
                    '<td>' + abonadoDisplay + '</td>',
                    '<td>' + (sale.fecha || '-') + '</td>',
                    '<td>' + (sale.hora || '-') + '</td>',
                    '<td>' + (sale.cajero || '-') + '</td>',
                    '<td>' + (sale.metodo_pago || '-') + '</td>',
                    '<td>',
                    '    <div class="sales-history__table-actions">',
                    '        <button type="button" class="btn btn-outline btn-icon btn-icon--sm" data-download-invoice data-sale-id="' + sale.id + '" title="Descargar factura">',
                    '            <span class="icon">üìÑ</span>',
                    '        </button>',
                    '        <button type="button" class="btn btn-outline btn-icon btn-icon--sm" data-download-ticket data-sale-id="' + sale.id + '" title="Descargar ticket">',
                    '            <span class="icon">üé´</span>',
                    '        </button>',
                    '    </div>',
                    '</td>',
                    '</tr>'
                ].join('');
            });

            salesTableBody.innerHTML = rows.join('');
        }

        function updateSalesPaginationBlock(pagination) {
            if (!salesPagination || !salesPrevButton || !salesNextButton || !salesSummary) {
                return;
            }

            var total = pagination.total || 0;
            var page = pagination.page || 1;
            var pageCount = pagination.page_count || 1;
            var startIndex = pagination.start_index || 0;
            var endIndex = pagination.end_index || 0;

            salesPagination.hidden = total === 0;
            salesPrevButton.disabled = !(pagination.has_previous || false);
            salesNextButton.disabled = !(pagination.has_next || false);

            if (total === 0) {
                salesSummary.textContent = '0 resultados';
            } else {
                salesSummary.textContent = startIndex + ' - ' + endIndex + ' de ' + total + ' ventas';
            }

            salesPrevButton.dataset.page = page > 1 ? String(page - 1) : String(page);
            salesNextButton.dataset.page = page < pageCount ? String(page + 1) : String(page);
        }

        function submitSale(payload) {
            if (!saleSubmitEndpoint) {
                return Promise.reject(new Error('Endpoint de ventas no configurado.'));
            }
            var csrfToken = getCsrfToken();
            return fetch(saleSubmitEndpoint, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken,
                    'Accept': 'application/json',
                },
                body: JSON.stringify(payload),
            }).then(function (response) {
                if (!response.ok) {
                    return response.json().catch(function () { return {}; }).then(function (data) {
                        var message = data.error || 'No fue posible registrar la venta.';
                        throw new Error(message);
                    });
                }
                return response.json();
            });
        }

        function parseSaleDateTime(sale) {
            var fecha = sale.fecha || '';
            var hora = sale.hora || '';
            var timestamp = fecha;
            if (hora) {
                timestamp += 'T' + hora;
            }
            var date = new Date(timestamp);
            if (Number.isNaN(date.getTime())) {
                return 0;
            }
            return date.getTime();
        }

        function sortSalesData(data) {
            if (!Array.isArray(data)) {
                return [];
            }
            return data.slice().sort(function (a, b) {
                var timeA = parseSaleDateTime(a);
                var timeB = parseSaleDateTime(b);
                if (timeA === timeB) {
                    return (b.id || 0) - (a.id || 0);
                }
                return timeB - timeA;
            });
        }

        function resolveMetodoPago(methods, isCreditSale) {
            if (isCreditSale) {
                return VentaMetodoPago.CREDITO;
            }
            if (!methods || !methods.length) {
                return VentaMetodoPago.EFECTIVO;
            }
            if (methods.indexOf('mixed') !== -1 || methods.length > 1) {
                return VentaMetodoPago.MIXTO;
            }
            var method = methods[0];
            if (method === 'cash') {
                return VentaMetodoPago.EFECTIVO;
            }
            if (method === 'transfer') {
                return VentaMetodoPago.TRANSFERENCIA;
            }
            if (method === 'debit' || method === 'credit') {
                return VentaMetodoPago.TARJETA;
            }
            if (method === 'mixed') {
                return VentaMetodoPago.MIXTO;
            }
            return VentaMetodoPago.EFECTIVO;
        }

        function applyCashTotals(snapshot) {
            if (!snapshot) {
                return;
            }
            cashState.totals.sales += snapshot.sales || 0;
            cashState.totals.creditSales += snapshot.creditSales || 0;
            cashState.totals.creditPayments += snapshot.creditPayments || 0;
            cashState.totals.discounts += snapshot.discounts || 0;
            cashState.totals.taxes += snapshot.taxes || 0;
            cashState.totals.tradeIn += snapshot.tradeIn || 0;
            var paymentSnapshot = snapshot.payment || {};
            Object.keys(paymentSnapshot).forEach(function (key) {
                if (Object.prototype.hasOwnProperty.call(cashState.totals.payment, key)) {
                    cashState.totals.payment[key] += paymentSnapshot[key] || 0;
                }
            });
        }

        function addCreditPaymentSnapshot(amount) {
            if (!Number.isFinite(amount) || amount <= 0) {
                return;
            }
            cashState.totals.creditPayments += amount;
            cashState.totals.payment.cash += amount;
            serializeCashState();
        }

        function generateInvoiceCode() {
            var now = new Date();
            return 'FAC-' + now.toISOString().replace(/[-:T.Z]/g, '').slice(0, 12);
        }

        function formatCurrency(value) {
            var number = Number(value);
            if (!isFinite(number)) {
                number = 0;
            }
            var formatted = number.toLocaleString('en-US', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
            return CURRENCY + ' ' + formatted;
        }

        function computeDiscountAmount(baseTotal, type, value) {
            if (!Number.isFinite(baseTotal) || baseTotal <= 0) {
                return 0;
            }
            if (!type || !Number.isFinite(value) || value <= 0) {
                return 0;
            }
            if (type === 'percent') {
                var percent = Math.min(Math.max(value, 0), 100);
                return baseTotal * (percent / 100);
            }
            if (type === 'fixed') {
                return Math.min(value, baseTotal);
            }
            return 0;
        }

        function formatDateTime(value) {
            var date = value instanceof Date ? value : (value ? new Date(value) : null);
            if (!date || Number.isNaN(date.getTime())) {
                return "Sin registros";
            }
            return date.toLocaleString('es-DO', {
                dateStyle: 'medium',
                timeStyle: 'short',
            });
        }

        function getCsrfToken() {
            var csrfInput = document.querySelector('input[name="csrfmiddlewaretoken"]');
            if (csrfInput) {
                return csrfInput.value;
            }
            var csrfCookieMatch = document.cookie.match(/(?:^|; )csrftoken=([^;]+)/);
            return csrfCookieMatch ? decodeURIComponent(csrfCookieMatch[1]) : '';
        }

        function buildFiscalPayload() {
            if (!paymentState.fiscalEnabled || !paymentState.fiscalConfig) {
                return null;
            }
            var config = paymentState.fiscalConfig;
            var clientOption = clientSelect ? clientSelect.options[clientSelect.selectedIndex] : null;
            var clientName = clientOption ? clientOption.textContent : '';
            var documento = clientOption ? clientOption.getAttribute('data-documento') || '' : '';
            var correo = clientOption ? clientOption.getAttribute('data-correo') || '' : '';
            var telefono = clientOption ? clientOption.getAttribute('data-telefono') || '' : '';

            return {
                config_id: config.id || null,
                tipo: config.tipo_por_defecto || '',
                serie: config.serie_por_defecto || '',
                cliente_nombre: clientName,
                cliente_documento: documento,
                correo_envio: correo,
                telefono_contacto: telefono,
            };
        }

        function buildSalePayload(options) {
            options = options || {};
            var clientId = clientSelect ? clientSelect.value : '';
            var vendedorId = options.vendedorId || '';
            var metodoPago = options.metodoPago || VentaMetodoPago.EFECTIVO;
            var notas = options.notas || '';

            var productosPayload = cartItems
                .map(function (item) {
                    var productoId = item.id ? parseInt(item.id, 10) : NaN;
                    var unidadIndex = item.unitIndex ? parseInt(item.unitIndex, 10) : null;
                    var cantidad = parseInt(item.quantity, 10);
                    var precio = roundMoney(item.price);
                    if (!Number.isInteger(productoId) || Number.isNaN(cantidad) || cantidad <= 0) {
                        return null;
                    }
                    return {
                        producto_id: productoId,
                        unidad_index: unidadIndex,
                        cantidad: cantidad,
                        precio: precio,
                        descuento: 0,
                    };
                })
                .filter(Boolean);

            var subtotal = roundMoney(paymentState.subtotal);
            var impuestos = roundMoney(paymentState.tax);
            var descuentoAplicado = roundMoney(paymentState.discountAmount);
            var totalConDescuento = roundMoney(Math.max(paymentState.total - paymentState.discountAmount, 0));
            var pagoRecibido = typeof options.pagoRecibido === 'number' ? roundMoney(options.pagoRecibido) : null;

            var payload = {
                cliente_id: clientId ? parseInt(clientId, 10) : null,
                vendedor_id: vendedorId ? parseInt(vendedorId, 10) : null,
                productos: productosPayload,
                subtotal: subtotal,
                impuestos: impuestos,
                descuento: descuentoAplicado,
                total: totalConDescuento,
                total_pagado: pagoRecibido,
                es_credito: Boolean(options.esCredito),
                metodo_pago: metodoPago,
                notas: notas,
                fiscal: buildFiscalPayload(),
            };

            // Agregar configuraci√≥n de cuotas si est√° habilitada
            if (creditConfig.enabled && options.esCredito) {
                payload.credito_config = {
                    numero_cuotas: creditConfig.installments,
                    frecuencia_dias: creditConfig.frequency,
                };
            }
            if (paymentState.tradeIn && paymentState.tradeIn.code) {
                payload.trade_in_code = paymentState.tradeIn.code;
                payload.trade_in_amount = roundMoney(paymentState.tradeIn.amount || 0);
            }
            return payload;
        }

        function roundMoney(value) {
            return Math.round((Number(value) || 0) * 100) / 100;
        }

        function updatePaymentSummary() {
            var tradeInAmountDisplay = 0;
            if (paymentState.tradeIn && typeof paymentState.tradeIn.amount === 'number') {
                tradeInAmountDisplay = roundMoney(paymentState.tradeIn.amount);
            }
            var totalDiscounts = paymentState.discountAmount + tradeInAmountDisplay;
            var discountedTotal = Math.max(paymentState.total - totalDiscounts, 0);
            if (paymentTotalOutput) {
                paymentTotalOutput.textContent = formatCurrency(paymentState.total);
            }
            if (paymentDiscountOutput) {
                paymentDiscountOutput.textContent = formatCurrency(paymentState.discountAmount);
            }
            if (paymentDiscountRow) {
                paymentDiscountRow.hidden = !(paymentState.discountAmount > 0);
            }
            if (paymentTradeInValue) {
                paymentTradeInValue.textContent = formatCurrency(tradeInAmountDisplay);
            }
            if (paymentTradeInRow) {
                paymentTradeInRow.hidden = !(tradeInAmountDisplay > 0);
            }
            if (paymentTotalDiscountedOutput) {
                paymentTotalDiscountedOutput.textContent = formatCurrency(discountedTotal);
            }
            if (paymentTotalDiscountedRow) {
                paymentTotalDiscountedRow.hidden = !(totalDiscounts > 0);
            }
            if (discountCurrentTotal) {
                discountCurrentTotal.textContent = formatCurrency(paymentState.total);
            }
            if (discountFinalTotal) {
                discountFinalTotal.textContent = formatCurrency(discountedTotal);
            }

            var paymentReceived = roundMoney(getPaymentReceivedTotal());
            if (paymentReceivedOutput) {
                paymentReceivedOutput.textContent = formatCurrency(paymentReceived);
            }

            var selectedMethods = getSelectedPaymentMethods();
            var isCreditSaleActive = creditSaleCheckbox ? creditSaleCheckbox.checked : false;
            var changeEligible = !isCreditSaleActive && selectedMethods.length === 1 && selectedMethods[0] === 'cash';
            var changeAmount = changeEligible ? roundMoney(paymentReceived - discountedTotal) : 0;
            if (changeAmount < 0) {
                changeAmount = 0;
            }

            if (paymentChangeRow) {
                paymentChangeRow.hidden = !(changeAmount > 0);
            }
            if (paymentChangeOutput) {
                paymentChangeOutput.textContent = formatCurrency(changeAmount);
            }
        }

        function setTradeInFeedback(message, state) {
            if (!tradeInFeedback) {
                return;
            }
            tradeInFeedback.textContent = message || '';
            tradeInFeedback.classList.remove('tradein-apply__feedback--success', 'tradein-apply__feedback--error');
            if (state === 'success') {
                tradeInFeedback.classList.add('tradein-apply__feedback--success');
            } else if (state === 'error') {
                tradeInFeedback.classList.add('tradein-apply__feedback--error');
            }
        }

        function updateTradeInControls() {
            var hasTradeIn = Boolean(paymentState.tradeIn && typeof paymentState.tradeIn.amount === 'number');
            if (tradeInApplyButton) {
                tradeInApplyButton.disabled = hasTradeIn;
                tradeInApplyButton.classList.remove('is-loading');
            }
            if (tradeInRemoveButton) {
                tradeInRemoveButton.hidden = !hasTradeIn;
            }
            if (tradeInCodeInput) {
                if (hasTradeIn) {
                    tradeInCodeInput.readOnly = true;
                } else {
                    tradeInCodeInput.readOnly = false;
                }
            }
        }

        function applyTradeInState(credit, options) {
            options = options || {};
            paymentState.tradeIn = credit ? {
                code: credit.codigo,
                amount: Number(credit.monto) || 0,
                nombre_cliente: credit.nombre_cliente || '',
                producto: credit.producto || '',
                descripcion: credit.descripcion || ''
            } : null;

            if (tradeInCodeInput) {
                tradeInCodeInput.value = credit ? credit.codigo : '';
            }

            updateTradeInControls();
            updatePaymentSummary();

            if (!options.silent) {
                if (credit) {
                    setTradeInFeedback('Cr√©dito aplicado correctamente.', 'success');
                    showToast('Cr√©dito trade-in aplicado.', 'success');
                } else {
                    setTradeInFeedback('', null);
                }
            }
        }

        function clearTradeInState(options) {
            options = options || {};
            var hadTradeIn = Boolean(paymentState.tradeIn);
            paymentState.tradeIn = null;
            if (tradeInCodeInput && options.resetInput !== false) {
                tradeInCodeInput.value = '';
            }
            updateTradeInControls();
            updatePaymentSummary();
            if (!options.silent && hadTradeIn) {
                setTradeInFeedback('Se elimin√≥ el cr√©dito trade-in.', 'success');
                showToast('Se quit√≥ el cr√©dito trade-in.', 'info');
            } else if (!options.silent) {
                setTradeInFeedback('', null);
            }
        }

        function applyTradeInCode() {
            if (!tradeInApplyButton || !tradeInCodeInput) {
                return;
            }
            if (!tradeInValidateEndpoint) {
                showToast('No hay endpoint configurado para validar cr√©ditos trade-in.', 'error');
                return;
            }
            var code = tradeInCodeInput.value.trim();
            if (!code) {
                setTradeInFeedback('Ingresa un c√≥digo antes de aplicar.', 'error');
                return;
            }
            if (paymentState.tradeIn && paymentState.tradeIn.code === code.toUpperCase()) {
                setTradeInFeedback('Este cr√©dito ya est√° aplicado.', 'success');
                return;
            }

            tradeInApplyButton.disabled = true;
            tradeInApplyButton.classList.add('is-loading');
            setTradeInFeedback('Validando cr√©dito...', null);

            fetch(tradeInValidateEndpoint, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCsrfToken(),
                },
                body: JSON.stringify({ codigo: code })
            })
                .then(function (response) {
                    if (!response.ok) {
                        return response.json().catch(function () { return {}; }).then(function (data) {
                            throw new Error(data.error || 'No se pudo validar el cr√©dito.');
                        });
                    }
                    return response.json();
                })
                .then(function (data) {
                    if (!data || !data.success || !data.credit) {
                        throw new Error('Respuesta inesperada del servidor.');
                    }
                    applyTradeInState(data.credit, { silent: true });
                    setTradeInFeedback('Cr√©dito aplicado: ' + formatCurrency(data.credit.monto), 'success');
                })
                .catch(function (error) {
                    setTradeInFeedback(error.message || 'No se pudo aplicar el cr√©dito.', 'error');
                    showToast(error.message || 'No se pudo validar el cr√©dito trade-in.', 'error');
                })
                .finally(function () {
                    tradeInApplyButton.disabled = false;
                    tradeInApplyButton.classList.remove('is-loading');
                    updateTradeInControls();
                });
        }

        function updateCashOpenInfo() {
            if (cashOpenLastValue) {
                cashOpenLastValue.textContent = cashState.lastCloseAmount != null
                    ? formatCurrency(cashState.lastCloseAmount)
                    : "Sin registros";
            }
            if (cashOpenTimestampLabel) {
                cashOpenTimestampLabel.textContent = formatDateTime(cashState.lastCloseTimestamp);
            }
            if (cashOpenSalesValue) {
                cashOpenSalesValue.textContent = cashState.lastCloseSales != null
                    ? formatCurrency(cashState.lastCloseSales)
                    : "Sin registros";
            }
            if (cashOpenProfitValue) {
                cashOpenProfitValue.textContent = cashState.lastCloseProfit != null
                    ? formatCurrency(cashState.lastCloseProfit)
                    : "Sin registros";
            }
        }

        function getPaymentReceivedTotal() {
            if (!paymentInputs.length) {
                return 0;
            }
            return Array.prototype.reduce.call(paymentInputs, function (acc, input) {
                var value = parseFloat(input.value);
                if (!Number.isFinite(value) || value < 0) {
                    return acc;
                }
                return acc + value;
            }, 0);
        }

        function getSelectedPaymentMethods() {
            var methods = [];
            if (!paymentMethodRefs) {
                return methods;
            }
            Object.keys(paymentMethodRefs).forEach(function (key) {
                var ref = paymentMethodRefs[key];
                if (ref && ref.checked) {
                    methods.push(key);
                }
            });
            return methods;
        }

        function hideFiscalPreview() {
            if (fiscalPreview) {
                fiscalPreview.hidden = true;
            }
            if (fiscalPreviewType) {
                fiscalPreviewType.textContent = '‚Äî';
            }
            if (fiscalPreviewSeries) {
                fiscalPreviewSeries.textContent = '‚Äî';
            }
        }

        function updateFiscalPreview() {
            if (!fiscalPreview) {
                return;
            }
            if (!paymentState.fiscalEnabled || !paymentState.fiscalConfig) {
                hideFiscalPreview();
                return;
            }
            fiscalPreview.hidden = false;
            if (fiscalPreviewType) {
                var type = paymentState.fiscalConfig.tipo_por_defecto || '';
                fiscalPreviewType.textContent = type || 'Sin definir';
            }
            if (fiscalPreviewSeries) {
                var series = paymentState.fiscalConfig.serie_por_defecto || '';
                fiscalPreviewSeries.textContent = series || 'Sin definir';
            }
        }

        function fetchFiscalConfig() {
            return fetch('{% url "dashboard:fiscal_voucher_config_api" %}', {
                headers: {
                    'Accept': 'application/json',
                },
                credentials: 'same-origin',
            })
                .then(function (response) {
                    if (!response.ok) {
                        throw new Error('No fue posible obtener la configuraci√≥n fiscal.');
                    }
                    return response.json();
                })
                .then(function (data) {
                    paymentState.fiscalConfig = data && data.config ? data.config : null;
                    return paymentState.fiscalConfig;
                })
                .catch(function (error) {
                    showToast(error.message || 'No fue posible cargar la configuraci√≥n fiscal.', 'warning');
                    paymentState.fiscalConfig = null;
                    return null;
                })
                .finally(function () {
                    updateFiscalPreview();
                });
        }

        function resetCashTotals() {
            cashState.totals = {
                sales: 0,
                creditSales: 0,
                creditPayments: 0,
                discounts: 0,
                taxes: 0,
                tradeIn: 0,
                payment: {
                    cash: 0,
                    cashCredit: 0,
                    cardDebit: 0,
                    cardCredit: 0,
                    transfer: 0,
                    credit: 0,
                    mixed: 0,
                },
            };
        }

        function ensureCashOpen(customMessage) {
            if (cashState.isOpen) {
                return true;
            }
            showToast(customMessage || 'Debes abrir la caja antes de realizar esta acci√≥n.', 'warning');
            return false;
        }

        function setCashUiState() {
            if (cashStatusBanner) {
                cashStatusBanner.classList.remove('cash-status--open', 'cash-status--closed');
                cashStatusBanner.classList.add(cashState.isOpen ? 'cash-status--open' : 'cash-status--closed');
                cashStatusBanner.textContent = cashState.isOpen
                    ? 'Caja abierta. Puedes registrar ventas.'
                    : 'Caja cerrada. Abre la caja para iniciar operaciones.';
            }
            if (openCashOpenButton) {
                openCashOpenButton.disabled = cashState.isOpen;
            }
            if (openCashCloseButton) {
                openCashCloseButton.disabled = false;
            }
            cashLockedSections.forEach(function (section) {
                section.classList.toggle('is-disabled', !cashState.isOpen);
            });
            updateCashOpenInfo();
            serializeCashState();
        }

        function serializeCashState() {
            try {
                var payload = {
                    isOpen: cashState.isOpen,
                    openingAmount: cashState.openingAmount,
                    totals: cashState.totals,
                    lastCloseAmount: cashState.lastCloseAmount,
                    lastCloseTimestamp: cashState.lastCloseTimestamp ? cashState.lastCloseTimestamp.toISOString() : null,
                    lastCloseSales: cashState.lastCloseSales,
                    lastCloseProfit: cashState.lastCloseProfit,
                };
                window.localStorage.setItem(CASH_STATE_STORAGE_KEY, JSON.stringify(payload));
            } catch (error) {
                console.warn('No fue posible guardar el estado de la caja:', error);
            }
        }

        function hydrateCashState() {
            try {
                var stored = window.localStorage.getItem(CASH_STATE_STORAGE_KEY);
                if (!stored) {
                    return;
                }
                var parsed = JSON.parse(stored);
                if (parsed && typeof parsed === 'object') {
                    cashState.isOpen = Boolean(parsed.isOpen);
                    cashState.openingAmount = Number(parsed.openingAmount) || 0;
                    if (parsed.totals && typeof parsed.totals === 'object') {
                        cashState.totals = Object.assign({}, cashState.totals, parsed.totals);
                        if (parsed.totals.payment && typeof parsed.totals.payment === 'object') {
                            cashState.totals.payment = Object.assign({}, cashState.totals.payment, parsed.totals.payment);
                        }
                    }
                    var lastAmount = Number(parsed.lastCloseAmount);
                    cashState.lastCloseAmount = Number.isFinite(lastAmount) && lastAmount >= 0 ? lastAmount : null;
                    cashState.lastCloseTimestamp = parsed.lastCloseTimestamp ? new Date(parsed.lastCloseTimestamp) : null;
                    if (cashState.lastCloseTimestamp && Number.isNaN(cashState.lastCloseTimestamp.getTime())) {
                        cashState.lastCloseTimestamp = null;
                    }
                    var lastSales = Number(parsed.lastCloseSales);
                    cashState.lastCloseSales = Number.isFinite(lastSales) && lastSales >= 0 ? lastSales : null;
                    var lastProfit = Number(parsed.lastCloseProfit);
                    cashState.lastCloseProfit = Number.isFinite(lastProfit) ? lastProfit : null;
                }
            } catch (error) {
                console.warn('No fue posible restaurar el estado de la caja:', error);
            }
        }

        function populateCashCloseSummary() {
            if (!cashCloseSummaryRefs) {
                return;
            }
            var totals = cashState.totals;
            var electronicTotal = totals.payment.cardDebit + totals.payment.cardCredit + totals.payment.transfer;
            var closingCash = cashState.openingAmount + totals.payment.cash + totals.payment.cashCredit + totals.payment.mixed;

            if (cashCloseSummaryRefs.opening) {
                cashCloseSummaryRefs.opening.textContent = formatCurrency(cashState.openingAmount);
            }
            if (cashCloseSummaryRefs.closing) {
                cashCloseSummaryRefs.closing.textContent = formatCurrency(closingCash);
            }
            if (cashCloseSummaryRefs.initial) {
                cashCloseSummaryRefs.initial.textContent = formatCurrency(cashState.openingAmount);
            }
            if (cashCloseSummaryRefs.sales) {
                cashCloseSummaryRefs.sales.textContent = formatCurrency(totals.sales);
            }
            if (cashCloseSummaryRefs.creditSales) {
                cashCloseSummaryRefs.creditSales.textContent = formatCurrency(totals.creditSales);
            }
            if (cashCloseSummaryRefs.creditPayments) {
                cashCloseSummaryRefs.creditPayments.textContent = formatCurrency(totals.creditPayments);
            }
            if (cashCloseSummaryRefs.discount) {
                cashCloseSummaryRefs.discount.textContent = formatCurrency(totals.discounts);
            }
            if (cashCloseSummaryRefs.tradeIn) {
                cashCloseSummaryRefs.tradeIn.textContent = formatCurrency(totals.tradeIn);
            }
            if (cashCloseSummaryRefs.taxes) {
                cashCloseSummaryRefs.taxes.textContent = formatCurrency(totals.taxes);
            }
            if (cashCloseSummaryRefs.cash) {
                cashCloseSummaryRefs.cash.textContent = formatCurrency(closingCash);
            }
            if (cashCloseSummaryRefs.electronic) {
                cashCloseSummaryRefs.electronic.textContent = formatCurrency(electronicTotal);
            }
            if (cashCloseSummaryRefs.cashSales) {
                cashCloseSummaryRefs.cashSales.textContent = formatCurrency(totals.payment.cash);
            }
            if (cashCloseSummaryRefs.cashCredit) {
                cashCloseSummaryRefs.cashCredit.textContent = formatCurrency(totals.payment.cashCredit);
            }
            if (cashCloseSummaryRefs.cardDebit) {
                cashCloseSummaryRefs.cardDebit.textContent = formatCurrency(totals.payment.cardDebit);
            }
            if (cashCloseSummaryRefs.cardCredit) {
                cashCloseSummaryRefs.cardCredit.textContent = formatCurrency(totals.payment.cardCredit);
            }
            if (cashCloseSummaryRefs.transfer) {
                cashCloseSummaryRefs.transfer.textContent = formatCurrency(totals.payment.transfer);
            }
            if (cashCloseSummaryRefs.credit) {
                cashCloseSummaryRefs.credit.textContent = formatCurrency(totals.payment.credit);
            }
            if (cashCloseSummaryRefs.mixed) {
                cashCloseSummaryRefs.mixed.textContent = formatCurrency(totals.payment.mixed);
            }
        }

        function computeLineTax(item) {
            if (!item || !Number.isFinite(item.price) || !Number.isFinite(item.quantity)) {
                return 0;
            }
            var base = item.price * item.quantity;
            if (!Number.isFinite(base) || base <= 0) {
                return 0;
            }
            if (GLOBAL_TAX_ENABLED) {
                if (!item.impuestoActivo) {
                    return 0;
                }
                return base * GLOBAL_TAX_RATE;
            }
            if (!Number.isFinite(item.impuestoPorcentaje) || item.impuestoPorcentaje <= 0) {
                return 0;
            }
            return base * (item.impuestoPorcentaje / 100);
        }

        function renderCart() {
            if (!salesItemsBody) {
                return;
            }

            if (!cartItems.length) {
                selectedItemIndex = null;
                salesItemsBody.innerHTML = '<tr><td colspan="7" class="sales-cart__empty">Agrega un producto para comenzar.</td></tr>';
            } else {
                var rows = cartItems.map(function (item, index) {
                    var lineSubtotal = item.price * item.quantity;
                    var lineTax = computeLineTax(item);
                    var lineTotal = lineSubtotal + lineTax;
                    var isSelected = index === selectedItemIndex;
                    
                    // Mostrar producto con especificaciones y cantidad
                    var productDisplay = item.product;
                    if (item.specs) {
                        productDisplay += ' <span class="product-specs">(' + item.specs + ')</span>';
                    }
                    if (item.quantity > 1) {
                        productDisplay += ' <span class="product-quantity-badge">(' + item.quantity + ' unidades)</span>';
                    }
                    
                    return [
                        '<tr data-row-index="' + index + '"' + (isSelected ? ' class="is-selected"' : '') + '>',
                        '<td>' + item.client + '</td>',
                        '<td>' + productDisplay + '</td>',
                        '<td>' + (item.batteryLife ? item.batteryLife + '%' : '‚Äî') + '</td>',
                        '<td>' + formatCurrency(item.price) + '</td>',
                        '<td>' + item.quantity + '</td>',
                        '<td>' + formatCurrency(lineTax) + '</td>',
                        '<td>' + formatCurrency(lineTotal) + '</td>',
                        '</tr>'
                    ].join('');
                });
                salesItemsBody.innerHTML = rows.join('');
            }

            var subtotal = cartItems.reduce(function (acc, item) {
                return acc + (item.price * item.quantity);
            }, 0);
            var tax = cartItems.reduce(function (acc, item) {
                return acc + computeLineTax(item);
            }, 0);
            var total = subtotal + tax;

            paymentState.subtotal = subtotal;
            paymentState.tax = tax;
            paymentState.total = total;
            if (paymentState.discountType === 'percent') {
                paymentState.discountAmount = computeDiscountAmount(total, 'percent', paymentState.discountValue);
            } else if (paymentState.discountType === 'fixed') {
                paymentState.discountAmount = computeDiscountAmount(total, 'fixed', paymentState.discountValue);
            } else {
                paymentState.discountAmount = 0;
            }
            updatePaymentSummary();

            if (subtotalOutput) {
                subtotalOutput.textContent = formatCurrency(subtotal);
            }
            if (taxOutput) {
                taxOutput.textContent = formatCurrency(tax);
            }
            if (totalOutput) {
                totalOutput.textContent = formatCurrency(total);
            }
        }

        function handleAddToCart() {
            if (!ensureCashOpen()) {
                return;
            }
            if (!productSelector) {
                return;
            }

            var productValue = productSelector.value;
            var clientValue = clientSelect ? clientSelect.value : '';
            var quantityValue = quantityInput ? parseInt(quantityInput.value, 10) : 0;

            if (!productValue || !clientValue) {
                showToast('Selecciona un cliente y un producto antes de agregar.', 'warning');
                return;
            }

            if (!quantityValue || quantityValue <= 0) {
                showToast('Ingresa una cantidad v√°lida.', 'warning');
                return;
            }

            var productOption = productSelector.options[productSelector.selectedIndex];
            var clientOption = clientSelect ? clientSelect.options[clientSelect.selectedIndex] : null;
            var price = parseFloat(productOption ? productOption.getAttribute('data-price') || '0' : '0');
            var impuestoPorcentaje = parseFloat(productOption ? productOption.getAttribute('data-impuesto') || '0' : '0');
            var impuestoActivoAttr = productOption ? productOption.getAttribute('data-impuesto-activo') : null;
            var impuestoActivo = impuestoActivoAttr === null ? true : impuestoActivoAttr === 'true';
            var usarImpuestoGlobalAttr = productOption ? productOption.getAttribute('data-usa-global') : 'true';
            var usarImpuestoGlobal = usarImpuestoGlobalAttr !== 'false';
            var impuestoIdAttr = productOption ? productOption.getAttribute('data-impuesto-id') : '';
            var impuestoLabelAttr = productOption ? productOption.getAttribute('data-impuesto-label') : '';

            if (!price || price < 0) {
                showToast('El producto seleccionado no tiene un precio v√°lido.', 'warning');
                return;
            }

            cartItems.push({
                id: productValue,
                invoice: invoiceCode || '-',
                client: clientOption ? clientOption.text : '-',
                product: productOption ? productOption.text : '-',
                price: price,
                quantity: quantityValue,
                impuestoPorcentaje: impuestoPorcentaje,
                impuestoActivo: impuestoActivo,
                usarImpuestoGlobal: usarImpuestoGlobal,
                impuestoId: impuestoIdAttr || '',
                impuestoLabel: impuestoLabelAttr || (usarImpuestoGlobal ? 'Impuesto global' : 'Sin impuesto'),
                unitIndex: productOption ? productOption.getAttribute('data-unit-index') : null,
                batteryLife: productOption ? productOption.getAttribute('data-battery') : '',
            });

            selectedItemIndex = cartItems.length - 1;
            renderCart();

            if (quantityInput) {
                quantityInput.value = '';
            }
        }

        function handleClearCart() {
            if (!ensureCashOpen()) {
                return;
            }
            cartItems = [];
            selectedItemIndex = null;
            renderCart();
            if (paymentInput) {
                paymentInput.value = '';
            }
        }

        function openModalElement(modal) {
            if (!modal) {
                return;
            }
            if (document.activeElement && document.activeElement !== document.body) {
                modal._previouslyFocused = document.activeElement;
            } else {
                modal._previouslyFocused = null;
            }
            modal.classList.add('is-visible');
            modal.setAttribute('aria-hidden', 'false');
        }

        function closeModalElement(modal) {
            if (!modal) {
                return;
            }
            var activeElement = document.activeElement;
            if (activeElement && modal.contains(activeElement) && typeof activeElement.blur === 'function') {
                activeElement.blur();
            }
            modal.classList.remove('is-visible');
            requestAnimationFrame(function () {
                modal.setAttribute('aria-hidden', 'true');
                if (modal._previouslyFocused && typeof modal._previouslyFocused.focus === 'function') {
                    modal._previouslyFocused.focus();
                }
                modal._previouslyFocused = null;
            });
        }

        function openInvoiceModalWithSale(saleSummary) {
            if (!invoiceModal) {
                return;
            }
            lastRegisteredSale = saleSummary || null;
            openModalElement(invoiceModal);
        }

        function closeInvoiceModal() {
            if (!invoiceModal) {
                return;
            }
            closeModalElement(invoiceModal);
        }

        function handleEditQuantity() {
            if (!ensureCashOpen()) {
                return;
            }
            if (selectedItemIndex === null || !cartItems[selectedItemIndex]) {
                showToast('Selecciona un producto de la lista para editar la cantidad.', 'warning');
                return;
            }
            
            var item = cartItems[selectedItemIndex];
            
            // Analizar stock completo para este producto
            var stockAnalysis = analyzeStockBySpecs(item.id, item.storage || '', item.ram || ''); // Sin color
            
            // Mostrar informaci√≥n en el modal
            var stockInfo = editQuantityModal.querySelector('[data-stock-info]');
            var stockProduct = editQuantityModal.querySelector('[data-stock-product]');
            var stockSpecs = editQuantityModal.querySelector('[data-stock-specs]');
            var stockAvailability = editQuantityModal.querySelector('[data-stock-availability]');
            
            if (stockProduct) {
                stockProduct.textContent = item.product;
            }
            
            if (stockSpecs) {
                stockSpecs.textContent = item.specs || 'Sin especificaciones';
            }
            
            if (stockAvailability) {
                var availabilityText = '';
                var availabilityColor = '';
                
                if (stockAnalysis.availableStock > 5) {
                    availabilityText = '‚úÖ Stock disponible: ' + stockAnalysis.availableStock + ' unidades (Total en inventario: ' + stockAnalysis.totalInventoryStock + ')';
                    availabilityColor = '#28a745';
                } else if (stockAnalysis.availableStock > 0) {
                    availabilityText = '‚ö†Ô∏è Stock limitado: ' + stockAnalysis.availableStock + ' unidades (Total en inventario: ' + stockAnalysis.totalInventoryStock + ')';
                    availabilityColor = '#ffc107';
                } else {
                    availabilityText = '‚ùå Sin stock disponible (Total en inventario: ' + stockAnalysis.totalInventoryStock + ')';
                    availabilityColor = '#dc3545';
                }
                
                if (stockAnalysis.reservedInCart > 0) {
                    availabilityText += ' | Reservadas en carrito: ' + stockAnalysis.reservedInCart;
                }
                
                stockAvailability.innerHTML = availabilityText;
                stockAvailability.style.color = availabilityColor;
                stockAvailability.style.fontWeight = '600';
            }
            
            if (editQuantityInput) {
                editQuantityInput.value = item.quantity;
                editQuantityInput.focus();
            }
            
            console.log('üìä Informaci√≥n de stock en modal:', {
                product: item.product,
                specs: item.specs,
                stockAnalysis: stockAnalysis,
                currentQuantity: item.quantity
            });
            
            openModalElement(editQuantityModal);
        }

        function handleEditPrice() {
            if (!ensureCashOpen()) {
                return;
            }
            if (selectedItemIndex === null || !cartItems[selectedItemIndex]) {
                showToast('Selecciona un producto de la lista para editar el precio.', 'warning');
                return;
            }
            if (editPriceInput) {
                editPriceInput.value = cartItems[selectedItemIndex].price.toFixed(2);
                editPriceInput.focus();
            }
            openModalElement(editPriceModal);
        }

        function handleDeleteSelected() {
            if (!ensureCashOpen()) {
                return;
            }
            if (selectedItemIndex === null || !cartItems[selectedItemIndex]) {
                showToast('Selecciona un producto de la lista para eliminar.', 'warning');
                return;
            }
            cartItems.splice(selectedItemIndex, 1);
            if (cartItems.length === 0) {
                selectedItemIndex = null;
            } else if (selectedItemIndex >= cartItems.length) {
                selectedItemIndex = cartItems.length - 1;
            }
            renderCart();
        }

        if (salesActionButtons.length) {
            salesActionButtons.forEach(function (button) {
                button.addEventListener('click', function () {
                    var action = button.dataset.salesAction;
                    if (action === 'add') {
                        handleAddToCart();
                    } else if (action === 'clear') {
                        handleClearCart();
                    } else if (action === 'edit') {
                        handleEditQuantity();
                    } else if (action === 'price') {
                        handleEditPrice();
                    } else if (action === 'delete') {
                        handleDeleteSelected();
                    }
                });
            });
        }

        if (salesItemsBody) {
            salesItemsBody.addEventListener('click', function (event) {
                var row = event.target.closest('tr[data-row-index]');
                if (!row) {
                    return;
                }
                var index = parseInt(row.getAttribute('data-row-index'), 10);
                if (Number.isNaN(index)) {
                    return;
                }
                selectedItemIndex = index;
                renderCart();
            });
        }

        invoiceCode = generateInvoiceCode();
        if (codeInput) {
            codeInput.value = '';
            codeInput.readOnly = false;
            codeInput.focus();
            
            // Handle barcode scanning
            codeInput.addEventListener('keydown', function(event) {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    handleBarcodeScan(codeInput.value.trim());
                }
            });
        }

        hydrateCashState();
        renderCart();
        setCashUiState();
        serializeCashState();

        if (openPaymentModalButton && paymentModal) {
            openPaymentModalButton.addEventListener('click', openPaymentModal);
        }

        if (closePaymentButtons.length) {
            closePaymentButtons.forEach(function (button) {
                button.addEventListener('click', function () {
                    closeModalElement(paymentModal);
                });
            });
        }

        if (confirmPaymentButton) {
            confirmPaymentButton.addEventListener('click', handleConfirmPayment);
        }

        if (tradeInApplyButton) {
            tradeInApplyButton.addEventListener('click', function () {
                applyTradeInCode();
            });
        }
        if (tradeInSearchButton) {
            tradeInSearchButton.addEventListener('click', function () {
                applyTradeInCode();
            });
        }

        if (closeDiscountButtons.length) {
            closeDiscountButtons.forEach(function (button) {
                button.addEventListener('click', function () {
                    closeModalElement(discountModal);
                });
            });
        }

        if (openDiscountButton) {
            openDiscountButton.addEventListener('click', function () {
                openDiscountModal();
            });
        }

        if (closeDiscountButtons.length) {
            closeDiscountButtons.forEach(function (button) {
                button.addEventListener('click', closeDiscountModal);
            });
        }

        // Event listeners para modal de cuotas
        if (closeCreditModalButtons.length) {
            closeCreditModalButtons.forEach(function (button) {
                button.addEventListener('click', closeCreditInstallmentsModal);
            });
        }

        if (confirmCreditConfigButton) {
            confirmCreditConfigButton.addEventListener('click', confirmCreditConfiguration);
        }

        if (creditInstallmentsSelect) {
            creditInstallmentsSelect.addEventListener('change', updateCreditCalculation);
        }

        if (creditFrequencySelect) {
            creditFrequencySelect.addEventListener('change', updateCreditCalculation);
        }

        if (creditInitialPaymentInput) {
            creditInitialPaymentInput.addEventListener('input', updateCreditCalculation);
        }

        if (applyDiscountButton) {
            applyDiscountButton.addEventListener('click', handleApplyDiscount);
        }

        discountTypeInputs.forEach(function (input) {
            input.addEventListener('change', refreshDiscountPreview);
        });

        if (discountValueInput) {
            discountValueInput.addEventListener('input', refreshDiscountPreview);
        }

        paymentInputs.forEach(function (input) {
            input.addEventListener('input', function () {
                updatePaymentSummary();
            });
        });

        Object.keys(paymentMethodRefs).forEach(function (key) {
            var ref = paymentMethodRefs[key];
            if (ref) {
                ref.addEventListener('change', updatePaymentSummary);
            }
        });

        if (creditSaleCheckbox) {
            creditSaleCheckbox.addEventListener('change', function() {
                if (this.checked) {
                    openCreditInstallmentsModal();
                } else {
                    creditConfig.enabled = false;
                    updatePaymentSummary();
                }
            });
        }

        closeInvoiceButtons.forEach(function (button) {
            button.addEventListener('click', closeInvoiceModal);
        });

        if (invoiceOptionsContainer) {
            invoiceOptionsContainer.addEventListener('click', function (event) {
                var optionButton = event.target.closest('[data-invoice-option]');
                if (!optionButton) {
                    return;
                }
                var option = optionButton.getAttribute('data-invoice-option');
                if (option === 'skip') {
                    showToast('Venta registrada sin generar documento.', 'info');
                } else if (option === 'a4') {
                    showToast('Generando factura A4...', 'info');
                } else if (option === 'ticket80') {
                    showToast('Generando ticket 80 mm...', 'info');
                } else if (option === 'ticket50') {
                    showToast('Generando ticket 50 mm...', 'info');
                }
                closeInvoiceModal();
            });
        }

        function handleCashOpen() {
            if (!cashOpenModal) {
                return;
            }
            if (cashOpenAmountInput) {
                cashOpenAmountInput.value = '';
            }
            updateCashOpenInfo();
            openModalElement(cashOpenModal);
            if (cashOpenAmountInput) {
                cashOpenAmountInput.focus();
            }
        }

        function confirmCashOpen() {
            var value = parseFloat(cashOpenAmountInput ? cashOpenAmountInput.value : '0');
            if (!Number.isFinite(value) || value < 0) {
                showToast('Ingresa un monto v√°lido para abrir la caja.', 'warning');
                if (cashOpenAmountInput) {
                    cashOpenAmountInput.focus();
                }
                return;
            }
            var payload = {
                monto_inicial: value,
            };
            fetch(cashEndpoints.open, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCsrfToken(),
                },
                body: JSON.stringify(payload),
            })
                .then(function (response) {
                    if (!response.ok) {
                        return response.json().then(function (data) {
                            throw new Error(data.error || 'No se pudo abrir la caja.');
                        });
                    }
                    return response.json();
                })
                .then(function (data) {
                    cashState.isOpen = true;
                    cashState.openingAmount = value;
                    resetCashTotals();
                    serializeCashState();
                    setCashUiState();
                    if (data && data.open_session) {
                        renderCashReportRow(parseCashSession(data.open_session));
                    }
                    updateCashStatusFromServer();
                    closeModalElement(cashOpenModal);
                    showToast('Caja abierta correctamente.', 'success');
                })
                .catch(function (error) {
                    showToast(error.message || 'No se pudo abrir la caja.', 'error');
                });
        }

        function closeCashOpenModal() {
            closeModalElement(cashOpenModal);
        }

        function openCashCloseModal() {
            if (!ensureCashOpen()) {
                return;
            }
            populateCashCloseSummary();
            openModalElement(cashCloseModal);
        }

        function finalizeCashClose() {
            fetch(cashEndpoints.close, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCsrfToken(),
                },
            })
                .then(function (response) {
                    if (!response.ok) {
                        return response.json().then(function (data) {
                            throw new Error(data.error || 'No se pudo cerrar la caja.');
                        });
                    }
                    return response.json();
                })
                .then(function (data) {
                    var parsedClosedSession = data && data.closed_session ? parseCashSession(data.closed_session) : null;
                    cashState.isOpen = false;
                    cashState.openingAmount = 0;
                    resetCashTotals();
                    if (parsedClosedSession) {
                        cashState.lastCloseAmount = typeof parsedClosedSession.totalEnCajaValor === 'number'
                            ? parsedClosedSession.totalEnCajaValor
                            : null;
                        cashState.lastCloseSales = typeof parsedClosedSession.totalVentasValor === 'number'
                            ? parsedClosedSession.totalVentasValor
                            : null;
                        cashState.lastCloseProfit = typeof parsedClosedSession.totalGananciaValor === 'number'
                            ? parsedClosedSession.totalGananciaValor
                            : null;
                        if (parsedClosedSession.cierreISO) {
                            var cierreDate = new Date(parsedClosedSession.cierreISO);
                            cashState.lastCloseTimestamp = Number.isNaN(cierreDate.getTime()) ? null : cierreDate;
                        } else {
                            cashState.lastCloseTimestamp = null;
                        }
                    } else {
                        cashState.lastCloseAmount = null;
                        cashState.lastCloseTimestamp = null;
                        cashState.lastCloseSales = null;
                        cashState.lastCloseProfit = null;
                    }
                    serializeCashState();
                    setCashUiState();
                    if (parsedClosedSession) {
                        renderCashReportRow(parsedClosedSession);
                    }
                    updateCashStatusFromServer();
                    closeModalElement(cashCloseModal);
                    closeModalElement(cashCloseConfirmModal);
                    showToast('Caja cerrada correctamente.', 'success');
                })
                .catch(function (error) {
                    showToast(error.message || 'No se pudo cerrar la caja.', 'error');
                });
        }

        function exportCashClose() {
            showToast('Funci√≥n de exportaci√≥n a√∫n no est√° disponible.', 'info');
        }

        if (openCashOpenButton) {
            openCashOpenButton.addEventListener('click', function () {
                if (cashState.isOpen) {
                    showToast('La caja ya est√° abierta.', 'info');
                    return;
                }
                handleCashOpen();
            });
        }

        if (openCashCloseButton) {
            openCashCloseButton.addEventListener('click', function () {
                if (!cashState.isOpen) {
                    showToast('La caja no est√° abierta.', 'warning');
                    return;
                }
                openCashCloseModal();
            });
        }

        closeCashOpenButtons.forEach(function (button) {
            button.addEventListener('click', closeCashOpenModal);
        });

        if (confirmCashOpenButton) {
            confirmCashOpenButton.addEventListener('click', confirmCashOpen);
        }

        closeCashCloseButtons.forEach(function (button) {
            button.addEventListener('click', function () {
                closeModalElement(cashCloseModal);
            });
        });

        if (finalizeCashCloseButton) {
            finalizeCashCloseButton.addEventListener('click', function () {
                if (!cashCloseConfirmModal) {
                    finalizeCashClose();
                    return;
                }
                closeModalElement(cashCloseModal);
                openModalElement(cashCloseConfirmModal);
            });
        }

        closeCashCloseConfirmButtons.forEach(function (button) {
            button.addEventListener('click', function () {
                closeModalElement(cashCloseConfirmModal);
                openModalElement(cashCloseModal);
            });
        });

        if (confirmCashCloseButton) {
            confirmCashCloseButton.addEventListener('click', finalizeCashClose);
        }

        if (exportCashCloseButton) {
            exportCashCloseButton.addEventListener('click', exportCashClose);
        }

        updateCashStatusFromServer();

        function handleQuantitySave() {
            if (!editQuantityInput || selectedItemIndex === null || !cartItems[selectedItemIndex]) {
                return;
            }
            var newQuantity = parseInt(editQuantityInput.value, 10);
            if (!newQuantity || newQuantity <= 0) {
                showToast('Ingresa una cantidad v√°lida.', 'warning');
                editQuantityInput.focus();
                return;
            }
            
            // Validar stock disponible recorriendo todo el inventario
            var item = cartItems[selectedItemIndex];
            var stockAnalysis = analyzeStockBySpecs(item.id, item.storage || '', item.ram || ''); // Sin color
            
            console.log('üìä An√°lisis completo de stock:', stockAnalysis);
            
            if (newQuantity > stockAnalysis.availableStock) {
                var displayName = item.specs ? item.product + ' (' + item.specs + ')' : item.product;
                showToast('Stock insuficiente. Solo hay ' + stockAnalysis.availableStock + 
                         ' unidades disponibles de ' + displayName + 
                         ' (Total en inventario: ' + stockAnalysis.totalInventoryStock + ')', 'error');
                editQuantityInput.focus();
                return;
            }
            
            // Actualizar cantidad y marcar unidades para actualizaci√≥n de inventario
            var oldQuantity = item.quantity;
            item.quantity = newQuantity;
            
            // Marcar unidades para actualizaci√≥n en inventario al vender
            item.unitsToUpdate = markUnitsForUpdate(item, newQuantity, stockAnalysis);
            
            console.log('üîÑ Unidades marcadas para actualizaci√≥n:', item.unitsToUpdate);
            
            closeModalElement(editQuantityModal);
            renderCart();
            showToast('Cantidad actualizada. ' + (newQuantity > oldQuantity ? 
                     'Se reservar√°n ' + (newQuantity - oldQuantity) + ' unidades adicionales.' : 
                     'Se liberar√°n ' + (oldQuantity - newQuantity) + ' unidades.'), 'success');
        }

        // Funci√≥n para analizar stock completo por especificaciones (color no afecta agrupaci√≥n)
        function analyzeStockBySpecs(productId, storage, ram) {
            var productSelect = productSelector;
            var analysis = {
                totalInventoryStock: 0,
                availableStock: 0,
                reservedInCart: 0,
                matchingUnits: [],
                allUnits: []
            };
            
            console.log('üîç Analizando stock completo para:', {
                productId: productId,
                storage: storage,
                ram: ram,
                productSelectorExists: !!productSelector
            });
            
            if (productSelect) {
                var options = productSelect.querySelectorAll('option[data-product-id="' + productId + '"]');
                console.log('üì¶ Opciones encontradas para producto ' + productId + ':', options.length);
                
                options.forEach(function(option, index) {
                    var optionColor = option.dataset.color || '';
                    var optionStorage = option.dataset.almacenamiento || '';
                    var optionRam = option.dataset.ram || '';
                    var stock = parseInt(option.getAttribute('data-stock') || '0', 10);
                    var unitIndex = option.dataset.unitIndex || '';
                    var optionText = option.textContent;
                    
                    console.log('üìã Analizando opci√≥n ' + index + ':', {
                        text: optionText,
                        unitIndex: unitIndex,
                        optionStorage: optionStorage,
                        optionRam: optionRam,
                        stock: stock,
                        searchStorage: storage,
                        searchRam: ram,
                        storageMatches: compareStorage(optionStorage, storage),
                        ramMatches: compareRam(optionRam, ram),
                        willMatch: compareStorage(optionStorage, storage) && compareRam(optionRam, ram)
                    });
                    
                    var unitInfo = {
                        index: index,
                        unitIndex: unitIndex,
                        color: optionColor,
                        storage: optionStorage,
                        ram: optionRam,
                        stock: stock,
                        text: optionText,
                        matches: compareStorage(optionStorage, storage) && compareRam(optionRam, ram) // Color no afecta
                    };
                    
                    analysis.allUnits.push(unitInfo);
                    analysis.totalInventoryStock += stock;
                    
                    if (unitInfo.matches) {
                        analysis.matchingUnits.push(unitInfo);
                        analysis.availableStock += stock;
                        console.log('‚úÖ Unidad agregada al stock disponible:', unitInfo);
                    }
                });
                
                console.log('üìä Resumen del an√°lisis:', {
                    totalUnits: analysis.allUnits.length,
                    matchingUnits: analysis.matchingUnits.length,
                    totalInventoryStock: analysis.totalInventoryStock,
                    availableStock: analysis.availableStock
                });
                
                // Calcular unidades reservadas en carrito (solo por storage y ram)
                analysis.reservedInCart = calculateReservedInCart(productId, storage, ram);
                analysis.availableStock -= analysis.reservedInCart;
                
                console.log('üõí Carrito reservado:', analysis.reservedInCart);
                console.log('üéØ Stock final disponible:', analysis.availableStock);
            } else {
                console.log('‚ùå productSelect es NULL o undefined');
            }
            
            console.log('üìà Resultado del an√°lisis:', analysis);
            return analysis;
        }

        // Funci√≥n para calcular unidades reservadas en carrito (color no afecta agrupaci√≥n)
        function calculateReservedInCart(productId, storage, ram) {
            var reserved = 0;
            var productKey = 'product_' + productId + '_' + storage + '_' + ram; // Sin color
            
            cartItems.forEach(function(item) {
                if (item.productKey === productKey) {
                    reserved += item.quantity;
                }
            });
            
            return reserved;
        }

        // Funci√≥n para marcar unidades para actualizaci√≥n en inventario
        function markUnitsForUpdate(item, newQuantity, stockAnalysis) {
            var unitsToUpdate = {
                toReserve: [],
                toRelease: [],
                totalChange: newQuantity - item.quantity
            };
            
            if (unitsToUpdate.totalChange > 0) {
                // Necesita reservar m√°s unidades
                var neededUnits = unitsToUpdate.totalChange;
                var availableUnits = stockAnalysis.matchingUnits.filter(function(unit) {
                    return unit.stock > 0;
                });
                
                for (var i = 0; i < availableUnits.length && neededUnits > 0; i++) {
                    var unit = availableUnits[i];
                    var reserveQuantity = Math.min(unit.stock, neededUnits);
                    
                    unitsToUpdate.toReserve.push({
                        unitIndex: unit.unitIndex,
                        storage: unit.storage,
                        ram: unit.ram,
                        quantity: reserveQuantity,
                        action: 'reserve'
                    });
                    
                    neededUnits -= reserveQuantity;
                }
            } else if (unitsToUpdate.totalChange < 0) {
                // Necesita liberar unidades
                var releaseQuantity = Math.abs(unitsToUpdate.totalChange);
                
                unitsToUpdate.toRelease.push({
                    productId: item.id,
                    storage: item.storage,
                    ram: item.ram,
                    quantity: releaseQuantity,
                    action: 'release'
                });
            }
            
            return unitsToUpdate;
        }

        function handlePriceSave() {
            if (!editPriceInput || selectedItemIndex === null || !cartItems[selectedItemIndex]) {
                return;
            }
            var newPrice = parseFloat(editPriceInput.value);
            if (!Number.isFinite(newPrice) || newPrice < 0) {
                showToast('Ingresa un precio v√°lido.', 'warning');
                editPriceInput.focus();
                return;
            }
            cartItems[selectedItemIndex].price = newPrice;
            closeModalElement(editPriceModal);
            renderCart();
        }

        function handleBarcodeScan(codigo) {
            if (!codigo) {
                return;
            }
            
            if (!ensureCashOpen()) {
                return;
            }
            
            // Show loading state
            if (codeInput) {
                codeInput.disabled = true;
                codeInput.placeholder = 'Buscando...';
            }
            
            // Call scan API
            fetch('{% url "dashboard:scan_unit_barcode_api" %}?codigo=' + encodeURIComponent(codigo))
                .then(function(response) {
                    return response.json();
                })
                .then(function(data) {
                    if (data.success && data.unit) {
                        // Check if client is selected
                        if (!clientSelect || !clientSelect.value) {
                            showToast('Selecciona un cliente antes de escanear productos.', 'warning');
                            return;
                        }
                        
                        // Check if unit is already in cart
                        var existingItem = cartItems.find(function(item) {
                            return item.id === data.unit.key;
                        });
                        
                        if (existingItem) {
                            showToast('Esta unidad ya est√° en el carrito.', 'warning');
                            return;
                        }
                        
                        // Add to cart automatically
                        var clientOption = clientSelect.options[clientSelect.selectedIndex];
                        
                        cartItems.push({
                            id: data.unit.key,
                            client: clientOption ? clientOption.text : '-',
                            product: data.unit.etiqueta,
                            price: parseFloat(data.unit.precio || '0'),
                            quantity: 1,
                            impuestoPorcentaje: parseFloat(data.unit.impuesto_porcentaje || '0'),
                            impuestoActivo: data.unit.impuesto_activo,
                            usarImpuestoGlobal: data.unit.usar_impuesto_global,
                            impuestoId: data.unit.impuesto_id || '',
                            impuestoLabel: data.unit.impuesto_label || 'Impuesto global',
                            unitIndex: data.unit.unidad_index,
                            batteryLife: data.unit.vida_bateria || '',
                        });
                        
                        selectedItemIndex = cartItems.length - 1;
                        renderCart();
                        
                        showToast('Producto agregado: ' + data.unit.etiqueta, 'success');
                        
                    } else {
                        showToast(data.error || 'C√≥digo no encontrado', 'error');
                    }
                })
                .catch(function(error) {
                    console.error('Error scanning barcode:', error);
                    showToast('Error al procesar el c√≥digo escaneado', 'error');
                })
                .finally(function() {
                    // Reset input state
                    if (codeInput) {
                        codeInput.disabled = false;
                        codeInput.placeholder = 'Escanea c√≥digo de barras aqu√≠';
                        codeInput.value = '';
                        codeInput.focus();
                    }
                });
        }

        function handlePaymentTrigger() {
            if (!ensureCashOpen()) {
                return;
            }
            if (cartItems.length === 0) {
                showToast('Agrega productos al carrito antes de realizar el pago.', 'warning');
                return;
            }
            if (!clientSelect || !clientSelect.value) {
                showToast('Selecciona un cliente antes de realizar el pago.', 'warning');
                return;
            }

            if (fiscalEmitCheckbox && fiscalEmitCheckbox.checked) {
                paymentState.fiscalEnabled = true;
                if (!paymentState.fiscalConfig) {
                    fetchFiscalConfig().then(function () {
                        updateFiscalPreview();
                        openModalElement(paymentModal);
                    });
                    return;
                }
            } else {
                paymentState.fiscalEnabled = false;
                updateFiscalPreview();
            }

            if (!creditSaleCheckbox || !creditSaleCheckbox.checked) {
                Object.keys(paymentMethodRefs || {}).forEach(function (key) {
                    if (paymentMethodRefs[key]) {
                        paymentMethodRefs[key].checked = key === 'cash';
                    }
                });
            }

            updatePaymentSummary();
            openModalElement(paymentModal);
        }

        function handleConfirmPayment() {
            if (!creditSaleCheckbox) {
                closeModalElement(paymentModal);
                return;
            }
            if (isSubmittingSale) {
                return;
            }

            var isCreditSaleChecked = creditSaleCheckbox.checked;
            var selectedMethods = getSelectedPaymentMethods();
            var hasContadoMethod = selectedMethods.length > 0;
            var changeEligible = !isCreditSaleChecked && selectedMethods.length === 1 && selectedMethods[0] === 'cash';
            var tradeInAmount = paymentState.tradeIn && typeof paymentState.tradeIn.amount === 'number'
                ? roundMoney(paymentState.tradeIn.amount)
                : 0;
            var paymentDue = roundMoney(Math.max(paymentState.total - (paymentState.discountAmount + tradeInAmount), 0));
            var paymentReceived = roundMoney(getPaymentReceivedTotal());

            if (!isCreditSaleChecked && !hasContadoMethod) {
                showToast('Selecciona al menos un medio de pago contado o marca "Venta a cr√©dito".', 'warning');
                return;
            }

            if (isCreditSaleChecked && hasContadoMethod) {
                showToast('Para registrar una venta a cr√©dito, no selecciones medios de pago contado.', 'warning');
                return;
            }

            if (!isCreditSaleChecked) {
                if (paymentReceived + 0.009 < paymentDue) {
                    showToast('La cantidad pagada no es suficiente.', 'warning');
                    return;
                }
                if (!changeEligible && paymentReceived - paymentDue > 0.01) {
                    showToast('La cantidad pagada excede el total a pagar.', 'warning');
                    return;
                }
            }

            if (!saleSubmitEndpoint) {
                showToast('No se encontr√≥ el endpoint para registrar la venta.', 'error');
                return;
            }

            var metodoPago = resolveMetodoPago(selectedMethods, isCreditSaleChecked);
            var payload = buildSalePayload({
                metodoPago: metodoPago,
                esCredito: isCreditSaleChecked,
                pagoRecibido: paymentReceived,
            });

            if (!payload.cliente_id) {
                showToast('Selecciona un cliente antes de confirmar el pago.', 'warning');
                return;
            }

            if (!payload.productos.length) {
                showToast('Agrega productos al carrito antes de confirmar el pago.', 'warning');
                return;
            }

            var cashSnapshot = {
                sales: isCreditSaleChecked ? 0 : paymentDue,
                creditSales: isCreditSaleChecked ? paymentDue : 0,
                creditPayments: isCreditSaleChecked ? paymentReceived : 0,
                discounts: roundMoney(paymentState.discountAmount + tradeInAmount),
                taxes: roundMoney(paymentState.tax),
                payment: {
                    cash: 0,
                    cashCredit: 0,
                    cardDebit: 0,
                    cardCredit: 0,
                    transfer: 0,
                    credit: 0,
                    mixed: 0,
                },
            };

            var changeAmount = changeEligible ? roundMoney(paymentReceived - paymentDue) : 0;
            if (changeAmount < 0) {
                changeAmount = 0;
            }
            var netCollected = roundMoney(paymentReceived - changeAmount);

            if (isCreditSaleChecked) {
                if (paymentReceived > 0) {
                    cashSnapshot.payment.cashCredit = netCollected;
                }
            } else {
                if (metodoPago === VentaMetodoPago.EFECTIVO) {
                    cashSnapshot.payment.cash = netCollected;
                } else if (metodoPago === VentaMetodoPago.TRANSFERENCIA) {
                    cashSnapshot.payment.transfer = netCollected;
                } else if (metodoPago === VentaMetodoPago.TARJETA) {
                    if (selectedMethods.indexOf('debit') !== -1 && selectedMethods.indexOf('credit') === -1) {
                        cashSnapshot.payment.cardDebit = netCollected;
                    } else if (selectedMethods.indexOf('credit') !== -1 && selectedMethods.indexOf('debit') === -1) {
                        cashSnapshot.payment.cardCredit = netCollected;
                    } else {
                        cashSnapshot.payment.mixed = netCollected;
                    }
                } else if (metodoPago === VentaMetodoPago.MIXTO) {
                    cashSnapshot.payment.mixed = netCollected;
                }
            }

            isSubmittingSale = true;
            syncConfirmPaymentButton(true);

            var saleItemsSnapshot = cartItems.map(function (item) {
                return {
                    id: item.id,
                    quantity: item.quantity,
                    unitIndex: item.unitIndex,
                };
            });

            submitSale(payload)
                .then(function (responseData) {
                    var saleSummary = {
                        id: responseData && responseData.id ? responseData.id : null,
                        factura: responseData && responseData.factura ? responseData.factura : null,
                        total: paymentDue,
                        paymentReceived: paymentReceived,
                        change: changeAmount,
                    };
                    applyCashTotals(cashSnapshot);
                    serializeCashState();
                    closeModalElement(paymentModal);
                    applySaleStockAdjustments(saleItemsSnapshot);
                    resetSaleForm();
                    var successMessage = 'Venta registrada correctamente. Total: ' + formatCurrency(paymentDue) + ', pago: ' + formatCurrency(paymentReceived);
                    if (changeAmount > 0) {
                        successMessage += ', vuelto: ' + formatCurrency(changeAmount);
                    }
                    showToast(successMessage, 'success');
                    refreshSalesHistory();
                    openInvoiceModalWithSale(saleSummary);
                })
                .catch(function (error) {
                    console.error(error);
                    showToast(error.message || 'No fue posible registrar la venta.', 'error');
                })
                .finally(function () {
                    isSubmittingSale = false;
                    syncConfirmPaymentButton(false);
                });
        }

        function getSelectedDiscountType() {
            var selected = null;
            discountTypeInputs.forEach(function (input) {
                if (input.checked) {
                    selected = input.value;
                }
            });
            return selected;
        }

        function setSelectedDiscountType(type) {
            var hasMatch = false;
            discountTypeInputs.forEach(function (input, index) {
                var shouldCheck = type ? input.value === type : index === 0;
                input.checked = shouldCheck;
                if (shouldCheck) {
                    hasMatch = true;
                }
            });
            if (!hasMatch && discountTypeInputs.length) {
                discountTypeInputs[0].checked = true;
            }
        }

        function parseCurrencyNumber(value) {
            if (typeof value !== 'string') {
                return Number(value) || 0;
            }
            var normalized = value.replace(/[\sRD$]/gi, '').replace(/,/g, '');
            var parsed = Number(normalized);
            return Number.isFinite(parsed) ? parsed : 0;
        }

        function refreshDiscountPreview() {
            if (!discountValueInput) {
                return;
            }
            var type = getSelectedDiscountType();
            var value = parseCurrencyNumber(discountValueInput.value);
            if (!Number.isFinite(value) || value < 0) {
                value = 0;
            }
            var previewDiscount = computeDiscountAmount(paymentState.total, type, value);
            var previewFinal = Math.max(paymentState.total - previewDiscount, 0);
            if (discountCurrentTotal) {
                discountCurrentTotal.textContent = formatCurrency(paymentState.total);
            }
            if (discountFinalTotal) {
                discountFinalTotal.textContent = formatCurrency(previewFinal);
            }
        }

        function openDiscountModal() {
            if (!discountModal) {
                return;
            }
            var typeToUse = paymentState.discountType || 'fixed';
            setSelectedDiscountType(typeToUse);
            if (discountValueInput) {
                discountValueInput.value = paymentState.discountValue ? paymentState.discountValue : '';
            }
            refreshDiscountPreview();
            openModalElement(discountModal);
        }

        function closeDiscountModal() {
            if (!discountModal) {
                return;
            }
            closeModalElement(discountModal);
        }

        function handleApplyDiscount() {
            if (!discountModal) {
                return;
            }
            var type = getSelectedDiscountType();
            if (!type) {
                showToast('Selecciona un tipo de descuento.', 'warning');
                return;
            }
            var rawValue = discountValueInput ? discountValueInput.value : '';
            var value = parseFloat(rawValue);
            if (rawValue === '' || (!Number.isFinite(value)) || value <= 0) {
                paymentState.discountType = null;
                paymentState.discountValue = 0;
                paymentState.discountAmount = 0;
                updatePaymentSummary();
                closeDiscountModal();
                return;
            }
            if (type === 'percent' && value > 100) {
                showToast('El porcentaje no puede exceder el 100%.', 'warning');
                return;
            }

            paymentState.discountType = type;
            paymentState.discountValue = value;
            paymentState.discountAmount = computeDiscountAmount(paymentState.total, type, value);
            updatePaymentSummary();
            closeDiscountModal();
        }

        function updateStock() {
            if (!productSelector || !stockOutput) {
                return;
            }
            var option = productSelector.options[productSelector.selectedIndex];
            var stock = option ? option.getAttribute('data-stock') : null;
            stockOutput.textContent = stock ? stock : "--";
        }

        function setProductStockData(productId, newStock) {
            newStock = Math.max(parseInt(newStock, 10) || 0, 0);

            if (productSelector) {
                var option = productSelector.querySelector('option[value="' + productId + '"]');
                if (option) {
                    option.setAttribute('data-stock', String(newStock));
                    option.disabled = newStock <= 0;
                    if (option.disabled && productSelector.value === productId) {
                        productSelector.value = '';
                    }
                }
            }

            if (productResultsContainer) {
                var stockBadges = productResultsContainer.querySelectorAll('[data-product-id="' + productId + '"] .product-results__stock');
                stockBadges.forEach(function (badge) {
                    badge.textContent = 'Existencias: ' + newStock;
                });

                var unitRows = productResultsContainer.querySelectorAll('.product-results__unit[data-product-id="' + productId + '"]');
                unitRows.forEach(function (row) {
                    row.dataset.stock = String(newStock);
                });
            }
        }

        function applySaleStockAdjustments(items) {
            if (!Array.isArray(items) || !items.length) {
                return;
            }
            items.forEach(function (item) {
                var productId = item && item.id ? String(item.id) : null;
                var quantity = item && item.quantity ? parseInt(item.quantity, 10) : 0;
                var unitIndex = item && item.unitIndex ? parseInt(item.unitIndex, 10) : null;
                if (!productId || !Number.isFinite(quantity) || quantity <= 0) {
                    return;
                }
                var option = productSelector ? productSelector.querySelector('option[value="' + productId + '"]') : null;
                var currentStock = option ? parseInt(option.getAttribute('data-stock') || '0', 10) : 0;
                var newStock = Math.max(currentStock - quantity, 0);
                setProductStockData(productId, newStock);
            });
            updateStock();
        }

        if (productSelector) {
            productSelector.addEventListener('change', updateStock);
            updateStock();
        }

        function openClientModal() {
            if (!clientModal) {
                return;
            }
            clientModal.classList.add('is-visible');
            clientModal.setAttribute('aria-hidden', 'false');
            if (clientSearchInput) {
                clientSearchInput.value = '';
                clientSearchInput.focus();
            }
            filterClientList('');
        }

        function closeClientModal() {
            if (!clientModal) {
                return;
            }
            clientModal.classList.remove('is-visible');
            clientModal.setAttribute('aria-hidden', 'true');
            if (openClientModalButton) {
                openClientModalButton.focus();
            }
        }

        function filterClientList(query) {
            if (!clientList) {
                return;
            }
            var items = clientList.querySelectorAll('[data-client-item]');
            query = query.toLowerCase();
            items.forEach(function (item) {
                var name = item.dataset.name ? item.dataset.name.toLowerCase() : '';
                var codeEl = item.querySelector('.client-list__code');
                var code = codeEl ? codeEl.textContent.toLowerCase() : '';
                var matches = name.includes(query) || code.includes(query);
                item.style.display = matches ? '' : 'none';
            });
        }

        function renderProductSearchPlaceholder(message, type) {
            if (!productResultsContainer) {
                return;
            }
            var className = type === 'status' ? 'product-search__status' : 'product-search__placeholder';
            productResultsContainer.innerHTML = '<div class="' + className + '">' + message + '</div>';
        }

        function escapeHtml(value) {
            return String(value || '').replace(/[&<>"]{1}/g, function (match) {
                var map = {
                    '&': '&amp;',
                    '<': '&lt;',
                    '>': '&gt;',
                    '"': '&quot;',
                };
                return map[match] || match;
            });
        }

        function renderProductSearchResults(products) {
            if (!productResultsContainer) {
                return;
            }
            if (!Array.isArray(products) || !products.length) {
                renderProductSearchPlaceholder('No se encontraron productos con ese t√≠tulo.', 'status');
                return;
            }

            var list = document.createElement('ul');
            list.className = 'product-results__list';

            products.forEach(function (product) {
                var item = document.createElement('li');
                item.className = 'product-results__item';

                var header = document.createElement('div');
                header.className = 'product-results__header';

                var thumb = document.createElement('div');
                thumb.className = 'product-results__thumb';
                if (product.imagen) {
                    var img = document.createElement('img');
                    img.src = product.imagen;
                    img.alt = 'Imagen de ' + escapeHtml(product.nombre);
                    thumb.appendChild(img);
                } else {
                    thumb.textContent = 'üì±';
                }
                header.appendChild(thumb);

                var summary = document.createElement('div');

                var title = document.createElement('h3');
                title.className = 'product-results__title';
                title.textContent = product.nombre || 'Producto';
                summary.appendChild(title);

                var meta = document.createElement('div');
                meta.className = 'product-results__meta';
                if (product.marca) {
                    meta.appendChild(document.createTextNode('Marca: ' + product.marca));
                }
                if (product.modelo) {
                    meta.appendChild(document.createTextNode('Modelo: ' + product.modelo));
                }
                summary.appendChild(meta);

                header.appendChild(summary);

                var stockBadge = document.createElement('span');
                stockBadge.className = 'product-results__stock';
                stockBadge.textContent = 'Existencias: ' + String(product.stock || 0);
                summary.appendChild(stockBadge);

                item.appendChild(header);

                var unitsContainer = document.createElement('div');
                unitsContainer.className = 'product-results__units';

                if (Array.isArray(product.unidades) && product.unidades.length) {
                    product.unidades.forEach(function (unit) {
                        var unitRow = document.createElement('div');
                        unitRow.className = 'product-results__unit';
                        unitRow.dataset.productId = String(product.id || '');
                        unitRow.dataset.unitIndex = String(unit.index || '');
                        unitRow.dataset.imei = unit.imei || '';
                        unitRow.dataset.color = unit.color || '';
                        unitRow.dataset.storageLabel = unit.almacenamiento || '';
                        unitRow.dataset.ramLabel = unit.memoria_ram || '';
                        unitRow.dataset.productName = product.nombre || '';
                        unitRow.dataset.price = product.precio_venta || '';
                        unitRow.dataset.stock = String(product.stock || '');
                        unitRow.dataset.tax = unit.impuesto_porcentaje || product.impuesto_porcentaje || '0';
                        unitRow.dataset.taxActive = (unit.impuesto_activo ? 'true' : (product.impuesto_activo ? 'true' : 'false'));
                        unitRow.dataset.useGlobal = unit.usar_impuesto_global ? 'true' : 'false';
                        unitRow.dataset.taxId = unit.impuesto_id || '';
                        unitRow.dataset.taxLabel = unit.impuesto_label || 'Impuesto global';

                        function addField(label, value) {
                            var wrapper = document.createElement('div');
                            var labelEl = document.createElement('span');
                            labelEl.className = 'product-results__unit-label';
                            labelEl.textContent = label;
                            var valueEl = document.createElement('span');
                            valueEl.className = 'product-results__unit-value';
                            valueEl.textContent = value || '‚Äî';
                            wrapper.appendChild(labelEl);
                            wrapper.appendChild(valueEl);
                            unitRow.appendChild(wrapper);
                        }

                        addField('Unidad', 'Unidad ' + (unit.index || '‚Äî'));
                        addField('Color', unit.color || 'Sin color');
                        addField('IMEI', unit.imei || 'Sin IMEI');
                        addField('Almacenamiento', unit.almacenamiento || 'No especificado');
                        addField('RAM', unit.memoria_ram || 'No especificada');
                        addField('Vida bater√≠a', unit.vida_bateria ? unit.vida_bateria + '%' : 'Sin dato');
                        addField('Impuesto', unit.impuesto_label || 'Impuesto global');

                        var actions = document.createElement('div');
                        actions.className = 'product-results__unit-actions';
                        var selectUnitButton = document.createElement('button');
                        selectUnitButton.type = 'button';
                        selectUnitButton.className = 'btn btn-secondary btn-sm';
                        selectUnitButton.textContent = 'Seleccionar';
                        selectUnitButton.addEventListener('click', function (event) {
                            event.stopPropagation();
                            handleProductUnitClick(unitRow);
                        });
                        actions.appendChild(selectUnitButton);
                        unitRow.appendChild(actions);

                        unitRow.addEventListener('click', function () {
                            handleProductUnitClick(unitRow);
                        });
                        unitsContainer.appendChild(unitRow);
                    });
                } else {
                    var emptyUnits = document.createElement('div');
                    emptyUnits.className = 'product-results__empty-state';
                    emptyUnits.textContent = 'No hay unidades detalladas registradas.';
                    unitsContainer.appendChild(emptyUnits);
                }

                item.appendChild(unitsContainer);
                list.appendChild(item);
            });

            productResultsContainer.innerHTML = '';
            productResultsContainer.appendChild(list);
        }

        function handleProductUnitClick(target) {
            var unitRow = target && target.currentTarget ? target.currentTarget : target;
            if (!unitRow || !productSelector) {
                return;
            }

            var productId = unitRow.dataset.productId || '';
            var unitIndex = unitRow.dataset.unitIndex || '';
            if (!productId || !unitIndex) {
                showToast('No se pudo identificar la unidad seleccionada.', 'warning');
                return;
            }

            var productName = unitRow.dataset.productName || 'Producto';
            var storage = unitRow.dataset.storageLabel || '';
            var ram = unitRow.dataset.ramLabel || '';
            
            // Crear clave de agrupaci√≥n espec√≠fica: producto + almacenamiento + RAM (color no afecta agrupaci√≥n)
            var color = unitRow.dataset.color || '';
            var storageLabel = storage ? storage + 'GB' : '';
            var ramLabel = ram ? ram + 'GB' : '';
            var specs = [storageLabel, ramLabel].filter(Boolean).join(' / ');
            var productKey = 'product_' + productId + '_' + storage + '_' + ram; // Clave √∫nica por specs (sin color)
            
            // Verificar stock disponible para estas especificaciones
            var availableStock = getAvailableStockBySpecs(productId, storage, ram, productSelector);
            var currentQuantityInCart = getCurrentQuantityBySpecs(productId, storage, ram); // Sin color
            
            // Depuraci√≥n - mostrar informaci√≥n de stock
            console.log('üîç Validaci√≥n de stock detallada:', {
                productId: productId,
                storage: storage,
                ram: ram,
                productName: productName,
                availableStock: availableStock,
                currentQuantityInCart: currentQuantityInCart,
                canAdd: currentQuantityInCart < availableStock,
                productSelector: productSelector ? 'exists' : 'NULL',
                totalOptions: productSelector ? productSelector.querySelectorAll('option').length : 0
            });
            
            // Depuraci√≥n adicional - mostrar todas las opciones del producto
            if (productSelector) {
                var allOptions = productSelector.querySelectorAll('option[data-product-id="' + productId + '"]');
                console.log('üìã Todas las opciones para producto ' + productId + ':', allOptions.length);
                allOptions.forEach(function(opt, idx) {
                    console.log('  Opci√≥n ' + idx + ':', {
                        text: opt.textContent,
                        storage: opt.dataset.almacenamiento,
                        ram: opt.dataset.ram,
                        stock: opt.getAttribute('data-stock')
                    });
                });
            }
            
            if (currentQuantityInCart >= availableStock && availableStock > 0) {
                var displayName = specs ? productName + ' (' + specs + ')' : productName;
                showToast('No hay stock disponible. Solo hay ' + availableStock + ' unidades de ' + displayName, 'error');
                return;
            }
            
            // Verificar si ya existe este producto con las mismas especificaciones
            var existingItem = cartItems.find(function(item) {
                return item.productKey === productKey;
            });

            if (existingItem) {
                // Si ya existe, incrementar cantidad
                existingItem.quantity += 1;
                existingItem.unitIndexes.push(unitIndex); // Agregar esta unidad a las usadas
                var displayName = specs ? productName + ' (' + specs + ')' : productName;
                showToast('Se agreg√≥ otra unidad de ' + displayName + '. Total: ' + existingItem.quantity, 'success');
            } else {
                // Si no existe, agregar nuevo item agrupado
                var price = parseFloat(unitRow.dataset.price) || 0;
                var batteryLife = unitRow.dataset.batteryLife || '';
                var impuestoPorcentaje = parseFloat(unitRow.dataset.tax) || 0;
                var impuestoActivo = unitRow.dataset.taxActive === 'true';
                var usaGlobal = unitRow.dataset.useGlobal === 'true';
                var impuestoId = unitRow.dataset.taxId || '';
                var impuestoLabel = unitRow.dataset.taxLabel || 'Impuesto global';
                
                var newItem = {
                    productKey: productKey, // Clave de agrupaci√≥n por specs
                    id: productId,
                    product: productName,
                    specs: specs, // Guardar especificaciones para mostrar
                    quantity: 1,
                    price: price,
                    batteryLife: batteryLife,
                    impuestoPorcentaje: impuestoPorcentaje,
                    impuestoActivo: impuestoActivo,
                    usarImpuestoGlobal: usaGlobal,
                    impuestoId: impuestoId,
                    impuestoLabel: impuestoLabel,
                    client: '', // Se llenar√° cuando se seleccione cliente
                    unitIndexes: [unitIndex], // Guardar las unidades espec√≠ficas usadas
                    color: color, // Guardar para validaci√≥n de stock
                    storage: storage, // Guardar para validaci√≥n de stock
                    ram: ram // Guardar para validaci√≥n de stock
                };
                
                cartItems.push(newItem);
                var displayName = specs ? productName + ' (' + specs + ')' : productName;
                showToast('Se agreg√≥ ' + displayName + ' al carrito', 'success');
            }

            var optionSelector = 'option[data-product-id="' + productId + '"][data-unit-index="' + unitIndex + '"]';
            var option = productSelector.querySelector(optionSelector);
            var optionValue = productId + ':' + unitIndex;

            if (!option) {
                option = document.createElement('option');
                option.value = optionValue;
                option.textContent = productName + ' - Unidad ' + unitIndex;
                option.dataset.productId = productId;
                option.dataset.unitIndex = unitIndex;
                productSelector.appendChild(option);
            } else {
                option.value = optionValue;
            }

            option.setAttribute('data-impuesto-label', unitRow.dataset.taxLabel || 'Impuesto global');
            option.dataset.productId = productId;
            option.dataset.unitIndex = unitIndex;

            productSelector.value = optionValue;
            updateStock();
            if (quantityInput && (!quantityInput.value || Number(quantityInput.value) <= 0)) {
                quantityInput.value = '1';
            }
            closeProductModal();
        }

        function selectProductOption(product) {
            if (!productSelector || !product || !product.id) {
                return;
            }

            var productId = String(product.id);
            var option = productSelector.querySelector('option[data-product-id="' + productId + '"]');
            if (!option) {
                option = document.createElement('option');
                option.value = productId;
                option.textContent = product.nombre || 'Producto';
                option.dataset.productId = productId;
                productSelector.appendChild(option);
            }

            option.setAttribute('data-price', product.precio_venta || '');
            option.setAttribute('data-stock', String(product.stock || ''));
            option.setAttribute('data-impuesto', product.impuesto_porcentaje || '0');
            option.setAttribute('data-impuesto-activo', product.impuesto_activo ? 'true' : 'false');
            option.setAttribute('data-usa-global', 'true');
            option.setAttribute('data-impuesto-id', '');
            option.setAttribute('data-impuesto-label', 'Impuesto global');

            productSelector.value = productId;
            updateStock();
            if (quantityInput && (!quantityInput.value || Number(quantityInput.value) <= 0)) {
                quantityInput.value = '1';
            }
            closeProductModal();
        }

        function openProductModal() {
            if (!ensureCashOpen()) {
                return;
            }
            if (!productModal) {
                return;
            }
            productModal.classList.add('is-visible');
            productModal.setAttribute('aria-hidden', 'false');
            if (productSearchInput) {
                productSearchInput.value = '';
                productSearchInput.focus();
            }
            resetProductFilters();
            renderProductSearchPlaceholder('Escribe el nombre del producto para ver las unidades en existencia.');
        }

        function closeProductModal() {
            if (!productModal) {
                return;
            }
            productModal.classList.remove('is-visible');
            productModal.setAttribute('aria-hidden', 'true');
            if (openProductModalButton) {
                openProductModalButton.focus();
            }
        }

        function handleClientSelect(event) {
            var button = event.target.closest('[data-select-client]');
            if (!button) {
                return;
            }
            var item = button.closest('[data-client-item]');
            if (!item || !clientSelect) {
                return;
            }
            var clientId = item.dataset.id;
            var clientName = item.dataset.name;
            if (!clientId) {
                return;
            }
            var option = clientSelect.querySelector('option[value="' + clientId + '"]');
            if (!option) {
                option = document.createElement('option');
                option.value = clientId;
                option.textContent = clientName;
                clientSelect.appendChild(option);
            }
            clientSelect.value = clientId;
            closeClientModal();
        }

        if (openClientModalButton) {
            openClientModalButton.addEventListener('click', openClientModal);
        }

        if (openProductModalButton) {
            openProductModalButton.addEventListener('click', openProductModal);
        }

        function buildProductSearchParams(query) {
            var params = new URLSearchParams({ query: query });
            if (activeProductFilters.brand) {
                params.set('brand', activeProductFilters.brand);
            }
            if (activeProductFilters.model) {
                params.set('model', activeProductFilters.model);
            }
            if (activeProductFilters.color) {
                params.set('color', activeProductFilters.color);
            }
            if (activeProductFilters.storage) {
                params.set('storage', activeProductFilters.storage);
            }
            if (activeProductFilters.ram) {
                params.set('ram', activeProductFilters.ram);
            }
            if (activeProductFilters.priceMin) {
                params.set('price_min', activeProductFilters.priceMin);
            }
            if (activeProductFilters.priceMax) {
                params.set('price_max', activeProductFilters.priceMax);
            }
            return params;
        }

        function updateModelOptionsForBrand(brandId) {
            if (!productFilters) {
                return;
            }
            var modelSelect = productFilters.querySelector('[data-product-filter="model"]');
            if (!modelSelect) {
                return;
            }
            var originalValue = modelSelect.value;
            Array.from(modelSelect.options).forEach(function (option, index) {
                if (index === 0) {
                    return;
                }
                var optionBrandId = option.getAttribute('data-brand-id');
                var matches = !brandId || !optionBrandId || optionBrandId === brandId;
                option.hidden = !matches;
                if (!matches && option.value === originalValue) {
                    modelSelect.value = '';
                }
            });
        }

        function resetProductFilters() {
            activeProductFilters = {
                brand: '',
                model: '',
                color: '',
                storage: '',
                ram: '',
                priceMin: '',
                priceMax: '',
            };
            if (productFilterControls && productFilterControls.length) {
                productFilterControls.forEach(function (control) {
                    if (!control) {
                        return;
                    }
                    control.value = '';
                });
            }
            updateModelOptionsForBrand('');
        }

        function performProductSearch(query) {
            if (!productSearchEndpoint) {
                renderProductSearchPlaceholder('No se configur√≥ el endpoint de b√∫squeda.', 'status');
                return;
            }

            if (productSearchAbortController) {
                productSearchAbortController.abort();
            }
            productSearchAbortController = new AbortController();

            var params = buildProductSearchParams(query);
            var requestUrl = productSearchEndpoint + '?' + params.toString();

            renderProductSearchPlaceholder('Buscando productos...', 'status');

            fetch(requestUrl, {
                method: 'GET',
                headers: {
                    'Accept': 'application/json',
                },
                signal: productSearchAbortController.signal,
            })
                .then(function (response) {
                    if (!response.ok) {
                        throw new Error('No se pudieron cargar los productos.');
                    }
                    return response.json();
                })
                .then(function (data) {
                    if (!data || data.success === false) {
                        renderProductSearchPlaceholder(data && data.message ? data.message : 'No se pudieron cargar los productos.', 'status');
                        return;
                    }
                    renderProductSearchResults(data.results || []);
                })
                .catch(function (error) {
                    if (error.name === 'AbortError') {
                        return;
                    }
                    console.error(error);
                    renderProductSearchPlaceholder('Ocurri√≥ un error al buscar productos. Intenta nuevamente.', 'status');
                });
        }

        function handleProductSearchInput(event) {
            var value = event.target.value || '';
            var query = value.trim();

            if (!query) {
                renderProductSearchPlaceholder('Escribe el nombre del producto para ver las unidades en existencia.');
                return;
            }

            if (productSearchDebounceTimer) {
                clearTimeout(productSearchDebounceTimer);
            }

            productSearchDebounceTimer = setTimeout(function () {
                performProductSearch(query);
            }, 250);
        }

        function handleProductFilterChange(event) {
            var control = event.target;
            if (!control) {
                return;
            }
            var filterType = control.getAttribute('data-product-filter');
            if (!filterType) {
                return;
            }
            var value = (control.value || '').trim();

            if (filterType === 'price-min') {
                activeFilters.priceMin = value;
            } else if (filterType === 'price-max') {
                activeFilters.priceMax = value;
            } else {
                activeFilters[filterType.replace('-', '')] = value;
            }

            if (filterType === 'brand') {
                updateModelOptions(value);
                if (!value) {
                    activeFilters.model = '';
                    var modelSelect = productFilters ? productFilters.querySelector('[data-product-filter="model"]') : null;
                    if (modelSelect) {
                        modelSelect.value = '';
                    }
                }
            }

            if (productSearchDebounceTimer) {
                clearTimeout(productSearchDebounceTimer);
            }

            var query = productSearchInput ? productSearchInput.value.trim() : '';
            productSearchDebounceTimer = setTimeout(function () {
                performProductSearch(query);
            }, 200);
        }

        function handleProductFilterClear() {
            resetProductFilters();
            if (productSearchDebounceTimer) {
                clearTimeout(productSearchDebounceTimer);
            }
            var query = productSearchInput ? productSearchInput.value.trim() : '';
            performProductSearch(query);
        }

        function openSalesModal() {
            if (!ensureCashOpen()) {
                return;
            }
            if (!salesModal || salesState.isLoading) {
                return;
            }
            salesModal.classList.add('is-visible');
            salesModal.setAttribute('aria-hidden', 'false');

            salesState.page = 1;
            salesState.query = salesSearchInput ? salesSearchInput.value.trim() : '';
            salesState.fechaInicio = salesDateStartInput ? salesDateStartInput.value : '';
            salesState.fechaFin = salesDateEndInput ? salesDateEndInput.value : '';

            if (salesSearchInput) {
                salesSearchInput.focus();
            }

            fetchSalesData();
        }

        function closeSalesModal() {
            if (!salesModal) {
                return;
            }
            salesModal.classList.remove('is-visible');
            salesModal.setAttribute('aria-hidden', 'true');
            if (openSalesModalButton) {
                openSalesModalButton.focus();
            }
        }

        function fetchSalesData() {
            if (!salesEndpoint || salesState.isLoading) {
                return;
            }

            salesState.isLoading = true;

            var params = new URLSearchParams({
                page: String(salesState.page),
                page_size: String(salesState.pageSize),
            });

            if (salesState.query) {
                params.set('query', salesState.query);
            }

            if (salesState.fechaInicio) {
                params.set('fecha_inicio', salesState.fechaInicio);
            }

            if (salesState.fechaFin) {
                params.set('fecha_fin', salesState.fechaFin);
            }

            if (salesResultsContainer) {
                salesResultsContainer.innerHTML = '<div class="sales-history__empty">Cargando ventas...</div>';
            }

            var requestUrl = salesEndpoint + '?' + params.toString();

            fetch(requestUrl, {
                headers: {
                    'Accept': 'application/json',
                },
            })
                .then(function (response) {
                    if (!response.ok) {
                        throw new Error('Error al cargar las ventas');
                    }
                    return response.json();
                })
                .then(function (payload) {
                    renderSalesResults(payload.results || []);
                    updateSalesPagination(payload.pagination || {});
                })
                .catch(function (error) {
                    console.error(error);
                    if (salesResultsContainer) {
                        salesResultsContainer.innerHTML = '<div class="sales-history__empty">No fue posible cargar el historial. Int√©ntalo nuevamente.</div>';
                    }
                    if (salesPagination) {
                        salesPagination.hidden = true;
                    }
                })
                .finally(function () {
                    salesState.isLoading = false;
                });
        }

        function renderSalesResults(data) {
            var orderedResults = sortSalesData(data);

            if (salesResultsContainer) {
                if (!orderedResults.length) {
                    salesResultsContainer.innerHTML = '<div class="sales-history__empty">No se encontraron ventas para los filtros seleccionados.</div>';
                } else {
                    var metaList = orderedResults.map(function (sale) {
                        var subtotalDisplay = sale.subtotal || (typeof sale.subtotal_num === 'number' ? formatCurrency(sale.subtotal_num) : '-');
                        var taxDisplay = sale.impuestos || (typeof sale.impuestos_num === 'number' ? formatCurrency(sale.impuestos_num) : '-');
                        var totalDisplay = sale.total || (typeof sale.total_num === 'number' ? formatCurrency(sale.total_num) : '-');
                        var abonadoDisplay = sale.total_abonado || (typeof sale.total_abonado_num === 'number' ? formatCurrency(sale.total_abonado_num) : '-');
                        var saldoDisplay = sale.saldo_pendiente || (typeof sale.saldo_pendiente_num === 'number' ? formatCurrency(sale.saldo_pendiente_num) : '-');
                        var fechaDisplay = sale.fecha_formateada || [sale.fecha, sale.hora].filter(Boolean).join(' ');

                        var detallesList = (sale.detalles || []).map(function (detalle) {
                            var parts = [];
                            if (detalle.producto) {
                                parts.push(detalle.producto);
                            }
                            if (detalle.cantidad != null) {
                                parts.push('x ' + detalle.cantidad);
                            }
                            var lineSubtotal = detalle.subtotal_formatted || (typeof detalle.subtotal === 'number' ? formatCurrency(detalle.subtotal) : '');
                            var lineTax = detalle.impuesto_formatted || (typeof detalle.impuesto === 'number' ? formatCurrency(detalle.impuesto) : '');
                            var lineTotal = detalle.total_formatted || (typeof detalle.total === 'number' ? formatCurrency(detalle.total) : '');
                            var extras = [];
                            if (lineSubtotal) {
                                extras.push('Subtotal ' + lineSubtotal);
                            }
                            if (lineTax && lineTax !== 'RD$ 0.00') {
                                extras.push('ITBIS ' + lineTax);
                            }
                            if (lineTotal) {
                                extras.push('Total ' + lineTotal);
                            }
                            if (extras.length) {
                                parts.push(extras.join(' ‚Ä¢ '));
                            }
                            return '<li>' + parts.join(' ‚Ä¢ ') + '</li>';
                        }).join('');

                        var badge = '<span class="sales-history__badge">' + (sale.factura || '-') + '</span>';
                        var creditBadge = '';
                        if (sale.es_credito) {
                            if (sale.progreso_cuotas) {
                                creditBadge = '<span class="sales-history__badge sales-history__badge--credit">Cr√©dito ' + sale.progreso_cuotas + '</span>';
                            } else {
                                creditBadge = '<span class="sales-history__badge sales-history__badge--credit">Cr√©dito</span>';
                            }
                        }

                        var bodyParts = [
                            '<article class="sales-history__item" data-sale-accordion>',
                            '   <button class="sales-history__accordion-trigger" type="button" data-sale-accordion-toggle>',
                            '       <div class="sales-history__summary">',
                            '           <div class="sales-history__summary-row">',
                            '               <div class="sales-history__summary-main">' + badge + creditBadge + '<strong>' + (sale.cliente_nombre || '-') + '</strong></div>',
                            '               <div class="sales-history__summary-extra">',
                            '                   <span>' + (sale.metodo_pago || '-') + '</span>',
                            '               </div>',
                            '           </div>',
                            '           <div class="sales-history__summary-date">' + (fechaDisplay || '-') + '</div>',
                            '       </div>',
                            '       <span class="sales-history__trigger-icon" aria-hidden="true">‚ñæ</span>',
                            '   </button>',
                            '   <div class="sales-history__body" data-sale-accordion-body>',
                            '       <div class="sales-history__meta-grid">',
                            '           <div class="sales-history__meta-item"><span class="sales-history__meta-label">Documento</span><span class="sales-history__meta-value">' + (sale.cliente_documento || '-') + '</span></div>',
                            '           <div class="sales-history__meta-item"><span class="sales-history__meta-label">Cajero</span><span class="sales-history__meta-value">' + (sale.cajero || '-') + '</span></div>'
                        ];

                        if (sale.vendedor) {
                            bodyParts.push(
                                '           <div class="sales-history__meta-item"><span class="sales-history__meta-label">Vendedor</span><span class="sales-history__meta-value">' + sale.vendedor + '</span></div>'
                            );
                        }

                        bodyParts.push(
                            '           <div class="sales-history__meta-item"><span class="sales-history__meta-label">Estado</span><span class="sales-history__meta-value">' + (sale.estado || '-') + '</span></div>'
                        );

                        // Agregar informaci√≥n de cuotas si es venta a cr√©dito
                        if (sale.es_credito && sale.progreso_cuotas) {
                            bodyParts.push(
                                '           <div class="sales-history__meta-item"><span class="sales-history__meta-label">Progreso cuotas</span><span class="sales-history__meta-value">' + sale.progreso_cuotas + '</span></div>'
                            );
                        }
                        if (sale.es_credito && sale.frecuencia_display) {
                            bodyParts.push(
                                '           <div class="sales-history__meta-item"><span class="sales-history__meta-label">Frecuencia</span><span class="sales-history__meta-value">' + sale.frecuencia_display + '</span></div>'
                            );
                        }

                        bodyParts.push('       </div>');

                        if (detallesList) {
                            bodyParts.push(
                                '       <div class="sales-history__details-wrapper">',
                                '           <strong>Productos</strong>',
                                '           <ul class="sales-history__details">' + detallesList + '</ul>',
                                '       </div>'
                            );
                        }

                        bodyParts.push(
                            '       <div class="sales-history__totals">',
                            '           <div class="sales-history__totals-item"><span class="sales-history__totals-label">Subtotal</span><span class="sales-history__totals-value">' + subtotalDisplay + '</span></div>',
                            '           <div class="sales-history__totals-item"><span class="sales-history__totals-label">ITBIS</span><span class="sales-history__totals-value">' + taxDisplay + '</span></div>',
                            '           <div class="sales-history__totals-item"><span class="sales-history__totals-label">Total</span><span class="sales-history__totals-value">' + totalDisplay + '</span></div>',
                            '           <div class="sales-history__totals-item"><span class="sales-history__totals-label">Abonado</span><span class="sales-history__totals-value">' + abonadoDisplay + '</span></div>',
                            '           <div class="sales-history__totals-item"><span class="sales-history__totals-label">Saldo pendiente</span><span class="sales-history__totals-value">' + saldoDisplay + '</span></div>',
                            '       </div>',
                            '   </div>',
                            '</article>'
                        );

                        return bodyParts.join('');
                    });

                    salesResultsContainer.innerHTML = '<div class="sales-history__list">' + metaList.join('') + '</div>';
                }
            }

            renderSaleTableRows(orderedResults);
            bindSalesAccordions();
        }

        function toggleAccordion(item) {
            if (!item) {
                return;
            }
            var isOpen = item.classList.contains('is-open');
            document.querySelectorAll('[data-sale-accordion]').forEach(function (accordion) {
                accordion.classList.remove('is-open');
            });
            if (!isOpen) {
                item.classList.add('is-open');
            }
        }

        function bindSalesAccordions() {
            var accordions = document.querySelectorAll('[data-sale-accordion]');
            accordions.forEach(function (accordion) {
                var trigger = accordion.querySelector('[data-sale-accordion-toggle]');
                if (!trigger) {
                    return;
                }
                trigger.addEventListener('click', function () {
                    toggleAccordion(accordion);
                });
            });
        }

        function updateSalesPagination(pagination) {
            updateSalesPaginationBlock(pagination || {});
        }

        if (openSalesModalButton) {
            openSalesModalButton.addEventListener('click', openSalesModal);
        }

        if (clientModal) {
            clientModal.querySelectorAll('[data-close-modal]').forEach(function (closeBtn) {
                closeBtn.addEventListener('click', closeClientModal);
            });

            clientModal.addEventListener('click', function (event) {
                if (event.target === clientModal) {
                    closeClientModal();
                }
            });

            document.addEventListener('keydown', function (event) {
                if (event.key === 'Escape' && clientModal.classList.contains('is-visible')) {
                    closeClientModal();
                }
            });

            if (clientSearchInput) {
                clientSearchInput.addEventListener('input', function (event) {
                    filterClientList(event.target.value);
                });
            }

            if (clientList) {
                clientList.addEventListener('click', handleClientSelect);
            }
        }

        if (productModal) {
            productModal.querySelectorAll('[data-close-product]').forEach(function (closeBtn) {
                closeBtn.addEventListener('click', closeProductModal);
            });

            productModal.addEventListener('click', function (event) {
                if (event.target === productModal) {
                    closeProductModal();
                }
            });

            document.addEventListener('keydown', function (event) {
                if (event.key === 'Escape' && productModal.classList.contains('is-visible')) {
                    closeProductModal();
                }
            });

            if (productSearchInput) {
                productSearchInput.addEventListener('input', handleProductSearchInput);
            }
        }

        if (editQuantityModal) {
            editQuantityModal.querySelectorAll('[data-close-quantity]').forEach(function (button) {
                button.addEventListener('click', function () {
                    closeModalElement(editQuantityModal);
                });
            });
            var saveQuantityButton = editQuantityModal.querySelector('[data-save-quantity]');
            if (saveQuantityButton) {
                saveQuantityButton.addEventListener('click', handleQuantitySave);
            }
            editQuantityModal.addEventListener('click', function (event) {
                if (event.target === editQuantityModal) {
                    closeModalElement(editQuantityModal);
                }
            });
        }

        if (editPriceModal) {
            editPriceModal.querySelectorAll('[data-close-price]').forEach(function (button) {
                button.addEventListener('click', function () {
                    closeModalElement(editPriceModal);
                });
            });
            var savePriceButton = editPriceModal.querySelector('[data-save-price]');
            if (savePriceButton) {
                savePriceButton.addEventListener('click', handlePriceSave);
            }
            editPriceModal.addEventListener('click', function (event) {
                if (event.target === editPriceModal) {
                    closeModalElement(editPriceModal);
                }
            });
        }

        document.addEventListener('keydown', function (event) {
            if (event.key !== 'Escape') {
                return;
            }
            if (editQuantityModal && editQuantityModal.classList.contains('is-visible')) {
                closeModalElement(editQuantityModal);
                return;
            }
            if (editPriceModal && editPriceModal.classList.contains('is-visible')) {
                closeModalElement(editPriceModal);
            }
        });

        if (salesModal) {
            salesModal.querySelectorAll('[data-close-sales]').forEach(function (button) {
                button.addEventListener('click', closeSalesModal);
            });

            salesModal.addEventListener('click', function (event) {
                if (event.target === salesModal) {
                    closeSalesModal();
                }
            });

            document.addEventListener('keydown', function (event) {
                if (event.key === 'Escape' && salesModal.classList.contains('is-visible')) {
                    closeSalesModal();
                }
            });

            if (salesSearchInput) {
                var searchTimeout = null;
                salesSearchInput.addEventListener('input', function (event) {
                    clearTimeout(searchTimeout);
                    searchTimeout = setTimeout(function () {
                        salesState.query = salesSearchInput.value.trim();
                        salesState.page = 1;
                        fetchSalesData();
                    }, 250);
                });
            }

            if (salesDateStartInput) {
                salesDateStartInput.addEventListener('change', function () {
                    salesState.fechaInicio = salesDateStartInput.value;
                    salesState.page = 1;
                    fetchSalesData();
                });
            }

            if (salesDateEndInput) {
                salesDateEndInput.addEventListener('change', function () {
                    salesState.fechaFin = salesDateEndInput.value;
                    salesState.page = 1;
                    fetchSalesData();
                });
            }

            if (salesRefreshButton) {
                salesRefreshButton.addEventListener('click', function () {
                    salesState.query = salesSearchInput ? salesSearchInput.value.trim() : '';
                    salesState.fechaInicio = salesDateStartInput ? salesDateStartInput.value : '';
                    salesState.fechaFin = salesDateEndInput ? salesDateEndInput.value : '';
                    salesState.page = 1;
                    fetchSalesData();
                });
            }

            if (salesPrevButton) {
                salesPrevButton.addEventListener('click', function () {
                    var targetPage = parseInt(salesPrevButton.dataset.page || '1', 10);
                    if (!Number.isNaN(targetPage) && targetPage !== salesState.page) {
                        salesState.page = targetPage;
                        fetchSalesData();
                    }
                });
            }

            if (salesNextButton) {
                salesNextButton.addEventListener('click', function () {
                    var targetPage = parseInt(salesNextButton.dataset.page || '1', 10);
                    if (!Number.isNaN(targetPage) && targetPage !== salesState.page) {
                        salesState.page = targetPage;
                        fetchSalesData();
                    }
                });
            }
        }

        // Funciones para el modal de configuraci√≥n de cuotas
        function openCreditInstallmentsModal() {
            if (!creditInstallmentsModal) {
                return;
            }
            
            // Mostrar el total de la venta
            var total = paymentState.total - paymentState.discountAmount;
            if (creditTotalOutput) {
                creditTotalOutput.textContent = formatCurrency(total);
            }
            
            // Resetear valores
            if (creditInstallmentsSelect) {
                creditInstallmentsSelect.value = '3';
            }
            if (creditFrequencySelect) {
                creditFrequencySelect.value = '30';
            }
            if (creditInitialPaymentInput) {
                creditInitialPaymentInput.value = '';
            }
            
            updateCreditCalculation();
            openModalElement(creditInstallmentsModal);
        }

        function closeCreditInstallmentsModal() {
            if (!creditInstallmentsModal) {
                return;
            }
            
            // Si se cierra sin confirmar, desmarcar el checkbox
            if (creditSaleCheckbox && !creditConfig.enabled) {
                creditSaleCheckbox.checked = false;
            }
            
            closeModalElement(creditInstallmentsModal);
        }

        function updateCreditCalculation() {
            if (!creditInstallmentsModal) {
                return;
            }
            
            var total = paymentState.total - paymentState.discountAmount;
            var installments = parseInt(creditInstallmentsSelect ? creditInstallmentsSelect.value : '3', 10);
            var frequency = parseInt(creditFrequencySelect ? creditFrequencySelect.value : '30', 10);
            var initialPayment = parseFloat(creditInitialPaymentInput ? creditInitialPaymentInput.value : '0') || 0;
            
            // Validar abono inicial
            if (initialPayment > total) {
                initialPayment = total;
                if (creditInitialPaymentInput) {
                    creditInitialPaymentInput.value = total.toFixed(2);
                }
            }
            
            var balance = total - initialPayment;
            var installmentAmount = installments > 0 ? balance / installments : 0;
            
            // Actualizar displays
            if (creditCalcInitial) {
                creditCalcInitial.textContent = formatCurrency(initialPayment);
            }
            if (creditCalcBalance) {
                creditCalcBalance.textContent = formatCurrency(balance);
            }
            if (creditCalcInstallment) {
                creditCalcInstallment.textContent = formatCurrency(installmentAmount);
            }
            if (creditCalcFrequency) {
                var frequencyText = frequency === 7 ? 'Semanal' : 
                                 frequency === 15 ? 'Quincenal' : 'Mensual';
                creditCalcFrequency.textContent = frequencyText;
            }
            
            // Actualizar configuraci√≥n temporal
            creditConfig.installments = installments;
            creditConfig.frequency = frequency;
            creditConfig.initialPayment = initialPayment;
            creditConfig.installmentAmount = installmentAmount;
        }

        function confirmCreditConfiguration() {
            if (!creditInstallmentsModal) {
                return;
            }
            
            // Confirmar configuraci√≥n
            creditConfig.enabled = true;
            
            // Cerrar modal
            closeModalElement(creditInstallmentsModal);
            
            // Actualizar resumen de pago
            updatePaymentSummary();
            
            showToast('Configuraci√≥n de cuotas guardada correctamente', 'success');
        }
    });
// Funci√≥n para obtener stock real del inventario por especificaciones
        function getAvailableStockBySpecs(productId, storage, ram, selector) {
            // Primero intentar obtener stock real del inventario
            var totalStock = 0;
            var productSelect = selector || productSelector;
            
            console.log('üîç Buscando stock REAL del inventario:', {
                productId: productId,
                storage: storage,
                ram: ram
            });
            
            if (productSelect) {
                var options = productSelect.querySelectorAll('option[data-product-id="' + productId + '"]');
                console.log('üì¶ Opciones en selector:', options.length);
                
                options.forEach(function(option, index) {
                    var optionStorage = option.dataset.almacenamiento || '';
                    var optionRam = option.dataset.ram || '';
                    var stock = parseInt(option.getAttribute('data-stock') || '0', 10);
                    var optionText = option.textContent;
                    
                    console.log('üìã Opci√≥n ' + index + ':', {
                        text: optionText,
                        optionStorage: optionStorage,
                        optionRam: optionRam,
                        stock: stock,
                        storageMatch: optionStorage === storage,
                        ramMatch: optionRam === ram,
                        bothMatch: optionStorage === storage && optionRam === ram
                    });
                    
                    // Comparaci√≥n flexible para almacenamiento y RAM
                    var storageMatches = compareStorage(optionStorage, storage);
                    var ramMatches = compareRam(optionRam, ram);
                    
                    if (storageMatches && ramMatches) {
                        totalStock += stock;
                        console.log('‚úÖ Coincidencia encontrada, stock acumulado:', totalStock);
                    }
                });
            }
            
            console.log('üéØ Stock REAL disponible:', totalStock);
            return totalStock;
        }
        
        // Funci√≥n para comparar color de forma flexible
        function compareColor(optionColor, searchColor) {
            if (!optionColor || !searchColor) return false;
            
            // Normalizar ambos valores (ignorar may√∫sculas/min√∫sculas y espacios)
            var normalizedOption = optionColor.toLowerCase().trim();
            var normalizedSearch = searchColor.toLowerCase().trim();
            
            console.log('üé® Comparando color:', {
                option: optionColor,
                search: searchColor,
                normalizedOption: normalizedOption,
                normalizedSearch: normalizedSearch,
                match: normalizedOption === normalizedSearch
            });
            
            return normalizedOption === normalizedSearch;
        }
        
        // Funci√≥n para comparar almacenamiento de forma flexible
        function compareStorage(optionStorage, searchStorage) {
            if (!optionStorage || !searchStorage) return false;
            
            // Normalizar ambos valores
            var normalizedOption = optionStorage.toLowerCase().replace(/\s+/g, '').replace('gb', '');
            var normalizedSearch = searchStorage.toLowerCase().replace(/\s+/g, '').replace('gb', '');
            
            console.log('üî¢ Comparando almacenamiento:', {
                option: optionStorage,
                search: searchStorage,
                normalizedOption: normalizedOption,
                normalizedSearch: normalizedSearch,
                match: normalizedOption === normalizedSearch
            });
            
            return normalizedOption === normalizedSearch;
        }
        
        // Funci√≥n para comparar RAM de forma flexible
        function compareRam(optionRam, searchRam) {
            if (!optionRam || !searchRam) return false;
            
            // Normalizar ambos valores
            var normalizedOption = optionRam.toLowerCase().replace(/\s+/g, '').replace('gb', '');
            var normalizedSearch = searchRam.toLowerCase().replace(/\s+/g, '').replace('gb', '');
            
            console.log('üíæ Comparando RAM:', {
                option: optionRam,
                search: searchRam,
                normalizedOption: normalizedOption,
                normalizedSearch: normalizedSearch,
                match: normalizedOption === normalizedSearch
            });
            
            return normalizedOption === normalizedSearch;
        }

        // Funci√≥n para obtener cantidad actual en carrito por especificaciones (color no afecta agrupaci√≥n)
        function getCurrentQuantityBySpecs(productId, storage, ram) {
            if (!cartItems || cartItems.length === 0) {
                return 0;
            }
            var productKey = 'product_' + productId + '_' + storage + '_' + ram; // Sin color
            var existingItem = cartItems.find(function(item) {
                return item.productKey === productKey;
            });
            return existingItem ? existingItem.quantity : 0;
        }

        // Funciones para descargar documentos de ventas
        function bindDownloadButtons() {
            // Botones de descarga en la tabla
            document.querySelectorAll('[data-download-invoice]').forEach(function(button) {
                button.addEventListener('click', function() {
                    var saleId = this.getAttribute('data-sale-id');
                    downloadInvoice(saleId);
                });
            });

            document.querySelectorAll('[data-download-ticket]').forEach(function(button) {
                button.addEventListener('click', function() {
                    var saleId = this.getAttribute('data-sale-id');
                    downloadTicket(saleId);
                });
            });
        }

        function downloadInvoice(saleId) {
            var url = '/app/ventas/' + saleId + '/factura/';
            window.open(url, '_blank');
        }

        function downloadTicket(saleId) {
            var url = '/app/ventas/' + saleId + '/ticket/';
            window.open(url, '_blank');
        }

        // Llamar a bindDownloadButtons despu√©s de renderizar las ventas
        function renderSalesResults(data) {
            var orderedResults = sortSalesData(data);

            if (salesResultsContainer) {
                if (!orderedResults.length) {
                    salesResultsContainer.innerHTML = '<div class="sales-history__empty">No se encontraron ventas para los filtros seleccionados.</div>';
                } else {
                    var metaList = orderedResults.map(function (sale) {
                        var subtotalDisplay = sale.subtotal || (typeof sale.subtotal_num === 'number' ? formatCurrency(sale.subtotal_num) : '-');
                        var taxDisplay = sale.impuestos || (typeof sale.impuestos_num === 'number' ? formatCurrency(sale.impuestos_num) : '-');
                        var totalDisplay = sale.total || (typeof sale.total_num === 'number' ? formatCurrency(sale.total_num) : '-');
                        var abonadoDisplay = sale.total_abonado || (typeof sale.total_abonado_num === 'number' ? formatCurrency(sale.total_abonado_num) : '-');
                        var saldoDisplay = sale.saldo_pendiente || (typeof sale.saldo_pendiente_num === 'number' ? formatCurrency(sale.saldo_pendiente_num) : '-');
                        var fechaDisplay = sale.fecha_formateada || [sale.fecha, sale.hora].filter(Boolean).join(' ');

                        var detallesList = (sale.detalles || []).map(function (detalle) {
                            var parts = [];
                            if (detalle.producto) {
                                parts.push(detalle.producto);
                            }
                            if (detalle.cantidad != null) {
                                parts.push('x ' + detalle.cantidad);
                            }
                            var lineSubtotal = detalle.subtotal_formatted || (typeof detalle.subtotal === 'number' ? formatCurrency(detalle.subtotal) : '');
                            var lineTax = detalle.impuesto_formatted || (typeof detalle.impuesto === 'number' ? formatCurrency(detalle.impuesto) : '');
                            var lineTotal = detalle.total_formatted || (typeof detalle.total === 'number' ? formatCurrency(detalle.total) : '');
                            var extras = [];
                            if (lineSubtotal) {
                                extras.push('Subtotal ' + lineSubtotal);
                            }
                            if (lineTax && lineTax !== 'RD$ 0.00') {
                                extras.push('ITBIS ' + lineTax);
                            }
                            if (lineTotal) {
                                extras.push('Total ' + lineTotal);
                            }
                            if (extras.length) {
                                parts.push(extras.join(' ‚Ä¢ '));
                            }
                            return '<li>' + parts.join(' ‚Ä¢ ') + '</li>';
                        }).join('');

                        var badge = '<span class="sales-history__badge">' + (sale.factura || '-') + '</span>';
                        var creditBadge = '';
                        if (sale.es_credito) {
                            if (sale.progreso_cuotas) {
                                creditBadge = '<span class="sales-history__badge sales-history__badge--credit">Cr√©dito ' + sale.progreso_cuotas + '</span>';
                            } else {
                                creditBadge = '<span class="sales-history__badge sales-history__badge--credit">Cr√©dito</span>';
                            }
                        }

                        var bodyParts = [
                            '<article class="sales-history__item" data-sale-accordion>',
                            '   <button class="sales-history__accordion-trigger" type="button" data-sale-accordion-toggle>',
                            '       <div class="sales-history__summary">',
                            '           <div class="sales-history__summary-row">',
                            '               <div class="sales-history__summary-main">' + badge + creditBadge + '<strong>' + (sale.cliente_nombre || '-') + '</strong></div>',
                            '               <div class="sales-history__summary-extra">',
                            '                   <span>' + (sale.metodo_pago || '-') + '</span>',
                            '               </div>',
                            '           </div>',
                            '           <div class="sales-history__summary-date">' + (fechaDisplay || '-') + '</div>',
                            '       </div>',
                            '       <span class="sales-history__trigger-icon" aria-hidden="true">‚ñæ</span>',
                            '   </button>',
                            '   <div class="sales-history__body" data-sale-accordion-body>',
                            '       <div class="sales-history__meta-grid">',
                            '           <div class="sales-history__meta-item"><span class="sales-history__meta-label">Documento</span><span class="sales-history__meta-value">' + (sale.cliente_documento || '-') + '</span></div>',
                            '           <div class="sales-history__meta-item"><span class="sales-history__meta-label">Cajero</span><span class="sales-history__meta-value">' + (sale.cajero || '-') + '</span></div>'
                        ];

                        if (sale.vendedor) {
                            bodyParts.push(
                                '           <div class="sales-history__meta-item"><span class="sales-history__meta-label">Vendedor</span><span class="sales-history__meta-value">' + sale.vendedor + '</span></div>'
                            );
                        }

                        bodyParts.push(
                            '           <div class="sales-history__meta-item"><span class="sales-history__meta-label">Estado</span><span class="sales-history__meta-value">' + (sale.estado || '-') + '</span></div>'
                        );

                        // Agregar informaci√≥n de cuotas si es venta a cr√©dito
                        if (sale.es_credito && sale.progreso_cuotas) {
                            bodyParts.push(
                                '           <div class="sales-history__meta-item"><span class="sales-history__meta-label">Progreso cuotas</span><span class="sales-history__meta-value">' + sale.progreso_cuotas + '</span></div>'
                            );
                        }
                        if (sale.es_credito && sale.frecuencia_display) {
                            bodyParts.push(
                                '           <div class="sales-history__meta-item"><span class="sales-history__meta-label">Frecuencia</span><span class="sales-history__meta-value">' + sale.frecuencia_display + '</span></div>'
                            );
                        }

                        bodyParts.push('       </div>');

                        if (detallesList) {
                            bodyParts.push(
                                '       <div class="sales-history__details-wrapper">',
                                '           <strong>Productos</strong>',
                                '           <ul class="sales-history__details">' + detallesList + '</ul>',
                                '       </div>'
                            );
                        }

                        bodyParts.push(
                            '       <div class="sales-history__totals">',
                            '           <div class="sales-history__totals-item"><span class="sales-history__totals-label">Subtotal</span><span class="sales-history__totals-value">' + subtotalDisplay + '</span></div>',
                            '           <div class="sales-history__totals-item"><span class="sales-history__totals-label">ITBIS</span><span class="sales-history__totals-value">' + taxDisplay + '</span></div>',
                            '           <div class="sales-history__totals-item"><span class="sales-history__totals-label">Total</span><span class="sales-history__totals-value">' + totalDisplay + '</span></div>',
                            '           <div class="sales-history__totals-item"><span class="sales-history__totals-label">Abonado</span><span class="sales-history__totals-value">' + abonadoDisplay + '</span></div>',
                            '           <div class="sales-history__totals-item"><span class="sales-history__totals-label">Saldo pendiente</span><span class="sales-history__totals-value">' + saldoDisplay + '</span></div>',
                            '       </div>',
                            '   </div>',
                            '</article>'
                        );

                        return bodyParts.join('');
                    });

                    salesResultsContainer.innerHTML = '<div class="sales-history__list">' + metaList.join('') + '</div>';
                }
            }

            renderSaleTableRows(orderedResults);
            bindSalesAccordions();
            bindDownloadButtons(); // Bind download buttons after rendering
        }
    </script>
{% endblock %}
